{"version":3,"file":"jellyfin-danmaku.min.js","sources":["../src/api/settings.js","../src/api/fetch.js","../src/api/utils.js","../src/ui/pages/BasicSettingsPage.js","../src/ui/pages/CombinedSettingsPage.js","../src/ui/pages/FilterSettingsPage.js","../src/ui/pages/CommentPoolPage.js","../src/ui/pages/SearchDanmakuPage.js","../src/ui/settingsPanel.js","../src/ui/buttons.js","../src/render/heatmapRenderer.js","../src/render/danmakuCanvas.js","../src/danmakuActions.js","../src/log.js","../src/index.js"],"sourcesContent":["/**\r\n * DanmakuSettings - 弹幕 / 热力图 参数设置类\r\n * - 负责：类型规范化、默认值填充、更新验证、序列化\r\n * - 用法：\r\n *   const s = new DanmakuSettings(rawSettingsObject);\r\n *   s.set('font_size', 30); s.enable_heatmap = 'combined';\r\n */\r\n\r\nconst GLOBAL_NS = '__jfDanmakuGlobal__';\r\n\r\nexport class DanmakuSettings {\r\n    /**\r\n     * @param {Object} raw 服务器返回的 settings 对象（可选 / 部分字段）\r\n     */\r\n    constructor(raw = {}) {\r\n        // 定义所有受支持的键：默认值 + 期望类型\r\n        // type: 'number' | 'boolean' | 'string'\r\n        this._schema = Object.freeze({\r\n            chConvert:          { def: '0',        type: 'string'  }, // '0' | '1' | '2'\r\n            withRelated:        { def: 'true',     type: 'string'  }, // 服务器用字符串布尔\r\n            enable_heatmap:     { def: 'combined', type: 'string'  },\r\n            font_size:          { def: 25,         type: 'number'  },\r\n            font_family:        { def: 'sans-serif', type: 'string'},\r\n            opacity:            { def: 70,         type: 'number'  },\r\n            speed:              { def: 144,        type: 'number'  },\r\n            display_top_pct:    { def: 0,          type: 'number'  },\r\n            display_bottom_pct: { def: 100,        type: 'number'  },\r\n            // 合并选项\r\n            enable_combine:     { def: true,       type: 'boolean' },\r\n            threshold_seconds:  { def: 15,          type: 'number'  },\r\n            max_distance:       { def: 3,          type: 'number'  },\r\n            max_cosine:         { def: 40,         type: 'number'  },\r\n            use_pinyin:         { def: true,       type: 'boolean' },\r\n            cross_mode:         { def: true,       type: 'boolean' },\r\n            trim_ending:        { def: true,       type: 'boolean' },\r\n            trim_space:         { def: true,       type: 'boolean' },\r\n            trim_width:         { def: true,       type: 'boolean' },\r\n            heatmap_style:      { def: \"blue\",     type: 'string'  },\r\n            mark_style:         { def: \"sub_low\",  type: 'string'  },\r\n            mark_threshold:     { def: 1,          type: 'number'  },\r\n            mode_elevation:     { def: true,       type: 'boolean' },\r\n            enlarge:            { def: true,       type: 'boolean' },\r\n            scroll_threshold:   { def: 0,          type: 'number'  },\r\n            shrink_threshold:   { def: 0,          type: 'number'  },\r\n            drop_threshold:     { def: 0,          type: 'number'  },\r\n            max_chunk_size:     { def: 1000,       type: 'number'  },\r\n            // 规则列表\r\n            force_list:         { def: '[]',         type: 'string'  },\r\n            white_list:         { def: '[]',         type: 'string'  },\r\n            black_list:         { def: '[]',         type: 'string'  },\r\n            black_source_list:  { def: '[]',         type: 'string'  },\r\n        });\r\n\r\n        // 内部存储实际值\r\n        this._values = {};\r\n        // 逐项加载\r\n        for (const key of Object.keys(this._schema)) {\r\n            const schema = this._schema[key];\r\n            const rawVal = Object.prototype.hasOwnProperty.call(raw, key) ? raw[key] : schema.def;\r\n            this._values[key] = this._normalize(rawVal, schema.type, schema.def);\r\n        }\r\n        // 记录未知字段（可能用于调试）\r\n        this._unknown = Object.keys(raw).filter(k => !this._schema[k]);\r\n    }\r\n\r\n    /**\r\n     * 类型规范化\r\n     */\r\n    _normalize(value, type, def) {\r\n        if (value == null) return def;\r\n        try {\r\n            switch (type) {\r\n                case 'number': {\r\n                    if (typeof value === 'number' && !isNaN(value)) return value;\r\n                    const n = Number(value);\r\n                    return isNaN(n) ? def : n;\r\n                }\r\n                case 'boolean': {\r\n                    if (typeof value === 'boolean') return value;\r\n                    if (value === 'true' || value === '1') return true;\r\n                    if (value === 'false' || value === '0') return false;\r\n                    return !!value;\r\n                }\r\n                case 'string': {\r\n                    return String(value);\r\n                }\r\n                default:\r\n                    return value;\r\n            }\r\n        } catch (_) {\r\n            return def;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 获取全部键列表\r\n     */\r\n    keys() { return Object.keys(this._schema); }\r\n\r\n    /**\r\n     * 快速导出纯对象（深拷贝简单值）\r\n     */\r\n    toJSON() {\r\n        const out = {};\r\n        for (const k of this.keys()) out[k] = this._values[k];\r\n        return out;\r\n    }\r\n\r\n    /**\r\n     * 获取单个值\r\n     */\r\n    get(key) { return this._values[key]; }\r\n\r\n    /**\r\n     * 设置单个值（带类型校验与规范化）\r\n     */\r\n    set(key, value) {\r\n        const schema = this._schema[key];\r\n        if (!schema) return false;\r\n        this._values[key] = this._normalize(value, schema.type, schema.def);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * 批量更新\r\n     */\r\n    patch(obj = {}) {\r\n        for (const [k, v] of Object.entries(obj)) this.set(k, v);\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * 便捷获取布尔（某些后端使用字符串布尔）\r\n     */\r\n    asBool(key) {\r\n        const v = this.get(key);\r\n        if (typeof v === 'boolean') return v;\r\n        if (v === 'true' || v === '1') return true;\r\n        if (v === 'false' || v === '0') return false;\r\n        return !!v;\r\n    }\r\n\r\n    /**\r\n     * 全局挂载\r\n     */\r\n    mountGlobal() {\r\n        if (typeof window === 'undefined') return this;\r\n        const g = window[GLOBAL_NS] = window[GLOBAL_NS] || {};\r\n        g.danmakuSettings = this;\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * 重置为默认值（不自动保存到服务器）\r\n     * - 就地修改当前实例的所有键为 schema.def\r\n     * - 返回自身，便于链式调用\r\n     */\r\n    resetToDefaults() {\r\n        try {\r\n            for (const k of Object.keys(this._schema)) {\r\n                const { def, type } = this._schema[k];\r\n                this._values[k] = this._normalize(def, type, def);\r\n            }\r\n        } catch (_) { /* no-op */ }\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * 获取一个包含全部默认值的纯对象（便于外部直接覆盖/初始化）\r\n     */\r\n    static getDefaultObject() {\r\n        try {\r\n            const tmp = new DanmakuSettings({});\r\n            const out = {};\r\n            for (const k of Object.keys(tmp._schema)) out[k] = tmp._schema[k].def;\r\n            return out;\r\n        } catch (_) {\r\n            return {};\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * 工具：从原始对象创建并挂载\r\n */\r\nexport function createAndMountDanmakuSettings(raw) {\r\n    // 若已存在全局实例：直接 patch 合并更新并返回，避免频繁 new 导致引用失效\r\n    try {\r\n        if (typeof window !== 'undefined') {\r\n            const g = window[GLOBAL_NS] = window[GLOBAL_NS] || {};\r\n            if (g.danmakuSettings instanceof DanmakuSettings) {\r\n                g.danmakuSettings.patch(raw || {});\r\n                return g.danmakuSettings;\r\n            }\r\n        }\r\n    } catch (_) { }\r\n    return new DanmakuSettings(raw).mountGlobal();\r\n}\r\n","// 获取弹幕数据的独立函数，从 danmakuExt.js 中迁移\r\n// 依赖全局 ApiClient 与统一命名空间 __jfDanmakuGlobal__ (兼容旧 __jfWebPlayerState__ 指向同对象)\r\nimport { createAndMountDanmakuSettings } from './settings';\r\nconst GLOBAL_NS = '__jfDanmakuGlobal__';\r\n\r\n\r\n\r\n\r\n// 提交（保存）当前全局设置到服务器，并获取最新弹幕/设置返回\r\n// 步骤：\r\n// 1. 从 window.__jfDanmakuGlobal__.danmakuSettings 读取全部键值\r\n// 2. 构建 URLSearchParams 作为表单数据\r\n// 3. 调用同一接口 danmaku/comment?item_id=... 发送 POST（应用服务器端保存逻辑）\r\n// 4. 若返回含 settings 再次实例化全局（保持与获取逻辑一致）\r\nexport async function updateDanmakuSettings(logger, item_id, danmaku_id) {\r\n    // item_id 仅使用显式传入参数，不再回退到播放器 mediaId\r\n    const g = window[GLOBAL_NS] = window[GLOBAL_NS] || {};\r\n    const gSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    if (!gSettings || typeof gSettings.toJSON !== 'function') {\r\n        logger?.warn?.('无法保存设置：全局设置对象缺失');\r\n        return null;\r\n    }\r\n\r\n    // 若没有媒体标识，避免误将默认设置保存到服务器\r\n    if (!item_id && !danmaku_id) {\r\n        logger?.info?.('跳过保存：缺少 item_id/danmaku_id');\r\n        return null;\r\n    }\r\n\r\n    try {\r\n        const settingsObj = gSettings.toJSON();\r\n        const formParams = new URLSearchParams();\r\n        for (const [k, v] of Object.entries(settingsObj)) {\r\n            // 全部转为字符串\r\n            formParams.append(k, String(v));\r\n        }\r\n        // 可附带一个动作字段(若后端需要)；此处仅示例，可按需开启\r\n        // formParams.append('action', 'save_settings');\r\n\r\n        // 构建查询参数（可选 item_id / danmaku_id）\r\n        const queryParts = [];\r\n        if (item_id) queryParts.push(`item_id=${encodeURIComponent(item_id)}`);\r\n        if (danmaku_id) queryParts.push(`danmaku_id=${encodeURIComponent(danmaku_id)}`);\r\n        const query = queryParts.length ? `?${queryParts.join('&')}` : '';\r\n        const url = ApiClient.getUrl(`danmaku/comment${query}`);\r\n        // Jellyfin ApiClient.ajax 典型参数：type, url, data, dataType\r\n        // data 传入 URL 编码字符串\r\n        const result = await ApiClient.ajax({\r\n            type: 'POST',\r\n            url,\r\n            data: formParams.toString(),\r\n            contentType: 'application/x-www-form-urlencoded; charset=UTF-8',\r\n            dataType: 'json'\r\n        });\r\n        logger?.info?.('已提交弹幕设置并获取响应', { 服务器返回弹幕数: result.comments?.length ?? undefined });\r\n        // 仅在存在 item_id 或 danmaku_id 的场景下应用响应（更新全局设置/弹幕/热力图）\r\n\r\n        if (!result || typeof result !== 'object') return result;\r\n        // settings\r\n        if (result.settings && typeof result.settings === 'object') {\r\n            try {\r\n                createAndMountDanmakuSettings(result.settings);\r\n                logger?.info?.('弹幕设置对象已更新');\r\n            } catch (e) {\r\n                logger?.warn?.('弹幕设置对象更新失败', e);\r\n            }\r\n        }\r\n        g.danmakuData = result;\r\n        logger?.info?.('全局 danmakuData 已刷新', { 数量: result.comments.length });\r\n\r\n        if (item_id || danmaku_id) {\r\n            try {\r\n                // 若已有渲染器实例，使用无闪烁替换方法更新数据\r\n                if (g.danmakuRenderer && typeof g.danmakuRenderer.replaceComments === 'function') {\r\n                    try {\r\n                        g.danmakuRenderer.replaceComments(result.comments, { preserveState: true });\r\n                        logger?.info?.('替换弹幕渲染器数据成功');\r\n                    } catch (re) {\r\n                        logger?.warn?.('替换弹幕渲染器数据失败', re);\r\n                    }\r\n                }\r\n                // 若返回了热力图数据且有渲染器实例，更新热力图\r\n                if (result.heatmap_data && typeof result.heatmap_data === 'object') {\r\n                    const heatmapValues = Object.values(result.heatmap_data);\r\n                    if (g.heatmapRenderer && typeof g.heatmapRenderer.recalculate === 'function') {\r\n                        try {\r\n                            const video = document.querySelector('video');\r\n                            const duration = video?.duration || 0;\r\n                            g.heatmapRenderer.recalculate(heatmapValues, duration);\r\n                            logger?.info?.('热力图数据已更新并重新计算');\r\n                        } catch (he) {\r\n                            logger?.warn?.('热力图更新失败', he);\r\n                        }\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                logger?.warn?.('刷新全局 danmakuData 失败', e);\r\n            }\r\n        } else {\r\n            logger?.info?.('设置已保存：未提供 item_id / danmaku_id，服务器正常不返回弹幕数据（未执行 _applyDanmakuResponse）');\r\n        }\r\n        return result;\r\n    } catch (err) {\r\n        logger?.warn?.('提交弹幕设置请求失败', err);\r\n        throw err;\r\n    }\r\n}\r\n\r\n// 仅获取（不覆盖）当前媒体的弹幕数据与设置\r\n// 用于页面初次加载或媒体切换后初始化，避免将本地默认值提交覆盖服务器\r\nexport async function fetchDanmakuData(logger, item_id, danmaku_id) {\r\n    const g = window[GLOBAL_NS] = window[GLOBAL_NS] || {};\r\n    try {\r\n        // 构建查询参数（可选 item_id / danmaku_id）\r\n        const queryParts = [];\r\n        if (item_id) queryParts.push(`item_id=${encodeURIComponent(item_id)}`);\r\n        if (danmaku_id) queryParts.push(`danmaku_id=${encodeURIComponent(danmaku_id)}`);\r\n        const query = queryParts.length ? `?${queryParts.join('&')}` : '';\r\n        const url = ApiClient.getUrl(`danmaku/comment${query}`);\r\n        const result = await ApiClient.ajax({ type: 'GET', url, dataType: 'json' });\r\n        if (!result || typeof result !== 'object') return result;\r\n        // settings\r\n        if (result.settings && typeof result.settings === 'object') {\r\n            try {\r\n                createAndMountDanmakuSettings(result.settings);\r\n                logger?.info?.('弹幕设置对象已加载');\r\n            } catch (e) {\r\n                logger?.warn?.('弹幕设置对象加载失败', e);\r\n            }\r\n        }\r\n        g.danmakuData = result;\r\n        logger?.info?.('已获取弹幕数据', { 数量: result.comments?.length });\r\n\r\n        // 更新渲染器/热力图\r\n        try {\r\n            if (g.danmakuRenderer && typeof g.danmakuRenderer.replaceComments === 'function' && Array.isArray(result.comments)) {\r\n                try {\r\n                    g.danmakuRenderer.replaceComments(result.comments, { preserveState: true });\r\n                    logger?.info?.('替换弹幕渲染器数据成功');\r\n                } catch (re) { logger?.warn?.('替换弹幕渲染器数据失败', re); }\r\n            }\r\n            if (result.heatmap_data && typeof result.heatmap_data === 'object') {\r\n                const heatmapValues = Object.values(result.heatmap_data);\r\n                if (g.heatmapRenderer && typeof g.heatmapRenderer.recalculate === 'function') {\r\n                    try {\r\n                        const video = document.querySelector('video');\r\n                        const duration = video?.duration || 0;\r\n                        g.heatmapRenderer.recalculate(heatmapValues, duration);\r\n                        logger?.info?.('热力图数据已更新并重新计算');\r\n                    } catch (he) { logger?.warn?.('热力图更新失败', he); }\r\n                }\r\n            }\r\n        } catch (_) { }\r\n        return result;\r\n    } catch (err) {\r\n        logger?.warn?.('获取弹幕设置/数据失败', err);\r\n        throw err;\r\n    }\r\n}\r\n","// 统一的保存工具（带防抖）\r\n// 用法：\r\n//   saveIfAutoOn(logger) -> Promise | undefined\r\n// 说明：\r\n// - 当 g.danmakuAutoSave 关闭时，直接返回 undefined，并清理挂起的定时器。\r\n// - 当开启时，进行尾随防抖（默认300ms，可通过 g.settingsSaveDebounceMs 或 g.saveDebounceMs 配置），\r\n//   多次快速调用会合并为一次保存，并返回同一个 pending Promise。\r\n\r\nimport { updateDanmakuSettings } from \"./fetch\";\r\n\r\n\r\nconst DEFAULT_SAVE_DEBOUNCE_MS = 300;\r\nlet _saveTimer = null;\r\nlet _pendingPromise = null;\r\nlet _pendingResolve = null;\r\nlet _pendingReject = null;\r\nlet _lastLogger = null;\r\n\r\nfunction _clearPendingTimer() {\r\n  if (_saveTimer) {\r\n    try { clearTimeout(_saveTimer); } catch (_) {}\r\n    _saveTimer = null;\r\n  }\r\n}\r\n\r\nfunction _resetPendingState() {\r\n  _clearPendingTimer();\r\n  _pendingPromise = null;\r\n  _pendingResolve = null;\r\n  _pendingReject = null;\r\n}\r\n\r\n// 通用保存（带防抖合并）\r\nexport function saveIfAutoOn(logger = null) {\r\n  try {\r\n    const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n    const enabled = !!g.danmakuAutoSave;\r\n\r\n    if (!enabled) {\r\n      // 关闭时清理任何挂起的保存任务；若已有挂起 Promise，则以已完成(undefined)结束，避免悬挂\r\n      if (_pendingPromise) {\r\n        _clearPendingTimer();\r\n        try { _pendingResolve?.(undefined); } catch (_) {}\r\n      }\r\n      _resetPendingState();\r\n      return;\r\n    }\r\n\r\n    // 记录最近一次 logger，用于真正执行时输出\r\n    if (logger) _lastLogger = logger;\r\n\r\n    const delay = DEFAULT_SAVE_DEBOUNCE_MS;\r\n\r\n    // 若已有定时器，则刷新触发时间\r\n    _clearPendingTimer();\r\n\r\n    // 复用一个 pending Promise，使多次快速调用拿到同一个结果\r\n    if (!_pendingPromise) {\r\n      _pendingPromise = new Promise((resolve, reject) => {\r\n        _pendingResolve = resolve;\r\n        _pendingReject = reject;\r\n      });\r\n    }\r\n\r\n    _saveTimer = setTimeout(() => {\r\n      _saveTimer = null;\r\n      // 取最新 mediaId 与 logger 执行\r\n      const currentLogger = _lastLogger || logger;\r\n      const mediaId = g.getMediaId?.();\r\n      try {\r\n        const ret = updateDanmakuSettings(currentLogger, mediaId);\r\n        if (ret && typeof ret.then === 'function') {\r\n          ret.then(val => {\r\n            _pendingResolve?.(val);\r\n            _resetPendingState();\r\n          }).catch(err => {\r\n            currentLogger?.warn?.('保存设置失败', err);\r\n            _pendingReject?.(err);\r\n            _resetPendingState();\r\n          });\r\n        } else {\r\n          _pendingResolve?.(ret);\r\n          _resetPendingState();\r\n        }\r\n      } catch (err) {\r\n        currentLogger?.warn?.('保存设置失败', err);\r\n        _pendingReject?.(err);\r\n        _resetPendingState();\r\n      }\r\n    }, delay);\r\n\r\n    return _pendingPromise;\r\n  } catch (err) {\r\n    logger?.warn?.('保存设置失败', err);\r\n  }\r\n}\r\n","// 基础设置分页：提供基础弹幕相关可视化与行为调节\r\nimport { saveIfAutoOn } from \"../../api/utils\";\r\n\r\nexport class BasicSettingsPage {\r\n  constructor(opts = {}) { this.logger = opts.logger || null; }\r\n  getKey() { return 'basic'; }\r\n  getLabel() { return '基础设置'; }\r\n\r\n  _createFontSizeRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    const current = settings?.get?.('font_size') ?? 25;\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'font_size');\r\n    row.setAttribute('data-type', 'number');\r\n\r\n    const labelLine = document.createElement('div');\r\n    labelLine.className = 'danmaku-setting-row__label';\r\n    const labelSpan = document.createElement('span');\r\n    labelSpan.className = 'danmaku-setting-row__labelText';\r\n    labelSpan.textContent = '字体大小 (px)';\r\n    labelLine.appendChild(labelSpan);\r\n\r\n    row.appendChild(labelLine);\r\n\r\n    const sliderWrap = document.createElement('div');\r\n    sliderWrap.style.display = 'flex';\r\n    sliderWrap.style.alignItems = 'center';\r\n    sliderWrap.style.gap = '8px';\r\n\r\n    const range = document.createElement('input');\r\n    range.type = 'range';\r\n    range.min = '8';\r\n    range.max = '80';\r\n    range.step = '1';\r\n    range.value = String(current);\r\n    range.style.flex = '1 1 auto';\r\n\r\n    const numberInput = document.createElement('input');\r\n    numberInput.type = 'number';\r\n    numberInput.min = '8';\r\n    numberInput.max = '80';\r\n    numberInput.step = '1';\r\n    numberInput.value = String(current);\r\n    numberInput.className = 'danmaku-setting-input';\r\n    numberInput.style.width = '70px';\r\n\r\n    const applyValue = (v, src) => {\r\n      let nv = parseInt(v, 10);\r\n      if (isNaN(nv)) return;\r\n      if (nv < 8) nv = 8; else if (nv > 80) nv = 80;\r\n      range.value = String(nv);\r\n      numberInput.value = String(nv);\r\n      try {\r\n        const liveSettings = window.__jfDanmakuGlobal__.danmakuSettings;\r\n        liveSettings?.set?.('font_size', nv);\r\n        saveIfAutoOn(this.logger);\r\n      } catch (_) { }\r\n      this.logger?.info?.('[BasicSettings] font_size ->', nv, '(from', src, ')');\r\n    };\r\n\r\n    range.addEventListener('input', () => applyValue(range.value, 'range'));\r\n    numberInput.addEventListener('input', () => applyValue(numberInput.value, 'number'));\r\n    numberInput.addEventListener('change', () => applyValue(numberInput.value, 'number-change'));\r\n\r\n    sliderWrap.appendChild(range);\r\n    sliderWrap.appendChild(numberInput);\r\n    row.appendChild(sliderWrap);\r\n\r\n    const desc = document.createElement('div');\r\n    desc.className = 'danmaku-setting-row__desc';\r\n    // desc.textContent = '调整弹幕基础字号 (8 - 80px)。';\r\n    row.appendChild(desc);\r\n\r\n    return row;\r\n  }\r\n\r\n  _createOpacityRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    const current = settings?.get?.('opacity') ?? 70; // 0-100\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'opacity');\r\n    row.setAttribute('data-type', 'number');\r\n\r\n    const labelLine = document.createElement('div');\r\n    labelLine.className = 'danmaku-setting-row__label';\r\n    const labelSpan = document.createElement('span');\r\n    labelSpan.className = 'danmaku-setting-row__labelText';\r\n    labelSpan.textContent = '弹幕透明度 (%)';\r\n    labelLine.appendChild(labelSpan);\r\n    row.appendChild(labelLine);\r\n\r\n    const sliderWrap = document.createElement('div');\r\n    sliderWrap.style.display = 'flex';\r\n    sliderWrap.style.alignItems = 'center';\r\n    sliderWrap.style.gap = '8px';\r\n    const range = document.createElement('input');\r\n    range.type = 'range'; range.min = '0'; range.max = '100'; range.step = '1';\r\n    range.value = String(current);\r\n    range.style.flex = '1 1 auto';\r\n    const numberInput = document.createElement('input');\r\n    numberInput.type = 'number'; numberInput.min = '0'; numberInput.max = '100'; numberInput.step = '1';\r\n    numberInput.value = String(current); numberInput.className = 'danmaku-setting-input'; numberInput.style.width = '70px';\r\n\r\n    const applyValue = (v, src) => {\r\n      let nv = parseInt(v, 10);\r\n      if (isNaN(nv)) return; if (nv < 0) nv = 0; else if (nv > 100) nv = 100;\r\n      range.value = String(nv); numberInput.value = String(nv);\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('opacity', nv);\r\n        // 更新实时弹幕层透明度（如果存在）\r\n        const layer = document.querySelector('#danmaku-layer');\r\n        if (layer) layer.style.opacity = String(Math.min(1, Math.max(0, nv / 100)));\r\n        saveIfAutoOn(this.logger);\r\n      } catch (_) { }\r\n      this.logger?.info?.('[BasicSettings] opacity ->', nv, '(from', src, ')');\r\n    };\r\n    range.addEventListener('input', () => applyValue(range.value, 'range'));\r\n    numberInput.addEventListener('input', () => applyValue(numberInput.value, 'number'));\r\n    numberInput.addEventListener('change', () => applyValue(numberInput.value, 'number-change'));\r\n    sliderWrap.appendChild(range); sliderWrap.appendChild(numberInput); row.appendChild(sliderWrap);\r\n    const desc = document.createElement('div');\r\n    desc.className = 'danmaku-setting-row__desc';\r\n    // desc.textContent = '调节弹幕整体透明度 (0-100)。';\r\n    row.appendChild(desc);\r\n    return row;\r\n  }\r\n\r\n  _createSpeedRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    const current = settings?.get?.('speed') ?? 144; // 24-600\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'speed');\r\n    row.setAttribute('data-type', 'number');\r\n    const labelLine = document.createElement('div');\r\n    labelLine.className = 'danmaku-setting-row__label';\r\n    const labelSpan = document.createElement('span');\r\n    labelSpan.className = 'danmaku-setting-row__labelText';\r\n    labelSpan.textContent = '弹幕速度';\r\n    labelLine.appendChild(labelSpan);\r\n\r\n    row.appendChild(labelLine);\r\n    const sliderWrap = document.createElement('div'); sliderWrap.style.display = 'flex'; sliderWrap.style.alignItems = 'center'; sliderWrap.style.gap = '8px';\r\n    const range = document.createElement('input'); range.type = 'range'; range.min = '24'; range.max = '600'; range.step = '1'; range.value = String(current); range.style.flex = '1 1 auto';\r\n    const numberInput = document.createElement('input'); numberInput.type = 'number'; numberInput.min = '24'; numberInput.max = '600'; numberInput.step = '1'; numberInput.value = String(current); numberInput.className = 'danmaku-setting-input'; numberInput.style.width = '70px';\r\n    const applyValue = (v, src) => {\r\n      let nv = parseInt(v, 10); if (isNaN(nv)) return; if (nv < 24) nv = 24; else if (nv > 600) nv = 600;\r\n      range.value = String(nv); numberInput.value = String(nv);\r\n      try {\r\n        const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n        const liveSettings = g.danmakuSettings;\r\n        liveSettings?.set?.('speed', nv);\r\n        // 直接写实例的 speed 属性\r\n        try { g.danmakuRenderer.speed = nv; } catch (_) { }\r\n\r\n        saveIfAutoOn(this.logger);\r\n      } catch (_) { }\r\n      this.logger?.info?.('[BasicSettings] speed ->', nv, '(from', src, ')');\r\n    };\r\n    range.addEventListener('input', () => applyValue(range.value, 'range'));\r\n    numberInput.addEventListener('input', () => applyValue(numberInput.value, 'number'));\r\n    numberInput.addEventListener('change', () => applyValue(numberInput.value, 'number-change'));\r\n    sliderWrap.appendChild(range); sliderWrap.appendChild(numberInput); row.appendChild(sliderWrap);\r\n    // const desc = document.createElement('div'); desc.className = 'danmaku-setting-row__desc'; desc.textContent = '调节弹幕滚动速度 (24 - 600)。数值越大，移动越快。'; row.appendChild(desc);\r\n    const desc = document.createElement('div'); desc.className = 'danmaku-setting-row__desc'; row.appendChild(desc);\r\n    return row;\r\n  }\r\n\r\n  _createFontFamilyRow() {\r\n  const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n  let current = settings?.get?.('font_family') || 'sans-serif';\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'font_family');\r\n    row.setAttribute('data-type', 'string');\r\n    // 确保只注入一次针对字体选择控件的样式\r\n    try {\r\n      if (!document.getElementById('danmaku-fontfamily-style')) {\r\n        const styleEl = document.createElement('style');\r\n        styleEl.id = 'danmaku-fontfamily-style';\r\n        styleEl.textContent = `\r\n/* Font Family combo input + list */\r\n.danmaku-setting-row[data-key=\"font_family\"] .ff-combo { position: relative; width: 100%; }\r\n.danmaku-setting-row[data-key=\"font_family\"] .ff-input {\r\n  width: 100%; background-color: rgba(30,30,30,.92); color: #fff;\r\n  border: 1px solid rgba(255,255,255,.28); border-radius: 4px; outline: none;\r\n  padding: 6px 8px; font-size: 12px;\r\n}\r\n.danmaku-setting-row[data-key=\"font_family\"] .ff-input:focus { box-shadow: 0 0 0 2px rgba(255,255,255,.15); }\r\n.danmaku-setting-row[data-key=\"font_family\"] .ff-list {\r\n  position: absolute; left: 0; right: 0; top: calc(100% + 6px);\r\n  max-height: 220px; overflow: auto; background: #1e1e1e; color: #fff;\r\n  border: 1px solid rgba(255,255,255,.28); border-radius: 6px; padding: 4px 0; z-index: 9999;\r\n  display: none;\r\n}\r\n.danmaku-setting-row[data-key=\"font_family\"] .ff-item {\r\n  padding: 6px 10px; font-size: 12px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;\r\n}\r\n.danmaku-setting-row[data-key=\"font_family\"] .ff-item:hover,\r\n.danmaku-setting-row[data-key=\"font_family\"] .ff-item.active { background: rgba(255,255,255,.12); }\r\n`;\r\n        document.head.appendChild(styleEl);\r\n      }\r\n    } catch (_) { }\r\n    const labelLine = document.createElement('div');\r\n    labelLine.className = 'danmaku-setting-row__label';\r\n    const labelSpan = document.createElement('span'); labelSpan.className = 'danmaku-setting-row__labelText'; labelSpan.textContent = '字体';\r\n    labelLine.appendChild(labelSpan);\r\n    row.appendChild(labelLine);\r\n    // 组合控件：输入框 + 过滤列表\r\n  const combo = document.createElement('div');\r\n    combo.className = 'ff-combo';\r\n  const input = document.createElement('input');\r\n  input.className = 'ff-input danmaku-setting-input';\r\n  input.type = 'text';\r\n  const genericPlaceholder = '输入以筛选字体...';\r\n  input.placeholder = genericPlaceholder;\r\n    const list = document.createElement('div');\r\n    list.className = 'ff-list';\r\n    combo.appendChild(input);\r\n    combo.appendChild(list);\r\n\r\n    let allFonts = [];\r\n    let filtered = [];\r\n    let activeIndex = -1;\r\n    const labelFor = (f) => {\r\n      if (typeof f === 'string' && f.indexOf('/danmaku/font/') === 0) {\r\n        const last = (f.split('/').pop() || f).split('?')[0];\r\n        let decoded = last;\r\n        try { decoded = decodeURIComponent(last); } catch (_) { /* ignore */ }\r\n        return `服务器字体: ${decoded}`;\r\n      }\r\n      return f;\r\n    };\r\n    const openList = () => { list.style.display = 'block'; };\r\n    const closeList = () => { list.style.display = 'none'; activeIndex = -1; };\r\n    const renderList = () => {\r\n      list.innerHTML = '';\r\n      filtered.forEach((f, idx) => {\r\n        const it = document.createElement('div');\r\n        it.className = 'ff-item' + (idx === activeIndex ? ' active' : '');\r\n        it.textContent = labelFor(f);\r\n        it.dataset.val = f;\r\n        it.addEventListener('mousedown', (e) => { e.preventDefault(); selectFont(f); });\r\n        list.appendChild(it);\r\n      });\r\n      // 仅在输入框处于聚焦状态时才展开，避免首次加载默认展开\r\n      if (filtered.length && document.activeElement === input) openList(); else closeList();\r\n      // 尝试滚动到当前激活项\r\n      if (activeIndex >= 0 && list.children[activeIndex]) {\r\n        try { list.children[activeIndex].scrollIntoView({ block: 'nearest' }); } catch (_) {}\r\n      }\r\n    };\r\n    const setFilter = (kw) => {\r\n      const q = (kw || '').toLowerCase();\r\n      filtered = allFonts.filter(f => (f || '').toLowerCase().includes(q));\r\n      // 优先把当前值放到顶部（保持存在感）\r\n      if (current && filtered.indexOf(current) > 0) filtered = [current].concat(filtered.filter(x => x !== current));\r\n      // 激活项尽量定位到当前值\r\n      activeIndex = filtered.length ? (Math.max(0, filtered.indexOf(current))) : -1;\r\n      renderList();\r\n    };\r\n    const selectFont = (val) => {\r\n      if (!val) return;\r\n      // 更新设置并失焦\r\n      applyValue(val);\r\n      current = val;\r\n  input.value = '';\r\n  input.placeholder = labelFor(val);\r\n      closeList();\r\n      try { input.blur(); } catch (_) {}\r\n    };\r\n    // 动态收集字体函数 -> 更新 allFonts\r\n    const populateFonts = (fontList) => {\r\n      const gset = new Set();\r\n      fontList.forEach(f => { if (f) gset.add(f); });\r\n      ['sans-serif', 'serif', 'monospace', 'system-ui'].forEach(f => gset.add(f));\r\n      allFonts = Array.from(gset).sort((a, b) => a.localeCompare(b, 'zh-Hans-CN'));\r\n      if (current && !allFonts.includes(current)) allFonts.unshift(current);\r\n  // 初始以占位符展示当前字体（虚化）\r\n  input.value = '';\r\n  input.placeholder = labelFor(current);\r\n  setFilter('');\r\n    };\r\n\r\n    const detectViaLocalFontAccess = async () => {\r\n      const fams = new Set();\r\n      try {\r\n        // 需权限，可能抛错\r\n        if (navigator.fonts?.query) {\r\n          // for await 迭代\r\n          // 部分浏览器要求 https + 用户手势，失败即回退\r\n          // eslint-disable-next-line no-restricted-syntax\r\n          for await (const meta of navigator.fonts.query()) {\r\n            if (meta.family) fams.add(meta.family);\r\n          }\r\n        }\r\n      } catch (_) { /* 忽略 */ }\r\n      return Array.from(fams);\r\n    };\r\n\r\n    const detectViaCanvas = () => {\r\n      // 由于浏览器隐私限制无法真正枚举，只能用候选池测试是否存在\r\n      const candidatePool = [\r\n        'Arial', 'Helvetica', 'Segoe UI', 'Roboto', 'PingFang SC', 'Microsoft YaHei', 'Noto Sans CJK SC', 'SimHei', 'SimSun', 'KaiTi', 'FangSong', 'Courier New', 'Consolas', 'Menlo', 'Monaco', 'Ubuntu', 'Ubuntu Mono', 'Tahoma', 'Verdana', 'Georgia', 'Times New Roman'\r\n      ];\r\n      const baseFonts = ['monospace', 'serif', 'sans-serif'];\r\n      const testString = 'mmmmmmmmmwwwwwwwiiiilllOO0测试字样ABC123';\r\n      const size = '72px';\r\n      const span = document.createElement('span');\r\n      span.style.position = 'absolute'; span.style.left = '-9999px'; span.style.fontSize = size; span.textContent = testString;\r\n      document.body.appendChild(span);\r\n      const baseMetrics = {};\r\n      baseFonts.forEach(bf => { span.style.fontFamily = bf; baseMetrics[bf] = { w: span.offsetWidth, h: span.offsetHeight }; });\r\n      const available = [];\r\n      candidatePool.forEach(font => {\r\n        let detected = false;\r\n        for (const bf of baseFonts) {\r\n          span.style.fontFamily = `'${font}',${bf}`;\r\n          const w = span.offsetWidth, h = span.offsetHeight;\r\n          if (w !== baseMetrics[bf].w || h !== baseMetrics[bf].h) { detected = true; break; }\r\n        }\r\n        if (detected) available.push(font);\r\n      });\r\n      document.body.removeChild(span);\r\n      return available;\r\n    };\r\n\r\n    const detectViaServerFonts = async () => {\r\n      try {\r\n        if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) return [];\r\n        const url = ApiClient.getUrl('danmaku/font/get_all');\r\n        const res = await ApiClient.ajax({ type: 'GET', url, dataType: 'json' });\r\n        if (!Array.isArray(res)) return [];\r\n        // 返回 URL 路径（保持与渲染器协议一致）\r\n        return res.map(x => x && typeof x.url === 'string' ? x.url : null).filter(Boolean);\r\n      } catch (_) { return []; }\r\n    };\r\n\r\n    const runDetection = async () => {\r\n      try {\r\n        const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n        if (Array.isArray(g.availableFontFamilies) && g.availableFontFamilies.length) {\r\n          populateFonts(g.availableFontFamilies);\r\n          return;\r\n        }\r\n        let fonts = await detectViaLocalFontAccess();\r\n        // 合并服务器字体\r\n        try {\r\n          const serverFonts = await detectViaServerFonts();\r\n          if (serverFonts && serverFonts.length) {\r\n            const merged = new Set([...(fonts || []), ...serverFonts]);\r\n            fonts = Array.from(merged);\r\n          }\r\n        } catch (_) {}\r\n        // 若 Local Font Access 得到过少结果，则回退 canvas 探测\r\n        if (!fonts || fonts.length < 5) {\r\n          const canvasFonts = detectViaCanvas();\r\n          const merged = new Set([...(fonts || []), ...canvasFonts]);\r\n          fonts = Array.from(merged);\r\n        }\r\n        g.availableFontFamilies = fonts;\r\n        populateFonts(fonts);\r\n      } catch (e) {\r\n        // 最终失败，使用最小集合\r\n        populateFonts([current || 'sans-serif']);\r\n      }\r\n    };\r\n    // 延迟微任务，等待元素插入再开始检测，减少阻塞\r\n    Promise.resolve().then(runDetection);\r\n    const applyValue = (nv) => {\r\n      try {\r\n        const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n        const liveSettings = g.danmakuSettings;\r\n        liveSettings?.set?.('font_family', nv);\r\n        // 如果选择的是服务器字体 URL，则预加载并用加载完成的家族名；否则直接应用\r\n        const applyFam = (famName) => {\r\n          const targetFam = famName ? `'${famName}', sans-serif` : nv;\r\n          const layer = document.querySelector('#danmaku-layer');\r\n          if (layer) layer.style.fontFamily = targetFam;\r\n          if (g.danmakuRenderer?.container) {\r\n            try { g.danmakuRenderer.container.style.fontFamily = targetFam; } catch (_) { }\r\n          }\r\n        };\r\n\r\n        if (typeof nv === 'string' && nv.indexOf('/danmaku/font/') === 0) {\r\n          // 使用渲染器暴露的加载器（若存在）\r\n          const loader = g.ensureRemoteFontLoaded || (g.danmakuRenderer && g.danmakuRenderer.ensureRemoteFontLoaded);\r\n          if (typeof loader === 'function') {\r\n            loader(nv).then(fam => {\r\n              applyFam(fam || null);\r\n            }).catch(() => applyFam(null));\r\n          } else {\r\n            // 尝试直接设置，浏览器会在未加载时自动回退\r\n            applyFam(null);\r\n          }\r\n        } else {\r\n          applyFam(null);\r\n        }\r\n        saveIfAutoOn(this.logger);\r\n      } catch (_) { }\r\n      this.logger?.info?.('[BasicSettings] font_family ->', nv);\r\n    };\r\n    // 交互：输入即筛选；上下箭头/回车选择；失焦隐藏\r\n    input.addEventListener('input', () => setFilter(input.value));\r\n    input.addEventListener('focus', () => {\r\n      // 聚焦时：如果当前输入为空，显示通用提示占位符\r\n      if (!input.value) input.placeholder = genericPlaceholder;\r\n      // 聚焦清空输入，打开并高亮当前项\r\n      input.value = '';\r\n      setFilter('');\r\n      openList();\r\n    });\r\n    input.addEventListener('blur', () => {\r\n      // 失焦：恢复为当前已选字体的占位符\r\n      input.placeholder = labelFor(current);\r\n    });\r\n    input.addEventListener('keydown', (e) => {\r\n      if (list.style.display !== 'block') return;\r\n      if (e.key === 'ArrowDown') { activeIndex = Math.min(filtered.length - 1, activeIndex + 1); renderList(); e.preventDefault(); }\r\n      else if (e.key === 'ArrowUp') { activeIndex = Math.max(0, activeIndex - 1); renderList(); e.preventDefault(); }\r\n      else if (e.key === 'Enter') { if (activeIndex >= 0 && filtered[activeIndex]) { selectFont(filtered[activeIndex]); e.preventDefault(); } }\r\n      else if (e.key === 'Escape') { closeList(); }\r\n    });\r\n    document.addEventListener('click', (e) => { if (!combo.contains(e.target)) closeList(); });\r\n\r\n    row.appendChild(combo);\r\n    const desc = document.createElement('div'); desc.className = 'danmaku-setting-row__desc'; desc.textContent = '字体建议放在服务端的\"/config/fonts\"路径'; row.appendChild(desc);\r\n    return row;\r\n  }\r\n\r\n  _createHeatmapModeRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    const current = settings?.get?.('enable_heatmap') ?? 'combined'; // 'off' | 'combined' | 'original'\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'enable_heatmap');\r\n    row.setAttribute('data-type', 'enum');\r\n\r\n    const labelLine = document.createElement('div');\r\n    labelLine.className = 'danmaku-setting-row__label';\r\n    const labelSpan = document.createElement('span');\r\n    labelSpan.className = 'danmaku-setting-row__labelText';\r\n    labelSpan.textContent = '弹幕密度图';\r\n    labelLine.appendChild(labelSpan);\r\n    row.appendChild(labelLine);\r\n\r\n    const group = document.createElement('div');\r\n    group.style.display = 'flex';\r\n    group.style.width = '100%';\r\n    group.style.gap = '6px';\r\n    group.style.marginTop = '4px';\r\n\r\n    const options = [\r\n      { key: 'off', label: '关闭' },\r\n      { key: 'combined', label: '合并后' },\r\n      { key: 'original', label: '原始数据' }\r\n    ];\r\n\r\n    const applyValue = (val) => {\r\n      try {\r\n        const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n        const liveSettings = g.danmakuSettings || settings;\r\n        liveSettings?.set?.('enable_heatmap', val);\r\n        // 实时应用到热力图\r\n        try {\r\n          if (val === 'off') {\r\n            // 优先调用渲染器 hide；退化隐藏画布\r\n            if (g.heatmapRenderer && typeof g.heatmapRenderer.hide === 'function') {\r\n              g.heatmapRenderer.hide();\r\n            } else {\r\n              const c = document.getElementById('danmaku-heatmap-canvas');\r\n              if (c) c.style.display = 'none';\r\n            }\r\n          } else {\r\n            // 显示或按需生成\r\n            let shown = false;\r\n            if (g.heatmapRenderer && typeof g.heatmapRenderer.show === 'function') {\r\n              g.heatmapRenderer.show();\r\n              shown = true;\r\n            }\r\n            const canvas = document.getElementById('danmaku-heatmap-canvas');\r\n            if (!shown && canvas) { canvas.style.display = 'block'; shown = true; }\r\n            if (!shown) {\r\n              // 尝试通过扩展实例生成（允许内部自愈）\r\n              try { g.getExt?.()?._generateHeatmap?.(); } catch (_) { }\r\n            }\r\n          }\r\n        } catch (_) { }\r\n        saveIfAutoOn(this.logger);\r\n      } catch (_) { }\r\n      this.logger?.info?.('[BasicSettings] enable_heatmap ->', val);\r\n    };\r\n\r\n    options.forEach(opt => {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.textContent = opt.label;\r\n      btn.dataset.val = opt.key;\r\n      btn.style.flex = '1 1 0';\r\n      btn.style.padding = '6px 4px';\r\n      btn.style.fontSize = '12px';\r\n      btn.style.lineHeight = '1.1';\r\n      btn.style.borderRadius = '6px';\r\n      btn.style.border = '1px solid rgba(255,255,255,.25)';\r\n      btn.style.background = 'rgba(255,255,255,.08)';\r\n      btn.style.color = '#fff';\r\n      btn.style.cursor = 'pointer';\r\n      btn.style.transition = 'background .15s, border-color .15s, box-shadow .15s';\r\n      const setActiveState = () => {\r\n        if (btn.dataset.val === String(currentVal)) {\r\n          btn.style.background = '#3fa9ff';\r\n          btn.style.borderColor = '#3fa9ff';\r\n          btn.style.boxShadow = '0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)';\r\n        } else {\r\n          btn.style.background = 'rgba(255,255,255,.08)';\r\n          btn.style.borderColor = 'rgba(255,255,255,.25)';\r\n          btn.style.boxShadow = 'none';\r\n        }\r\n      };\r\n      btn.addEventListener('mouseenter', () => { if (btn.dataset.val !== String(currentVal)) btn.style.background = 'rgba(255,255,255,.15)'; });\r\n      btn.addEventListener('mouseleave', () => setActiveState());\r\n      btn.addEventListener('click', () => {\r\n        if (currentVal === opt.key) return;\r\n        currentVal = opt.key;\r\n        applyValue(currentVal);\r\n        group.querySelectorAll('button').forEach(b => {\r\n          const v = b.dataset.val;\r\n          if (v === currentVal) {\r\n            b.style.background = '#3fa9ff';\r\n            b.style.borderColor = '#3fa9ff';\r\n            b.style.boxShadow = '0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)';\r\n          } else {\r\n            b.style.background = 'rgba(255,255,255,.08)';\r\n            b.style.borderColor = 'rgba(255,255,255,.25)';\r\n            b.style.boxShadow = 'none';\r\n          }\r\n        });\r\n      });\r\n      group.appendChild(btn);\r\n      setTimeout(setActiveState, 0);\r\n    });\r\n\r\n    let currentVal = String(current);\r\n    row.appendChild(group);\r\n    const desc = document.createElement('div');\r\n    desc.className = 'danmaku-setting-row__desc';\r\n    // desc.textContent = '选择是否显示弹幕密度图（热力图）。';\r\n    row.appendChild(desc);\r\n    return row;\r\n  }\r\n\r\n  _createDisplayRangeRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    const topInit = settings?.get?.('display_top_pct');\r\n    const bottomInit = settings?.get?.('display_bottom_pct');\r\n    // 初始值：确保为 0-100 整数\r\n    let topVal = (isFinite(topInit) ? Math.round(topInit) : 0);\r\n    let bottomVal = (isFinite(bottomInit) ? Math.round(bottomInit) : 100);\r\n    if (topVal < 0) topVal = 0; if (topVal > 99) topVal = 99;\r\n    if (bottomVal <= topVal) bottomVal = Math.min(100, topVal + 1);\r\n    if (bottomVal > 100) bottomVal = 100;\r\n\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'display_range');\r\n    row.setAttribute('data-type', 'range');\r\n\r\n    const labelLine = document.createElement('div');\r\n    labelLine.className = 'danmaku-setting-row__label';\r\n    const labelSpan = document.createElement('span'); labelSpan.className = 'danmaku-setting-row__labelText'; labelSpan.textContent = '显示范围 (垂直%)';\r\n    labelLine.appendChild(labelSpan);\r\n    row.appendChild(labelLine);\r\n\r\n    // 双拖动条容器\r\n    const wrapper = document.createElement('div');\r\n    wrapper.style.position = 'relative';\r\n    wrapper.style.height = '32px';\r\n    wrapper.style.display = 'flex';\r\n    wrapper.style.alignItems = 'center';\r\n    wrapper.style.userSelect = 'none';\r\n\r\n    const track = document.createElement('div');\r\n    track.style.position = 'absolute';\r\n    track.style.left = '0'; track.style.right = '0';\r\n    track.style.top = '50%'; track.style.height = '4px';\r\n    track.style.transform = 'translateY(-50%)';\r\n    track.style.background = 'linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.15))';\r\n    track.style.borderRadius = '2px';\r\n    wrapper.appendChild(track);\r\n\r\n    const activeRange = document.createElement('div');\r\n    activeRange.style.position = 'absolute'; activeRange.style.top = '50%'; activeRange.style.height = '6px'; activeRange.style.transform = 'translateY(-50%)';\r\n    activeRange.style.background = 'rgba(0,150,255,.6)'; activeRange.style.borderRadius = '3px';\r\n    wrapper.appendChild(activeRange);\r\n\r\n    function updateActiveRange() {\r\n      activeRange.style.left = topVal + '%';\r\n      activeRange.style.width = (bottomVal - topVal) + '%';\r\n    }\r\n    updateActiveRange();\r\n\r\n    const handleStyle = (el) => {\r\n      el.style.position = 'absolute';\r\n      el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)';\r\n      el.style.width = '14px'; el.style.height = '14px';\r\n      el.style.borderRadius = '50%'; el.style.cursor = 'pointer';\r\n      el.style.background = 'rgba(0,150,255,.9)';\r\n      el.style.border = '1px solid rgba(255,255,255,.6)';\r\n      el.style.boxShadow = '0 0 4px rgba(0,150,255,.7)';\r\n      el.style.transition = 'background .15s, box-shadow .15s';\r\n    };\r\n    const handleTop = document.createElement('div'); handleStyle(handleTop);\r\n    const handleBottom = document.createElement('div'); handleStyle(handleBottom);\r\n    wrapper.appendChild(handleTop); wrapper.appendChild(handleBottom);\r\n\r\n    function positionHandles() {\r\n      handleTop.style.left = topVal + '%';\r\n      handleBottom.style.left = bottomVal + '%';\r\n    }\r\n    positionHandles();\r\n\r\n    function applyToSettings(src) {\r\n      try {\r\n        const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n        const liveSettings = g.danmakuSettings || settings;\r\n        liveSettings?.set?.('display_top_pct', topVal);\r\n        liveSettings?.set?.('display_bottom_pct', bottomVal);\r\n        // 实时应用到 layer-inner\r\n        const inner = document.getElementById('danmaku-layer-inner');\r\n        if (inner && inner.parentElement) {\r\n          inner.style.top = topVal + '%';\r\n          inner.style.height = (bottomVal - topVal) + '%';\r\n        }\r\n        saveIfAutoOn(this.logger);\r\n      } catch (_) { }\r\n      this?.logger?.info?.('[BasicSettings] display_range ->', topVal, bottomVal, 'from', src);\r\n    }\r\n\r\n    function clamp() {\r\n      // 四舍五入并限制为整数\r\n      topVal = Math.round(topVal); bottomVal = Math.round(bottomVal);\r\n      if (topVal < 0) topVal = 0; if (topVal > 99) topVal = 99;\r\n      if (bottomVal <= topVal) bottomVal = Math.min(100, topVal + 1);\r\n      if (bottomVal > 100) bottomVal = 100;\r\n    }\r\n\r\n    let dragging = null; // 'top' | 'bottom'\r\n    const onPointerDown = (e, which) => {\r\n      dragging = which; e.preventDefault();\r\n      document.addEventListener('pointermove', onPointerMove);\r\n      document.addEventListener('pointerup', onPointerUp);\r\n    };\r\n    const onPointerMove = (e) => {\r\n      if (!dragging) return;\r\n      const rect = wrapper.getBoundingClientRect();\r\n      const pct = Math.round(((e.clientX - rect.left) / rect.width) * 100);\r\n      if (dragging === 'top') topVal = Math.min(bottomVal - 1, Math.max(0, pct));\r\n      else bottomVal = Math.max(topVal + 1, Math.min(100, pct));\r\n      clamp(); positionHandles(); updateActiveRange(); applyToSettings.call(selfRef, 'drag');\r\n    };\r\n    const onPointerUp = () => {\r\n      dragging = null;\r\n      document.removeEventListener('pointermove', onPointerMove);\r\n      document.removeEventListener('pointerup', onPointerUp);\r\n      applyToSettings.call(selfRef, 'release');\r\n    };\r\n    handleTop.addEventListener('pointerdown', e => onPointerDown(e, 'top'));\r\n    handleBottom.addEventListener('pointerdown', e => onPointerDown(e, 'bottom'));\r\n\r\n    // 点击轨道定位最近的手柄\r\n    // 点击整个 wrapper（除手柄本身）时，移动最近手柄并直接进入拖动状态\r\n    wrapper.addEventListener('pointerdown', e => {\r\n      if (e.target === handleTop || e.target === handleBottom) return; // 由各自 handler 处理\r\n      const rect = wrapper.getBoundingClientRect();\r\n      const pct = Math.round(((e.clientX - rect.left) / rect.width) * 100);\r\n      const distTop = Math.abs(pct - topVal);\r\n      const distBottom = Math.abs(pct - bottomVal);\r\n      if (distTop <= distBottom) {\r\n        topVal = Math.min(bottomVal - 1, Math.max(0, pct)); dragging = 'top';\r\n      } else {\r\n        bottomVal = Math.max(topVal + 1, Math.min(100, pct)); dragging = 'bottom';\r\n      }\r\n      clamp(); positionHandles(); updateActiveRange(); applyToSettings.call(selfRef, 'click-move');\r\n      // 进入拖动监听\r\n      document.addEventListener('pointermove', onPointerMove);\r\n      document.addEventListener('pointerup', onPointerUp);\r\n      e.preventDefault();\r\n    });\r\n\r\n    // 键盘支持（聚焦手柄后用左右键）\r\n    [handleTop, handleBottom].forEach((h, idx) => {\r\n      h.tabIndex = 0;\r\n      h.addEventListener('keydown', e => {\r\n        if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {\r\n          if (idx === 0) topVal = Math.max(0, topVal - 1); else bottomVal = Math.max(topVal + 1, bottomVal - 1);\r\n        } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {\r\n          if (idx === 0) topVal = Math.min(bottomVal - 1, topVal + 1); else bottomVal = Math.min(100, bottomVal + 1);\r\n        } else return;\r\n        clamp(); positionHandles(); updateActiveRange(); applyToSettings.call(selfRef, 'key');\r\n        e.preventDefault();\r\n      });\r\n    });\r\n\r\n    // activeRange 已在前面插入，无需重复追加\r\n    row.appendChild(wrapper);\r\n\r\n    const desc = document.createElement('div'); desc.className = 'danmaku-setting-row__desc'; desc.textContent = '限制弹幕垂直显示区域'; row.appendChild(desc);\r\n\r\n    const selfRef = this; // for call\r\n    return row;\r\n  }\r\n\r\n  _createChConvertRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    const current = settings?.get?.('chConvert') ?? '0'; // '0' 不转换, '1' 简体, '2' 繁体\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'chConvert');\r\n    row.setAttribute('data-type', 'enum');\r\n\r\n    const labelLine = document.createElement('div');\r\n    labelLine.className = 'danmaku-setting-row__label';\r\n    const labelSpan = document.createElement('span');\r\n    labelSpan.className = 'danmaku-setting-row__labelText';\r\n    labelSpan.textContent = '简繁转换';\r\n    labelLine.appendChild(labelSpan);\r\n    row.appendChild(labelLine);\r\n\r\n    const group = document.createElement('div');\r\n    group.style.display = 'flex';\r\n    group.style.width = '100%';\r\n    group.style.gap = '6px';\r\n    group.style.marginTop = '4px';\r\n\r\n    const options = [\r\n      { key: '0', label: '不转换' },\r\n      { key: '1', label: '简体' },\r\n      { key: '2', label: '繁体' }\r\n    ];\r\n\r\n    const applyValue = (val) => {\r\n      try {\r\n        const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n        const liveSettings = g.danmakuSettings || settings;\r\n        liveSettings?.set?.('chConvert', val);\r\n        saveIfAutoOn(this.logger);\r\n      } catch (_) { }\r\n      this.logger?.info?.('[BasicSettings] chConvert ->', val);\r\n    };\r\n\r\n    options.forEach(opt => {\r\n      const btn = document.createElement('button');\r\n      btn.type = 'button';\r\n      btn.textContent = opt.label;\r\n      btn.dataset.val = opt.key;\r\n      btn.style.flex = '1 1 0';\r\n      btn.style.padding = '6px 4px';\r\n      btn.style.fontSize = '12px';\r\n      btn.style.lineHeight = '1.1';\r\n      btn.style.borderRadius = '6px';\r\n      btn.style.border = '1px solid rgba(255,255,255,.25)';\r\n      btn.style.background = 'rgba(255,255,255,.08)';\r\n      btn.style.color = '#fff';\r\n      btn.style.cursor = 'pointer';\r\n      btn.style.transition = 'background .15s, border-color .15s, box-shadow .15s';\r\n      const setActiveState = () => {\r\n        if (btn.dataset.val === String(currentVal)) {\r\n          btn.style.background = '#3fa9ff';\r\n          btn.style.borderColor = '#3fa9ff';\r\n          btn.style.boxShadow = '0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)';\r\n        } else {\r\n          btn.style.background = 'rgba(255,255,255,.08)';\r\n          btn.style.borderColor = 'rgba(255,255,255,.25)';\r\n          btn.style.boxShadow = 'none';\r\n        }\r\n      };\r\n      btn.addEventListener('mouseenter', () => { if (btn.dataset.val !== String(currentVal)) btn.style.background = 'rgba(255,255,255,.15)'; });\r\n      btn.addEventListener('mouseleave', () => setActiveState());\r\n      btn.addEventListener('click', () => {\r\n        if (currentVal === opt.key) return;\r\n        currentVal = opt.key;\r\n        applyValue(currentVal);\r\n        group.querySelectorAll('button').forEach(b => {\r\n          const v = b.dataset.val;\r\n          if (v === currentVal) {\r\n            b.style.background = '#3fa9ff';\r\n            b.style.borderColor = '#3fa9ff';\r\n            b.style.boxShadow = '0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)';\r\n          } else {\r\n            b.style.background = 'rgba(255,255,255,.08)';\r\n            b.style.borderColor = 'rgba(255,255,255,.25)';\r\n            b.style.boxShadow = 'none';\r\n          }\r\n        });\r\n      });\r\n      group.appendChild(btn);\r\n      // 延迟设置激活样式在 currentVal 初始化之后\r\n      setTimeout(setActiveState, 0);\r\n    });\r\n\r\n    let currentVal = String(current);\r\n    row.appendChild(group);\r\n    const desc = document.createElement('div');\r\n    desc.className = 'danmaku-setting-row__desc';\r\n    // desc.textContent = '选择是否进行简繁体转换。';\r\n    row.appendChild(desc);\r\n    return row;\r\n  }\r\n\r\n  build() {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'danmaku-settings-tabPanel';\r\n    panel.dataset.key = this.getKey();\r\n\r\n    const list = document.createElement('div');\r\n    list.className = 'danmaku-settings-list';\r\n    list.appendChild(this._createFontSizeRow());\r\n    list.appendChild(this._createOpacityRow());\r\n    list.appendChild(this._createSpeedRow());\r\n    list.appendChild(this._createFontFamilyRow());\r\n    list.appendChild(this._createHeatmapModeRow());\r\n    list.appendChild(this._createChConvertRow());\r\n    list.appendChild(this._createDisplayRangeRow());\r\n    panel.appendChild(list);\r\n    return panel;\r\n  }\r\n}\r\n","import { saveIfAutoOn } from \"../../api/utils\";\r\n\r\n// 弹幕合并设置分页（逐步实现中）\r\nexport class CombinedSettingsPage {\r\n  constructor(opts = {}) { this.logger = opts.logger || null; }\r\n  getKey() { return 'combine'; }\r\n  getLabel() { return '弹幕合并'; }\r\n\r\n\r\n  _ensureCombineUpdate() {\r\n    try {\r\n      const p = saveIfAutoOn(this.logger);\r\n      if (p) p.then(() => this._updateCombineStats());\r\n    } catch (_) { }\r\n  }\r\n\r\n  _updateCombineStats() {\r\n    try {\r\n      const data = window.__jfDanmakuGlobal__.danmakuData;\r\n      if (this._combineStatsEl) {\r\n        let original = data?.original_total;\r\n        let merged = data?.count;\r\n        if (merged == null && Array.isArray(data?.comments)) merged = data.comments.length;\r\n        if (original == null && typeof data?.raw_total === 'number') original = data.raw_total;\r\n        if (original == null && Array.isArray(data?.original_comments)) original = data.original_comments.length;\r\n        if (original == null && Array.isArray(data?.comments_before_merge)) original = data.comments_before_merge.length;\r\n        if (original == null && Array.isArray(data?.comments)) original = data.comments.length;\r\n        if (typeof original === 'number' && typeof merged === 'number') {\r\n          if (original !== merged) this._combineStatsEl.textContent = `${original} → ${merged}`;\r\n          else this._combineStatsEl.textContent = String(merged);\r\n        } else if (merged != null) {\r\n          this._combineStatsEl.textContent = String(merged);\r\n        } else {\r\n          this._combineStatsEl.textContent = '--';\r\n        }\r\n      }\r\n      if (this._pakkuTimeEl) {\r\n        const rawTime = data?.pakku_time;\r\n        const displayTime = (rawTime === '' || rawTime == null) ? '--' : String(rawTime);\r\n        this._pakkuTimeEl.textContent = `合并耗时: ${displayTime}`;\r\n      }\r\n      if (this._removed_countStatsEl) {\r\n        const rawremoved_count = data?.removed_count;\r\n        const num = (rawremoved_count === '' || rawremoved_count == null) ? 0 : Number(rawremoved_count);\r\n        const display = Number.isFinite(num) ? num : 0;\r\n        this._removed_countStatsEl.textContent = `总击杀数: ${display}`;\r\n      }\r\n      if (this._pinyinStatsEl) {\r\n        const raw = data?.merge_counts?.pinyin;\r\n        // 兼容数字、数字字符串; 空/NaN/不可解析时显示0\r\n        const num = (raw === '' || raw == null) ? 0 : Number(raw);\r\n        const display = Number.isFinite(num) ? num : 0;\r\n        this.logger?.debug?.('[CombineSettings] 更新拼音击杀数', raw, '->', display);\r\n        this._pinyinStatsEl.textContent = `击杀数: ${display}`;\r\n      }\r\n      if (this._editDistanceStatsEl) {\r\n        const raw = data?.merge_counts?.edit_distance;\r\n        const num = (raw === '' || raw == null) ? 0 : Number(raw);\r\n        const display = Number.isFinite(num) ? num : 0;\r\n        this._editDistanceStatsEl.textContent = `击杀数: ${display}`;\r\n      }\r\n      if (this._vectorStatsEl) {\r\n        const raw = data?.merge_counts?.vector;\r\n        const num = (raw === '' || raw == null) ? 0 : Number(raw);\r\n        const display = Number.isFinite(num) ? num : 0;\r\n        this._vectorStatsEl.textContent = `击杀数: ${display}`;\r\n      }\r\n    } catch (_) {\r\n      if (this._combineStatsEl) this._combineStatsEl.textContent = '--';\r\n      if (this._pakkuTimeEl) this._pakkuTimeEl.textContent = '合并耗时: --';\r\n      if (this._removed_countStatsEl) this._removed_countStatsEl.textContent = '总击杀数: 0';\r\n      if (this._pinyinStatsEl) this._pinyinStatsEl.textContent = '击杀数: --';\r\n      if (this._editDistanceStatsEl) this._editDistanceStatsEl.textContent = '击杀数: 0';\r\n      if (this._vectorStatsEl) this._vectorStatsEl.textContent = '击杀数: 0';\r\n    }\r\n  }\r\n\r\n  // 合并耗时展示行（无设置，仅展示 & 点击刷新统计）\r\n  _createCombineTimeRow() {\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'combine_time');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n    row.style.cursor = 'pointer';\r\n\r\n    const label = document.createElement('span');\r\n    label.style.fontSize = '14px';\r\n    label.style.fontWeight = '500';\r\n    label.style.userSelect = 'none';\r\n    this._pakkuTimeEl = label;\r\n    label.textContent = '合并耗时: --';\r\n\r\n    const removed_count = document.createElement('span');\r\n    // 与其它“击杀数”统计统一样式\r\n    removed_count.style.fontSize = '14px';\r\n    removed_count.style.fontWeight = '500';\r\n    removed_count.style.userSelect = 'none';\r\n    this._removed_countStatsEl = removed_count;\r\n    removed_count.textContent = '总击杀数: 0';\r\n\r\n    row.appendChild(label);\r\n    row.appendChild(removed_count);\r\n    row.addEventListener('click', () => this._updateCombineStats());\r\n    setTimeout(() => this._updateCombineStats(), 0);\r\n    return row;\r\n  }\r\n\r\n  // 显示合并标记：enable_mark (boolean)\r\n  // 已移除：显示合并标记（enable_mark）\r\n\r\n  // 标记样式：mark_style (string via <select>)\r\n  _createMarkStyleRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = settings?.get?.('mark_style');\r\n    if (typeof current !== 'string') current = 'default';\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'mark_style');\r\n    row.setAttribute('data-type', 'select');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '标记样式';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.userSelect = 'none';\r\n\r\n    // 注入深色下拉样式\r\n    try {\r\n      if (!document.getElementById('danmaku-markstyle-style')) {\r\n        const styleEl = document.createElement('style');\r\n        styleEl.id = 'danmaku-markstyle-style';\r\n        styleEl.textContent = `\r\n.danmaku-setting-row[data-key=\"mark_style\"] select.danmaku-setting-input {\r\n  background-color: rgba(30,30,30,.92) !important;\r\n  color: #ffffff !important;\r\n  border: 1px solid rgba(255,255,255,.28) !important;\r\n  border-radius: 4px !important;\r\n  outline: none !important;\r\n}\r\n.danmaku-setting-row[data-key=\"mark_style\"] select.danmaku-setting-input:focus {\r\n  box-shadow: 0 0 0 2px rgba(255,255,255,.15);\r\n}\r\n.danmaku-setting-row[data-key=\"mark_style\"] select.danmaku-setting-input option {\r\n  background-color: #1e1e1e;\r\n  color: #fff;\r\n}\r\n@media (prefers-color-scheme: dark) {\r\n  .danmaku-setting-row[data-key=\"mark_style\"] select.danmaku-setting-input option { background-color:#222; }\r\n}\r\n`; document.head.appendChild(styleEl);\r\n      }\r\n    } catch (_) { }\r\n\r\n    const select = document.createElement('select');\r\n    select.className = 'danmaku-setting-input';\r\n    select.style.width = '140px';\r\n    // 强制覆盖（与字体族一致）\r\n    select.style.setProperty('background-color', 'rgba(30,30,30,.92)', 'important');\r\n    select.style.setProperty('color', '#ffffff', 'important');\r\n    select.style.setProperty('border', '1px solid rgba(255,255,255,.28)', 'important');\r\n    select.style.borderRadius = '4px';\r\n    select.style.padding = '4px 6px';\r\n    select.style.fontSize = '12px';\r\n    select.style.cursor = 'pointer';\r\n    select.style.appearance = 'none';\r\n    select.style.webkitAppearance = 'none';\r\n    select.style.mozAppearance = 'none';\r\n\r\n    const options = [\r\n      { value: 'off', label: '关闭' },\r\n      { value: 'sub_low', label: '小写下标' },\r\n      { value: 'sub_pre', label: '前置下标' },\r\n      { value: 'multiply', label: '乘号' },\r\n    ];\r\n    for (const opt of options) {\r\n      const o = document.createElement('option');\r\n      o.value = opt.value;\r\n      o.textContent = opt.label;\r\n      if (opt.value === current) o.selected = true;\r\n      select.appendChild(o);\r\n    }\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      current = String(val || '');\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('mark_style', current);\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] mark_style ->', current, 'from', src);\r\n    };\r\n\r\n    select.addEventListener('change', () => applyValue(select.value, 'change'));\r\n    row.addEventListener('click', (e) => { if (select.contains(e.target)) return; select.focus(); });\r\n\r\n    row.appendChild(title);\r\n    row.appendChild(select);\r\n    return row;\r\n  }\r\n\r\n  // 显示标记阈值：mark_threshold (1-20) 滑块\r\n  _createMarkThresholdRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = settings?.get?.('mark_threshold');\r\n    if (typeof current !== 'number' || !Number.isFinite(current)) current = 1;\r\n    if (current < 1) current = 1; else if (current > 20) current = 20;\r\n\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'mark_threshold');\r\n    row.setAttribute('data-type', 'range');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '显示标记阈值';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.userSelect = 'none';\r\n\r\n    const slider = document.createElement('input');\r\n    slider.type = 'range';\r\n    slider.min = '1';\r\n    slider.max = '20';\r\n    slider.step = '1';\r\n    slider.value = String(current);\r\n    slider.style.width = '140px';\r\n    slider.style.cursor = 'pointer';\r\n    slider.style.accentColor = '#3fa9ff';\r\n\r\n    const valSpan = document.createElement('span');\r\n    valSpan.textContent = String(current);\r\n    valSpan.style.minWidth = '0';\r\n    valSpan.style.textAlign = 'center';\r\n    valSpan.style.fontSize = '12px';\r\n    valSpan.style.opacity = '.85';\r\n    valSpan.style.whiteSpace = 'nowrap';\r\n    valSpan.style.overflow = 'hidden';\r\n    valSpan.style.textOverflow = 'clip';\r\n    valSpan.style.flex = '0 0 auto';\r\n    valSpan.style.width = '140px';\r\n\r\n    const sliderLine = document.createElement('div');\r\n    sliderLine.style.display = 'flex';\r\n    sliderLine.style.flexDirection = 'column';\r\n    sliderLine.style.alignItems = 'center';\r\n    sliderLine.style.gap = '4px';\r\n    sliderLine.style.width = '100%';\r\n    sliderLine.style.maxWidth = '190px';\r\n    sliderLine.appendChild(valSpan);\r\n    sliderLine.appendChild(slider);\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      let n = parseInt(val, 10);\r\n      if (!Number.isFinite(n)) n = 1;\r\n      if (n < 1) n = 1; else if (n > 20) n = 20;\r\n      current = n;\r\n      slider.value = String(n);\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('mark_threshold', n);\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] mark_threshold ->', current, 'from', src);\r\n    };\r\n\r\n    slider.addEventListener('input', () => { applyValue(slider.value, 'input'); valSpan.textContent = slider.value; });\r\n    slider.addEventListener('change', () => { applyValue(slider.value, 'change'); valSpan.textContent = slider.value; });\r\n    row.addEventListener('click', () => slider.focus());\r\n\r\n    row.appendChild(title);\r\n    row.appendChild(sliderLine);\r\n    return row;\r\n  }\r\n\r\n  _createUsePinyinRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = !!settings?.get?.('use_pinyin');\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'use_pinyin');\r\n    row.setAttribute('data-type', 'boolean');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const btn = document.createElement('button');\r\n    btn.type = 'button';\r\n    btn.setAttribute('role', 'switch');\r\n    btn.setAttribute('aria-checked', String(current));\r\n    btn.style.position = 'relative';\r\n    btn.style.width = '48px';\r\n    btn.style.height = '22px';\r\n    btn.style.borderRadius = '22px';\r\n    btn.style.border = '1px solid rgba(255,255,255,.3)';\r\n    btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.transition = 'background .2s, box-shadow .2s';\r\n    btn.style.outline = 'none';\r\n    btn.style.padding = '0';\r\n    btn.style.marginTop = '6px';\r\n\r\n    const knob = document.createElement('span');\r\n    knob.style.position = 'absolute';\r\n    knob.style.top = '50%';\r\n    knob.style.transform = 'translateY(-50%)';\r\n    knob.style.left = current ? '26px' : '4px';\r\n    knob.style.width = '16px';\r\n    knob.style.height = '16px';\r\n    knob.style.borderRadius = '50%';\r\n    knob.style.background = '#fff';\r\n    knob.style.boxShadow = '0 2px 4px rgba(0,0,0,.4)';\r\n    knob.style.transition = 'left .2s';\r\n    btn.appendChild(knob);\r\n\r\n    const leftWrap = document.createElement('div');\r\n    leftWrap.style.display = 'flex';\r\n    leftWrap.style.flexDirection = 'column';\r\n    leftWrap.style.alignItems = 'center';\r\n    leftWrap.style.flex = '0 0 auto';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '拼音相似度匹配';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.marginBottom = '4px';\r\n    title.style.userSelect = 'none';\r\n    leftWrap.appendChild(title);\r\n    leftWrap.appendChild(btn);\r\n\r\n    // 右侧统计\r\n    const stats = document.createElement('span');\r\n    stats.style.fontSize = '14px';\r\n    stats.style.fontWeight = '500';\r\n    stats.style.whiteSpace = 'nowrap';\r\n    stats.style.flex = '0 0 auto';\r\n    stats.style.maxWidth = '180px';\r\n    stats.style.overflow = 'hidden';\r\n    stats.style.textOverflow = 'ellipsis';\r\n    stats.style.textAlign = 'center';\r\n    this._pinyinStatsEl = stats;\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      current = !!val;\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('use_pinyin', current);\r\n        btn.setAttribute('aria-checked', String(current));\r\n        btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n        knob.style.left = current ? '26px' : '4px';\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] use_pinyin ->', current, 'from', src);\r\n    };\r\n\r\n    // 行级点击（排除点击开关自身避免双触发）\r\n    row.addEventListener('click', (e) => { if (btn.contains(e.target)) return; applyValue(!current, 'row'); });\r\n    btn.addEventListener('click', () => applyValue(!current, 'click'));\r\n    btn.addEventListener('keydown', e => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); applyValue(!current, 'key'); } });\r\n\r\n    row.appendChild(leftWrap);\r\n    row.appendChild(stats);\r\n    setTimeout(() => this._updateCombineStats(), 0);\r\n    return row;\r\n  }\r\n\r\n  // 放大合并弹幕：enlarge (boolean)\r\n  _createEnlargeRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = !!settings?.get?.('enlarge');\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'enlarge');\r\n    row.setAttribute('data-type', 'boolean');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const btn = document.createElement('button');\r\n    btn.type = 'button';\r\n    btn.setAttribute('role', 'switch');\r\n    btn.setAttribute('aria-checked', String(current));\r\n    btn.style.position = 'relative';\r\n    btn.style.width = '48px';\r\n    btn.style.height = '22px';\r\n    btn.style.borderRadius = '22px';\r\n    btn.style.border = '1px solid rgba(255,255,255,.3)';\r\n    btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.transition = 'background .2s, box-shadow .2s';\r\n    btn.style.outline = 'none';\r\n    btn.style.padding = '0';\r\n    btn.style.marginTop = '6px';\r\n\r\n    const knob = document.createElement('span');\r\n    knob.style.position = 'absolute';\r\n    knob.style.top = '50%';\r\n    knob.style.transform = 'translateY(-50%)';\r\n    knob.style.left = current ? '26px' : '4px';\r\n    knob.style.width = '16px';\r\n    knob.style.height = '16px';\r\n    knob.style.borderRadius = '50%';\r\n    knob.style.background = '#fff';\r\n    knob.style.boxShadow = '0 2px 4px rgba(0,0,0,.4)';\r\n    knob.style.transition = 'left .2s';\r\n    btn.appendChild(knob);\r\n\r\n    const leftWrap = document.createElement('div');\r\n    leftWrap.style.display = 'flex';\r\n    leftWrap.style.flexDirection = 'column';\r\n    leftWrap.style.alignItems = 'center';\r\n    leftWrap.style.flex = '0 0 auto';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '放大合并弹幕';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.marginBottom = '4px';\r\n    title.style.userSelect = 'none';\r\n    leftWrap.appendChild(title);\r\n    leftWrap.appendChild(btn);\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      current = !!val;\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('enlarge', current);\r\n        btn.setAttribute('aria-checked', String(current));\r\n        btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n        knob.style.left = current ? '26px' : '4px';\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] enlarge ->', current, 'from', src);\r\n    };\r\n\r\n    row.addEventListener('click', (e) => { if (btn.contains(e.target)) return; applyValue(!current, 'row'); });\r\n    btn.addEventListener('click', () => applyValue(!current, 'click'));\r\n    btn.addEventListener('keydown', e => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); applyValue(!current, 'key'); } });\r\n\r\n    row.appendChild(leftWrap);\r\n    return row;\r\n  }\r\n\r\n  // 文本相似度：max_distance (0-20 整数) 滑块 + 击杀数(edit_distance)\r\n  _createEditDistanceRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = settings?.get?.('max_distance');\r\n    if (typeof current !== 'number' || !Number.isFinite(current)) current = 0;\r\n    if (current < 0) current = 0; else if (current > 20) current = 20;\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'max_distance');\r\n    row.setAttribute('data-type', 'range');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '文本相似度';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.userSelect = 'none';\r\n\r\n    const slider = document.createElement('input');\r\n    slider.type = 'range';\r\n    slider.min = '0';\r\n    slider.max = '20';\r\n    slider.step = '1';\r\n    slider.value = String(current);\r\n    slider.style.width = '140px';\r\n    slider.style.cursor = 'pointer';\r\n    slider.style.accentColor = '#3fa9ff';\r\n\r\n    // 数值显示（在滑块右侧）\r\n    const valSpan = document.createElement('span');\r\n    valSpan.textContent = String(current);\r\n    valSpan.style.minWidth = '0';\r\n    valSpan.style.textAlign = 'center';\r\n    valSpan.style.fontSize = '12px';\r\n    valSpan.style.opacity = '.85';\r\n    valSpan.style.whiteSpace = 'nowrap';\r\n    valSpan.style.overflow = 'hidden';\r\n    valSpan.style.textOverflow = 'clip';\r\n    valSpan.style.flex = '0 0 auto';\r\n    valSpan.style.width = '140px';\r\n\r\n    const sliderLine = document.createElement('div');\r\n    sliderLine.style.display = 'flex';\r\n    sliderLine.style.flexDirection = 'column';\r\n    sliderLine.style.alignItems = 'center';\r\n    sliderLine.style.gap = '4px';\r\n    sliderLine.style.width = '100%';\r\n    sliderLine.style.maxWidth = '190px';\r\n    sliderLine.appendChild(valSpan);\r\n    sliderLine.appendChild(slider);\r\n\r\n    const stats = document.createElement('span');\r\n    stats.style.fontSize = '14px';\r\n    stats.style.fontWeight = '500';\r\n    stats.style.whiteSpace = 'nowrap';\r\n    stats.style.maxWidth = '180px';\r\n    stats.style.overflow = 'hidden';\r\n    stats.style.textOverflow = 'ellipsis';\r\n    stats.textContent = '击杀数: 0';\r\n    this._editDistanceStatsEl = stats;\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      let n = parseInt(val, 10);\r\n      if (!Number.isFinite(n)) n = 0;\r\n      if (n < 0) n = 0; else if (n > 20) n = 20;\r\n      current = n;\r\n      slider.value = String(n);\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('max_distance', n);\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] max_distance ->', current, 'from', src);\r\n    };\r\n\r\n    slider.addEventListener('input', () => { applyValue(slider.value, 'input'); valSpan.textContent = slider.value; });\r\n    slider.addEventListener('change', () => { applyValue(slider.value, 'change'); valSpan.textContent = slider.value; });\r\n    // 行级点击：点击行聚焦到滑块\r\n    row.addEventListener('click', () => slider.focus());\r\n\r\n    row.appendChild(title);\r\n    row.appendChild(sliderLine);\r\n    row.appendChild(stats);\r\n    setTimeout(() => this._updateCombineStats(), 0);\r\n    return row;\r\n  }\r\n\r\n  // 余弦相似度：max_cosine (0-100 整数) 滑块 + 击杀数(vector)\r\n  _createVectorRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = settings?.get?.('max_cosine');\r\n    if (typeof current !== 'number' || !Number.isFinite(current)) current = 0;\r\n    if (current < 0) current = 0; else if (current > 100) current = 100;\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'max_cosine');\r\n    row.setAttribute('data-type', 'range');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '余弦相似度';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.userSelect = 'none';\r\n\r\n    const slider = document.createElement('input');\r\n    slider.type = 'range';\r\n    slider.min = '0';\r\n    slider.max = '100';\r\n    slider.step = '1';\r\n    slider.value = String(current);\r\n    slider.style.width = '140px';\r\n    slider.style.cursor = 'pointer';\r\n    slider.style.accentColor = '#3fa9ff';\r\n\r\n    const valSpan = document.createElement('span');\r\n    valSpan.textContent = String(current);\r\n    valSpan.style.minWidth = '0';\r\n    valSpan.style.textAlign = 'center';\r\n    valSpan.style.fontSize = '12px';\r\n    valSpan.style.opacity = '.85';\r\n    valSpan.style.whiteSpace = 'nowrap';\r\n    valSpan.style.overflow = 'hidden';\r\n    valSpan.style.textOverflow = 'clip';\r\n    valSpan.style.flex = '0 0 auto';\r\n    valSpan.style.width = '140px';\r\n\r\n    const sliderLine = document.createElement('div');\r\n    sliderLine.style.display = 'flex';\r\n    sliderLine.style.flexDirection = 'column';\r\n    sliderLine.style.alignItems = 'center';\r\n    sliderLine.style.gap = '4px';\r\n    sliderLine.style.width = '100%';\r\n    sliderLine.style.maxWidth = '190px';\r\n    sliderLine.appendChild(valSpan);\r\n    sliderLine.appendChild(slider);\r\n\r\n    const stats = document.createElement('span');\r\n    stats.style.fontSize = '14px';\r\n    stats.style.fontWeight = '500';\r\n    stats.style.whiteSpace = 'nowrap';\r\n    stats.style.maxWidth = '180px';\r\n    stats.style.overflow = 'hidden';\r\n    stats.style.textOverflow = 'ellipsis';\r\n    stats.textContent = '击杀数: 0';\r\n    this._vectorStatsEl = stats;\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      let n = parseInt(val, 10);\r\n      if (!Number.isFinite(n)) n = 0;\r\n      if (n < 0) n = 0; else if (n > 100) n = 100;\r\n      current = n;\r\n      slider.value = String(n);\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('max_cosine', n);\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] max_cosine ->', current, 'from', src);\r\n    };\r\n\r\n    slider.addEventListener('input', () => { applyValue(slider.value, 'input'); valSpan.textContent = slider.value; });\r\n    slider.addEventListener('change', () => { applyValue(slider.value, 'change'); valSpan.textContent = slider.value; });\r\n    row.addEventListener('click', () => slider.focus());\r\n\r\n    row.appendChild(title);\r\n    row.appendChild(sliderLine);\r\n    row.appendChild(stats);\r\n    setTimeout(() => this._updateCombineStats(), 0);\r\n    return row;\r\n  }\r\n\r\n  // 跨模式合并：cross_mode (boolean)\r\n  _createCrossModeRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = !!settings?.get?.('cross_mode');\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'cross_mode');\r\n    row.setAttribute('data-type', 'boolean');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const btn = document.createElement('button');\r\n    btn.type = 'button';\r\n    btn.setAttribute('role', 'switch');\r\n    btn.setAttribute('aria-checked', String(current));\r\n    btn.style.position = 'relative';\r\n    btn.style.width = '48px';\r\n    btn.style.height = '22px';\r\n    btn.style.borderRadius = '22px';\r\n    btn.style.border = '1px solid rgba(255,255,255,.3)';\r\n    btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.transition = 'background .2s, box-shadow .2s';\r\n    btn.style.outline = 'none';\r\n    btn.style.padding = '0';\r\n    btn.style.marginTop = '6px';\r\n\r\n    const knob = document.createElement('span');\r\n    knob.style.position = 'absolute';\r\n    knob.style.top = '50%';\r\n    knob.style.transform = 'translateY(-50%)';\r\n    knob.style.left = current ? '26px' : '4px';\r\n    knob.style.width = '16px';\r\n    knob.style.height = '16px';\r\n    knob.style.borderRadius = '50%';\r\n    knob.style.background = '#fff';\r\n    knob.style.boxShadow = '0 2px 4px rgba(0,0,0,.4)';\r\n    knob.style.transition = 'left .2s';\r\n    btn.appendChild(knob);\r\n\r\n    const leftWrap = document.createElement('div');\r\n    leftWrap.style.display = 'flex';\r\n    leftWrap.style.flexDirection = 'column';\r\n    leftWrap.style.alignItems = 'center';\r\n    leftWrap.style.flex = '0 0 auto';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '跨模式合并';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.marginBottom = '4px';\r\n    title.style.userSelect = 'none';\r\n\r\n    leftWrap.appendChild(title);\r\n    leftWrap.appendChild(btn);\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      current = !!val;\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('cross_mode', current);\r\n        btn.setAttribute('aria-checked', String(current));\r\n        btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n        knob.style.left = current ? '26px' : '4px';\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] cross_mode ->', current, 'from', src);\r\n    };\r\n\r\n    row.addEventListener('click', (e) => { if (btn.contains(e.target)) return; applyValue(!current, 'row'); });\r\n    btn.addEventListener('click', () => applyValue(!current, 'click'));\r\n    btn.addEventListener('keydown', e => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); applyValue(!current, 'key'); } });\r\n\r\n    row.appendChild(leftWrap);\r\n    return row;\r\n  }\r\n\r\n  // 文本规范化：同时设置 trim_ending / trim_space / trim_width (统一开关)\r\n  _createNormalizeRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    const ending = !!settings?.get?.('trim_ending');\r\n    const space = !!settings?.get?.('trim_space');\r\n    const width = !!settings?.get?.('trim_width');\r\n    // 只有全部为 true 才视为当前开启\r\n    let current = ending && space && width;\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'text_normalize');\r\n    row.setAttribute('data-type', 'boolean-group');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const btn = document.createElement('button');\r\n    btn.type = 'button';\r\n    btn.setAttribute('role', 'switch');\r\n    btn.setAttribute('aria-checked', String(current));\r\n    btn.style.position = 'relative';\r\n    btn.style.width = '48px';\r\n    btn.style.height = '22px';\r\n    btn.style.borderRadius = '22px';\r\n    btn.style.border = '1px solid rgba(255,255,255,.3)';\r\n    btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.transition = 'background .2s, box-shadow .2s';\r\n    btn.style.outline = 'none';\r\n    btn.style.padding = '0';\r\n    btn.style.marginTop = '6px';\r\n\r\n    const knob = document.createElement('span');\r\n    knob.style.position = 'absolute';\r\n    knob.style.top = '50%';\r\n    knob.style.transform = 'translateY(-50%)';\r\n    knob.style.left = current ? '26px' : '4px';\r\n    knob.style.width = '16px';\r\n    knob.style.height = '16px';\r\n    knob.style.borderRadius = '50%';\r\n    knob.style.background = '#fff';\r\n    knob.style.boxShadow = '0 2px 4px rgba(0,0,0,.4)';\r\n    knob.style.transition = 'left .2s';\r\n    btn.appendChild(knob);\r\n\r\n    const leftWrap = document.createElement('div');\r\n    leftWrap.style.display = 'flex';\r\n    leftWrap.style.flexDirection = 'column';\r\n    leftWrap.style.alignItems = 'center';\r\n    leftWrap.style.flex = '0 0 auto';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '文本规范化';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.marginBottom = '4px';\r\n    title.style.userSelect = 'none';\r\n    leftWrap.appendChild(title);\r\n    leftWrap.appendChild(btn);\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      current = !!val;\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('trim_ending', current);\r\n        liveSettings?.set?.('trim_space', current);\r\n        liveSettings?.set?.('trim_width', current);\r\n        btn.setAttribute('aria-checked', String(current));\r\n        btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n        knob.style.left = current ? '26px' : '4px';\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] text_normalize ->', current, 'from', src);\r\n    };\r\n\r\n    row.addEventListener('click', (e) => { if (btn.contains(e.target)) return; applyValue(!current, 'row'); });\r\n    btn.addEventListener('click', () => applyValue(!current, 'click'));\r\n    btn.addEventListener('keydown', e => { if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); applyValue(!current, 'key'); } });\r\n\r\n    row.appendChild(leftWrap);\r\n    return row;\r\n  }\r\n\r\n  // 合并时间窗口：threshold_seconds (1-30) 滑块\r\n  _createThresholdSecondsRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = settings?.get?.('threshold_seconds');\r\n    if (typeof current !== 'number' || !Number.isFinite(current)) current = 1;\r\n    if (current < 1) current = 1; else if (current > 30) current = 30;\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'threshold_seconds');\r\n    row.setAttribute('data-type', 'range');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '合并时间窗口';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.userSelect = 'none';\r\n\r\n    const slider = document.createElement('input');\r\n    slider.type = 'range';\r\n    slider.min = '1';\r\n    slider.max = '30';\r\n    slider.step = '1';\r\n    slider.value = String(current);\r\n    slider.style.width = '140px';\r\n    slider.style.cursor = 'pointer';\r\n    slider.style.accentColor = '#3fa9ff';\r\n\r\n    const valSpan = document.createElement('span');\r\n    valSpan.textContent = String(current) + ' 秒';\r\n    valSpan.style.minWidth = '0';\r\n    valSpan.style.textAlign = 'center';\r\n    valSpan.style.fontSize = '12px';\r\n    valSpan.style.opacity = '.85';\r\n    valSpan.style.whiteSpace = 'nowrap';\r\n    valSpan.style.overflow = 'hidden';\r\n    valSpan.style.textOverflow = 'clip';\r\n    valSpan.style.flex = '0 0 auto';\r\n    valSpan.style.width = '140px';\r\n\r\n    const sliderLine = document.createElement('div');\r\n    sliderLine.style.display = 'flex';\r\n    sliderLine.style.flexDirection = 'column';\r\n    sliderLine.style.alignItems = 'center';\r\n    sliderLine.style.gap = '4px';\r\n    sliderLine.style.width = '100%';\r\n    sliderLine.style.maxWidth = '190px';\r\n    sliderLine.appendChild(valSpan);\r\n    sliderLine.appendChild(slider);\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      let n = parseInt(val, 10);\r\n      if (!Number.isFinite(n)) n = 1;\r\n      if (n < 1) n = 1; else if (n > 30) n = 30;\r\n      current = n;\r\n      slider.value = String(n);\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('threshold_seconds', n);\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] threshold_seconds ->', current, 'from', src);\r\n    };\r\n\r\n    slider.addEventListener('input', () => { applyValue(slider.value, 'input'); valSpan.textContent = slider.value + ' 秒'; });\r\n    slider.addEventListener('change', () => { applyValue(slider.value, 'change'); valSpan.textContent = slider.value + ' 秒'; });\r\n    row.addEventListener('click', () => slider.focus());\r\n\r\n    row.appendChild(title);\r\n    row.appendChild(sliderLine);\r\n    return row;\r\n  }\r\n\r\n  // 处理块最大数量：max_chunk_size (10-1000) 滑块\r\n  _createMaxChunkSizeRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = settings?.get?.('max_chunk_size');\r\n    if (typeof current !== 'number' || !Number.isFinite(current)) current = 10;\r\n    if (current < 10) current = 10; else if (current > 1000) current = 1000;\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'max_chunk_size');\r\n    row.setAttribute('data-type', 'range');\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '处理块最大数量';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.userSelect = 'none';\r\n\r\n    const slider = document.createElement('input');\r\n    slider.type = 'range';\r\n    slider.min = '10';\r\n    slider.max = '1000';\r\n    slider.step = '1';\r\n    slider.value = String(current);\r\n    slider.style.width = '140px';\r\n    slider.style.cursor = 'pointer';\r\n    slider.style.accentColor = '#3fa9ff';\r\n\r\n    const valSpan = document.createElement('span');\r\n    valSpan.textContent = String(current) + ' 条';\r\n    valSpan.style.minWidth = '0';\r\n    valSpan.style.textAlign = 'center';\r\n    valSpan.style.fontSize = '12px';\r\n    valSpan.style.opacity = '.85';\r\n    valSpan.style.whiteSpace = 'nowrap';\r\n    valSpan.style.overflow = 'hidden';\r\n    valSpan.style.textOverflow = 'clip';\r\n    valSpan.style.flex = '0 0 auto';\r\n    valSpan.style.width = '140px';\r\n\r\n    const sliderLine = document.createElement('div');\r\n    sliderLine.style.display = 'flex';\r\n    sliderLine.style.flexDirection = 'column';\r\n    sliderLine.style.alignItems = 'center';\r\n    sliderLine.style.gap = '4px';\r\n    sliderLine.style.width = '100%';\r\n    sliderLine.style.maxWidth = '190px';\r\n    sliderLine.appendChild(valSpan);\r\n    sliderLine.appendChild(slider);\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      let n = parseInt(val, 10);\r\n      if (!Number.isFinite(n)) n = 10;\r\n      if (n < 10) n = 10; else if (n > 1000) n = 1000;\r\n      current = n;\r\n      slider.value = String(n);\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('max_chunk_size', n);\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] max_chunk_size ->', current, 'from', src);\r\n    };\r\n\r\n    slider.addEventListener('input', () => { applyValue(slider.value, 'input'); valSpan.textContent = slider.value + ' 条'; });\r\n    slider.addEventListener('change', () => { applyValue(slider.value, 'change'); valSpan.textContent = slider.value + ' 条'; });\r\n    row.addEventListener('click', () => slider.focus());\r\n\r\n    row.appendChild(title);\r\n    row.appendChild(sliderLine);\r\n    return row;\r\n  }\r\n\r\n  // 总开关：enable_combine (boolean)\r\n  _createEnableCombineRow() {\r\n    const settings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n    let current = !!settings?.get?.('enable_combine');\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', 'enable_combine');\r\n    row.setAttribute('data-type', 'boolean');\r\n    // 居中布局\r\n    row.style.display = 'flex';\r\n    row.style.flexDirection = 'column';\r\n    row.style.alignItems = 'center';\r\n    row.style.justifyContent = 'center';\r\n    row.style.gap = '6px';\r\n    row.style.textAlign = 'center';\r\n\r\n    // 左侧容器 + 标题 + Switch 按钮\r\n    const btn = document.createElement('button');\r\n    btn.type = 'button';\r\n    btn.setAttribute('role', 'switch');\r\n    btn.setAttribute('aria-checked', String(current));\r\n    btn.style.position = 'relative';\r\n    btn.style.width = '48px';\r\n    btn.style.height = '22px';\r\n    btn.style.borderRadius = '22px';\r\n    btn.style.border = '1px solid rgba(255,255,255,.3)';\r\n    btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n    btn.style.cursor = 'pointer';\r\n    btn.style.transition = 'background .2s, box-shadow .2s';\r\n    btn.style.outline = 'none';\r\n    btn.style.padding = '0';\r\n    btn.style.marginTop = '6px';\r\n\r\n    const knob = document.createElement('span');\r\n    knob.style.position = 'absolute';\r\n    knob.style.top = '50%';\r\n    knob.style.transform = 'translateY(-50%)';\r\n    knob.style.left = current ? '26px' : '4px';\r\n    knob.style.width = '16px';\r\n    knob.style.height = '16px';\r\n    knob.style.borderRadius = '50%';\r\n    knob.style.background = '#fff';\r\n    knob.style.boxShadow = '0 2px 4px rgba(0,0,0,.4)';\r\n    knob.style.transition = 'left .2s';\r\n    btn.appendChild(knob);\r\n\r\n    // 右侧统计元素\r\n    const stats = document.createElement('span');\r\n    stats.style.fontSize = '16px';\r\n    stats.style.fontWeight = '600';\r\n    stats.style.letterSpacing = '.5px';\r\n    stats.style.whiteSpace = 'nowrap';\r\n    stats.style.flex = '0 0 auto';\r\n    stats.style.maxWidth = '180px';\r\n    stats.style.overflow = 'hidden';\r\n    stats.style.textOverflow = 'ellipsis';\r\n    stats.style.textAlign = 'center';\r\n    this._combineStatsEl = stats;\r\n\r\n    const applyValue = (val, src = 'ui') => {\r\n      current = !!val;\r\n      try {\r\n        const liveSettings = window?.__jfDanmakuGlobal__?.danmakuSettings;\r\n        liveSettings?.set?.('enable_combine', current);\r\n        btn.setAttribute('aria-checked', String(current));\r\n        btn.style.background = current ? 'linear-gradient(90deg,#3fa9ff,#0c82d8)' : 'rgba(255,255,255,.15)';\r\n        knob.style.left = current ? '26px' : '4px';\r\n        // 使用专属去抖保存 + 完成后刷新统计\r\n        this._ensureCombineUpdate();\r\n      } catch (_) { }\r\n      this.logger?.info?.('[CombineSettings] enable_combine ->', current, 'from', src);\r\n    };\r\n\r\n    // 行级点击（排除按钮自身）\r\n    row.addEventListener('click', (e) => { if (btn.contains(e.target)) return; applyValue(!current, 'row'); });\r\n    btn.addEventListener('click', () => applyValue(!current, 'click'));\r\n    btn.addEventListener('keydown', e => {\r\n      if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); applyValue(!current, 'key'); }\r\n    });\r\n    const leftWrap = document.createElement('div');\r\n    leftWrap.style.display = 'flex';\r\n    leftWrap.style.flexDirection = 'column';\r\n    leftWrap.style.alignItems = 'center';\r\n    leftWrap.style.flex = '0 0 auto';\r\n\r\n    const title = document.createElement('span');\r\n    title.textContent = '合并总开关';\r\n    title.style.fontSize = '12px';\r\n    title.style.opacity = '.85';\r\n    title.style.marginBottom = '4px';\r\n    title.style.userSelect = 'none';\r\n\r\n    leftWrap.appendChild(title);\r\n    leftWrap.appendChild(btn);\r\n\r\n    row.appendChild(leftWrap);\r\n    row.appendChild(stats);\r\n\r\n    // 初始统计渲染\r\n    setTimeout(() => this._updateCombineStats(), 0);\r\n\r\n    return row;\r\n  }\r\n\r\n  build() {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'danmaku-settings-tabPanel';\r\n    panel.dataset.key = this.getKey();\r\n\r\n    const list = document.createElement('div');\r\n    list.className = 'danmaku-settings-list';\r\n    // 两列网格布局\r\n    list.style.display = 'grid';\r\n    list.style.gridTemplateColumns = 'repeat(2, minmax(0, 1fr))';\r\n    list.style.columnGap = '16px';\r\n    list.style.rowGap = '14px';\r\n    list.style.alignItems = 'stretch';\r\n    list.style.width = '100%';\r\n    list.appendChild(this._createEnableCombineRow());\r\n    list.appendChild(this._createCombineTimeRow());\r\n    list.appendChild(this._createMarkStyleRow());\r\n    list.appendChild(this._createMarkThresholdRow());\r\n    list.appendChild(this._createThresholdSecondsRow());\r\n    list.appendChild(this._createEnlargeRow());\r\n    list.appendChild(this._createEditDistanceRow());\r\n    list.appendChild(this._createVectorRow());\r\n    list.appendChild(this._createUsePinyinRow());\r\n    list.appendChild(this._createMaxChunkSizeRow());\r\n    list.appendChild(this._createCrossModeRow());\r\n    list.appendChild(this._createNormalizeRow());\r\n\r\n    // 占位：后续将添加具体参数（阈值、白名单等）\r\n    const placeholder = document.createElement('div');\r\n    placeholder.style.padding = '6px 2px';\r\n    placeholder.style.textAlign = 'center';\r\n    placeholder.style.opacity = '.55';\r\n    placeholder.style.fontSize = '12px';\r\n    // placeholder.textContent = '更多弹幕合并细节参数后续补充...';\r\n    // 占位内容跨两列\r\n    placeholder.style.gridColumn = '1 / span 2';\r\n    list.appendChild(placeholder);\r\n\r\n    panel.appendChild(list);\r\n    return panel;\r\n  }\r\n}\r\n","// 过滤规则设置分页：白名单 / 黑名单 / 替换名单\r\nimport { saveIfAutoOn } from \"../../api/utils\";\r\n// 按 BasicSettingsPage 的风格实现三个可折叠可编辑的列表表单。\r\n// 数据来源：window.__jfDanmakuGlobal__.danmakuSettings 键 white_list / black_list / force_list\r\n// white_list / black_list: [{ isRegex: false, pattern: '签到' }, { isRegex: true, pattern: '^.{1,2}$'}]\r\n// force_list (替换名单): [{ pattern: 'test', replace: '测试' }]\r\nexport class FilterSettingsPage {\r\n  constructor(opts = {}) { this.logger = opts.logger || null; this._sectionUpdaters = []; }\r\n  getKey() { return 'filter'; }\r\n  getLabel() { return '过滤规则'; }\r\n\r\n\r\n\r\n  _commit(key, value, trigger = 'manual') {\r\n    try {\r\n      const settings = window.__jfDanmakuGlobal__.danmakuSettings\r\n      // 规则字段 schema 是 string，需要序列化\r\n      let toStore = value;\r\n      if (Array.isArray(value)) {\r\n        try { toStore = JSON.stringify(value); } catch (_) { toStore = '[]'; }\r\n      }\r\n      settings?.set?.(key, toStore);\r\n      // 专属：确保并触发当前页的保存（完成后刷新统计）\r\n      const p = saveIfAutoOn(this.logger);\r\n      if (p) {p.then(() => { try { this._sectionUpdaters.forEach(fn => { try { fn(); } catch (_) { } }); } catch (_) { }; });}\r\n      this.logger?.info?.('[FilterSettings]', key, 'updated via', trigger, value);\r\n\r\n    } catch (e) {\r\n      this.logger?.warn?.('[FilterSettings] commit failed', key, e);\r\n    }\r\n  }\r\n\r\n\r\n  _createSection(opts) {\r\n    const { key, label, type } = opts; // type: 'wl' | 'bl' | 'repl'\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    row.setAttribute('data-key', key);\r\n    row.setAttribute('data-type', 'list');\r\n\r\n    const header = document.createElement('div');\r\n    header.className = 'danmaku-setting-row__label';\r\n    header.style.cursor = 'pointer';\r\n    const labelSpan = document.createElement('span');\r\n    labelSpan.className = 'danmaku-setting-row__labelText';\r\n    labelSpan.textContent = label;\r\n    header.appendChild(labelSpan);\r\n    const countBadge = document.createElement('span');\r\n    countBadge.style.fontSize = '11px';\r\n    countBadge.style.opacity = '.75';\r\n    countBadge.textContent = '0';\r\n    header.appendChild(countBadge);\r\n    const toggleIcon = document.createElement('span');\r\n    toggleIcon.textContent = '▸';\r\n    toggleIcon.style.marginLeft = '6px';\r\n    toggleIcon.style.transition = 'transform .18s';\r\n    header.appendChild(toggleIcon);\r\n    row.appendChild(header);\r\n\r\n    const container = document.createElement('div');\r\n    container.style.marginTop = '6px';\r\n    container.style.display = 'none'; // 折叠初始状态\r\n    container.style.padding = '4px 2px 2px';\r\n    container.style.borderTop = '1px solid rgba(255,255,255,.12)';\r\n    container.style.display = 'none';\r\n\r\n    const listWrap = document.createElement('div');\r\n    listWrap.style.display = 'flex';\r\n    listWrap.style.flexDirection = 'column';\r\n    listWrap.style.gap = '4px';\r\n    container.appendChild(listWrap);\r\n\r\n    // 说明行\r\n    const desc = document.createElement('div');\r\n    desc.className = 'danmaku-setting-row__desc';\r\n    desc.style.marginTop = '4px';\r\n    desc.textContent = type === 'repl' ? '替换名单: 正则/纯文本 pattern 匹配后替换为 replace' : '支持纯文本或正则 (切换开关)。';\r\n    container.appendChild(desc);\r\n\r\n    row.appendChild(container);\r\n\r\n    // 读取初始数据\r\n    let dataRaw = [];\r\n    try {\r\n      const s = window?.__jfDanmakuGlobal__?.danmakuSettings || null;\r\n      const rawVal = s?.get?.(key);\r\n      if (Array.isArray(rawVal)) dataRaw = rawVal; // 理论上不会：schema 为 string\r\n      else if (typeof rawVal === 'string') {\r\n        const trimmed = rawVal.trim();\r\n        if (trimmed) {\r\n          try {\r\n            const parsed = JSON.parse(trimmed);\r\n            if (Array.isArray(parsed)) dataRaw = parsed;\r\n          } catch (_) { /* ignore parse error */ }\r\n        }\r\n      }\r\n      if (!Array.isArray(dataRaw)) dataRaw = [];\r\n    } catch (_) { dataRaw = []; }\r\n\r\n    let expanded = false;\r\n    const toggle = () => {\r\n      expanded = !expanded;\r\n      container.style.display = expanded ? 'block' : 'none';\r\n      toggleIcon.style.transform = expanded ? 'rotate(90deg)' : 'rotate(0deg)';\r\n    };\r\n    header.addEventListener('click', toggle);\r\n\r\n    // 更新规则数 + 命中次数的 badge\r\n    const updateHitBadge = () => {\r\n      try {\r\n        const g = window.__jfDanmakuGlobal__ || {};\r\n        const rc = g?.danmakuData?.rule_counts;\r\n        const map = { white_list: 'whitelist', black_list: 'blacklist', force_list: 'forcelist' };\r\n        const rcKey = map[key];\r\n        let hit = 0;\r\n        if (rc && rcKey && rc[rcKey] != null) {\r\n          const num = Number(rc[rcKey]);\r\n          if (Number.isFinite(num)) hit = num; else if (typeof rc[rcKey] === 'string' && rc[rcKey].trim() !== '') {\r\n            const n2 = Number(rc[rcKey].trim()); if (Number.isFinite(n2)) hit = n2;\r\n          }\r\n        }\r\n        countBadge.textContent = `规则数:${dataRaw.length} 命中次数:${hit}`;\r\n      } catch (_) {\r\n        countBadge.textContent = `规则数:${dataRaw.length} 命中次数:0`;\r\n      }\r\n    };\r\n\r\n    const rebuild = () => {\r\n      listWrap.innerHTML = '';\r\n      // 初步写入规则数，命中数稍后更新\r\n      countBadge.textContent = `规则数:${dataRaw.length} 命中次数:--`;\r\n      const makeAddRow = (position = 'bottom') => {\r\n        const addBtn = document.createElement('button');\r\n        addBtn.type = 'button';\r\n        addBtn.textContent = '+ 添加';\r\n        addBtn.style.width = '100%';\r\n        addBtn.style.padding = '6px 8px';\r\n        addBtn.style.fontSize = '12px';\r\n        addBtn.style.background = 'rgba(255,255,255,.08)';\r\n        addBtn.style.color = '#fff';\r\n        addBtn.style.border = '1px dashed rgba(255,255,255,.3)';\r\n        addBtn.style.borderRadius = '6px';\r\n        addBtn.style.cursor = 'pointer';\r\n        addBtn.addEventListener('mouseenter', () => addBtn.style.background = 'rgba(255,255,255,.15)');\r\n        addBtn.addEventListener('mouseleave', () => addBtn.style.background = 'rgba(255,255,255,.08)');\r\n        addBtn.addEventListener('click', () => {\r\n          if (type === 'repl') dataRaw.push({ pattern: '', replace: '' });\r\n          else dataRaw.push({ isRegex: false, pattern: '' });\r\n          this._commit(key, dataRaw, 'add');\r\n          rebuild();\r\n        });\r\n        if (position === 'top') listWrap.appendChild(addBtn); else listWrap.appendChild(addBtn);\r\n      };\r\n\r\n      if (dataRaw.length === 0) {\r\n        makeAddRow('top');\r\n        return;\r\n      }\r\n\r\n      dataRaw.forEach((item, idx) => {\r\n        const line = document.createElement('div');\r\n        line.style.display = 'flex';\r\n        line.style.alignItems = 'center';\r\n        line.style.gap = '6px';\r\n        line.style.padding = '6px 6px';\r\n        line.style.background = 'rgba(255,255,255,.05)';\r\n        line.style.border = '1px solid rgba(255,255,255,.15)';\r\n        line.style.borderRadius = '6px';\r\n        line.style.position = 'relative';\r\n\r\n        if (type !== 'repl') {\r\n          // isRegex switch\r\n          const regexToggle = document.createElement('button');\r\n          regexToggle.type = 'button';\r\n          regexToggle.textContent = item.isRegex ? '正则' : '文本';\r\n          regexToggle.style.minWidth = '44px';\r\n          regexToggle.style.fontSize = '11px';\r\n          regexToggle.style.padding = '4px 6px';\r\n          regexToggle.style.border = '1px solid rgba(255,255,255,.25)';\r\n          regexToggle.style.borderRadius = '4px';\r\n          regexToggle.style.background = item.isRegex ? '#3fa9ff' : 'rgba(255,255,255,.12)';\r\n          regexToggle.style.cursor = 'pointer';\r\n          regexToggle.addEventListener('click', () => {\r\n            item.isRegex = !item.isRegex;\r\n            regexToggle.textContent = item.isRegex ? '正则' : '文本';\r\n            regexToggle.style.background = item.isRegex ? '#3fa9ff' : 'rgba(255,255,255,.12)';\r\n            this._commit(key, dataRaw, 'toggle');\r\n          });\r\n          line.appendChild(regexToggle);\r\n        }\r\n\r\n        const patternInput = document.createElement('input');\r\n        patternInput.type = 'text';\r\n        patternInput.placeholder = 'pattern';\r\n        patternInput.value = item.pattern || '';\r\n        patternInput.className = 'danmaku-setting-input';\r\n        patternInput.style.flex = '1 1 auto';\r\n        patternInput.style.minWidth = '120px';\r\n        patternInput.addEventListener('input', () => { item.pattern = patternInput.value; });\r\n        patternInput.addEventListener('change', () => { this._commit(key, dataRaw, 'pattern-change'); });\r\n        line.appendChild(patternInput);\r\n\r\n        if (type === 'repl') {\r\n          const replaceInput = document.createElement('input');\r\n          replaceInput.type = 'text';\r\n          replaceInput.placeholder = 'replace';\r\n          replaceInput.value = item.replace || '';\r\n          replaceInput.className = 'danmaku-setting-input';\r\n          replaceInput.style.flex = '1 1 auto';\r\n          replaceInput.style.minWidth = '120px';\r\n          replaceInput.addEventListener('input', () => { item.replace = replaceInput.value; });\r\n          replaceInput.addEventListener('change', () => { this._commit(key, dataRaw, 'replace-change'); });\r\n          line.appendChild(replaceInput);\r\n        }\r\n\r\n        const delBtn = document.createElement('button');\r\n        delBtn.type = 'button';\r\n        delBtn.textContent = '✕';\r\n        delBtn.title = '删除';\r\n        delBtn.style.padding = '4px 6px';\r\n        delBtn.style.fontSize = '12px';\r\n        delBtn.style.background = 'rgba(255,80,80,.25)';\r\n        delBtn.style.border = '1px solid rgba(255,80,80,.4)';\r\n        delBtn.style.borderRadius = '4px';\r\n        delBtn.style.cursor = 'pointer';\r\n        delBtn.addEventListener('mouseenter', () => delBtn.style.background = 'rgba(255,80,80,.4)');\r\n        delBtn.addEventListener('mouseleave', () => delBtn.style.background = 'rgba(255,80,80,.25)');\r\n        delBtn.addEventListener('click', () => {\r\n          dataRaw.splice(idx, 1);\r\n          this._commit(key, dataRaw, 'delete');\r\n          rebuild();\r\n        });\r\n        line.appendChild(delBtn);\r\n\r\n        listWrap.appendChild(line);\r\n      });\r\n\r\n      // 添加按钮放到底部\r\n      makeAddRow('bottom');\r\n      // 重建后刷新命中次数\r\n      updateHitBadge();\r\n    };\r\n\r\n    rebuild();\r\n    // 注册全局刷新器（用于保存后统一刷新）\r\n    this._sectionUpdaters.push(updateHitBadge);\r\n    // 初始异步刷新一次（确保 rule_counts 可能稍后写入）\r\n    setTimeout(updateHitBadge, 0);\r\n    return row;\r\n  }\r\n\r\n  build() {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'danmaku-settings-tabPanel';\r\n    panel.dataset.key = this.getKey();\r\n\r\n    const list = document.createElement('div');\r\n    list.className = 'danmaku-settings-list';\r\n\r\n    list.appendChild(this._createSection({ key: 'white_list', label: '白名单', type: 'wl' }));\r\n    list.appendChild(this._createSection({ key: 'black_list', label: '黑名单', type: 'bl' }));\r\n    list.appendChild(this._createSection({ key: 'force_list', label: '替换名单', type: 'repl' }));\r\n\r\n    // 全局说明：显示白/黑名单的命中处理逻辑\r\n    const footerNote = document.createElement('div');\r\n    footerNote.className = 'danmaku-setting-row__desc';\r\n    footerNote.style.marginTop = '8px';\r\n    footerNote.style.opacity = '.85';\r\n    footerNote.innerHTML = '白名单: 命中时无视合并规则<br>黑名单: 命中时直接删除<br>替换名单: 命中时替换文本后继续处理<br>需要开启弹幕合并总开关才能生效';\r\n    list.appendChild(footerNote);\r\n\r\n    panel.appendChild(list);\r\n    return panel;\r\n  }\r\n}\r\n","// 弹幕池分页：来源统计 -> 物理小球（拖拽/碰撞/重力）\r\nimport { updateDanmakuSettings } from '../../api/fetch';\r\nimport { saveIfAutoOn } from \"../../api/utils\";\r\n\r\n\r\nexport class CommentPoolPage {\r\n  constructor(opts = {}) {\r\n    this.logger = opts.logger || null;\r\n    this._balls = [];\r\n    this._raf = null;\r\n    this._lastT = 0;\r\n    this._boxEl = null;\r\n    this._panel = null;\r\n    this._resizeOb = null; // ResizeObserver\r\n    this._activeMo = null; // MutationObserver for data-active\r\n    this._trashZoneEl = null;\r\n  }\r\n  getKey() { return 'commentpool'; }\r\n  getLabel() { return '弹幕池'; }\r\n\r\n  _readStats() {\r\n    try {\r\n      const g = window.__jfDanmakuGlobal__ || {};\r\n      const stats = g?.danmakuData?.source_stats;\r\n      if (!stats || typeof stats !== 'object') return null;\r\n      const entries = Object.entries(stats)\r\n        .map(([name, v]) => ({ name, count: Number(v) || 0 }))\r\n        .filter(e => e.count > 0);\r\n      if (!entries.length) return null;\r\n      return entries;\r\n    } catch (_) { return null; }\r\n  }\r\n\r\n  _readInitialBlacklist() {\r\n    try {\r\n      const g = window.__jfDanmakuGlobal__ || {};\r\n      const raw = g?.danmakuData?.settings?.black_source_list;\r\n      let arr = [];\r\n      if (Array.isArray(raw)) {\r\n        arr = raw;\r\n      } else if (typeof raw === 'string') {\r\n        const s = raw.trim();\r\n        if (s) {\r\n          try {\r\n            const parsed = JSON.parse(s);\r\n            if (Array.isArray(parsed)) arr = parsed; else arr = s.split(',');\r\n          } catch (_) { arr = s.split(','); }\r\n        }\r\n      }\r\n      const list = arr.map(x => String(x).trim()).filter(Boolean);\r\n      const set = new Set(list.map(x => x.toLowerCase()));\r\n      return { list, set };\r\n    } catch (_) { return { list: [], set: new Set() }; }\r\n  }\r\n\r\n  _createBox() {\r\n    const box = document.createElement('div');\r\n    box.style.position = 'relative';\r\n    box.style.width = '100%';\r\n    box.style.height = '260px';\r\n    box.style.background = 'rgba(255,255,255,.05)';\r\n    box.style.border = '1px solid rgba(255,255,255,.15)';\r\n    box.style.borderRadius = '10px';\r\n    box.style.overflow = 'hidden';\r\n    // 触屏优化：允许纵向滚动页面（在主框空白区域上下滑动可滚动）\r\n    // 拖拽小球本身仍通过小球元素的 touch-action:none 阻止页面滚动\r\n    box.style.touchAction = 'pan-y';\r\n    box.style.userSelect = 'none';\r\n    return box;\r\n  }\r\n\r\n  _makeBallEl(label, color) {\r\n    // 解析名称与计数\r\n    const parts = String(label ?? '').split('\\n');\r\n    const name = (parts[0] || '').trim();\r\n    const countText = (parts[1] || '').trim();\r\n    const initial = name ? name[0] : '·';\r\n\r\n    const el = document.createElement('div');\r\n    el.style.position = 'absolute';\r\n    el.style.left = '0px';\r\n    el.style.top = '0px';\r\n    el.style.width = '40px';\r\n    el.style.height = '40px';\r\n    el.style.borderRadius = '50%';\r\n    el.style.display = 'flex';\r\n    el.style.alignItems = 'center';\r\n    el.style.justifyContent = 'center';\r\n    el.style.color = '#fff';\r\n    el.style.textAlign = 'center';\r\n    el.style.padding = '4px';\r\n    el.style.boxSizing = 'border-box';\r\n    el.style.cursor = 'grab';\r\n    // 触屏优化：禁用浏览器手势滚动/缩放，避免拖动时页面滚动\r\n    el.style.touchAction = 'none';\r\n    el.style.willChange = 'transform';\r\n    el.style.background = `radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.05) 35%), ${color}`;\r\n    el.style.boxShadow = '0 4px 10px rgba(0,0,0,.35)';\r\n    el.title = name ? `${name} (${countText || '0'})` : (countText || '');\r\n\r\n    // 背景水印（名称首字母/首字）\r\n    const bg = document.createElement('div');\r\n    bg.className = 'jf-ball-bg';\r\n    bg.style.position = 'absolute';\r\n    bg.style.inset = '0';\r\n    bg.style.display = 'flex';\r\n    bg.style.alignItems = 'center';\r\n    bg.style.justifyContent = 'center';\r\n    bg.style.pointerEvents = 'none';\r\n    bg.style.userSelect = 'none';\r\n    bg.style.fontWeight = '800';\r\n    bg.style.lineHeight = '1';\r\n    bg.style.letterSpacing = '0';\r\n    bg.style.color = 'rgba(255,255,255,.12)';\r\n    bg.style.textShadow = '0 1px 2px rgba(0,0,0,.2)';\r\n    bg.style.zIndex = '0';\r\n    bg.textContent = initial;\r\n\r\n    // 前景：只显示计数，字号固定（不随球大小变化）\r\n    const fg = document.createElement('div');\r\n    fg.className = 'jf-ball-count';\r\n    fg.style.position = 'relative';\r\n    fg.style.zIndex = '1';\r\n    fg.style.fontSize = '12px';\r\n    fg.style.fontWeight = '600';\r\n    fg.style.textShadow = '0 1px 2px rgba(0,0,0,.35)';\r\n    fg.textContent = countText || '';\r\n\r\n    el.appendChild(bg);\r\n    el.appendChild(fg);\r\n    // 保存引用，方便外部依据半径设定字号\r\n    el._bgWatermark = bg;\r\n    return el;\r\n  }\r\n\r\n  _colorForIndex(i) {\r\n    const palette = [\r\n      'linear-gradient(135deg,#3fa9ff,#0c82d8)',\r\n      'linear-gradient(135deg,#ff7a59,#ff3d6e)',\r\n      'linear-gradient(135deg,#6bd06b,#2fbf71)',\r\n      'linear-gradient(135deg,#a78bfa,#6d28d9)',\r\n      'linear-gradient(135deg,#fbbf24,#f59e0b)',\r\n      'linear-gradient(135deg,#34d399,#10b981)',\r\n      'linear-gradient(135deg,#f472b6,#ec4899)'\r\n    ];\r\n    return palette[i % palette.length];\r\n  }\r\n\r\n  _initBalls(stats) {\r\n    const rect = this._boxEl.getBoundingClientRect();\r\n    const W = Math.max(50, rect.width);\r\n    const H = Math.max(50, rect.height);\r\n    const max = Math.max(...stats.map(s => s.count));\r\n    const minR = 14, maxR = 44;\r\n    this._balls = stats.map((s, i) => {\r\n      const r = minR + (max > 0 ? (maxR - minR) * (s.count / max) : 0);\r\n      const el = this._makeBallEl(`${s.name}\\n${s.count}`, this._colorForIndex(i));\r\n      el.style.width = `${Math.round(r * 2)}px`;\r\n      el.style.height = `${Math.round(r * 2)}px`;\r\n      // 背景水印字号 ~ 1.1 × 半径，最小 12px\r\n      const bgFS = Math.max(12, Math.round(r * 1.1));\r\n      if (el._bgWatermark) el._bgWatermark.style.fontSize = `${bgFS}px`;\r\n      this._boxEl.appendChild(el);\r\n      // 随机放置，避免重叠：尝试多次\r\n      let x = r + Math.random() * (W - 2 * r);\r\n      let y = r + Math.random() * (H - 2 * r);\r\n      let tries = 0;\r\n      const temp = { x, y, r };\r\n      while (tries++ < 50 && this._balls?.length) {\r\n        let overlap = false;\r\n        for (const b of this._balls) {\r\n          const dx = temp.x - b.x; const dy = temp.y - b.y;\r\n          if (Math.hypot(dx, dy) < temp.r + b.r + 2) { overlap = true; break; }\r\n        }\r\n        if (!overlap) break;\r\n        temp.x = r + Math.random() * (W - 2 * r);\r\n        temp.y = r + Math.random() * (H - 2 * r);\r\n      }\r\n      x = temp.x; y = temp.y;\r\n      // 基于半径设定质量（二维近似：m ∝ r^2，密度取 1）\r\n      const mass = r * r;\r\n      // 初始化平滑随机漂移（力向量，缓慢变化）\r\n      const _driftAng = Math.random() * Math.PI * 2;\r\n      const _DRIFT_FORCE_MIN = 40, _DRIFT_FORCE_MAX = 120;\r\n      const _driftMag = _DRIFT_FORCE_MIN + Math.random() * (_DRIFT_FORCE_MAX - _DRIFT_FORCE_MIN);\r\n      const ball = {\r\n        el, name: s.name, count: s.count, x, y,\r\n        vx: 0, vy: 0, r, mass,\r\n        dragging: false, _px: 0, _py: 0, _pt: 0,\r\n        // 漂移力当前值与目标值、下次切换时间\r\n        _driftFx: 0, _driftFy: 0,\r\n        _driftTargetFx: Math.cos(_driftAng) * _driftMag,\r\n        _driftTargetFy: Math.sin(_driftAng) * _driftMag,\r\n        _driftNext: performance.now() + (150 + Math.random() * 200)\r\n      };\r\n      this._attachDrag(ball);\r\n      return ball;\r\n    });\r\n  }\r\n\r\n  _attachDrag(ball) {\r\n    const onDown = (e) => {\r\n      // 仅响应左键拖拽；右键在此截断，避免冒泡到外层导致面板关闭\r\n      if (typeof e.button === 'number' && e.button !== 0) {\r\n        try { e.preventDefault?.(); e.stopPropagation?.(); e.stopImmediatePropagation?.(); } catch (_) { }\r\n        return;\r\n      }\r\n      try { ball.el.setPointerCapture?.(e.pointerId); } catch (_) { }\r\n      ball.dragging = true;\r\n      ball.el.style.cursor = 'grabbing';\r\n      ball.vx = 0; ball.vy = 0;\r\n      // 在垃圾桶内与在主容器内，偏移计算不同\r\n      if (ball.inTrash) {\r\n        // 使用幽灵球随鼠标移动，隐藏原球\r\n        const r = ball.r;\r\n        if (!ball._ghostEl) this._createGhostEl(ball);\r\n        ball.el.style.visibility = 'hidden';\r\n        ball._ghostEl.style.left = `${Math.round(e.clientX - r)}px`;\r\n        ball._ghostEl.style.top = `${Math.round(e.clientY - r)}px`;\r\n        const now = performance.now();\r\n        ball._pt = now; ball._px = e.clientX; ball._py = e.clientY;\r\n      } else {\r\n        const p = this._toLocal(e.clientX, e.clientY);\r\n        ball._offsetX = p.x - ball.x;\r\n        ball._offsetY = p.y - ball.y;\r\n        ball._px = p.x; ball._py = p.y; ball._pt = performance.now();\r\n      }\r\n      e.preventDefault?.(); e.stopPropagation?.();\r\n    };\r\n    const onMove = (e) => {\r\n      if (!ball.dragging) return;\r\n      // 触屏拖动时阻止页面滚动/回弹\r\n      try { e.preventDefault?.(); } catch (_) { }\r\n      if (ball.inTrash) {\r\n        // 幽灵球跟随\r\n        if (!ball._ghostEl) this._createGhostEl(ball);\r\n        const r = ball.r;\r\n        const nx = Math.round(e.clientX - r);\r\n        const ny = Math.round(e.clientY - r);\r\n        ball._ghostEl.style.left = `${nx}px`;\r\n        ball._ghostEl.style.top = `${ny}px`;\r\n      } else {\r\n        // 主框内拖拽 + 框外幽灵球\r\n        const inside = this._isPointInBox(e.clientX, e.clientY);\r\n        if (inside) {\r\n          // 回到框内：移除幽灵球、显示原球并按原逻辑更新\r\n          if (ball._ghostEl) this._removeGhostEl(ball);\r\n          if (ball.el.style.visibility === 'hidden') ball.el.style.visibility = 'visible';\r\n          const p = this._toLocal(e.clientX, e.clientY);\r\n          const x = p.x - ball._offsetX; const y = p.y - ball._offsetY;\r\n          const rect = this._boxEl.getBoundingClientRect();\r\n          const W = rect.width, H = rect.height; const r = ball.r;\r\n          ball.x = Math.max(r, Math.min(W - r, x));\r\n          ball.y = Math.max(r, Math.min(H - r, y));\r\n          // 估算拖拽速度以便松手后“掷出”\r\n          const now = performance.now();\r\n          const dt = Math.max(1, now - (ball._pt || now));\r\n          ball.vx = (p.x - (ball._px || p.x)) / dt * 16;\r\n          ball.vy = (p.y - (ball._py || p.y)) / dt * 16;\r\n          ball._px = p.x; ball._py = p.y; ball._pt = now;\r\n        } else {\r\n          // 框外：隐藏原球，显示幽灵球跟随鼠标（以中心对准指针）\r\n          if (!ball._ghostEl) {\r\n            this._createGhostEl(ball);\r\n          }\r\n          if (ball.el.style.visibility !== 'hidden') ball.el.style.visibility = 'hidden';\r\n          const r = ball.r;\r\n          const nx = Math.round(e.clientX - r);\r\n          const ny = Math.round(e.clientY - r);\r\n          ball._ghostEl.style.left = `${nx}px`;\r\n          ball._ghostEl.style.top = `${ny}px`;\r\n        }\r\n      }\r\n      // 顶部垃圾桶命中检测（基于指针屏幕坐标）\r\n      if (this._trashZoneEl) {\r\n        try {\r\n          const rct = this._trashZoneEl.getBoundingClientRect();\r\n          const over = e.clientX >= rct.left && e.clientX <= rct.right && e.clientY >= rct.top && e.clientY <= rct.bottom;\r\n          ball._overTrash = !!over;\r\n          this._trashZoneEl.style.outlineColor = over ? 'rgba(255,80,80,.95)' : 'rgba(255,255,255,.25)';\r\n          this._trashZoneEl.style.background = over ? 'linear-gradient(135deg, rgba(255,64,64,.25), rgba(255,0,0,.12))' : 'rgba(255,255,255,.04)';\r\n        } catch (_) { }\r\n      }\r\n    };\r\n    const onUp = async (e) => {\r\n      const wasDragging = ball.dragging;\r\n      ball.dragging = false;\r\n      ball.el.style.cursor = 'grab';\r\n      try { ball.el.releasePointerCapture?.(e.pointerId); } catch (_) { }\r\n      // 根据松手位置决定逻辑\r\n      if (!wasDragging) return;\r\n      const overTrash = this._isPointInTrash(e.clientX, e.clientY);\r\n      // 触屏增加“命中松弛”，让靠近主框边缘也视为命中，方便从黑名单拖出\r\n      const slack = (e.pointerType === 'touch') ? Math.max(24, Math.min(48, Math.round(ball.r))) : 0;\r\n      const overBox = this._isPointInBox(e.clientX, e.clientY);\r\n      const nearBox = slack > 0 ? this._isPointNearBox(e.clientX, e.clientY, slack) : false;\r\n      // 清理临时样式（若来自垃圾桶视口拖拽）\r\n      if (ball._prevPosStyle != null) {\r\n        // 恢复为相对排版（若仍在垃圾桶）或交由盒子物理渲染\r\n        ball.el.style.position = ball._prevPosStyle;\r\n        ball.el.style.left = ball._prevLeft || '';\r\n        ball.el.style.top = ball._prevTop || '';\r\n        ball.el.style.transform = ball._prevTransform || '';\r\n        ball._prevPosStyle = null; ball._prevLeft = null; ball._prevTop = null; ball._prevTransform = null;\r\n      }\r\n      // 情况1：从主盒拖到垃圾桶\r\n      if (!ball.inTrash && overTrash) {\r\n        if (ball._ghostEl) this._removeGhostEl(ball);\r\n        if (ball.el.style.visibility === 'hidden') ball.el.style.visibility = 'visible';\r\n        await this._moveBallToTrash(ball);\r\n        return;\r\n      }\r\n      // 情况2：从垃圾桶拖回主盒\r\n      if (ball.inTrash && (overBox || nearBox)) {\r\n        if (ball._ghostEl) this._removeGhostEl(ball);\r\n        if (ball.el.style.visibility === 'hidden') ball.el.style.visibility = 'visible';\r\n        await this._moveBallBackToBox(ball, e.clientX, e.clientY);\r\n        return;\r\n      }\r\n      // 情况2.1：仍在垃圾桶或框外松手 -> 保留在垃圾桶，清理幽灵球并恢复可见\r\n      if (ball.inTrash && !overBox) {\r\n        if (ball._ghostEl) this._removeGhostEl(ball);\r\n        if (ball.el.style.visibility === 'hidden') ball.el.style.visibility = 'visible';\r\n        return;\r\n      }\r\n      // 情况3：主盒拖拽，松手在盒内 -> 依靠现有位置即可\r\n      if (!ball.inTrash && overBox) {\r\n        if (ball._ghostEl) this._removeGhostEl(ball);\r\n        if (ball.el.style.visibility === 'hidden') ball.el.style.visibility = 'visible';\r\n        return;\r\n      }\r\n      // 情况4：主盒拖拽，松手在盒外且不在垃圾桶 -> 还原显示（位置保持最近一次盒内位置）\r\n      if (!ball.inTrash && !overTrash && !overBox) {\r\n        if (ball._ghostEl) this._removeGhostEl(ball);\r\n        if (ball.el.style.visibility === 'hidden') ball.el.style.visibility = 'visible';\r\n        return;\r\n      }\r\n      // 其他：回到原位（主盒由下一帧渲染，垃圾桶维持布局）\r\n    };\r\n    // 当触控被系统手势中断（pointercancel），按松手处理，防止卡住\r\n    const onCancel = (e) => { try { onUp(e); } catch (_) { } };\r\n    // 悬停暂停（仅限鼠标）\r\n    const onEnter = (e) => {\r\n      try {\r\n        if ((e.pointerType || 'mouse') !== 'mouse') return;\r\n        if (ball.dragging || ball.inTrash) return;\r\n        ball.hoverPause = true;\r\n        // 记录当前速度并清零，避免在暂停时残余移动\r\n        ball._preHoverVx = ball.vx; ball._preHoverVy = ball.vy;\r\n        ball.vx = 0; ball.vy = 0;\r\n      } catch (_) { }\r\n    };\r\n    const onLeave = (e) => {\r\n      try {\r\n        if ((e.pointerType || 'mouse') !== 'mouse') return;\r\n        ball.hoverPause = false;\r\n        // 不恢复速度，保持静止，由系统力再次缓慢推动\r\n      } catch (_) { }\r\n    };\r\n    // 右键菜单：阻止默认并显示自定义菜单\r\n    const onCtx = (e) => {\r\n      try { e.preventDefault?.(); e.stopPropagation?.(); } catch (_) { }\r\n      this._showBallMenu(ball, e.clientX, e.clientY);\r\n    };\r\n    ball.el.addEventListener('pointerdown', onDown);\r\n    window.addEventListener('pointermove', onMove, { passive: false });\r\n    window.addEventListener('pointerup', onUp, { passive: true });\r\n    window.addEventListener('pointercancel', onCancel, { passive: true });\r\n    ball.el.addEventListener('pointerenter', onEnter);\r\n    ball.el.addEventListener('pointerleave', onLeave);\r\n    // 捕获阶段拦截，确保外层不会先关闭面板\r\n    ball.el.addEventListener('contextmenu', onCtx, { capture: true });\r\n    // 保存引用以便销毁时解绑\r\n    ball._onDown = onDown;\r\n    ball._onMove = onMove;\r\n    ball._onUp = onUp;\r\n    ball._onCancel = onCancel;\r\n    ball._onEnter = onEnter;\r\n    ball._onLeave = onLeave;\r\n    ball._onCtx = onCtx;\r\n    // 记录以便未来销毁（此处简化不做 remove，页面重建会释放元素引用）\r\n  }\r\n\r\n  _showBallMenu(ball, x, y) {\r\n    try { this._closeMenu(); } catch (_) { }\r\n    const menu = document.createElement('div');\r\n    // 在面板内使用绝对定位，坐标以面板为参考系\r\n    menu.style.position = 'absolute';\r\n    // 初始定位占位，稍后根据尺寸再校正\r\n    menu.style.left = '0px';\r\n    menu.style.top = '0px';\r\n    menu.style.background = 'rgba(20,20,20,.96)';\r\n    menu.style.backdropFilter = 'blur(4px)';\r\n    menu.style.border = '1px solid rgba(255,255,255,.15)';\r\n    menu.style.borderRadius = '8px';\r\n    menu.style.boxShadow = '0 8px 24px rgba(0,0,0,.45)';\r\n    menu.style.padding = '6px';\r\n    menu.style.minWidth = '160px';\r\n    menu.style.color = '#fff';\r\n    menu.style.zIndex = '999999';\r\n    menu.style.fontSize = '12px';\r\n    menu.style.userSelect = 'none';\r\n\r\n    const mkItem = (label, handler, { danger = false, disabled = false } = {}) => {\r\n      const it = document.createElement('div');\r\n      it.textContent = label;\r\n      it.style.padding = '8px 10px';\r\n      it.style.borderRadius = '6px';\r\n      it.style.cursor = disabled ? 'not-allowed' : 'pointer';\r\n      it.style.opacity = disabled ? '.45' : '1';\r\n      it.style.color = danger ? 'rgb(255,120,120)' : '#fff';\r\n      it.addEventListener('mouseenter', () => { if (!disabled) it.style.background = 'rgba(255,255,255,.08)'; });\r\n      it.addEventListener('mouseleave', () => { it.style.background = 'transparent'; });\r\n      if (!disabled && typeof handler === 'function') {\r\n        it.addEventListener('click', async () => {\r\n          try { await handler(); } finally { this._closeMenu(); }\r\n        });\r\n      }\r\n      menu.appendChild(it);\r\n      return it;\r\n    };\r\n\r\n    // 动态加入/移出黑名单\r\n    if (ball.inTrash) {\r\n      mkItem('移出黑名单', async () => {\r\n        // 若在垃圾桶，回到主框，位置使用菜单触发坐标\r\n        await this._moveBallBackToBox(ball, x, y);\r\n      });\r\n    } else {\r\n      mkItem('加入黑名单', async () => {\r\n        await this._moveBallToTrash(ball, true);\r\n      }, { danger: true });\r\n    }\r\n    // 占位项（暂未实现功能）\r\n    mkItem('查看来源信息（暂未实现）', () => { }, { disabled: true });\r\n    mkItem('更多操作（暂未实现）', () => { }, { disabled: true });\r\n    mkItem('取消', () => { });\r\n\r\n    // 将菜单作为设置面板的一部分，避免触发面板的“点击外部关闭”\r\n    const host = this._panel || document.body;\r\n    host.appendChild(menu);\r\n    // 阻止菜单内部的指针与点击事件向上冒泡，避免外层捕获到并关闭面板\r\n    const stopCap = (ev) => { try { ev.stopPropagation(); ev.stopImmediatePropagation?.(); } catch (_) { } };\r\n    const stopBub = (ev) => { try { ev.stopPropagation(); } catch (_) { } };\r\n    // 捕获阶段阻断指针类事件，防止外层关闭\r\n    menu.addEventListener('pointerdown', stopCap, { capture: true });\r\n    menu.addEventListener('pointerup', stopCap, { capture: true });\r\n    menu.addEventListener('contextmenu', stopCap, { capture: true });\r\n    // 冒泡阶段阻断 click（允许目标点击处理器先执行，再阻断向外层冒泡）\r\n    menu.addEventListener('click', stopBub, { capture: false });\r\n    this._stopMenuCap = stopCap;\r\n    this._stopMenuBubble = stopBub;\r\n    // 在面板内校正坐标，避免超出面板可视范围\r\n    try {\r\n      const w = menu.offsetWidth || 160;\r\n      const h = menu.offsetHeight || 10;\r\n      const hostRect = host.getBoundingClientRect();\r\n      // 将屏幕坐标转换为面板内坐标\r\n      let nx = x - hostRect.left;\r\n      let ny = y - hostRect.top;\r\n      nx = Math.min(Math.max(8, nx), Math.max(8, (hostRect.width - w - 8)));\r\n      ny = Math.min(Math.max(8, ny), Math.max(8, (hostRect.height - h - 8)));\r\n      menu.style.left = `${nx}px`;\r\n      menu.style.top = `${ny}px`;\r\n    } catch (_) { }\r\n\r\n    const onDocDown = (ev) => {\r\n      try { if (!menu.contains(ev.target)) this._closeMenu(); } catch (_) { }\r\n    };\r\n    const onKey = (ev) => { if (ev.key === 'Escape') this._closeMenu(); };\r\n    const onScroll = () => { this._closeMenu(); };\r\n    setTimeout(() => { // 延迟绑定以避免立即触发\r\n      document.addEventListener('pointerdown', onDocDown, { passive: true, capture: true });\r\n      window.addEventListener('scroll', onScroll, { passive: true });\r\n      window.addEventListener('resize', onScroll, { passive: true });\r\n      window.addEventListener('keydown', onKey, { passive: true });\r\n    }, 0);\r\n\r\n    this._menuEl = menu;\r\n    this._menuBallRef = ball;\r\n    this._onMenuDocDown = onDocDown;\r\n    this._onMenuScroll = onScroll;\r\n    this._onMenuKey = onKey;\r\n  }\r\n\r\n  _closeMenu() {\r\n    try {\r\n      if (this._menuEl?.parentElement) {\r\n        try {\r\n          // 解除菜单上为阻止冒泡/捕获绑定的监听\r\n          if (this._stopMenuCap) {\r\n            this._menuEl.removeEventListener('pointerdown', this._stopMenuCap, { capture: true });\r\n            this._menuEl.removeEventListener('pointerup', this._stopMenuCap, { capture: true });\r\n            this._menuEl.removeEventListener('contextmenu', this._stopMenuCap, { capture: true });\r\n          }\r\n          if (this._stopMenuBubble) {\r\n            this._menuEl.removeEventListener('click', this._stopMenuBubble, { capture: false });\r\n          }\r\n        } catch (_) { }\r\n        this._menuEl.parentElement.removeChild(this._menuEl);\r\n      }\r\n    } catch (_) { }\r\n    try {\r\n      if (this._onMenuDocDown) document.removeEventListener('pointerdown', this._onMenuDocDown, { capture: true });\r\n    } catch (_) { }\r\n    try { if (this._onMenuScroll) window.removeEventListener('scroll', this._onMenuScroll); } catch (_) { }\r\n    try { if (this._onMenuScroll) window.removeEventListener('resize', this._onMenuScroll); } catch (_) { }\r\n    try { if (this._onMenuKey) window.removeEventListener('keydown', this._onMenuKey); } catch (_) { }\r\n    this._menuEl = null; this._menuBallRef = null; this._stopMenuBubble = null; this._stopMenuCap = null;\r\n    this._onMenuDocDown = null; this._onMenuScroll = null; this._onMenuKey = null;\r\n  }\r\n\r\n  _isPointInTrash(clientX, clientY) {\r\n    try {\r\n      if (!this._trashZoneEl) return false;\r\n      const r = this._trashZoneEl.getBoundingClientRect();\r\n      return clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom;\r\n    } catch (_) { return false; }\r\n  }\r\n\r\n  _isPointInBox(clientX, clientY) {\r\n    try {\r\n      if (!this._boxEl) return false;\r\n      const r = this._boxEl.getBoundingClientRect();\r\n      return clientX >= r.left && clientX <= r.right && clientY >= r.top && clientY <= r.bottom;\r\n    } catch (_) { return false; }\r\n  }\r\n\r\n  // 触屏松弛命中：允许在主框边缘 slack 像素内判为“接近命中”\r\n  _isPointNearBox(clientX, clientY, slack = 24) {\r\n    try {\r\n      if (!this._boxEl) return false;\r\n      const r = this._boxEl.getBoundingClientRect();\r\n      const rs = { left: r.left - slack, top: r.top - slack, right: r.right + slack, bottom: r.bottom + slack };\r\n      return clientX >= rs.left && clientX <= rs.right && clientY >= rs.top && clientY <= rs.bottom;\r\n    } catch (_) { return false; }\r\n  }\r\n\r\n  _createGhostEl(ball) {\r\n    try {\r\n      const g = document.createElement('div');\r\n      const size = Math.round(ball.r * 2);\r\n      g.style.position = 'fixed';\r\n      g.style.left = '0px';\r\n      g.style.top = '0px';\r\n      g.style.width = `${size}px`;\r\n      g.style.height = `${size}px`;\r\n      g.style.borderRadius = '50%';\r\n      g.style.pointerEvents = 'none';\r\n      g.style.backdropFilter = 'none';\r\n      g.style.filter = 'none';\r\n      g.style.opacity = '0.7';\r\n      g.style.boxShadow = '0 6px 16px rgba(0,0,0,.35)';\r\n      // 复制背景和一个简单的文本（仅来源名，不显示数量以避免过密）\r\n      g.style.background = ball.el.style.background || 'rgba(255,255,255,.2)';\r\n      g.style.display = 'flex';\r\n      g.style.alignItems = 'center';\r\n      g.style.justifyContent = 'center';\r\n      g.style.color = '#fff';\r\n      g.style.fontSize = '11px';\r\n      g.style.userSelect = 'none';\r\n      g.style.zIndex = '999999';\r\n      g.textContent = ball.name || '';\r\n      document.body.appendChild(g);\r\n      ball._ghostEl = g;\r\n    } catch (_) { }\r\n  }\r\n\r\n  _removeGhostEl(ball) {\r\n    try {\r\n      if (ball?._ghostEl?.parentElement) {\r\n        ball._ghostEl.parentElement.removeChild(ball._ghostEl);\r\n      }\r\n    } catch (_) { }\r\n    ball._ghostEl = null;\r\n  }\r\n\r\n  async _moveBallToTrash(ball, persist = true) {\r\n    try {\r\n      this._closeMenu();\r\n      // 标记并移入垃圾桶容器，暂停物理与渲染\r\n      ball.inTrash = true;\r\n      ball.vx = 0; ball.vy = 0;\r\n      if (ball._ghostEl) this._removeGhostEl(ball);\r\n      ball.el.style.visibility = 'visible';\r\n      if (this._trashZoneEl && ball.el?.parentElement !== this._trashZoneEl) {\r\n        this._trashZoneEl.appendChild(ball.el);\r\n      }\r\n      // 作为列表项布局\r\n      ball.el.style.position = 'relative';\r\n      ball.el.style.transform = 'none';\r\n      ball.el.style.left = 'auto'; ball.el.style.top = 'auto';\r\n      ball.el.style.margin = '4px';\r\n      ball.el.style.zIndex = '1'; // 置于背景水印之上\r\n      // 更新设置：加入黑名单\r\n      if (persist) {\r\n        await this._blacklistUpdate(ball.name, true);\r\n      }\r\n    } catch (e) {\r\n      this.logger?.warn?.('[CommentPool] 移入垃圾桶失败', e);\r\n    } finally {\r\n      if (this._trashZoneEl) {\r\n        this._trashZoneEl.style.outlineColor = 'rgba(255,255,255,.25)';\r\n        this._trashZoneEl.style.background = 'rgba(255,255,255,.04)';\r\n      }\r\n    }\r\n  }\r\n\r\n  async _moveBallBackToBox(ball, clientX, clientY) {\r\n    try {\r\n      this._closeMenu();\r\n      // 从垃圾桶恢复到主容器，恢复物理\r\n      ball.inTrash = false;\r\n      if (this._boxEl && ball.el?.parentElement !== this._boxEl) {\r\n        this._boxEl.appendChild(ball.el);\r\n      }\r\n      ball.el.style.margin = '0';\r\n      ball.el.style.position = 'absolute';\r\n      ball.el.style.zIndex = ''; // 清理垃圾桶内的叠放样式\r\n      // 依据半径重新设置水印字号\r\n      try {\r\n        const r = ball.r;\r\n        const bgFS = Math.max(12, Math.round(r * 1.1));\r\n        if (ball.el && ball.el._bgWatermark) ball.el._bgWatermark.style.fontSize = `${bgFS}px`;\r\n      } catch (_) { }\r\n      // 设置回盒子坐标\r\n      const p = this._toLocal(clientX, clientY);\r\n      const rect = this._boxEl.getBoundingClientRect();\r\n      const W = rect.width, H = rect.height; const r = ball.r;\r\n      ball.x = Math.max(r, Math.min(W - r, p.x));\r\n      ball.y = Math.max(r, Math.min(H - r, p.y));\r\n      // 移除 transform 由渲染循环接管\r\n      // 黑名单移除\r\n      await this._blacklistUpdate(ball.name, false);\r\n    } catch (e) {\r\n      this.logger?.warn?.('[CommentPool] 恢复至主框失败', e);\r\n    } finally {\r\n      if (this._trashZoneEl) {\r\n        this._trashZoneEl.style.outlineColor = 'rgba(255,255,255,.25)';\r\n        this._trashZoneEl.style.background = 'rgba(255,255,255,.04)';\r\n      }\r\n    }\r\n  }\r\n\r\n  async _blacklistUpdate(name, add) {\r\n    try {\r\n      const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n      const s = g.danmakuSettings;\r\n      if (!(s?.get && s?.set)) return;\r\n      const raw = s.get('black_source_list') || '';\r\n      let arr = [];\r\n      if (typeof raw === 'string' && raw.trim()) {\r\n        try { const parsed = JSON.parse(raw.trim()); if (Array.isArray(parsed)) arr = parsed; } catch (_) {\r\n          arr = raw.split(',').map(x => x.trim()).filter(Boolean);\r\n        }\r\n      }\r\n      const key = String(name || '').trim().toLowerCase();\r\n      const lower = arr.map(x => String(x).toLowerCase());\r\n      if (add) {\r\n        if (!lower.includes(key)) arr.push(key);\r\n      } else {\r\n        arr = arr.filter(x => String(x).toLowerCase() !== key);\r\n      }\r\n      s.set('black_source_list', JSON.stringify(arr));\r\n      try { saveIfAutoOn(this.logger); } catch (e) { this.logger?.warn?.('[CommentPool] 保存 black_source_list 失败', e); }\r\n      this.logger?.info?.(`[CommentPool] ${add ? '已加入' : '已移除'}黑名单来源`, key);\r\n    } catch (e) {\r\n      this.logger?.warn?.('[CommentPool] 更新黑名单失败', e);\r\n    }\r\n  }\r\n\r\n  _toLocal(clientX, clientY) {\r\n    const rect = this._boxEl.getBoundingClientRect();\r\n    return { x: clientX - rect.left, y: clientY - rect.top };\r\n  }\r\n\r\n  _step = (t) => {\r\n    if (!this._boxEl?.isConnected) { this._raf = null; return; }\r\n    // 不可见（当前tab未激活）则暂停动画，待激活时由观察器恢复\r\n    if (this._panel && this._panel.getAttribute('data-active') !== 'true') {\r\n      this._raf = null;\r\n      return;\r\n    }\r\n    const dt = Math.min(32, (t - (this._lastT || t))) || 16; // ms\r\n    this._lastT = t;\r\n    const rect = this._boxEl.getBoundingClientRect();\r\n    const W = rect.width, H = rect.height;\r\n    // 已移除重力\r\n    // 空气阻力“力”系数基准：线性 c1（~Stokes，∝r），二次 c2（∝截面积∝r^2）\r\n    // 实际加速度 a = F/m，因此分量加速度：-(c1*r*v + c2*r^2*v|v|)/m\r\n    const c1 = 0.06;   // 线性阻力基准\r\n    const c2 = 0.0008; // 二次阻力基准（保持与改动前量级一致）\r\n    const bounce = 0.9;\r\n    // 质量中心吸引力（主框内球朝系统质心靠拢）\r\n    let sumM = 0, cx = 0, cy = 0, activeCount = 0;\r\n    for (const b of this._balls) {\r\n      if (b.inTrash) continue;\r\n      const m = b.mass || (b.r * b.r) || 1;\r\n      sumM += m; cx += (b.x || 0) * m; cy += (b.y || 0) * m; activeCount++;\r\n    }\r\n    if (sumM > 0) {\r\n      // 添加位于框中心的虚拟质量点，质量为所有（主框内）球的一半\r\n      const virtM = sumM * 0.5;\r\n      const totM = sumM + virtM;\r\n      const cxc = W / 2, cyc = H / 2;\r\n      cx = (cx + cxc * virtM) / totM;\r\n      cy = (cy + cyc * virtM) / totM;\r\n    } else {\r\n      cx = W / 2; cy = H / 2;\r\n    }\r\n    const kCoh = 0.045; // 吸引强度（越大越快收拢）\r\n    // 积分 & 边界\r\n    for (const b of this._balls) {\r\n      if (!b.dragging && !b.inTrash && !b.hoverPause) {\r\n        // 空气阻力：基于半径与质量的线性+二次模型\r\n        const m = b.mass || (b.r * b.r) || 1;\r\n        const r = b.r;\r\n        const axDrag = -((c1 * r) * b.vx + (c2 * r * r) * b.vx * Math.abs(b.vx)) / m;\r\n        const ayDrag = -((c1 * r) * b.vy + (c2 * r * r) * b.vy * Math.abs(b.vy)) / m;\r\n        b.vx += axDrag * dt;\r\n        b.vy += ayDrag * dt;\r\n        // 平滑随机漂移力（缓慢变化，带插值），按质量转为加速度\r\n        const DRIFT_LERP_TAU = 1000; // ms，越大越平滑\r\n        const DRIFT_SWITCH_MIN = 1500, DRIFT_SWITCH_MAX = 3500; // 切换周期范围\r\n        if (typeof b._driftNext !== 'number') b._driftNext = t + (1500 + Math.random() * 2000);\r\n        if (t >= b._driftNext) {\r\n          const ang = Math.random() * Math.PI * 2;\r\n          const FMIN = 0.4, FMAX = 1.2;\r\n          const mag = FMIN + Math.random() * (FMAX - FMIN);\r\n          b._driftTargetFx = Math.cos(ang) * mag;\r\n          b._driftTargetFy = Math.sin(ang) * mag;\r\n          b._driftNext = t + (DRIFT_SWITCH_MIN + Math.random() * (DRIFT_SWITCH_MAX - DRIFT_SWITCH_MIN));\r\n        }\r\n        const alpha = Math.min(1, dt / DRIFT_LERP_TAU);\r\n        b._driftFx = (b._driftFx || 0) + ((b._driftTargetFx || 0) - (b._driftFx || 0)) * alpha;\r\n        b._driftFy = (b._driftFy || 0) + ((b._driftTargetFy || 0) - (b._driftFy || 0)) * alpha;\r\n        b.vx += ((b._driftFx || 0) / m) * dt;\r\n        b.vy += ((b._driftFy || 0) / m) * dt;\r\n        // 质量中心吸引：沿与质量中心连线顺时针偏转70°的方向施力（右侧70度）\r\n        // 原始方向 v = (cx - b.x, cy - b.y)，旋转公式（顺时针θ）：\r\n        // v' = [ v.x*cos(-θ) - v.y*sin(-θ), v.x*sin(-θ) + v.y*cos(-θ) ]\r\n        // 注意：当仅有一个球时也生效，以虚拟质量点影响其轨迹\r\n        if (activeCount >= 1) {\r\n          const dxC = (cx - b.x);\r\n          const dyC = (cy - b.y);\r\n          const theta = -Math.PI * 70 / 180; // -70°，顺时针\r\n          const cosT = Math.cos(theta);\r\n          const sinT = Math.sin(theta);\r\n          const rx = dxC * cosT - dyC * sinT;\r\n          const ry = dxC * sinT + dyC * cosT;\r\n          b.vx += (kCoh * rx / m) * dt;\r\n          b.vy += (kCoh * ry / m) * dt;\r\n        }\r\n        // 低速阈值截断，避免无限抖动\r\n        if (Math.abs(b.vx) < 0.001) b.vx = 0;\r\n        if (Math.abs(b.vy) < 0.001) b.vy = 0;\r\n        b.x += b.vx * dt / 16; b.y += b.vy * dt / 16;\r\n      }\r\n      // 边界碰撞\r\n      if (!b.inTrash) {\r\n        if (b.x < b.r) { b.x = b.r; b.vx = Math.abs(b.vx) * bounce; }\r\n        if (b.x > W - b.r) { b.x = W - b.r; b.vx = -Math.abs(b.vx) * bounce; }\r\n        if (b.y < b.r) { b.y = b.r; b.vy = Math.abs(b.vy) * bounce; }\r\n        if (b.y > H - b.r) { b.y = H - b.r; b.vy = -Math.abs(b.vy) * bounce; b.vx *= 0.285; }\r\n      }\r\n    }\r\n    // 球-球碰撞（朴素 O(n^2)）\r\n    for (let i = 0; i < this._balls.length; i++) {\r\n      for (let j = i + 1; j < this._balls.length; j++) {\r\n        const a = this._balls[i], c = this._balls[j];\r\n        if (a.inTrash || c.inTrash) continue;\r\n        const dx = c.x - a.x, dy = c.y - a.y; const dist = Math.hypot(dx, dy) || 0.0001;\r\n        const minDist = a.r + c.r;\r\n        if (dist < minDist) {\r\n          const nx = dx / dist, ny = dy / dist; // 碰撞法线\r\n          const overlap = (minDist - dist);\r\n          // 质量权重：拖拽或悬停视为无限质量（invMass=0）\r\n          const invA = (a.dragging || a.hoverPause) ? 0 : 1 / (a.mass || (a.r * a.r) || 1);\r\n          const invC = (c.dragging || c.hoverPause) ? 0 : 1 / (c.mass || (c.r * c.r) || 1);\r\n          const invSum = invA + invC;\r\n          // 位置校正按逆质量比例分配\r\n          if (invSum > 0) {\r\n            const corr = overlap / invSum;\r\n            a.x -= nx * (corr * invA);\r\n            a.y -= ny * (corr * invA);\r\n            c.x += nx * (corr * invC);\r\n            c.y += ny * (corr * invC);\r\n          }\r\n          // 速度沿法线分离（可恢复系数 e=bounce）\r\n          const rvx = c.vx - a.vx, rvy = c.vy - a.vy;\r\n          const rel = rvx * nx + rvy * ny;\r\n          if (rel < 0 && invSum > 0) {\r\n            const e = 0.9;\r\n            const jImp = -(1 + e) * rel / invSum;\r\n            const impX = jImp * nx, impY = jImp * ny;\r\n            if (invA > 0) { a.vx -= impX * invA; a.vy -= impY * invA; }\r\n            if (invC > 0) { c.vx += impX * invC; c.vy += impY * invC; }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    // 渲染\r\n    for (const b of this._balls) {\r\n      if (b.inTrash) continue; // 垃圾桶中由布局/拖拽样式控制\r\n      const x = b.x - b.r, y = b.y - b.r;\r\n      b.el.style.transform = `translate(${Math.round(x)}px, ${Math.round(y)}px)`;\r\n    }\r\n    this._raf = requestAnimationFrame(this._step);\r\n  }\r\n\r\n  build() {\r\n    const panel = document.createElement('div');\r\n    panel.className = 'danmaku-settings-tabPanel';\r\n    panel.dataset.key = this.getKey();\r\n    this._panel = panel;\r\n\r\n    const list = document.createElement('div');\r\n    list.className = 'danmaku-settings-list';\r\n\r\n    const row = document.createElement('div');\r\n    row.className = 'danmaku-setting-row';\r\n    const label = document.createElement('div');\r\n    label.className = 'danmaku-setting-row__label';\r\n    const title = document.createElement('span');\r\n    title.className = 'danmaku-setting-row__labelText';\r\n    title.textContent = '弹幕来源';\r\n    label.appendChild(title);\r\n    row.appendChild(label);\r\n\r\n    // 辅助函数：创建可放置小球的区域（垃圾桶）\r\n    const makeZone = (label, align = 'left') => {\r\n      const z = document.createElement('div');\r\n      z.style.flex = '1';\r\n      z.style.minHeight = '48px';\r\n      z.style.border = '1px dashed rgba(255,255,255,.25)';\r\n      z.style.borderRadius = '8px';\r\n      z.style.display = 'flex';\r\n      z.style.alignItems = 'center';\r\n      z.style.justifyContent = align === 'left' ? 'flex-start' : 'flex-end';\r\n      z.style.padding = '8px 10px';\r\n      z.style.background = 'rgba(255,255,255,.04)';\r\n      z.style.outline = '2px solid transparent';\r\n      z.style.outlineColor = 'rgba(255,255,255,.25)';\r\n      z.style.flexWrap = 'wrap';\r\n      z.style.gap = '6px';\r\n      z.style.position = 'relative';\r\n      // 背景水印文字\r\n      const bg = document.createElement('div');\r\n      bg.style.position = 'absolute';\r\n      bg.style.left = '0';\r\n      bg.style.top = '0';\r\n      bg.style.right = '0';\r\n      bg.style.bottom = '0';\r\n      bg.style.display = 'flex';\r\n      bg.style.alignItems = 'center';\r\n      bg.style.justifyContent = 'center';\r\n      bg.style.pointerEvents = 'none';\r\n      bg.style.userSelect = 'none';\r\n      bg.style.fontSize = '30px';\r\n      bg.style.fontWeight = '700';\r\n      bg.style.letterSpacing = '0.3em';\r\n      bg.style.color = 'rgba(255,255,255,.12)';\r\n      bg.style.textShadow = '0 1px 2px rgba(0,0,0,.2)';\r\n      bg.style.zIndex = '0';\r\n      bg.textContent = label || '';\r\n      z.appendChild(bg);\r\n      return z;\r\n    };\r\n    const box = this._createBox();\r\n    this._boxEl = box;\r\n    row.appendChild(box);\r\n    // 将垃圾桶区域移动到主框下方（背景显示“黑名单”）\r\n    this._trashZoneEl = makeZone('黑名单', 'left');\r\n    // 触屏优化：垃圾桶区域允许纵向滚动，但拖拽小球本身会阻止默认\r\n    this._trashZoneEl.style.touchAction = 'pan-y';\r\n    this._trashZoneEl.style.margin = '8px 0 0 0';\r\n    row.appendChild(this._trashZoneEl);\r\n    const desc = document.createElement('div');\r\n    desc.className = 'danmaku-setting-row__desc';\r\n    // 图例：颜色-名称-数量 对照\r\n    desc.textContent = '';\r\n    const legendTitle = document.createElement('div');\r\n    legendTitle.style.fontWeight = '600';\r\n    legendTitle.style.margin = '2px 0 6px';\r\n    const legendWrap = document.createElement('div');\r\n    legendWrap.style.display = 'flex';\r\n    legendWrap.style.flexWrap = 'wrap';\r\n    legendWrap.style.gap = '8px 14px';\r\n    legendWrap.style.alignItems = 'center';\r\n    legendWrap.style.opacity = '0.95';\r\n    desc.appendChild(legendTitle);\r\n    desc.appendChild(legendWrap);\r\n    // 渲染函数：从 this._balls 生成图例项\r\n    const renderLegend = () => {\r\n      try {\r\n        if (!legendWrap) return;\r\n        legendWrap.innerHTML = '';\r\n        const balls = Array.isArray(this._balls) ? this._balls : [];\r\n        for (const b of balls) {\r\n          const item = document.createElement('div');\r\n          item.style.display = 'inline-flex';\r\n          item.style.alignItems = 'center';\r\n          item.style.lineHeight = '1.3';\r\n          const dot = document.createElement('span');\r\n          dot.style.width = '12px';\r\n          dot.style.height = '12px';\r\n          dot.style.borderRadius = '50%';\r\n          dot.style.display = 'inline-block';\r\n          dot.style.marginRight = '6px';\r\n          dot.style.boxShadow = '0 0 0 1px rgba(255,255,255,.25) inset, 0 0 4px rgba(0,0,0,.35)';\r\n          // 直接复用小球背景（包含高光与渐变）\r\n          try { dot.style.background = b?.el?.style?.background || '#999'; } catch (_) { dot.style.background = '#999'; }\r\n          const txt = document.createElement('span');\r\n          txt.style.fontSize = '12px';\r\n          txt.style.opacity = '0.95';\r\n          // const name = (b?.name ?? '').toString();\r\n          // const count = Number(b?.count || 0);\r\n          txt.textContent = (b?.name ?? '').toString();;\r\n          item.appendChild(dot);\r\n          item.appendChild(txt);\r\n          legendWrap.appendChild(item);\r\n        }\r\n      } catch (_) { /* 忽略图例渲染异常 */ }\r\n    };\r\n    row.appendChild(desc);\r\n\r\n    list.appendChild(row);\r\n    panel.appendChild(list);\r\n\r\n    // 数据与启动\r\n    const stats = this._readStats();\r\n    if (!stats) {\r\n      const empty = document.createElement('div');\r\n      empty.className = 'danmaku-setting-row__desc';\r\n      empty.style.opacity = '.8';\r\n      empty.textContent = '暂无来源统计数据。';\r\n      list.appendChild(empty);\r\n      return panel;\r\n    }\r\n    this._initBalls(stats);\r\n    // 初始化完小球后渲染一次图例\r\n    try { renderLegend(); } catch (_) { }\r\n    // 按初始黑名单将对应来源放入垃圾桶（仅视觉，不触发保存）\r\n    try {\r\n      const initialBlack = this._readInitialBlacklist();\r\n      if (initialBlack && initialBlack.set && initialBlack.set.size) {\r\n        for (const b of this._balls) {\r\n          const key = String(b.name || '').trim().toLowerCase();\r\n          if (initialBlack.set.has(key)) {\r\n            // 异步放入垃圾桶（仅视觉），不阻塞构建\r\n            this._moveBallToTrash(b, false).catch(() => { });\r\n          }\r\n        }\r\n        // 对于黑名单中但不在当前统计的数据源，创建计数为 0 的小球并放入垃圾桶\r\n        const present = new Set(this._balls.map(x => String(x.name || '').trim().toLowerCase()));\r\n        let extraIdx = 0;\r\n        for (const rawName of initialBlack.list) {\r\n          const key = String(rawName || '').trim().toLowerCase();\r\n          if (!key || present.has(key)) continue;\r\n          const r = 14; // 最小半径\r\n          const color = this._colorForIndex(this._balls.length + (extraIdx++));\r\n          const el = this._makeBallEl(`${rawName}\\n0`, color);\r\n          el.style.width = `${r * 2}px`;\r\n          el.style.height = `${r * 2}px`;\r\n          const bgFS = Math.max(12, Math.round(r * 1.1));\r\n          if (el._bgWatermark) el._bgWatermark.style.fontSize = `${bgFS}px`;\r\n          // 直接加入垃圾桶容器并按列表项布局\r\n          if (this._trashZoneEl) this._trashZoneEl.appendChild(el);\r\n          el.style.position = 'relative';\r\n          el.style.transform = 'none';\r\n          el.style.left = 'auto'; el.style.top = 'auto';\r\n          el.style.margin = '4px';\r\n          el.style.zIndex = '1';\r\n          // 初始化带漂移属性的小球（虽然在垃圾桶内不会参与物理，但便于拖回时直接生效）\r\n          const _ang = Math.random() * Math.PI * 2;\r\n          const _FMIN = 0.4, _FMAX = 1.2;\r\n          const _mag = _FMIN + Math.random() * (_FMAX - _FMIN);\r\n          const ball = {\r\n            el, name: rawName, count: 0, x: r, y: r,\r\n            vx: 0, vy: 0, r, mass: r * r, dragging: false, _px: 0, _py: 0, _pt: 0, inTrash: true,\r\n            _driftFx: 0, _driftFy: 0,\r\n            _driftTargetFx: Math.cos(_ang) * _mag,\r\n            _driftTargetFy: Math.sin(_ang) * _mag,\r\n            _driftNext: performance.now() + (1500 + Math.random() * 2000)\r\n          };\r\n          this._attachDrag(ball);\r\n          this._balls.push(ball);\r\n        }\r\n        // 黑名单额外小球加入后，刷新图例\r\n        try { renderLegend(); } catch (_) { }\r\n      }\r\n    } catch (_) { /* 忽略初始化黑名单异常 */ }\r\n    // 监听可见性变化：tab 切换时自动暂停/恢复\r\n    try {\r\n      this._activeMo = new MutationObserver(() => {\r\n        if (!this._panel?.isConnected) return;\r\n        const active = this._panel.getAttribute('data-active') === 'true';\r\n        if (active && !this._raf) {\r\n          this._lastT = 0;\r\n          this._raf = requestAnimationFrame(this._step);\r\n        }\r\n      });\r\n      this._activeMo.observe(panel, { attributes: true, attributeFilter: ['data-active'] });\r\n    } catch (_) { /* 忽略 */ }\r\n    // 自适应尺寸变化：收缩时收拢到容器内\r\n    try {\r\n      this._resizeOb = new ResizeObserver(() => {\r\n        if (!this._boxEl) return;\r\n        const { width: W, height: H } = this._boxEl.getBoundingClientRect();\r\n        for (const b of this._balls) {\r\n          b.x = Math.max(b.r, Math.min(W - b.r, b.x));\r\n          b.y = Math.max(b.r, Math.min(H - b.r, b.y));\r\n        }\r\n      });\r\n      this._resizeOb.observe(this._boxEl);\r\n    } catch (_) { /* 忽略 */ }\r\n    // 初始若可见则启动动画\r\n    if (panel.getAttribute('data-active') === 'true') {\r\n      this._raf = requestAnimationFrame(this._step);\r\n    }\r\n    return panel;\r\n  }\r\n\r\n  // 清理资源，供上层在页面销毁/对话框关闭时调用\r\n  destroy() {\r\n    try { if (this._raf) cancelAnimationFrame(this._raf); } catch (_) { }\r\n    this._raf = null;\r\n    this._lastT = 0;\r\n    try { this._activeMo?.disconnect(); } catch (_) { }\r\n    this._activeMo = null;\r\n    try { this._resizeOb?.disconnect(); } catch (_) { }\r\n    this._resizeOb = null;\r\n    // 解绑 window 事件\r\n    for (const b of this._balls) {\r\n      if (b?._onDown) { try { b.el.removeEventListener('pointerdown', b._onDown); } catch (_) { } }\r\n      if (b?._onMove) { try { window.removeEventListener('pointermove', b._onMove); } catch (_) { } }\r\n      if (b?._onUp) { try { window.removeEventListener('pointerup', b._onUp); } catch (_) { } }\r\n      if (b?._onCancel) { try { window.removeEventListener('pointercancel', b._onCancel); } catch (_) { } }\r\n      if (b?._onEnter) { try { b.el.removeEventListener('pointerenter', b._onEnter); } catch (_) { } }\r\n      if (b?._onLeave) { try { b.el.removeEventListener('pointerleave', b._onLeave); } catch (_) { } }\r\n      if (b?._onCtx) { try { b.el.removeEventListener('contextmenu', b._onCtx); } catch (_) { } }\r\n      // 清理幽灵球\r\n      if (b?._ghostEl) { try { this._removeGhostEl(b); } catch (_) { } }\r\n      b._onMove = null; b._onUp = null; b._onCancel = null;\r\n    }\r\n    try { this._closeMenu(); } catch (_) { }\r\n    this._trashZoneEl = null;\r\n  }\r\n}\r\n","// 搜索弹幕分页：首页顶部信息框 + 远端匹配数据获取\r\n// 约定接口：getKey/getLabel/build/destroy\r\nimport { saveIfAutoOn } from \"../../api/utils\";\r\n\r\nexport class SearchDanmakuPage {\r\n    constructor(opts = {}) {\r\n        this.logger = opts.logger || null;\r\n        this._panel = null;\r\n        this._headerBox = null;\r\n        this._imgEl = null;\r\n        this._titleValEl = null;\r\n        this._episodeTitleEl = null;\r\n        this._idValEl = null;\r\n        this._epIdValEl = null;\r\n        this._offsetInput = null;\r\n        this._matchData = null;\r\n        this._unbinds = [];\r\n        this._searchInput = null;\r\n        this._searchBtn = null;\r\n        this._searchPlaceholder = null;\r\n        this._resultsWrap = null;\r\n        this._listWrap = null;\r\n        this._detailWrap = null;\r\n        this._selectedItem = null;\r\n        this._detailUnbinds = [];\r\n        this._isAnimating = false;\r\n    }\r\n    getKey() { return 'search'; }\r\n    getLabel() { return '搜索弹幕'; }\r\n\r\n    build() {\r\n        const panel = document.createElement('div');\r\n        panel.className = 'danmaku-settings-tabPanel';\r\n        panel.dataset.key = this.getKey();\r\n        this._panel = panel;\r\n\r\n        // 顶部信息框\r\n        const header = document.createElement('div');\r\n        header.style.display = 'flex';\r\n        header.style.alignItems = 'stretch';\r\n        header.style.gap = '10px';\r\n        header.style.border = '1px solid rgba(255,255,255,.12)';\r\n        header.style.borderRadius = '8px';\r\n        header.style.background = 'rgba(255,255,255,.05)';\r\n        header.style.padding = '10px';\r\n        header.style.minHeight = '110px';\r\n        header.style.boxSizing = 'border-box';\r\n        header.style.overflow = 'hidden';\r\n        this._headerBox = header;\r\n\r\n        // 左侧图片（不超过整体宽度 1/4；高度等于容器高度）\r\n        const leftWrap = document.createElement('div');\r\n        leftWrap.style.flex = '0 0 25%';\r\n        leftWrap.style.maxWidth = '25%';\r\n        leftWrap.style.borderRadius = '6px';\r\n        leftWrap.style.overflow = 'hidden';\r\n        leftWrap.style.background = 'rgba(0,0,0,.2)';\r\n        const img = document.createElement('img');\r\n        img.alt = '海报';\r\n        img.style.display = 'block';\r\n        img.style.width = '100%';\r\n        img.style.height = '100%';\r\n        img.style.objectFit = 'cover';\r\n        img.style.background = 'rgba(0,0,0,.3)';\r\n        img.referrerPolicy = 'no-referrer';\r\n        this._imgEl = img;\r\n        leftWrap.appendChild(img);\r\n        header.appendChild(leftWrap);\r\n\r\n        // 右侧信息\r\n        const rightWrap = document.createElement('div');\r\n        rightWrap.style.flex = '1 1 auto';\r\n        rightWrap.style.display = 'flex';\r\n        rightWrap.style.flexDirection = 'column';\r\n        rightWrap.style.gap = '8px';\r\n\r\n        const makeLine = (labelText, valueNode) => {\r\n            const line = document.createElement('div');\r\n            line.style.display = 'flex';\r\n            line.style.gap = '8px';\r\n            line.style.alignItems = 'center';\r\n            const lab = document.createElement('span');\r\n            lab.textContent = labelText;\r\n            lab.style.opacity = '.8';\r\n            lab.style.minWidth = '64px';\r\n            lab.style.fontSize = '12px';\r\n            const val = valueNode || document.createElement('span');\r\n            val.style.fontSize = '13px';\r\n            val.style.wordBreak = 'break-all';\r\n            line.appendChild(lab);\r\n            line.appendChild(val);\r\n            return { line, val };\r\n        };\r\n\r\n        const titleNode = document.createElement('span');\r\n        titleNode.textContent = '加载中…';\r\n        const titleLine = makeLine('标题:', titleNode);\r\n        this._titleValEl = titleNode;\r\n\r\n        // 本集标题（来自全局 danmakuData.episodeTitle）\r\n        const epTitleNode = document.createElement('span');\r\n        try {\r\n            const gInit = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n            epTitleNode.textContent = gInit?.danmakuData?.episodeTitle || '--';\r\n        } catch (_) { epTitleNode.textContent = '--'; }\r\n        const epTitleLine = makeLine('本集标题:', epTitleNode);\r\n        this._episodeTitleEl = epTitleNode;\r\n\r\n        const idNode = document.createElement('span');\r\n        idNode.textContent = '--';\r\n        const idLine = makeLine('anime_id:', idNode);\r\n        this._idValEl = idNode;\r\n\r\n        const offsetInput = document.createElement('input');\r\n        offsetInput.type = 'text';\r\n        offsetInput.value = '0';\r\n        offsetInput.className = 'danmaku-setting-input';\r\n        offsetInput.style.width = '3ch';\r\n        offsetInput.style.padding = '4px 6px';\r\n        offsetInput.style.fontSize = '12px';\r\n        offsetInput.step = '1';\r\n        offsetInput.min = '-9999';\r\n        offsetInput.max = '9999';\r\n        this._offsetInput = offsetInput;\r\n        // 右侧“更新”按钮\r\n        const updateBtn = document.createElement('button');\r\n        updateBtn.type = 'button';\r\n        updateBtn.textContent = '更新';\r\n        updateBtn.style.border = '1px solid rgba(255,255,255,.28)';\r\n        updateBtn.style.background = 'rgba(255,255,255,.10)';\r\n        updateBtn.style.color = '#fff';\r\n        updateBtn.style.borderRadius = '6px';\r\n        updateBtn.style.fontSize = '12px';\r\n        updateBtn.style.padding = '6px 10px';\r\n        updateBtn.style.cursor = 'pointer';\r\n        updateBtn.style.whiteSpace = 'nowrap';\r\n        const offsetValueWrap = document.createElement('div');\r\n        offsetValueWrap.style.display = 'flex';\r\n        offsetValueWrap.style.alignItems = 'center';\r\n        offsetValueWrap.style.gap = '8px';\r\n        offsetValueWrap.appendChild(offsetInput);\r\n        offsetValueWrap.appendChild(updateBtn);\r\n        const offsetLine = makeLine('集数偏移:', offsetValueWrap);\r\n        // ep_id 展示（位于集数偏移下方）\r\n        const epIdNode = document.createElement('span');\r\n        epIdNode.textContent = '--';\r\n        const epIdLine = makeLine('ep_id:', epIdNode);\r\n        this._epIdValEl = epIdNode;\r\n        const onOffsetChange = () => {\r\n            let v = parseInt(offsetInput.value, 10);\r\n            if (!Number.isFinite(v)) v = 0;\r\n            if (v < -9999) v = -9999; else if (v > 9999) v = 9999;\r\n            offsetInput.value = String(v);\r\n            if (this._matchData) this._matchData.offset = v;\r\n            try {\r\n                const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                g.danmakuMatchData = { ...(g.danmakuMatchData || {}), ...this._matchData };\r\n            } catch (_) { }\r\n            this.logger?.info?.('[Search] offset ->', v);\r\n        };\r\n        offsetInput.addEventListener('change', onOffsetChange);\r\n        offsetInput.addEventListener('input', () => {\r\n            // 轻量跟随，但不触发过多日志\r\n            let v = parseInt(offsetInput.value, 10);\r\n            if (!Number.isFinite(v)) return;\r\n            if (this._matchData) this._matchData.offset = v;\r\n        });\r\n        this._unbinds.push(() => { try { offsetInput.removeEventListener('change', onOffsetChange); } catch (_) { } });\r\n        // 更新按钮点击：仅发送，不修改本地\r\n        const onUpdateClick = async () => {\r\n            try {\r\n                if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) {\r\n                    this.logger?.warn?.('[Search] 无法更新：缺少 ApiClient');\r\n                    return;\r\n                }\r\n                const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                const item_id = g.getMediaId?.();\r\n                if (!item_id) { this.logger?.warn?.('[Search] 无法更新：缺少 item_id'); return; }\r\n                let v = parseInt(offsetInput.value, 10);\r\n                if (!Number.isFinite(v)) v = 0;\r\n                const url = ApiClient.getUrl('danmaku/match_data');\r\n                updateBtn.disabled = true;\r\n                updateBtn.textContent = '更新中…';\r\n                const form = new URLSearchParams();\r\n                form.append('item_id', String(item_id));\r\n                form.append('offset', String(v));\r\n                await ApiClient.ajax({\r\n                    type: 'POST',\r\n                    url,\r\n                    data: form.toString(),\r\n                    contentType: 'application/x-www-form-urlencoded; charset=UTF-8',\r\n                    dataType: 'json'\r\n                });\r\n                const p = saveIfAutoOn(this.logger);\r\n                // 根据返回 Promise 结果刷新“本集标题”\r\n                try {\r\n                    if (p && typeof p.then === 'function') {\r\n                        p.then(val => {\r\n                            if (val) {\r\n                                try {\r\n                                    const g2 = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                                    const newEpTitle = g2?.danmakuData?.episodeTitle || '--';\r\n                                    if (this._episodeTitleEl) this._episodeTitleEl.textContent = newEpTitle;\r\n                                } catch (_) { }\r\n                            }\r\n                        }).catch(() => { });\r\n                    }\r\n                } catch (_) { }\r\n                this.logger?.info?.('[Search] 已提交匹配偏移更新', { item_id, offset: v });\r\n            } catch (e) {\r\n                this.logger?.warn?.('[Search] 提交偏移更新失败', e);\r\n            } finally {\r\n                try { updateBtn.disabled = false; updateBtn.textContent = '更新'; } catch (_) { }\r\n            }\r\n        };\r\n        updateBtn.addEventListener('click', onUpdateClick);\r\n        this._unbinds.push(() => { try { updateBtn.removeEventListener('click', onUpdateClick); } catch (_) { } });\r\n\r\n        rightWrap.appendChild(titleLine.line);\r\n        rightWrap.appendChild(epTitleLine.line);\r\n        rightWrap.appendChild(idLine.line);\r\n        rightWrap.appendChild(offsetLine.line);\r\n        rightWrap.appendChild(epIdLine.line);\r\n        header.appendChild(rightWrap);\r\n\r\n        // 内容容器（为后续搜索 UI 预留）\r\n        const list = document.createElement('div');\r\n        list.className = 'danmaku-settings-list';\r\n        // 先只放顶部信息框\r\n        list.appendChild(header);\r\n\r\n        // 信息栏与搜索栏之间：删除已匹配结果（整栏可点击，红色）\r\n        const deleteBar = document.createElement('div');\r\n        deleteBar.textContent = '删除已匹配结果';\r\n        deleteBar.style.marginTop = '10px';\r\n        deleteBar.style.height = '36px';\r\n        deleteBar.style.lineHeight = '36px';\r\n        deleteBar.style.textAlign = 'center';\r\n        deleteBar.style.color = '#fff';\r\n        deleteBar.style.fontSize = '13px';\r\n        deleteBar.style.fontWeight = '600';\r\n        deleteBar.style.background = 'rgba(220, 53, 69, 0.95)'; // 红色\r\n        deleteBar.style.border = '1px solid rgba(255,255,255,.18)';\r\n        deleteBar.style.borderRadius = '8px';\r\n        deleteBar.style.cursor = 'pointer';\r\n        deleteBar.style.userSelect = 'none';\r\n        deleteBar.style.transition = 'filter .12s ease, opacity .12s ease';\r\n        deleteBar.addEventListener('mouseenter', () => { try { deleteBar.style.filter = 'brightness(1.05)'; } catch (_) {} });\r\n        deleteBar.addEventListener('mouseleave', () => { try { deleteBar.style.filter = 'none'; } catch (_) {} });\r\n\r\n        const onDeleteClick = async () => {\r\n            try {\r\n                // 二次确认\r\n                // eslint-disable-next-line no-alert\r\n                const ok = window.confirm?.('确认删除已匹配结果？此操作将清空信息栏数据。');\r\n                if (!ok) return;\r\n                if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) {\r\n                    this.logger?.warn?.('[Search] 无法删除：缺少 ApiClient');\r\n                    return;\r\n                }\r\n                const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                const item_id = g.getMediaId?.();\r\n                if (!item_id) {\r\n                    this.logger?.warn?.('[Search] 无法删除：缺少 item_id');\r\n                    return;\r\n                }\r\n                const prevText = deleteBar.textContent;\r\n                deleteBar.textContent = '处理中…';\r\n                deleteBar.style.opacity = '0.85';\r\n                deleteBar.style.pointerEvents = 'none';\r\n                const url = ApiClient.getUrl(`danmaku/del_match?item_id=${encodeURIComponent(String(item_id))}`);\r\n                // 无需解析返回体\r\n                await ApiClient.ajax({ type: 'GET', url });\r\n                // 成功后清空信息栏数据\r\n                this._clearHeaderInfo();\r\n                this.logger?.info?.('[Search] 已删除匹配结果', { item_id });\r\n            } catch (e) {\r\n                this.logger?.warn?.('[Search] 删除匹配结果失败', e);\r\n            } finally {\r\n                try {\r\n                    deleteBar.textContent = '删除已匹配结果';\r\n                    deleteBar.style.opacity = '';\r\n                    deleteBar.style.pointerEvents = '';\r\n                } catch (_) { }\r\n            }\r\n        };\r\n        deleteBar.addEventListener('click', onDeleteClick);\r\n        this._unbinds.push(() => { try { deleteBar.removeEventListener('click', onDeleteClick); } catch (_) { } });\r\n        list.appendChild(deleteBar);\r\n\r\n        // 信息栏下方的搜索栏\r\n        const searchWrap = document.createElement('div');\r\n        searchWrap.style.position = 'relative';\r\n        searchWrap.style.marginTop = '10px';\r\n        searchWrap.style.height = '36px';\r\n        searchWrap.style.display = 'block';\r\n\r\n        const searchInput = document.createElement('input');\r\n        searchInput.type = 'text';\r\n        searchInput.autocomplete = 'off';\r\n        searchInput.spellcheck = false;\r\n        searchInput.className = 'danmaku-setting-input';\r\n        searchInput.style.boxSizing = 'border-box';\r\n        searchInput.style.width = '100%';\r\n        searchInput.style.height = '36px';\r\n        searchInput.style.padding = '0 40px 0 12px';\r\n        searchInput.style.fontSize = '13px';\r\n        searchInput.style.border = '1px solid rgba(255,255,255,.18)';\r\n        searchInput.style.background = 'rgba(255,255,255,.06)';\r\n        searchInput.style.color = '#fff';\r\n        searchInput.style.borderRadius = '8px';\r\n        searchInput.style.outline = 'none';\r\n        this._searchInput = searchInput;\r\n\r\n        // 居中占位提示（仅在未聚焦且无内容时显示）\r\n        const placeholder = document.createElement('span');\r\n        placeholder.textContent = '搜索';\r\n        placeholder.style.position = 'absolute';\r\n        placeholder.style.left = '0';\r\n        placeholder.style.right = '40px';\r\n        placeholder.style.top = '0';\r\n        placeholder.style.bottom = '0';\r\n        placeholder.style.display = 'flex';\r\n        placeholder.style.alignItems = 'center';\r\n        placeholder.style.justifyContent = 'center';\r\n        placeholder.style.color = 'rgba(255,255,255,.5)';\r\n        placeholder.style.pointerEvents = 'none';\r\n        placeholder.style.fontSize = '13px';\r\n        this._searchPlaceholder = placeholder;\r\n\r\n        // 放大镜按钮（靠右）\r\n        const searchBtn = document.createElement('button');\r\n        searchBtn.type = 'button';\r\n        searchBtn.title = '搜索';\r\n        searchBtn.style.position = 'absolute';\r\n        searchBtn.style.top = '0';\r\n        searchBtn.style.right = '0';\r\n        searchBtn.style.height = '100%';\r\n        searchBtn.style.width = '36px';\r\n        searchBtn.style.border = '1px solid rgba(255,255,255,.18)';\r\n        searchBtn.style.borderLeft = 'none';\r\n        searchBtn.style.background = 'rgba(255,255,255,.10)';\r\n        searchBtn.style.color = '#fff';\r\n        searchBtn.style.cursor = 'pointer';\r\n        searchBtn.style.borderTopRightRadius = '8px';\r\n        searchBtn.style.borderBottomRightRadius = '8px';\r\n        searchBtn.style.display = 'flex';\r\n        searchBtn.style.alignItems = 'center';\r\n        searchBtn.style.justifyContent = 'center';\r\n        // 线条风格放大镜图标（SVG）\r\n        const svgNS = 'http://www.w3.org/2000/svg';\r\n        const icon = document.createElementNS(svgNS, 'svg');\r\n        icon.setAttribute('viewBox', '0 0 24 24');\r\n        icon.setAttribute('width', '18');\r\n        icon.setAttribute('height', '18');\r\n        icon.style.pointerEvents = 'none';\r\n        const circle = document.createElementNS(svgNS, 'circle');\r\n        circle.setAttribute('cx', '11');\r\n        circle.setAttribute('cy', '11');\r\n        circle.setAttribute('r', '7');\r\n        circle.setAttribute('fill', 'none');\r\n        circle.setAttribute('stroke', 'currentColor');\r\n        circle.setAttribute('stroke-width', '2');\r\n        const line = document.createElementNS(svgNS, 'line');\r\n        line.setAttribute('x1', '16.5');\r\n        line.setAttribute('y1', '16.5');\r\n        line.setAttribute('x2', '21');\r\n        line.setAttribute('y2', '21');\r\n        line.setAttribute('stroke', 'currentColor');\r\n        line.setAttribute('stroke-width', '2');\r\n        line.setAttribute('stroke-linecap', 'round');\r\n        icon.appendChild(circle);\r\n        icon.appendChild(line);\r\n        searchBtn.appendChild(icon);\r\n        this._searchBtn = searchBtn;\r\n\r\n        // 占位显示控制\r\n        const updatePlaceholder = () => {\r\n            const focused = document.activeElement === searchInput;\r\n            const hasText = !!searchInput.value && searchInput.value.trim().length > 0;\r\n            placeholder.style.display = (!focused && !hasText) ? 'flex' : 'none';\r\n        };\r\n        const onFocus = () => updatePlaceholder();\r\n        const onBlur = () => updatePlaceholder();\r\n        const onInput = () => updatePlaceholder();\r\n        const onSearchClick = () => { try { searchInput.focus(); } catch (_) { } };\r\n        searchInput.addEventListener('focus', onFocus);\r\n        searchInput.addEventListener('blur', onBlur);\r\n        searchInput.addEventListener('input', onInput);\r\n        searchBtn.addEventListener('click', onSearchClick);\r\n        this._unbinds.push(() => { try { searchInput.removeEventListener('focus', onFocus); } catch (_) { } });\r\n        this._unbinds.push(() => { try { searchInput.removeEventListener('blur', onBlur); } catch (_) { } });\r\n        this._unbinds.push(() => { try { searchInput.removeEventListener('input', onInput); } catch (_) { } });\r\n        this._unbinds.push(() => { try { searchBtn.removeEventListener('click', onSearchClick); } catch (_) { } });\r\n\r\n        // 组装\r\n        searchWrap.appendChild(searchInput);\r\n        searchWrap.appendChild(placeholder);\r\n        searchWrap.appendChild(searchBtn);\r\n        // 添加到列表\r\n        list.appendChild(searchWrap);\r\n\r\n        // 结果容器（两列布局）\r\n        const resultsWrap = document.createElement('div');\r\n        resultsWrap.style.marginTop = '12px';\r\n        resultsWrap.style.display = 'grid';\r\n        resultsWrap.style.gridTemplateColumns = '1fr 1fr';\r\n        resultsWrap.style.gap = '12px';\r\n        this._resultsWrap = resultsWrap;\r\n        list.appendChild(resultsWrap);\r\n\r\n        panel.appendChild(list);\r\n        this._listWrap = list;\r\n        // 绑定搜索事件\r\n        this._bindSearchActions();\r\n\r\n        // 异步获取匹配数据与 ep_id\r\n        Promise.resolve().then(() => { this._fetchMatchData(); this._fetchEpId(); });\r\n        return panel;\r\n    }\r\n\r\n    _bindSearchActions() {\r\n        if (!this._searchInput || !this._searchBtn) return;\r\n        const doSearch = () => this._doSearch();\r\n        const onKeyDown = (e) => { if (e.key === 'Enter') { e.preventDefault?.(); doSearch(); } };\r\n        this._searchInput.addEventListener('keydown', onKeyDown);\r\n        this._searchBtn.addEventListener('click', doSearch);\r\n        this._unbinds.push(() => { try { this._searchInput.removeEventListener('keydown', onKeyDown); } catch (_) { } });\r\n        this._unbinds.push(() => { try { this._searchBtn.removeEventListener('click', doSearch); } catch (_) { } });\r\n    }\r\n\r\n    async _doSearch() {\r\n        try {\r\n            const q = (this._searchInput?.value || '').trim();\r\n            if (!q) { this._renderSearchResults([]); return; }\r\n            if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) {\r\n                this.logger?.warn?.('[Search] 缺少 ApiClient，无法搜索');\r\n                return;\r\n            }\r\n            // 简易加载态\r\n            this._renderSearchLoading();\r\n            const url = ApiClient.getUrl(`danmaku/search?keyword=${encodeURIComponent(q)}`);\r\n            const res = await ApiClient.ajax({ type: 'GET', url, dataType: 'json' });\r\n            const animes = Array.isArray(res?.animes) ? res.animes : [];\r\n            this.logger?.info?.('[Search] 搜索结果', { 关键字: q, 数量: animes.length });\r\n            this._renderSearchResults(animes);\r\n        } catch (e) {\r\n            this.logger?.warn?.('[Search] 搜索失败', e);\r\n            this._renderSearchError();\r\n        }\r\n    }\r\n\r\n    _renderSearchLoading() {\r\n        if (!this._resultsWrap) return;\r\n        this._resultsWrap.innerHTML = '';\r\n        const tip = document.createElement('div');\r\n        tip.textContent = '正在搜索…';\r\n        tip.style.opacity = '.8';\r\n        tip.style.fontSize = '13px';\r\n        tip.style.gridColumn = '1 / -1';\r\n        this._resultsWrap.appendChild(tip);\r\n    }\r\n\r\n    _renderSearchError() {\r\n        if (!this._resultsWrap) return;\r\n        this._resultsWrap.innerHTML = '';\r\n        const tip = document.createElement('div');\r\n        tip.textContent = '搜索失败';\r\n        tip.style.color = '#e66';\r\n        tip.style.fontSize = '13px';\r\n        tip.style.gridColumn = '1 / -1';\r\n        this._resultsWrap.appendChild(tip);\r\n    }\r\n\r\n    _renderSearchResults(animes) {\r\n        if (!this._resultsWrap) return;\r\n        this._resultsWrap.innerHTML = '';\r\n        if (!animes || animes.length === 0) {\r\n            const tip = document.createElement('div');\r\n            tip.textContent = '无结果';\r\n            tip.style.opacity = '.7';\r\n            tip.style.fontSize = '13px';\r\n            tip.style.gridColumn = '1 / -1';\r\n            this._resultsWrap.appendChild(tip);\r\n            return;\r\n        }\r\n        for (const it of animes) {\r\n            const card = this._createResultCard(it);\r\n            // 点击进入二级页面\r\n            card.style.cursor = 'pointer';\r\n            card.style.userSelect = 'none';\r\n            card.addEventListener('click', () => { try { this._enterDetail(it); } catch (_) { } });\r\n            this._resultsWrap.appendChild(card);\r\n        }\r\n    }\r\n\r\n    _createResultCard(item) {\r\n        const card = document.createElement('div');\r\n        card.style.border = '1px solid rgba(255,255,255,.12)';\r\n        card.style.borderRadius = '8px';\r\n        card.style.background = 'rgba(255,255,255,.04)';\r\n        card.style.overflow = 'hidden';\r\n        card.style.position = 'relative';\r\n        try { card.style.aspectRatio = '2 / 3'; } catch (_) { }\r\n\r\n        // 图片层（充满卡片）\r\n        const topBox = document.createElement('div');\r\n        topBox.style.position = 'absolute';\r\n        topBox.style.left = '0';\r\n        topBox.style.right = '0';\r\n        topBox.style.top = '0';\r\n        topBox.style.bottom = '0';\r\n        topBox.style.background = 'transparent';\r\n        topBox.style.overflow = 'hidden';\r\n        topBox.style.zIndex = '1';\r\n\r\n        const img = document.createElement('img');\r\n        img.alt = item?.animeTitle || '';\r\n        img.referrerPolicy = 'no-referrer';\r\n        img.style.width = '100%';\r\n        img.style.height = '100%';\r\n        img.style.objectFit = 'contain'; // 小图不拉伸，留白用于露出背景色\r\n        img.style.objectPosition = 'center center';\r\n        img.style.transition = 'transform .15s ease';\r\n        img.style.transformOrigin = 'center center';\r\n\r\n        const src = item?.imageUrl || '';\r\n        if (src) img.src = src; else img.removeAttribute('src');\r\n\r\n        img.onerror = () => {\r\n            try {\r\n                img.style.display = 'none';\r\n                topBox.style.background = 'transparent';\r\n            } catch (_) { }\r\n        };\r\n        img.onload = () => {\r\n            try {\r\n                if (!img.src) return;\r\n                img.style.display = '';\r\n                topBox.style.background = 'transparent';\r\n            } catch (_) { }\r\n        };\r\n        topBox.appendChild(img);\r\n        card.appendChild(topBox);\r\n\r\n        // 覆盖文字层（叠在底部，半透明黑底）\r\n        const overlay = document.createElement('div');\r\n        overlay.style.position = 'absolute';\r\n        overlay.style.left = '0';\r\n        overlay.style.right = '0';\r\n        overlay.style.bottom = '0';\r\n        overlay.style.background = 'rgba(0,0,0,.5)';\r\n        overlay.style.color = '#fff';\r\n        overlay.style.padding = '6px 8px';\r\n        overlay.style.display = 'flex';\r\n        overlay.style.flexDirection = 'column';\r\n        overlay.style.gap = '2px';\r\n        overlay.style.zIndex = '2';\r\n        overlay.style.transformOrigin = 'bottom left';\r\n        overlay.style.transition = 'transform .15s ease';\r\n\r\n        const title = document.createElement('div');\r\n        title.textContent = item?.animeTitle || '--';\r\n        title.style.fontSize = '12px';\r\n        title.style.fontWeight = '600';\r\n        title.style.lineHeight = '1.3';\r\n        title.style.whiteSpace = 'nowrap';\r\n        title.style.overflow = 'hidden';\r\n        title.style.textOverflow = 'ellipsis';\r\n\r\n        const type = document.createElement('div');\r\n        type.textContent = item?.typeDescription || item?.type || '';\r\n        type.style.opacity = '.9';\r\n        type.style.fontSize = '11px';\r\n        type.style.whiteSpace = 'nowrap';\r\n        type.style.overflow = 'hidden';\r\n        type.style.textOverflow = 'ellipsis';\r\n\r\n        overlay.appendChild(title);\r\n        overlay.appendChild(type);\r\n        card.appendChild(overlay);\r\n\r\n        // 悬停时放大文字\r\n        card.addEventListener('mouseenter', () => {\r\n            try { overlay.style.transform = 'scale(1.05)'; } catch (_) { }\r\n            try { img.style.transform = 'scale(0.97)'; } catch (_) { }\r\n        });\r\n        card.addEventListener('mouseleave', () => {\r\n            try { overlay.style.transform = 'scale(1)'; } catch (_) { }\r\n            try { img.style.transform = 'scale(1)'; } catch (_) { }\r\n        });\r\n\r\n        return card;\r\n    }\r\n\r\n    _enterDetail(item) {\r\n        try {\r\n            if (this._isAnimating) return;\r\n            this._isAnimating = true;\r\n            this._selectedItem = item || null;\r\n            // 确保列表视图可见以进行动画\r\n            if (this._listWrap) this._listWrap.style.display = '';\r\n\r\n            // 若已存在详情容器，先移除\r\n            if (this._detailWrap && this._detailWrap.parentNode) {\r\n                try { this._detailWrap.parentNode.removeChild(this._detailWrap); } catch (_) { }\r\n            }\r\n            this._detailWrap = document.createElement('div');\r\n            this._detailWrap.style.position = 'relative';\r\n            this._detailWrap.style.display = 'block';\r\n            this._detailWrap.style.minHeight = '200px';\r\n            this._detailWrap.style.border = '1px solid rgba(255,255,255,.12)';\r\n            this._detailWrap.style.borderRadius = '8px';\r\n            this._detailWrap.style.padding = '10px';\r\n            this._detailWrap.style.background = 'rgba(255,255,255,.04)';\r\n\r\n            // 顶部返回按钮\r\n            const backBtn = document.createElement('button');\r\n            backBtn.type = 'button';\r\n            backBtn.textContent = '← 返回';\r\n            backBtn.style.border = '1px solid rgba(255,255,255,.28)';\r\n            backBtn.style.background = 'rgba(255,255,255,.10)';\r\n            backBtn.style.color = '#fff';\r\n            backBtn.style.borderRadius = '6px';\r\n            backBtn.style.fontSize = '12px';\r\n            backBtn.style.padding = '6px 10px';\r\n            backBtn.style.cursor = 'pointer';\r\n            backBtn.style.marginBottom = '10px';\r\n            const onBack = () => { this._exitDetail(); };\r\n            backBtn.addEventListener('click', onBack);\r\n            this._detailUnbinds.push(() => { try { backBtn.removeEventListener('click', onBack); } catch (_) { } });\r\n            this._detailWrap.appendChild(backBtn);\r\n\r\n            // 简单详情内容（占位，可后续扩展）\r\n            const row = document.createElement('div');\r\n            row.style.display = 'flex';\r\n            row.style.gap = '12px';\r\n            row.style.alignItems = 'stretch';\r\n\r\n            const posterBox = document.createElement('div');\r\n            posterBox.style.flex = '0 0 33%';\r\n            posterBox.style.maxWidth = '240px';\r\n            posterBox.style.borderRadius = '8px';\r\n            posterBox.style.overflow = 'hidden';\r\n            posterBox.style.background = 'transparent';\r\n            posterBox.style.position = 'relative';\r\n            try { posterBox.style.aspectRatio = '2 / 3'; } catch (_) { }\r\n\r\n            const posterImg = document.createElement('img');\r\n            posterImg.alt = item?.animeTitle || '';\r\n            posterImg.referrerPolicy = 'no-referrer';\r\n            posterImg.style.width = '100%';\r\n            posterImg.style.height = '100%';\r\n            posterImg.style.objectFit = 'contain';\r\n            posterImg.style.background = 'transparent';\r\n            const psrc = item?.imageUrl || '';\r\n            if (psrc) posterImg.src = psrc;\r\n            posterBox.appendChild(posterImg);\r\n\r\n            const infoBox = document.createElement('div');\r\n            infoBox.style.flex = '1 1 auto';\r\n            infoBox.style.display = 'flex';\r\n            infoBox.style.flexDirection = 'column';\r\n            infoBox.style.gap = '8px';\r\n\r\n            const title = document.createElement('div');\r\n            title.textContent = item?.animeTitle || '--';\r\n            title.style.fontSize = '16px';\r\n            title.style.fontWeight = '700';\r\n            title.style.lineHeight = '1.3';\r\n\r\n            const type = document.createElement('div');\r\n            type.textContent = item?.typeDescription || item?.type || '';\r\n            type.style.opacity = '.9';\r\n            type.style.fontSize = '12px';\r\n\r\n            // 简介（最多 6 行，超出省略）\r\n            const summary = document.createElement('div');\r\n            summary.textContent = '';\r\n            summary.style.opacity = '.85';\r\n            summary.style.fontSize = '12px';\r\n            summary.style.lineHeight = '1.45';\r\n            summary.style.overflow = 'hidden';\r\n            summary.style.display = '-webkit-box';\r\n            summary.style.webkitLineClamp = '6';\r\n            summary.style.webkitBoxOrient = 'vertical';\r\n\r\n            infoBox.appendChild(title);\r\n            infoBox.appendChild(type);\r\n            infoBox.appendChild(summary);\r\n\r\n            row.appendChild(posterBox);\r\n            row.appendChild(infoBox);\r\n            this._detailWrap.appendChild(row);\r\n\r\n            // 设为本季id操作栏（位于分集列表上方）\r\n            const actionBar = document.createElement('div');\r\n            actionBar.style.marginTop = '10px';\r\n            actionBar.style.border = '1px solid rgba(255,255,255,.12)';\r\n            actionBar.style.borderRadius = '8px';\r\n            actionBar.style.padding = '8px 10px';\r\n            actionBar.style.display = 'flex';\r\n            actionBar.style.alignItems = 'center';\r\n            actionBar.style.gap = '10px';\r\n            actionBar.style.background = 'rgba(255,255,255,.03)';\r\n            actionBar.style.minHeight = '52px';\r\n\r\n            const aidText = document.createElement('span');\r\n            const curAnimeId = item?.animeId ?? item?.id ?? '--';\r\n            aidText.textContent = `将 ${curAnimeId} 作为本季id offset:`;\r\n            aidText.style.fontSize = '12px';\r\n            aidText.style.opacity = '.95';\r\n\r\n            const seasonOffsetInput = document.createElement('input');\r\n            seasonOffsetInput.type = 'text';\r\n            seasonOffsetInput.value = '0';\r\n            seasonOffsetInput.className = 'danmaku-setting-input';\r\n            seasonOffsetInput.style.width = '3ch';\r\n            seasonOffsetInput.style.padding = '4px 6px';\r\n            seasonOffsetInput.style.fontSize = '12px';\r\n            seasonOffsetInput.step = '1';\r\n            seasonOffsetInput.min = '-9999';\r\n            seasonOffsetInput.max = '9999';\r\n\r\n            const confirmBtn = document.createElement('button');\r\n            confirmBtn.type = 'button';\r\n            confirmBtn.textContent = '确认';\r\n            confirmBtn.style.border = '1px solid rgba(255,255,255,.28)';\r\n            confirmBtn.style.background = 'rgba(255,255,255,.10)';\r\n            confirmBtn.style.color = '#fff';\r\n            confirmBtn.style.borderRadius = '6px';\r\n            confirmBtn.style.fontSize = '12px';\r\n            confirmBtn.style.padding = '6px 10px';\r\n            confirmBtn.style.cursor = 'pointer';\r\n            confirmBtn.style.whiteSpace = 'nowrap';\r\n\r\n            actionBar.appendChild(aidText);\r\n            actionBar.appendChild(seasonOffsetInput);\r\n            actionBar.appendChild(confirmBtn);\r\n            this._detailWrap.appendChild(actionBar);\r\n\r\n            const onConfirm = async () => {\r\n                try {\r\n                    if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) {\r\n                        this.logger?.warn?.('[Search] 无法设置本季id：缺少 ApiClient');\r\n                        return;\r\n                    }\r\n                    const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                    const itemId = g.getMediaId?.();\r\n                    const animeId = item?.animeId ?? item?.id;\r\n                    const animeTitle = item?.animeTitle || '';\r\n                    const imageUrl = item?.imageUrl || '';\r\n                    if (!itemId || !animeId) {\r\n                        this.logger?.warn?.('[Search] 无法设置本季id：缺少 itemId/animeId');\r\n                        return;\r\n                    }\r\n                    let v = parseInt(seasonOffsetInput.value, 10);\r\n                    if (!Number.isFinite(v)) v = 0;\r\n                    if (v < -9999) v = -9999; else if (v > 9999) v = 9999;\r\n                    seasonOffsetInput.value = String(v);\r\n\r\n                    const url = ApiClient.getUrl('danmaku/match_data');\r\n                    confirmBtn.disabled = true;\r\n                    const prevText = confirmBtn.textContent;\r\n                    confirmBtn.textContent = '提交中…';\r\n                    const form = new URLSearchParams();\r\n                    // 按需求使用 itemId/animeId 等表单键名\r\n                    form.append('itemId', String(itemId));\r\n                    form.append('animeId', String(animeId));\r\n                    form.append('offset', String(v));\r\n                    form.append('animeTitle', String(animeTitle));\r\n                    form.append('imageUrl', String(imageUrl));\r\n\r\n                    await ApiClient.ajax({\r\n                        type: 'POST',\r\n                        url,\r\n                        data: form.toString(),\r\n                        contentType: 'application/x-www-form-urlencoded; charset=UTF-8',\r\n                        dataType: 'json'\r\n                    });\r\n\r\n                    // 成功后，适度更新顶部信息展示\r\n                    try {\r\n                        if (this._idValEl) this._idValEl.textContent = String(animeId);\r\n                        if (this._titleValEl) this._titleValEl.textContent = animeTitle || this._titleValEl.textContent;\r\n                        if (this._imgEl && imageUrl) this._imgEl.src = imageUrl;\r\n                        if (this._offsetInput) this._offsetInput.value = String(v);\r\n                        const g2 = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                        g2.danmakuMatchData = {\r\n                            ...(g2.danmakuMatchData || {}),\r\n                            animeId,\r\n                            animeTitle,\r\n                            imageUrl,\r\n                            offset: v,\r\n                            exists: true\r\n                        };\r\n                    } catch (_) { }\r\n\r\n                    // 触发自动保存后的刷新“本集标题”\r\n                    try {\r\n                        const p = saveIfAutoOn(this.logger);\r\n                        if (p && typeof p.then === 'function') {\r\n                            p.then(val => {\r\n                                if (val) {\r\n                                    try {\r\n                                        const g3 = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                                        const newEpTitle = g3?.danmakuData?.episodeTitle || '--';\r\n                                        if (this._episodeTitleEl) this._episodeTitleEl.textContent = newEpTitle;\r\n                                    } catch (_) { }\r\n                                }\r\n                            }).catch(() => { });\r\n                        }\r\n                    } catch (_) { }\r\n\r\n                    this.logger?.info?.('[Search] 已设置本季id', { itemId, animeId, offset: v });\r\n                } catch (e) {\r\n                    this.logger?.warn?.('[Search] 设置本季id失败', e);\r\n                } finally {\r\n                    try { confirmBtn.disabled = false; confirmBtn.textContent = '确认'; } catch (_) { }\r\n                }\r\n            };\r\n            confirmBtn.addEventListener('click', onConfirm);\r\n            this._detailUnbinds.push(() => { try { confirmBtn.removeEventListener('click', onConfirm); } catch (_) { } });\r\n\r\n            // Episodes 容器\r\n            const episodesWrap = document.createElement('div');\r\n            episodesWrap.style.marginTop = '12px';\r\n            episodesWrap.style.display = 'flex';\r\n            episodesWrap.style.flexDirection = 'column';\r\n            episodesWrap.style.gap = '8px';\r\n            const loading = document.createElement('div');\r\n            loading.textContent = '加载中…';\r\n            loading.style.opacity = '.8';\r\n            loading.style.fontSize = '13px';\r\n            episodesWrap.appendChild(loading);\r\n            this._detailWrap.appendChild(episodesWrap);\r\n\r\n            // 挂载到面板\r\n            if (this._panel) this._panel.appendChild(this._detailWrap);\r\n\r\n            // 动画：进入二级 -> 向右移动\r\n            const list = this._listWrap;\r\n            const detail = this._detailWrap;\r\n            const dur = 220; // ms\r\n            const ease = 'ease';\r\n            if (list) {\r\n                list.style.transition = 'transform ' + dur + 'ms ' + ease + ', opacity ' + dur + 'ms ' + ease;\r\n                list.style.transform = 'translateX(0)';\r\n                list.style.opacity = '1';\r\n            }\r\n            if (detail) {\r\n                detail.style.transition = 'transform ' + dur + 'ms ' + ease + ', opacity ' + dur + 'ms ' + ease;\r\n                detail.style.transform = 'translateX(-24px)';\r\n                detail.style.opacity = '0';\r\n            }\r\n            // 触发重排\r\n            void (detail && detail.offsetWidth);\r\n            // 目标状态：两个都向右移动感受\r\n            if (list) {\r\n                list.style.transform = 'translateX(24px)';\r\n                list.style.opacity = '0';\r\n            }\r\n            if (detail) {\r\n                detail.style.transform = 'translateX(0)';\r\n                detail.style.opacity = '1';\r\n            }\r\n\r\n            const finish = () => {\r\n                try {\r\n                    if (list) {\r\n                        list.style.display = 'none';\r\n                        list.style.transition = '';\r\n                        list.style.transform = '';\r\n                        list.style.opacity = '';\r\n                    }\r\n                    if (detail) {\r\n                        detail.style.transition = '';\r\n                        detail.style.transform = '';\r\n                        detail.style.opacity = '';\r\n                    }\r\n                } catch (_) { }\r\n                this._isAnimating = false;\r\n            };\r\n            const onEnd = (e) => { finish(); try { detail.removeEventListener('transitionend', onEnd); } catch (_) { } };\r\n            try { detail.addEventListener('transitionend', onEnd); } catch (_) { }\r\n            // 兜底超时\r\n            setTimeout(finish, dur + 80);\r\n\r\n            // 异步加载 bangumi 详情\r\n            this._loadBangumiDetail(item, { summaryEl: summary, episodesWrap });\r\n        } catch (e) {\r\n            this.logger?.warn?.('[Search] 进入二级页面失败', e);\r\n            this._isAnimating = false;\r\n        }\r\n    }\r\n\r\n    _exitDetail() {\r\n        try {\r\n            if (this._isAnimating) return;\r\n            this._isAnimating = true;\r\n            // 移除详情容器\r\n            const list = this._listWrap;\r\n            const detail = this._detailWrap;\r\n            // 若没有详情，直接复原\r\n            if (!detail) {\r\n                if (list) list.style.display = '';\r\n                this._isAnimating = false;\r\n                return;\r\n            }\r\n            // 准备动画：返回一级 -> 向左移动\r\n            const dur = 220; const ease = 'ease';\r\n            if (list) {\r\n                list.style.display = '';\r\n                list.style.transition = 'transform ' + dur + 'ms ' + ease + ', opacity ' + dur + 'ms ' + ease;\r\n                list.style.transform = 'translateX(24px)';\r\n                list.style.opacity = '0';\r\n            }\r\n            if (detail) {\r\n                detail.style.transition = 'transform ' + dur + 'ms ' + ease + ', opacity ' + dur + 'ms ' + ease;\r\n                detail.style.transform = 'translateX(0)';\r\n                detail.style.opacity = '1';\r\n            }\r\n            void (detail && detail.offsetWidth);\r\n            // 目标：列表向左进入，详情向左退出\r\n            if (list) {\r\n                list.style.transform = 'translateX(0)';\r\n                list.style.opacity = '1';\r\n            }\r\n            if (detail) {\r\n                detail.style.transform = 'translateX(-24px)';\r\n                detail.style.opacity = '0';\r\n            }\r\n\r\n            const finish = () => {\r\n                try {\r\n                    if (detail && detail.parentNode) { detail.parentNode.removeChild(detail); }\r\n                } catch (_) { }\r\n                this._detailWrap = null;\r\n                this._selectedItem = null;\r\n                try { this._detailUnbinds.forEach(fn => { try { fn(); } catch (_) { } }); } catch (_) { }\r\n                this._detailUnbinds = [];\r\n                if (list) {\r\n                    list.style.transition = '';\r\n                    list.style.transform = '';\r\n                    list.style.opacity = '';\r\n                    list.style.display = '';\r\n                }\r\n                this._isAnimating = false;\r\n            };\r\n            const onEnd = () => { finish(); try { detail.removeEventListener('transitionend', onEnd); } catch (_) { } };\r\n            try { detail.addEventListener('transitionend', onEnd); } catch (_) { }\r\n            setTimeout(finish, dur + 80);\r\n        } catch (e) {\r\n            this.logger?.warn?.('[Search] 退出二级页面失败', e);\r\n            this._isAnimating = false;\r\n        }\r\n    }\r\n\r\n    async _loadBangumiDetail(item, { summaryEl, episodesWrap }) {\r\n        try {\r\n            const animeId = item?.animeId ?? item?.id ?? null;\r\n            if (!animeId) {\r\n                if (summaryEl) summaryEl.textContent = '';\r\n                if (episodesWrap) {\r\n                    episodesWrap.innerHTML = '';\r\n                    const tip = document.createElement('div');\r\n                    tip.textContent = '缺少 animeId';\r\n                    tip.style.color = '#e66';\r\n                    tip.style.fontSize = '13px';\r\n                    episodesWrap.appendChild(tip);\r\n                }\r\n                return;\r\n            }\r\n            if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) {\r\n                if (episodesWrap) { episodesWrap.innerHTML = ''; const tip = document.createElement('div'); tip.textContent = '缺少 ApiClient'; tip.style.color = '#e66'; tip.style.fontSize = '13px'; episodesWrap.appendChild(tip); }\r\n                return;\r\n            }\r\n            const url = ApiClient.getUrl(`danmaku/search?bangumi_id=${encodeURIComponent(animeId)}`);\r\n            const res = await ApiClient.ajax({ type: 'GET', url, dataType: 'json' });\r\n            const bangumi = res?.bangumi || {};\r\n            // 渲染简介\r\n            if (summaryEl) {\r\n                const txt = (bangumi.summary || '').trim();\r\n                summaryEl.textContent = txt || '';\r\n            }\r\n            // 渲染分集\r\n            if (episodesWrap) {\r\n                episodesWrap.innerHTML = '';\r\n                const episodes = Array.isArray(bangumi.episodes) ? bangumi.episodes : [];\r\n                if (episodes.length === 0) {\r\n                    const tip = document.createElement('div');\r\n                    tip.textContent = '无分集';\r\n                    tip.style.opacity = '.8';\r\n                    tip.style.fontSize = '13px';\r\n                    episodesWrap.appendChild(tip);\r\n                } else {\r\n                    for (const ep of episodes) {\r\n                        const row = document.createElement('div');\r\n                        row.style.border = '1px solid rgba(255,255,255,.12)';\r\n                        row.style.borderRadius = '8px';\r\n                        row.style.padding = '8px 10px';\r\n                        row.style.display = 'flex';\r\n                        row.style.alignItems = 'center';\r\n                        row.style.justifyContent = 'space-between';\r\n                        row.style.gap = '10px';\r\n                        row.style.background = 'rgba(255,255,255,.03)';\r\n\r\n                        // 左侧：大写 episodeNumber\r\n                        const left = document.createElement('div');\r\n                        left.style.flex = '0 0 auto';\r\n                        left.style.display = 'flex';\r\n                        left.style.alignItems = 'center';\r\n                        left.style.justifyContent = 'center';\r\n                        left.style.padding = '0 8px';\r\n                        const num = document.createElement('div');\r\n                        const n = (ep?.episodeNumber ?? '').toString();\r\n                        num.textContent = n.toUpperCase();\r\n                        num.style.fontSize = '18px';\r\n                        num.style.fontWeight = '700';\r\n                        num.style.letterSpacing = '.5px';\r\n                        num.style.opacity = '.95';\r\n                        left.appendChild(num);\r\n\r\n                        // 右侧：内容（episodeId + episodeTitle），垂直居中\r\n                        const right = document.createElement('div');\r\n                        right.style.flex = '1 1 auto';\r\n                        right.style.display = 'flex';\r\n                        right.style.flexDirection = 'column';\r\n                        right.style.justifyContent = 'center';\r\n                        right.style.minHeight = '52px';\r\n\r\n                        const eid = document.createElement('div');\r\n                        eid.textContent = 'ep_id: ' + String(ep?.episodeId ?? '--');\r\n                        eid.style.fontSize = '12px';\r\n                        eid.style.opacity = '.9';\r\n\r\n                        const etitle = document.createElement('div');\r\n                        etitle.textContent = ep?.episodeTitle || '';\r\n                        etitle.style.fontSize = '13px';\r\n                        etitle.style.fontWeight = '600';\r\n                        etitle.style.lineHeight = '1.35';\r\n                        etitle.style.whiteSpace = 'nowrap';\r\n                        etitle.style.overflow = 'hidden';\r\n                        etitle.style.textOverflow = 'ellipsis';\r\n\r\n                        right.appendChild(eid);\r\n                        right.appendChild(etitle);\r\n\r\n                        // 右侧操作按钮：设置单集ID\r\n                        const actionWrap = document.createElement('div');\r\n                        actionWrap.style.flex = '0 0 auto';\r\n                        const setBtn = document.createElement('button');\r\n                        setBtn.type = 'button';\r\n                        setBtn.textContent = '设置单集ID';\r\n                        setBtn.style.border = '1px solid rgba(255,255,255,.28)';\r\n                        setBtn.style.background = 'rgba(255,255,255,.10)';\r\n                        setBtn.style.color = '#fff';\r\n                        setBtn.style.borderRadius = '6px';\r\n                        setBtn.style.fontSize = '12px';\r\n                        setBtn.style.padding = '6px 10px';\r\n                        setBtn.style.cursor = 'pointer';\r\n                        setBtn.style.whiteSpace = 'nowrap';\r\n                        actionWrap.appendChild(setBtn);\r\n\r\n                        const onSet = async () => {\r\n                            try {\r\n                                if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) {\r\n                                    this.logger?.warn?.('[Search] 无法设置单集ID：缺少 ApiClient');\r\n                                    return;\r\n                                }\r\n                                const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                                const item_id = g.getMediaId?.();\r\n                                const danmaku_id = ep?.episodeId;\r\n                                if (!item_id || danmaku_id == null) {\r\n                                    this.logger?.warn?.('[Search] 无法设置单集ID：缺少 item_id/episodeId');\r\n                                    return;\r\n                                }\r\n                                const url = ApiClient.getUrl(`danmaku/set_id?item_id=${encodeURIComponent(String(item_id))}&danmaku_id=${encodeURIComponent(String(danmaku_id))}`);\r\n                                setBtn.disabled = true;\r\n                                const prev = setBtn.textContent; setBtn.textContent = '设置中…';\r\n                                // 无返回体，避免解析 JSON 导致挂起\r\n                                await ApiClient.ajax({ type: 'GET', url });\r\n                                // 成功后刷新头部 ep_id 展示\r\n                                try {\r\n                                    if (this._epIdValEl) this._epIdValEl.textContent = String(danmaku_id);\r\n                                    g.danmakuEpId = danmaku_id;\r\n                                } catch (_) { }\r\n                                this.logger?.info?.('[Search] 已设置单集ID', { item_id, danmaku_id });\r\n                                setBtn.textContent = prev;\r\n                                // 保存完成后刷新“本集标题”\r\n                                try {\r\n                                    const p = saveIfAutoOn(this.logger);\r\n                                    if (p && typeof p.then === 'function') {\r\n                                        p.then(val => {\r\n                                            if (val) {\r\n                                                try {\r\n                                                    const g2 = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                                                    const newEpTitle = g2?.danmakuData?.episodeTitle || '--';\r\n                                                    if (this._episodeTitleEl) this._episodeTitleEl.textContent = newEpTitle;\r\n                                                } catch (_) { }\r\n                                            }\r\n                                        }).catch(() => { });\r\n                                    }\r\n                                } catch (_) { }\r\n                            } catch (e) {\r\n                                this.logger?.warn?.('[Search] 设置单集ID失败', e);\r\n                            } finally {\r\n                                try { setBtn.disabled = false; } catch (_) { }\r\n                            }\r\n                        };\r\n                        setBtn.addEventListener('click', onSet);\r\n                        this._detailUnbinds.push(() => { try { setBtn.removeEventListener('click', onSet); } catch (_) { } });\r\n\r\n                        row.appendChild(left);\r\n                        row.appendChild(right);\r\n                        row.appendChild(actionWrap);\r\n                        episodesWrap.appendChild(row);\r\n                    }\r\n                }\r\n            }\r\n        } catch (e) {\r\n            this.logger?.warn?.('[Search] 加载 bangumi 详情失败', e);\r\n            try {\r\n                if (episodesWrap) {\r\n                    episodesWrap.innerHTML = '';\r\n                    const tip = document.createElement('div');\r\n                    tip.textContent = '加载失败';\r\n                    tip.style.color = '#e66';\r\n                    tip.style.fontSize = '13px';\r\n                    episodesWrap.appendChild(tip);\r\n                }\r\n            } catch (_) { }\r\n        }\r\n    }\r\n\r\n    // 取消随机背景取色逻辑，保持透明背景\r\n\r\n    async _fetchMatchData() {\r\n        try {\r\n            const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n            const item_id = g.getMediaId?.();\r\n            if (!item_id) {\r\n                this._applyMatchData(null, { reason: 'no-media-id' });\r\n                return;\r\n            }\r\n            if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) {\r\n                this._applyMatchData(null, { reason: 'no-apiclient' });\r\n                return;\r\n            }\r\n            const url = ApiClient.getUrl(`danmaku/match_data?item_id=${encodeURIComponent(item_id)}`);\r\n            const res = await ApiClient.ajax({ type: 'GET', url, dataType: 'json' });\r\n            this.logger?.info?.('[Search] 获取匹配信息', res);\r\n            this._applyMatchData(res);\r\n        } catch (e) {\r\n            this.logger?.warn?.('[Search] 获取匹配信息失败', e);\r\n            this._applyMatchData(null, { reason: 'error' });\r\n        }\r\n    }\r\n\r\n    _applyMatchData(data, meta = {}) {\r\n        this._matchData = (data && typeof data === 'object') ? data : null;\r\n        const exists = !!this._matchData?.exists;\r\n        // 标题\r\n        try { this._titleValEl.textContent = exists ? (this._matchData.animeTitle ?? '--') : (meta.reason ? '未获取到匹配数据' : '--'); } catch (_) { }\r\n        // id（仅显示 animeId）\r\n        try {\r\n            const aid = this._matchData?.animeId;\r\n            this._idValEl.textContent = exists && (aid !== undefined && aid !== null) ? String(aid) : '--';\r\n        } catch (_) { }\r\n        // offset\r\n        try {\r\n            const off = Number(this._matchData?.offset ?? 0);\r\n            if (Number.isFinite(off)) this._offsetInput.value = String(off); else this._offsetInput.value = '0';\r\n        } catch (_) { try { this._offsetInput.value = '0'; } catch (__) { } }\r\n        // image\r\n        try {\r\n            const url = exists ? (this._matchData.imageUrl || '') : '';\r\n            if (url) this._imgEl.src = url; else this._imgEl.removeAttribute('src');\r\n            this._imgEl.onerror = () => { try { this._imgEl.removeAttribute('src'); } catch (_) { } };\r\n        } catch (_) { }\r\n        // 将数据放入全局以便其它模块复用\r\n        try { const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {}; g.danmakuMatchData = this._matchData || null; } catch (_) { }\r\n    }\r\n\r\n    _clearHeaderInfo() {\r\n        try {\r\n            this._matchData = null;\r\n            if (this._titleValEl) this._titleValEl.textContent = '--';\r\n            if (this._episodeTitleEl) this._episodeTitleEl.textContent = '--';\r\n            if (this._idValEl) this._idValEl.textContent = '--';\r\n            if (this._offsetInput) this._offsetInput.value = '0';\r\n            if (this._epIdValEl) this._epIdValEl.textContent = '--';\r\n            if (this._imgEl) {\r\n                try { this._imgEl.removeAttribute('src'); } catch (_) { }\r\n            }\r\n            try {\r\n                const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                g.danmakuMatchData = null;\r\n                g.danmakuEpId = null;\r\n            } catch (_) { }\r\n        } catch (_) { }\r\n    }\r\n\r\n    async _fetchEpId() {\r\n        try {\r\n            const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n            const item_id = g.getMediaId?.();\r\n            if (!item_id) { try { if (this._epIdValEl) this._epIdValEl.textContent = '--'; } catch (_) { } return; }\r\n            if (typeof ApiClient === 'undefined' || !ApiClient.getUrl) { return; }\r\n            const url = ApiClient.getUrl(`danmaku/get_id?item_id=${encodeURIComponent(item_id)}`);\r\n            const res = await ApiClient.ajax({ type: 'GET', url, dataType: 'json' });\r\n            this.logger?.info?.('[Search] 获取 ep_id', res);\r\n            let epId = null;\r\n            if (res && typeof res === 'object') {\r\n                epId = res.ep_id ?? res.epId ?? res.id ?? null;\r\n            } else if (typeof res === 'string' || typeof res === 'number') {\r\n                epId = res;\r\n            }\r\n            if (epId === undefined || epId === null || epId === '') epId = '--';\r\n            try { if (this._epIdValEl) this._epIdValEl.textContent = String(epId); } catch (_) { }\r\n            try { g.danmakuEpId = epId; } catch (_) { }\r\n        } catch (e) {\r\n            this.logger?.warn?.('[Search] 获取 ep_id 失败', e);\r\n            try { if (this._epIdValEl) this._epIdValEl.textContent = '--'; } catch (_) { }\r\n        }\r\n    }\r\n\r\n    destroy() {\r\n        try { this._exitDetail(); } catch (_) { }\r\n        try { this._unbinds.forEach(fn => { try { fn(); } catch (_) { } }); } catch (_) { }\r\n        this._unbinds = [];\r\n        try { this._detailUnbinds.forEach(fn => { try { fn(); } catch (_) { } }); } catch (_) { }\r\n        this._detailUnbinds = [];\r\n        this._panel = null;\r\n        this._headerBox = null;\r\n        this._imgEl = null;\r\n        this._titleValEl = null;\r\n        this._episodeTitleEl = null;\r\n        this._idValEl = null;\r\n        this._epIdValEl = null;\r\n        this._offsetInput = null;\r\n        this._matchData = null;\r\n        this._searchInput = null;\r\n        this._searchBtn = null;\r\n        this._searchPlaceholder = null;\r\n        this._resultsWrap = null;\r\n        this._listWrap = null;\r\n        this._detailWrap = null;\r\n        this._selectedItem = null;\r\n    }\r\n}\r\n","import { BasicSettingsPage } from './pages/BasicSettingsPage.js';\r\nimport { CombinedSettingsPage } from './pages/CombinedSettingsPage.js';\r\nimport { FilterSettingsPage } from './pages/FilterSettingsPage.js';\r\nimport { CommentPoolPage } from './pages/CommentPoolPage.js';\r\nimport { SearchDanmakuPage } from './pages/SearchDanmakuPage.js';\r\nimport { updateDanmakuSettings } from '../api/fetch.js';\r\n\r\nexport class DanmakuSettingsPanel {\r\n    constructor({ logger } = {}) {\r\n        this.logger = logger || null;\r\n        this.el = null;\r\n        this._styleInjected = false;\r\n        this._id = 'danmakuSettingsPanel';\r\n        this._followRaf = null; // requestAnimationFrame id\r\n        this._followAnchor = null;\r\n        this._lastPosKey = '';\r\n        this._wheelListener = null;\r\n        this._keyboardListener = null;\r\n        this._currentTab = null;\r\n        this._pinned = false; // 图钉固定状态\r\n    this._vvListener = null; // visualViewport 监听器\r\n    }\r\n\r\n    getElement() {\r\n        if (this.el) return this.el;\r\n        this._injectStyles();\r\n        const wrap = document.createElement('div');\r\n        wrap.id = this._id;\r\n        wrap.className = 'danmaku-settings-panel';\r\n        wrap.setAttribute('role', 'dialog');\r\n        wrap.setAttribute('aria-hidden', 'true');\r\n        wrap.setAttribute('data-open', 'false');\r\n        // 构建内容骨架（仅样式 / 结构，不含功能逻辑）\r\n        wrap.appendChild(this._buildContent());\r\n        this._installWheelInterceptor(wrap);\r\n        this._installKeyboardInterceptor(wrap);\r\n        this.el = wrap;\r\n        return wrap;\r\n    }\r\n\r\n    show(anchorEl) {\r\n        try {\r\n            const el = this.getElement();\r\n            if (!el.parentElement) {\r\n                (document.body || document.documentElement).appendChild(el);\r\n            }\r\n            // 初始化一次小屏 vh 变量，避免移动端 100vh 偏差\r\n            this._updatePanelVhVar();\r\n            this._position(anchorEl);\r\n            el.removeAttribute('data-closing');\r\n            el.setAttribute('data-open', 'true');\r\n            el.setAttribute('aria-hidden', 'false');\r\n            this._beginFollow(anchorEl);\r\n        } catch (err) { this.logger?.warn?.('显示设置面板失败', err); }\r\n    }\r\n\r\n    hide() {\r\n        try {\r\n            const el = this.el;\r\n            if (!el) return;\r\n            if (el.getAttribute('data-open') !== 'true') return;\r\n            // 标记关闭过渡\r\n            el.setAttribute('data-closing', 'true');\r\n            el.setAttribute('data-open', 'false');\r\n            this._stopFollow();\r\n            const done = () => {\r\n                try { el.setAttribute('aria-hidden', 'true'); el.removeAttribute('data-closing'); } catch (_) { }\r\n                try { el.removeEventListener('transitionend', done); } catch (_) { }\r\n            };\r\n            try { el.addEventListener('transitionend', done); } catch (_) { }\r\n            setTimeout(done, 300); // 兜底\r\n        } catch (_) { }\r\n    }\r\n\r\n    toggle(anchorEl) {\r\n        if (!this.el || this.el.getAttribute('data-open') !== 'true') {\r\n            this.show(anchorEl);\r\n        } else {\r\n            this.hide();\r\n        }\r\n    }\r\n\r\n    _position(anchorEl) {\r\n        if (!this.el || !anchorEl || typeof anchorEl.getBoundingClientRect !== 'function') return;\r\n        try {\r\n            const rect = anchorEl.getBoundingClientRect();\r\n            const h = this.el.offsetHeight || 0;\r\n            this.el.style.position = 'absolute';\r\n            this.el.style.zIndex = 9999;\r\n            this.el.style.left = `${Math.round(rect.left + rect.width / 2)}px`;\r\n            this.el.style.top = `${Math.round(rect.top - h)}px`;\r\n            this._lastPosKey = `${rect.left},${rect.top},${h}`;\r\n            this._ensureInViewport();\r\n        } catch (_) { }\r\n    }\r\n\r\n    _beginFollow(anchorEl) {\r\n        this._followAnchor = anchorEl || this._followAnchor;\r\n        if (!this._followAnchor) return;\r\n        if (this._followRaf) return; // 已在跟随\r\n        this._anchorInvisible = false;\r\n        this._reacquireTick = 0;\r\n    // 首次进入也刷新一次 vh 变量\r\n    this._updatePanelVhVar();\r\n        const isAnchorVisible = (el) => {\r\n            if (!el) return false;\r\n            if (!el.isConnected) return false; // 不在文档\r\n            const rect = el.getBoundingClientRect();\r\n            if (rect.width === 0 && rect.height === 0) return false;\r\n            const style = window.getComputedStyle ? window.getComputedStyle(el) : null;\r\n            if (style) {\r\n                if (style.display === 'none' || style.visibility === 'hidden' || parseFloat(style.opacity || '1') === 0) return false;\r\n            }\r\n            return true;\r\n        };\r\n        const reacquireAnchor = () => {\r\n            try {\r\n                const cand = document.querySelector('.danmaku-settings-btn, .btnDanmakuSettings');\r\n                if (cand) {\r\n                    this._followAnchor = cand;\r\n                    this._position(cand);\r\n                    this._anchorInvisible = !isAnchorVisible(cand);\r\n                }\r\n            } catch (_) { }\r\n        };\r\n        const step = () => {\r\n            this._followRaf = null;\r\n            try {\r\n                if (!this.el || this.el.getAttribute('data-open') !== 'true') { this._stopFollow(); return; }\r\n                if (!this._followAnchor || !this._followAnchor.isConnected) {\r\n                    // 尝试重新获取锚点，不隐藏面板\r\n                    if ((this._reacquireTick++ % 30) === 0) reacquireAnchor();\r\n                } else {\r\n                    // 锚点存在但可能暂时不可见（控制条自动隐藏）\r\n                    const visible = isAnchorVisible(this._followAnchor);\r\n                    if (!visible) {\r\n                        this._anchorInvisible = true; // 冻结位置\r\n                    } else {\r\n                        // 从不可见恢复\r\n                        const rect = this._followAnchor.getBoundingClientRect();\r\n                        const h = this.el.offsetHeight || 0;\r\n                        const key = `${rect.left},${rect.top},${h}`;\r\n                        if (key !== this._lastPosKey) {\r\n                            this.el.style.left = `${Math.round(rect.left + rect.width / 2)}px`;\r\n                            this.el.style.top = `${Math.round(rect.top - h)}px`;\r\n                            this._lastPosKey = key;\r\n                            this._ensureInViewport();\r\n                        }\r\n                        this._anchorInvisible = false;\r\n                    }\r\n                }\r\n            } catch (_) { }\r\n            this._followRaf = requestAnimationFrame(step);\r\n        };\r\n        this._followRaf = requestAnimationFrame(step);\r\n        // 监听窗口 resize 以强制一次定位\r\n        if (!this._resizeListener) {\r\n            this._resizeListener = () => { try { this._updatePanelVhVar(); this._position(this._followAnchor); this._ensureInViewport(); } catch (_) { } };\r\n            try { window.addEventListener('resize', this._resizeListener, { passive: true }); } catch (_) { }\r\n        }\r\n        // 监听 visualViewport（移动端地址栏/软键盘变化更灵敏）\r\n        if (!this._vvListener && window.visualViewport) {\r\n            this._vvListener = () => { try { this._updatePanelVhVar(); this._ensureInViewport(); } catch (_) { } };\r\n            try { window.visualViewport.addEventListener('resize', this._vvListener, { passive: true }); } catch (_) { }\r\n            try { window.visualViewport.addEventListener('scroll', this._vvListener, { passive: true }); } catch (_) { }\r\n        }\r\n    }\r\n\r\n    _stopFollow() {\r\n        if (this._followRaf) { try { cancelAnimationFrame(this._followRaf); } catch (_) { } this._followRaf = null; }\r\n        if (this._resizeListener) { try { window.removeEventListener('resize', this._resizeListener); } catch (_) { } this._resizeListener = null; }\r\n        if (this._vvListener && window.visualViewport) {\r\n            try { window.visualViewport.removeEventListener('resize', this._vvListener); } catch (_) { }\r\n            try { window.visualViewport.removeEventListener('scroll', this._vvListener); } catch (_) { }\r\n            this._vvListener = null;\r\n        }\r\n    }\r\n\r\n    _injectStyles() {\r\n        if (this._styleInjected) return;\r\n        if (typeof document === 'undefined') return;\r\n        const id = 'danmakuSettingsPanelStyles';\r\n        if (document.getElementById(id)) { this._styleInjected = true; return; }\r\n        const style = document.createElement('style');\r\n        style.id = id;\r\n        // 带淡入/上滑 & 淡出/下滑 动画的样式实现\r\n        style.textContent = `\r\n        .danmaku-settings-panel { \r\n            display:block; box-sizing:border-box; position:absolute; \r\n            background:rgba(0,0,0,.78); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);\r\n            color:#fff; font-size:12px; line-height:1.4; padding:10px 14px 12px; \r\n            border:1px solid rgba(255,255,255,.18); border-radius:10px; \r\n            /* 自适应宽度：在较窄窗口下自动收缩，保证不超出；使用 clamp 设定范围 */\r\n            width:clamp(320px, 70vw, 400px); max-width:90vw; min-width:0; \r\n            /* 高度策略：空间充足固定 600px；小屏降级为可视高度的 90% */\r\n            height:min(600px, calc(var(--danmaku-vh, 1vh) * 90));\r\n            max-height:none;\r\n            opacity:0; transform:translate(-50%, 8px) scale(.94); \r\n            transition:opacity .18s ease, transform .22s cubic-bezier(.215,.61,.355,1); \r\n            pointer-events:none; will-change:opacity,transform; \r\n            box-shadow:0 8px 28px -6px rgba(0,0,0,.55), 0 4px 10px -2px rgba(0,0,0,.5);\r\n            font-family:system-ui,-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,sans-serif;\r\n            overflow:hidden; display:flex; flex-direction:column;\r\n            /* 防止滚动冒泡到页面 */\r\n            overscroll-behavior:contain;\r\n        }\r\n        .danmaku-settings-panel[data-open=\"true\"] { opacity:1; transform:translate(-50%, 0) scale(1); pointer-events:auto; }\r\n        .danmaku-settings-panel[data-closing=\"true\"] { pointer-events:none; }\r\n    .danmaku-settings-pinBtn { position:absolute; top:6px; right:34px; width:22px; height:22px; border:0; background:rgba(255,255,255,.08); color:#ddd; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; transition:background .18s ease, color .18s ease, box-shadow .18s ease; }\r\n    .danmaku-settings-pinBtn:hover { background:rgba(255,255,255,.18); color:#fff; }\r\n    .danmaku-settings-pinBtn svg { width:14px; height:14px; fill:currentColor; pointer-events:none; }\r\n    .danmaku-settings-panel[data-pinned=\"true\"] .danmaku-settings-pinBtn { background:#3fa9ff; color:#fff; box-shadow:0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6); }\r\n    .danmaku-settings-panel[data-pinned=\"true\"] .danmaku-settings-pinBtn:hover { background:#56b4ff; }\r\n    .danmaku-settings-closeBtn { position:absolute; top:6px; right:6px; width:22px; height:22px; border:0; background:rgba(255,0,0,.14); color:#ff6b6b; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; transition:background .18s ease, color .18s ease, box-shadow .18s ease; }\r\n    .danmaku-settings-closeBtn:hover { background:rgba(255,0,0,.22); color:#fff; }\r\n    .danmaku-settings-closeBtn svg { width:14px; height:14px; fill:currentColor; pointer-events:none; }\r\n        .danmaku-settings-panel__title { font-size:14px; font-weight:600; margin:0 0 6px; letter-spacing:.5px; }\r\n        .danmaku-settings-tabs { display:flex; gap:6px; margin:0 0 8px; flex-wrap:wrap; }\r\n        .danmaku-settings-tab { border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.06); color:#fff; padding:4px 10px; border-radius:16px; font-size:12px; cursor:pointer; line-height:1; position:relative; }\r\n        .danmaku-settings-tab:hover { background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.35); }\r\n        .danmaku-settings-tab[data-active=\"true\"] { background:#3fa9ff; border-color:#3fa9ff; box-shadow:0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6); }\r\n    .danmaku-settings-panel__inner { flex:1 1 auto; display:flex; flex-direction:column; overflow:hidden; }\r\n    .danmaku-settings-scroll { flex:1 1 auto; overflow:auto; padding-right:6px; }\r\n        .danmaku-settings-tabPanels { position:relative; }\r\n        .danmaku-settings-tabPanel { display:none; animation:fadeIn .18s ease; }\r\n        .danmaku-settings-tabPanel[data-active=\"true\"] { display:block; }\r\n    .danmaku-settings-list { display:flex; flex-direction:column; gap:8px; }\r\n        .danmaku-setting-row { display:flex; flex-direction:column; gap:3px; padding:6px 8px 7px; border:1px solid rgba(255,255,255,.08); border-radius:6px; background:rgba(255,255,255,.05); position:relative; min-width:0; }\r\n        .danmaku-setting-row[data-type=\"boolean\"] { cursor:pointer; }\r\n        .danmaku-setting-row:hover { border-color:rgba(255,255,255,.22); background:rgba(255,255,255,.09); }\r\n        .danmaku-setting-row__label { font-size:12px; font-weight:500; display:flex; align-items:center; justify-content:space-between; gap:8px; }\r\n        .danmaku-setting-row__desc { font-size:10px; opacity:.55; line-height:1.25; }\r\n        .danmaku-setting-input { width:100%; box-sizing:border-box; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.25); color:#fff; border-radius:4px; padding:3px 6px; font-size:12px; line-height:1.3; outline:none; }\r\n        .danmaku-setting-input:focus { border-color:#3fa9ff; box-shadow:0 0 0 1px rgba(63,169,255,.45); }\r\n        .danmaku-setting-textarea { resize:vertical; min-height:52px; }\r\n        .danmaku-setting-switch { width:30px; height:16px; border-radius:16px; background:rgba(255,255,255,.35); position:relative; flex-shrink:0; }\r\n        .danmaku-setting-switch::after { content:\"\"; position:absolute; left:2px; top:2px; width:12px; height:12px; background:#fff; border-radius:50%; transition:transform .18s ease, background-color .18s ease; }\r\n        .danmaku-setting-row[data-enabled=\"true\"] .danmaku-setting-switch { background:#3fa9ff; }\r\n        .danmaku-setting-row[data-enabled=\"true\"] .danmaku-setting-switch::after { transform:translateX(14px); }\r\n    .danmaku-settings-footer { padding:8px 2px 0; font-size:10px; opacity:.55; text-align:right; }\r\n    .danmaku-settings-actions { display:flex; gap:8px; justify-content:flex-end; padding:10px 0 0; margin-top:8px; background:transparent; border-top:1px solid rgba(255,255,255,.15); }\r\n    .danmaku-settings-actions button { font:500 12px/1 system-ui,-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,sans-serif; padding:6px 14px 7px; border-radius:6px; border:1px solid rgba(255,255,255,.28); background:rgba(255,255,255,.10); color:#fff; cursor:pointer; letter-spacing:.5px; transition:background-color .15s ease, border-color .15s ease, transform .15s ease; }\r\n    .danmaku-settings-actions button:hover:not([data-busy=\"true\"]) { background:rgba(255,255,255,.18); border-color:rgba(255,255,255,.4); }\r\n    .danmaku-settings-actions button:active:not([data-busy=\"true\"]) { transform:translateY(1px); }\r\n    .danmaku-settings-actions button[data-type=\"primary\"] { background:#3fa9ff; border-color:#3fa9ff; color:#fff; box-shadow:0 2px 8px -2px rgba(63,169,255,.6); }\r\n    .danmaku-settings-actions button[data-type=\"primary\"]:hover:not([data-busy=\"true\"]) { background:#56b4ff; }\r\n    .danmaku-settings-actions button[data-busy=\"true\"] { opacity:.6; cursor:default; }\r\n        /* 滚动条微样式 */\r\n    .danmaku-settings-scroll::-webkit-scrollbar { width:8px; }\r\n    .danmaku-settings-scroll::-webkit-scrollbar-track { background:transparent; }\r\n    .danmaku-settings-scroll::-webkit-scrollbar-thumb { background:rgba(255,255,255,.25); border-radius:4px; }\r\n    .danmaku-settings-scroll::-webkit-scrollbar-thumb:hover { background:rgba(255,255,255,.38); }\r\n        @media (max-width:860px) { .danmaku-settings-grid { grid-template-columns:repeat(3,1fr);} }\r\n        @media (max-width:680px) { .danmaku-settings-grid { grid-template-columns:repeat(2,1fr);} }\r\n        @media (max-width:520px) { .danmaku-settings-grid { grid-template-columns:repeat(1,1fr);} }\r\n        @media (prefers-reduced-motion: reduce) { .danmaku-settings-panel { transition:none!important; } .danmaku-setting-switch::after { transition:none!important; } }\r\n        @keyframes fadeIn { from { opacity:0; transform:translateY(4px);} to { opacity:1; transform:translateY(0);} }\r\n    /* 确认框样式 */\r\n    .danmaku-confirm-mask { position:absolute; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px); z-index:10000; }\r\n    .danmaku-confirm { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); min-width:280px; max-width:90%; background:rgba(0,0,0,.86); color:#fff; border:1px solid rgba(255,255,255,.18); border-radius:10px; box-shadow:0 8px 28px -6px rgba(0,0,0,.55), 0 4px 10px -2px rgba(0,0,0,.5); padding:12px 14px; z-index:10001; }\r\n    .danmaku-confirm__title { font-size:14px; font-weight:600; margin:0 0 6px; letter-spacing:.5px; }\r\n    .danmaku-confirm__msg { font-size:12px; opacity:.9; line-height:1.4; }\r\n    .danmaku-confirm__actions { display:flex; gap:8px; justify-content:flex-end; padding-top:10px; margin-top:10px; border-top:1px solid rgba(255,255,255,.15); }\r\n    .danmaku-confirm__actions button { font:500 12px/1 system-ui,-apple-system,BlinkMacSystemFont,\"Segoe UI\",Roboto,\"Helvetica Neue\",Arial,sans-serif; padding:6px 14px 7px; border-radius:6px; border:1px solid rgba(255,255,255,.28); background:rgba(255,255,255,.10); color:#fff; cursor:pointer; letter-spacing:.5px; transition:background-color .15s ease, border-color .15s ease, transform .15s ease; }\r\n    .danmaku-confirm__actions button:hover { background:rgba(255,255,255,.18); border-color:rgba(255,255,255,.4); }\r\n    .danmaku-confirm__actions button:active { transform:translateY(1px); }\r\n    .danmaku-confirm__actions button[data-type=\"primary\"] { background:#ff6363; border-color:#ff6363; color:#fff; box-shadow:0 2px 8px -2px rgba(255,99,99,.6); }\r\n    .danmaku-confirm__actions button[data-type=\"primary\"]:hover { background:#ff7a7a; }\r\n        `;\r\n        try { (document.head || document.documentElement).appendChild(style); this._styleInjected = true; } catch (_) { }\r\n    }\r\n\r\n    _buildContent() {\r\n        const inner = document.createElement('div');\r\n        inner.className = 'danmaku-settings-panel__inner';\r\n        const title = document.createElement('h3');\r\n        title.className = 'danmaku-settings-panel__title';\r\n        title.textContent = '弹幕设置';\r\n        // 图钉按钮\r\n        const pinBtn = document.createElement('button');\r\n        pinBtn.type = 'button';\r\n        pinBtn.className = 'danmaku-settings-pinBtn';\r\n        pinBtn.setAttribute('aria-label', '固定/取消固定 面板');\r\n        pinBtn.innerHTML = '<svg viewBox=\"0 0 24 24\"><path d=\"M14.53 2.53 12 0 9.47 2.53a5.5 5.5 0 0 0-1.61 3.9v4.17l-3.2 3.2a1 1 0 0 0 .7 1.7H11v6.5a1 1 0 0 0 2 0V15.5h5.64a1 1 0 0 0 .7-1.7l-3.2-3.2V6.43a5.5 5.5 0 0 0-1.61-3.9Z\"/></svg>';\r\n        pinBtn.addEventListener('click', () => { try { this.togglePin(); } catch (_) { } });\r\n        inner.appendChild(title);\r\n        inner.appendChild(pinBtn);\r\n        // 关闭按钮（红叉）\r\n        const closeBtn = document.createElement('button');\r\n        closeBtn.type = 'button';\r\n        closeBtn.className = 'danmaku-settings-closeBtn';\r\n        closeBtn.setAttribute('aria-label', '关闭设置面板');\r\n        closeBtn.innerHTML = '<svg viewBox=\"0 0 24 24\" focusable=\"false\" aria-hidden=\"true\"><path d=\"M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4Z\"/></svg>';\r\n        closeBtn.addEventListener('click', (ev) => {\r\n            try {\r\n                ev.stopPropagation();\r\n                ev.stopImmediatePropagation?.();\r\n                ev.preventDefault?.();\r\n            } catch (_) { }\r\n            try { this.hide(); } catch (_) { }\r\n        });\r\n        inner.appendChild(closeBtn);\r\n        const tabsWrap = document.createElement('div');\r\n        tabsWrap.className = 'danmaku-settings-tabs';\r\n        inner.appendChild(tabsWrap);\r\n        // 可滚动主体容器\r\n        const scrollWrap = document.createElement('div');\r\n        scrollWrap.className = 'danmaku-settings-scroll';\r\n        inner.appendChild(scrollWrap);\r\n        // 新的分页类集合（含预留的“搜索弹幕”，默认隐藏）\r\n        this._pages = [\r\n            new BasicSettingsPage({ logger: this.logger }),\r\n            new CombinedSettingsPage({ logger: this.logger }),\r\n            new FilterSettingsPage({ logger: this.logger }),\r\n            new SearchDanmakuPage({ logger: this.logger }),\r\n            new CommentPoolPage({ logger: this.logger })\r\n        ];\r\n        const panelsWrap = document.createElement('div');\r\n        panelsWrap.className = 'danmaku-settings-tabPanels';\r\n        scrollWrap.appendChild(panelsWrap);\r\n        const switchTab = (tabKey) => {\r\n            if (this._currentTab === tabKey) return;\r\n            this._currentTab = tabKey;\r\n            tabsWrap.querySelectorAll('.danmaku-settings-tab').forEach(btn => btn.setAttribute('data-active', btn.dataset.key === tabKey ? 'true' : 'false'));\r\n            panelsWrap.querySelectorAll('.danmaku-settings-tabPanel').forEach(p => p.setAttribute('data-active', p.dataset.key === tabKey ? 'true' : 'false'));\r\n        };\r\n        // 生成按钮与面板（显示全部分页）\r\n        this._pages.forEach(page => {\r\n            const key = page.getKey();\r\n            const btn = document.createElement('button');\r\n            btn.type = 'button';\r\n            btn.className = 'danmaku-settings-tab';\r\n            btn.dataset.key = key;\r\n            btn.textContent = page.getLabel();\r\n            btn.setAttribute('data-active', 'false');\r\n            btn.addEventListener('click', () => switchTab(key));\r\n            tabsWrap.appendChild(btn);\r\n            const panelEl = page.build();\r\n            panelsWrap.appendChild(panelEl);\r\n        });\r\n        // 默认选中第一个分页\r\n        if (this._pages.length) switchTab(this._pages[0].getKey());\r\n        const footer = document.createElement('div');\r\n        footer.className = 'danmaku-settings-footer';\r\n        scrollWrap.appendChild(footer);\r\n        // 操作按钮栏（重置 / 保存）保持在底部，不随内容滚动\r\n        inner.appendChild(this._buildActionBar());\r\n        return inner;\r\n    }\r\n\r\n    _renderRow(key, label) { /* 已拆分到各分页类，占位方法保留避免调用错误 */ return document.createElement('div'); }\r\n\r\n    _buildActionBar() {\r\n        const bar = document.createElement('div');\r\n        bar.className = 'danmaku-settings-actions';\r\n        // 让左右分布：左侧调试开关，右侧按钮组\r\n        bar.style.justifyContent = 'space-between';\r\n        // 左侧调试模式开关\r\n        const debugWrap = document.createElement('label');\r\n        debugWrap.style.display = 'flex';\r\n        debugWrap.style.alignItems = 'center';\r\n        debugWrap.style.gap = '4px';\r\n        debugWrap.style.fontSize = '11px';\r\n        debugWrap.style.opacity = '.85';\r\n        debugWrap.style.cursor = 'pointer';\r\n        const debugCb = document.createElement('input');\r\n        debugCb.type = 'checkbox';\r\n        debugCb.style.margin = 0;\r\n        // 从 localStorage 读取持久化调试模式（不上传服务器）\r\n        let storedDebug = null;\r\n        try { storedDebug = localStorage.getItem('danmaku_debug_enabled'); } catch (_) { }\r\n        const storedBool = storedDebug === '1';\r\n        // 若本地存储存在则优先使用；否则用当前 logger 状态\r\n        let initialDebug = storedDebug != null ? storedBool : !!this.logger?.getDebug?.();\r\n        debugCb.checked = initialDebug;\r\n        // 同步 logger 状态（若 logger 当前不同）\r\n        try { if (this.logger && this.logger.getDebug && this.logger.getDebug() !== initialDebug) { this.logger.setDebug(initialDebug); } } catch (_) { }\r\n        const debugText = document.createElement('span');\r\n        debugText.textContent = '调试模式';\r\n        debugWrap.appendChild(debugCb);\r\n        debugWrap.appendChild(debugText);\r\n        debugCb.addEventListener('change', () => {\r\n            try {\r\n                this.logger?.setDebug?.(debugCb.checked);\r\n                // 写入 localStorage 记忆\r\n                try { localStorage.setItem('danmaku_debug_enabled', debugCb.checked ? '1' : '0'); } catch (_) { }\r\n            } catch (_) { }\r\n        });\r\n        bar.appendChild(debugWrap);\r\n        // 右侧按钮容器\r\n        const rightGroup = document.createElement('div');\r\n        rightGroup.style.display = 'flex';\r\n        rightGroup.style.alignItems = 'center';\r\n        rightGroup.style.gap = '8px';\r\n        // 重置按钮\r\n        const resetBtn = document.createElement('button');\r\n        resetBtn.type = 'button';\r\n        resetBtn.textContent = '重置';\r\n        resetBtn.addEventListener('click', async () => {\r\n            try {\r\n                const ok = await this._showConfirm({\r\n                    title: '恢复默认设置',\r\n                    message: '确定将所有设置恢复为默认值吗？此操作会覆盖当前自定义设置。',\r\n                    confirmText: '重置',\r\n                    cancelText: '取消'\r\n                });\r\n                if (!ok) return;\r\n                const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                const settings = g.danmakuSettings;\r\n                if (!settings || typeof settings.resetToDefaults !== 'function') {\r\n                    this.logger?.warn?.('重置失败：设置对象缺失或不支持重置');\r\n                    return;\r\n                }\r\n                settings.resetToDefaults();\r\n                this.logger?.info?.('已重置为默认设置（本地）');\r\n                try {\r\n                    const mediaId = g.getMediaId?.();\r\n                    if (mediaId) await updateDanmakuSettings(this.logger, mediaId);\r\n                    else await updateDanmakuSettings(this.logger);\r\n                    this.logger?.info?.('默认设置已提交保存');\r\n                } catch (e) { this.logger?.warn?.('默认设置保存失败', e); }\r\n                try { this._refreshPagesUI(); } catch (_) { }\r\n            } catch (e) {\r\n                this.logger?.warn?.('执行重置时出错', e);\r\n            }\r\n        });\r\n        // 保存按钮\r\n        const saveBtn = document.createElement('button');\r\n        saveBtn.type = 'button';\r\n        saveBtn.textContent = '保存';\r\n        saveBtn.dataset.type = 'primary';\r\n        const setBusy = (busy) => {\r\n            if (busy) {\r\n                saveBtn.setAttribute('data-busy', 'true');\r\n                saveBtn.textContent = '保存中…';\r\n            } else {\r\n                saveBtn.removeAttribute('data-busy');\r\n                saveBtn.textContent = '保存';\r\n            }\r\n        };\r\n        saveBtn.addEventListener('click', async () => {\r\n            if (saveBtn.getAttribute('data-busy') === 'true') return; // 防重复\r\n            try {\r\n                const mediaId = window?.__jfDanmakuGlobal__?.getMediaId?.();\r\n                if (!mediaId) {\r\n                    this.logger?.warn?.('保存失败：缺少 mediaId');\r\n                    return;\r\n                }\r\n                setBusy(true);\r\n                await updateDanmakuSettings(this.logger, mediaId);\r\n                this.logger?.info?.('弹幕设置已保存');\r\n            } catch (e) {\r\n                this.logger?.warn?.('保存弹幕设置出错', e);\r\n            } finally {\r\n                setBusy(false);\r\n            }\r\n        });\r\n        rightGroup.appendChild(resetBtn);\r\n        rightGroup.appendChild(saveBtn);\r\n        // 实时保存开关\r\n        const autoWrap = document.createElement('label');\r\n        autoWrap.style.display = 'flex';\r\n        autoWrap.style.alignItems = 'center';\r\n        autoWrap.style.gap = '4px';\r\n        autoWrap.style.marginLeft = '8px';\r\n        autoWrap.style.fontSize = '11px';\r\n        autoWrap.style.opacity = '.85';\r\n        const autoCb = document.createElement('input');\r\n        autoCb.type = 'checkbox';\r\n        autoCb.style.margin = 0;\r\n        // 初始状态：仅读取本地持久化；未设置时默认开启\r\n        try {\r\n            const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n            let persisted = null;\r\n            try { persisted = localStorage.getItem('danmaku_auto_save'); } catch (_) { }\r\n            const persistedBool = (persisted === 'true') ? true : (persisted === 'false' ? false : null);\r\n            g.danmakuAutoSave = (persistedBool != null) ? persistedBool : true;\r\n            autoCb.checked = g.danmakuAutoSave;\r\n\r\n\r\n        } catch (_) { }\r\n        const autoText = document.createElement('span');\r\n        autoText.textContent = '实时';\r\n        autoWrap.appendChild(autoCb);\r\n        autoWrap.appendChild(autoText);\r\n\r\n\r\n    autoCb.addEventListener('change', () => {\r\n            try {\r\n                try { localStorage.setItem('danmaku_auto_save', autoCb.checked ? 'true' : 'false'); } catch (_) { }\r\n                if (autoCb.checked) {\r\n                    const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                    g.danmakuAutoSave = true;\r\n                    localStorage.setItem('danmaku_auto_save', 'true');\r\n                    this.logger?.info?.('实时保存已开启');\r\n                } else {\r\n                    const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                    g.danmakuAutoSave = false;\r\n                    localStorage.setItem('danmaku_auto_save', 'false');\r\n                    this.logger?.info?.('实时保存已关闭');\r\n                }\r\n            } catch (_) { }\r\n        });\r\n        rightGroup.appendChild(autoWrap);\r\n        bar.appendChild(rightGroup);\r\n        return bar;\r\n    }\r\n\r\n    // 重新构建分页以同步 UI 到当前全局设置值（尽量轻量，不销毁面板容器）\r\n    _refreshPagesUI() {\r\n        try {\r\n            if (!this.el) return;\r\n            const panelsWrap = this.el.querySelector('.danmaku-settings-tabPanels');\r\n            const tabsWrap = this.el.querySelector('.danmaku-settings-tabs');\r\n            if (!panelsWrap || !tabsWrap) return;\r\n            const activeKey = this._currentTab || (this._pages?.[0]?.getKey?.());\r\n            // 先销毁旧分页，释放资源（如 RAF/全局事件）\r\n            if (Array.isArray(this._pages)) {\r\n                try { this._pages.forEach(p => p?.destroy?.()); } catch (_) { }\r\n            }\r\n            // 清空旧内容\r\n            panelsWrap.innerHTML = '';\r\n            tabsWrap.querySelectorAll('.danmaku-settings-tab').forEach(btn => btn.remove());\r\n            // 重新实例化分页（保持 logger），并重建 tabs + panels（含预留的“搜索弹幕”，默认隐藏）\r\n            this._pages = [\r\n                new BasicSettingsPage({ logger: this.logger }),\r\n                new CombinedSettingsPage({ logger: this.logger }),\r\n                new FilterSettingsPage({ logger: this.logger }),\r\n                new SearchDanmakuPage({ logger: this.logger }),\r\n                new CommentPoolPage({ logger: this.logger })\r\n            ];\r\n            const switchTab = (tabKey) => {\r\n                if (this._currentTab === tabKey) return;\r\n                this._currentTab = tabKey;\r\n                tabsWrap.querySelectorAll('.danmaku-settings-tab').forEach(btn => btn.setAttribute('data-active', btn.dataset.key === tabKey ? 'true' : 'false'));\r\n                panelsWrap.querySelectorAll('.danmaku-settings-tabPanel').forEach(p => p.setAttribute('data-active', p.dataset.key === tabKey ? 'true' : 'false'));\r\n            };\r\n            this._pages.forEach(page => {\r\n                const key = page.getKey();\r\n                const btn = document.createElement('button');\r\n                btn.type = 'button';\r\n                btn.className = 'danmaku-settings-tab';\r\n                btn.dataset.key = key;\r\n                btn.textContent = page.getLabel();\r\n                btn.setAttribute('data-active', 'false');\r\n                btn.addEventListener('click', () => switchTab(key));\r\n                tabsWrap.appendChild(btn);\r\n                const panelEl = page.build();\r\n                panelsWrap.appendChild(panelEl);\r\n            });\r\n            if (this._pages.length) {\r\n                const exists = this._pages.some(p => p.getKey() === activeKey);\r\n                const key = exists ? activeKey : this._pages[0].getKey();\r\n                // 确保初次切换不会因“当前等于目标”而早退，导致未设置 data-active\r\n                this._currentTab = null;\r\n                switchTab(key);\r\n            }\r\n        } catch (_) { }\r\n    }\r\n\r\n    destroy() {\r\n        try { this.el?.parentElement?.removeChild(this.el); } catch (_) { }\r\n        this.el = null;\r\n        // 销毁所有分页实例，释放资源\r\n        if (Array.isArray(this._pages)) {\r\n            try { this._pages.forEach(p => p?.destroy?.()); } catch (_) { }\r\n        }\r\n        this._stopFollow();\r\n        if (this._wheelListener) {\r\n            try { window.removeEventListener('wheel', this._wheelListener, true); } catch (_) { }\r\n            this._wheelListener = null;\r\n        }\r\n        if (this._keyboardListener) {\r\n            try { document.removeEventListener('keydown', this._keyboardListener, true); } catch (_) { }\r\n            this._keyboardListener = null;\r\n        }\r\n    }\r\n\r\n    _installWheelInterceptor(rootEl) {\r\n        if (this._wheelListener) return;\r\n        this._wheelListener = (e) => {\r\n            try {\r\n                if (!this.el || this.el.getAttribute('data-open') !== 'true') return;\r\n                // 仅当指针位于面板内部时拦截（包含任意子元素）\r\n                if (this.el.contains(e.target)) {\r\n                    // 阻止向外层播放器的冒泡，避免调整音量或其它快捷行为\r\n                    e.stopPropagation();\r\n                    e.stopImmediatePropagation?.();\r\n                    // 不调用 preventDefault，保留面板内部滚动\r\n                }\r\n            } catch (_) { }\r\n        };\r\n        try { window.addEventListener('wheel', this._wheelListener, { capture: true, passive: true }); } catch (_) { }\r\n    }\r\n\r\n    _installKeyboardInterceptor(rootEl) {\r\n        if (this._keyboardListener) return;\r\n        this._keyboardListener = (ev) => {\r\n            try {\r\n                if (!this.el || this.el.getAttribute('data-open') !== 'true') return;\r\n                // 仅当事件来自设置面板内部（包含其后代）时处理\r\n                if (!this.el.contains(ev.target)) return;\r\n                // Esc: 关闭面板但不阻断（或阻断后自行处理）。这里阻断播放器，再执行关闭\r\n                if (ev.key === 'Escape') {\r\n                    ev.stopPropagation();\r\n                    ev.stopImmediatePropagation?.();\r\n                    this.hide();\r\n                    return;\r\n                }\r\n                // 允许组合键 (Ctrl/Meta/Alt 任意) 交给浏览器/系统，不拦截\r\n                if (ev.ctrlKey || ev.metaKey || ev.altKey) return;\r\n                // 放行 Enter（可能有提交/确认用途）\r\n                if (ev.key === 'Enter') return;\r\n                // 其它键统一阻断（含空格/方向键/F/C/M等播放器快捷键）\r\n                ev.stopPropagation();\r\n                ev.stopImmediatePropagation?.();\r\n                // Space 防止页面滚动 & 播放切换\r\n                if (ev.key === ' ' || ev.code === 'Space') {\r\n                    ev.preventDefault();\r\n                }\r\n            } catch (_) { }\r\n        };\r\n        try { document.addEventListener('keydown', this._keyboardListener, true); } catch (_) { }\r\n    }\r\n    // 统一确认框\r\n    _showConfirm({ title = '确认', message = '确定执行此操作吗？', confirmText = '确定', cancelText = '取消' } = {}) {\r\n        return new Promise(resolve => {\r\n            try {\r\n                const host = this.el || document.body;\r\n                const mask = document.createElement('div');\r\n                mask.className = 'danmaku-confirm-mask';\r\n                const box = document.createElement('div');\r\n                box.className = 'danmaku-confirm';\r\n                const h = document.createElement('div'); h.className = 'danmaku-confirm__title'; h.textContent = title; box.appendChild(h);\r\n                const p = document.createElement('div'); p.className = 'danmaku-confirm__msg'; p.textContent = message; box.appendChild(p);\r\n                const actions = document.createElement('div'); actions.className = 'danmaku-confirm__actions';\r\n                const btnCancel = document.createElement('button'); btnCancel.type = 'button'; btnCancel.textContent = cancelText; actions.appendChild(btnCancel);\r\n                const btnOk = document.createElement('button'); btnOk.type = 'button'; btnOk.textContent = confirmText; btnOk.dataset.type = 'primary'; actions.appendChild(btnOk);\r\n                box.appendChild(actions);\r\n                // 交互\r\n                const cleanup = (val) => {\r\n                    try { host.removeChild(mask); } catch (_) { }\r\n                    try { host.removeChild(box); } catch (_) { }\r\n                    resolve(!!val);\r\n                };\r\n                btnCancel.addEventListener('click', () => cleanup(false));\r\n                btnOk.addEventListener('click', () => cleanup(true));\r\n                mask.addEventListener('click', () => cleanup(false));\r\n                // Esc 关闭，阻断冒泡到播放器\r\n                const keyHandler = (ev) => {\r\n                    try {\r\n                        if (ev.key === 'Escape') { ev.stopPropagation(); ev.preventDefault(); cleanup(false); }\r\n                        if (ev.key === 'Enter') { ev.stopPropagation(); ev.preventDefault(); cleanup(true); }\r\n                    } catch (_) { }\r\n                };\r\n                document.addEventListener('keydown', keyHandler, true);\r\n                const unbind = () => { try { document.removeEventListener('keydown', keyHandler, true); } catch (_) { } };\r\n                const _origCleanup = cleanup;\r\n                // 包装以确保移除监听\r\n                const cleanupWrapped = (val) => { unbind(); _origCleanup(val); };\r\n                // 替换引用\r\n                // 重新绑定\r\n                btnCancel.onclick = () => cleanupWrapped(false);\r\n                btnOk.onclick = () => cleanupWrapped(true);\r\n                mask.onclick = () => cleanupWrapped(false);\r\n                // 注入 DOM\r\n                host.appendChild(mask);\r\n                host.appendChild(box);\r\n                // 初始聚焦\r\n                setTimeout(() => { try { btnOk.focus(); } catch (_) { } }, 0);\r\n            } catch (_) { resolve(false); }\r\n        });\r\n    }\r\n    // 确保面板在视口内：调整 left(中心) 和 top，留 8px 边距\r\n    _ensureInViewport() {\r\n        if (!this.el) return;\r\n        try {\r\n            const margin = 8;\r\n            const vw = window.innerWidth || document.documentElement.clientWidth || 0;\r\n            // 优先使用 visualViewport 的高度以应对移动端地址栏/键盘\r\n            const vh = (window.visualViewport?.height) || window.innerHeight || document.documentElement.clientHeight || 0;\r\n            const rect = this.el.getBoundingClientRect();\r\n            if (!rect || rect.width === 0) return;\r\n            let centerX = rect.left + rect.width / 2; // 因 translate(-50%) left 为中心\r\n            let changed = false;\r\n            if (rect.left < margin) { centerX += (margin - rect.left); changed = true; }\r\n            if (rect.right > vw - margin) { centerX -= (rect.right - (vw - margin)); changed = true; }\r\n            if (changed) this.el.style.left = `${Math.round(centerX)}px`;\r\n            let newTop = null;\r\n            if (rect.top < margin) newTop = margin; else if (rect.bottom > vh - margin) newTop = Math.max(margin, vh - margin - rect.height);\r\n            if (newTop !== null) this.el.style.top = `${Math.round(newTop)}px`;\r\n        } catch (_) { }\r\n    }\r\n    // 刷新小屏 vh 变量，解决 iOS/安卓 100vh 偏差；按 1vh 的像素值设置\r\n    _updatePanelVhVar() {\r\n        try {\r\n            const vv = window.visualViewport;\r\n            const h = Math.max(0, (vv?.height) || window.innerHeight || document.documentElement.clientHeight || 0);\r\n            const oneVhPx = h / 100;\r\n            const host = this.el || document.documentElement;\r\n            host.style.setProperty('--danmaku-vh', `${oneVhPx}px`);\r\n        } catch (_) { }\r\n    }\r\n    // 图钉固定状态切换\r\n    togglePin() {\r\n        this._pinned = !this._pinned;\r\n        try { this.el?.setAttribute('data-pinned', this._pinned ? 'true' : 'false'); } catch (_) { }\r\n        this.logger?.info?.(`设置面板已${this._pinned ? '固定 (不再自动关闭)' : '取消固定 (恢复自动关闭)'}`);\r\n        // 取消固定后立即尝试触发一次视口检查防止位置偏移\r\n        if (!this._pinned) { try { this._ensureInViewport(); } catch (_) { } }\r\n    }\r\n    isPinned() { return !!this._pinned; }\r\n}\r\n","// 该文件现仅负责：\r\n// 1. 生成按钮组 DOM 结构与事件逻辑\r\n// 2. 注入必要样式（SVG mask 等）\r\n// 不再负责：插入到控制条 / 轮询 / Mutation 监控（统一由 danmakuExt.js 的存在性监控完成）\r\n\r\nimport { DanmakuSettingsPanel } from './settingsPanel.js';\r\n\r\nexport class DanmakuButtonsGroup {\r\n    constructor({ logger } = {}) {\r\n        this.logger = logger || null;\r\n        this.el = null;\r\n        this.toggleButton = null;\r\n        this.settingsButton = null;\r\n        this.settingsPanel = new DanmakuSettingsPanel({ logger: this.logger });\r\n        this._globalKeyInterceptor = null; // 聚焦输入时的全局快捷键拦截器\r\n        this._enabled = false; // 当前开关状态（将尝试从本地存储恢复）\r\n        this._storageKeyEnabled = 'jf_danmaku_enabled'; // 本地存储 key\r\n        this._toggleRetryTimer = null; // 全局渲染器未就绪时的延迟重试\r\n        this._onToggle = this._onToggle.bind(this);\r\n        this._onOpenSettings = this._onOpenSettings.bind(this);\r\n        this._onSettingsHoverOpen = this._onSettingsHoverOpen.bind(this);\r\n        this._onDocumentClick = this._onDocumentClick.bind(this);\r\n        this._onSettingsButtonMouseLeave = this._onSettingsButtonMouseLeave.bind(this);\r\n        this._onPanelMouseEnter = this._onPanelMouseEnter.bind(this);\r\n        this._onPanelMouseLeave = this._onPanelMouseLeave.bind(this);\r\n        this._settingsHoverTimer = null;\r\n        this._settingsAutoCloseTimer = null; // 面板自动关闭计时器\r\n        this._restored = false; // 是否已尝试恢复\r\n        this._freezeClickUntil = 0; // 悬停打开后的一段时间内禁止点击立即关闭\r\n    // 设置面板内输入/焦点状态\r\n    this._panelHasFocus = false; // 面板内是否存在聚焦元素\r\n    this._imeComposing = false; // 是否处于输入法合成中\r\n    }\r\n\r\n    // 对外：获取（惰性创建）元素\r\n    getElement() {\r\n        if (this.el) return this.el;\r\n        this._injectStylesIfNeeded();\r\n        const group = document.createElement('div');\r\n        group.setAttribute('data-danmaku-buttons', 'true');\r\n        group.className = 'flex align-items-center flex-direction-row danmakuButtonsGroup';\r\n        group.setAttribute('dir', 'ltr');\r\n        group.setAttribute('data-enabled', 'false');\r\n\r\n        // 文本输入框（位于最左侧）\r\n        const inputEl = this._createTextInput();\r\n        const toggleBtn = this._createToggleButton();\r\n        const settingsBtn = this._createSettingsButton();\r\n        toggleBtn.setAttribute('aria-label', '切换弹幕');\r\n        settingsBtn.setAttribute('aria-label', '弹幕设置');\r\n        try { toggleBtn.addEventListener('click', this._onToggle, { passive: true }); } catch (_) { }\r\n        try { settingsBtn.addEventListener('click', this._onOpenSettings, { passive: true }); } catch (_) { }\r\n        // 悬停 500ms 打开\r\n        try { settingsBtn.addEventListener('mouseenter', this._onSettingsHoverOpen, { passive: true }); } catch (_) { }\r\n        try { settingsBtn.addEventListener('mouseleave', this._onSettingsButtonMouseLeave, { passive: true }); } catch (_) { }\r\n        group.appendChild(inputEl);\r\n        group.appendChild(toggleBtn);\r\n        group.appendChild(settingsBtn);\r\n\r\n        this.el = group;\r\n        this.inputEl = inputEl;\r\n        this.toggleButton = toggleBtn;\r\n        this.settingsButton = settingsBtn;\r\n\r\n        // 初次创建后尝试恢复开关状态\r\n        this._restoreEnabledState();\r\n        // 应用 UI 标记（不触发日志）\r\n        try {\r\n            group.setAttribute('data-enabled', String(this._enabled));\r\n            this.toggleButton?.setAttribute('aria-pressed', this._enabled ? 'true' : 'false');\r\n        } catch (_) { }\r\n        // 若是开启状态，尝试联动显示（可能 renderer 还没好，使用与 _onToggle 相似的重试逻辑）\r\n        if (this._enabled) {\r\n            this._applyVisibilityWithRetry();\r\n        }\r\n        return group;\r\n    }\r\n\r\n    _onToggle() {\r\n        this._enabled = !this._enabled;\r\n        this.logger?.info?.(`弹幕开关: ${this._enabled ? '开启' : '关闭'}`);\r\n        try {\r\n            this.el?.setAttribute('data-enabled', String(this._enabled));\r\n            this.toggleButton?.setAttribute('aria-pressed', this._enabled ? 'true' : 'false');\r\n        } catch (_) { /* no-op */ }\r\n\r\n        // 持久化当前状态\r\n        this._persistEnabledState();\r\n\r\n        // 与全局弹幕渲染器联动 show/hide\r\n        this._applyVisibilityWithRetry();\r\n    }\r\n\r\n    _applyVisibilityWithRetry() {\r\n        const applyVisibility = () => {\r\n            try {\r\n                const g = (typeof window !== 'undefined') ? window.__jfDanmakuGlobal__ : null;\r\n                const renderer = g?.danmakuRenderer;\r\n                if (!renderer) return false;\r\n                if (this._enabled) {\r\n                    try { renderer.show?.(); } catch (e) { this.logger?.warn?.('调用 renderer.show 失败', e); }\r\n                } else {\r\n                    try { renderer.hide?.(); } catch (e) { this.logger?.warn?.('调用 renderer.hide 失败', e); }\r\n                }\r\n                return true;\r\n            } catch (err) {\r\n                this.logger?.warn?.('切换弹幕显示状态失败', err);\r\n                return true; // 避免重复重试\r\n            }\r\n        };\r\n        const ok = applyVisibility();\r\n        if (!ok && this._enabled) {\r\n            if (this._toggleRetryTimer) { try { clearTimeout(this._toggleRetryTimer); } catch (_) { } }\r\n            this._toggleRetryTimer = setTimeout(() => {\r\n                this._toggleRetryTimer = null;\r\n                applyVisibility();\r\n            }, 1200);\r\n        }\r\n    }\r\n\r\n    _persistEnabledState() {\r\n        try {\r\n            if (typeof window === 'undefined' || !window.localStorage) return;\r\n            window.localStorage.setItem(this._storageKeyEnabled, this._enabled ? '1' : '0');\r\n        } catch (_) { /* ignore */ }\r\n    }\r\n\r\n    _restoreEnabledState() {\r\n        if (this._restored) return; // 只尝试一次\r\n        this._restored = true;\r\n        try {\r\n            if (typeof window === 'undefined' || !window.localStorage) return;\r\n            const v = window.localStorage.getItem(this._storageKeyEnabled);\r\n            if (v === '1') this._enabled = true;\r\n            if (v === '0') this._enabled = false;\r\n        } catch (_) { /* ignore */ }\r\n    }\r\n\r\n    _onOpenSettings() {\r\n        // 悬停刚打开后 1 秒内点击忽略（防止意外闪烁关闭）\r\n        if (this._freezeClickUntil && Date.now() < this._freezeClickUntil) {\r\n            this.logger?.info?.('设置面板点击切换已被冻结 (hover 冷却中)');\r\n            return;\r\n        }\r\n        // 点击：切换设置面板\r\n        this.logger?.info?.('打开/关闭弹幕设置面板 (点击)');\r\n        try { this.settingsPanel.toggle(this.settingsButton); } catch (_) { }\r\n        this._ensureOutsideClickBinding();\r\n        this._afterMaybeOpened();\r\n    }\r\n\r\n    _onSettingsHoverOpen() {\r\n        if (this._settingsHoverTimer) { try { clearTimeout(this._settingsHoverTimer); } catch (_) { } }\r\n        this._settingsHoverTimer = setTimeout(() => {\r\n            this._settingsHoverTimer = null;\r\n            // 仅当未打开时才通过 hover 打开\r\n            const open = this.settingsPanel?.el && this.settingsPanel.el.getAttribute('data-open') === 'true';\r\n            if (!open) {\r\n                this.logger?.info?.('打开弹幕设置面板 (悬停)');\r\n                try { this.settingsPanel.show(this.settingsButton); } catch (_) { }\r\n                this._ensureOutsideClickBinding();\r\n                this._afterMaybeOpened();\r\n                // 设置 1 秒冷却期\r\n                this._freezeClickUntil = Date.now() + 1000;\r\n            }\r\n        }, 100);\r\n    }\r\n\r\n    _afterMaybeOpened() {\r\n        // 如果已打开，绑定面板 hover 事件；如果关闭，清理自动关闭计时器\r\n        const open = this.settingsPanel?.el && this.settingsPanel.el.getAttribute('data-open') === 'true';\r\n        if (open) {\r\n            this._bindPanelHoverHandlers();\r\n            this._bindPanelFocusHandlers();\r\n            this._clearSettingsAutoClose();\r\n        } else {\r\n            this._clearSettingsAutoClose();\r\n        }\r\n    }\r\n\r\n    _bindPanelHoverHandlers() {\r\n        if (!this.settingsPanel?.el) return;\r\n        if (this._panelHoverBound) return;\r\n        try { this.settingsPanel.el.addEventListener('mouseenter', this._onPanelMouseEnter, { passive: true }); } catch (_) { }\r\n        try { this.settingsPanel.el.addEventListener('mouseleave', this._onPanelMouseLeave, { passive: true }); } catch (_) { }\r\n        this._panelHoverBound = true;\r\n    }\r\n\r\n    _onSettingsButtonMouseLeave() {\r\n        // 清除悬停打开计时\r\n        if (this._settingsHoverTimer) { try { clearTimeout(this._settingsHoverTimer); } catch (_) { } this._settingsHoverTimer = null; }\r\n        // 若面板已打开，开始 5 秒自动关闭计时（如未进入面板区域将关闭）\r\n        this._scheduleSettingsAutoClose();\r\n    }\r\n\r\n    _onPanelMouseEnter() {\r\n        this._clearSettingsAutoClose();\r\n    }\r\n\r\n    _onPanelMouseLeave() {\r\n        this._scheduleSettingsAutoClose();\r\n    }\r\n\r\n    _scheduleSettingsAutoClose() {\r\n        const open = this.settingsPanel?.el && this.settingsPanel.el.getAttribute('data-open') === 'true';\r\n        if (!open) return;\r\n        // 固定状态下不自动关闭\r\n        if (this.settingsPanel?.isPinned && this.settingsPanel.isPinned()) return;\r\n        // 面板内存在焦点或处于输入法合成中时，不自动关闭\r\n        try {\r\n            const hasFocusInPanel = this.settingsPanel?.el?.contains?.((this.el && this.el.ownerDocument) ? this.el.ownerDocument.activeElement : document.activeElement);\r\n            if (hasFocusInPanel) { return; }\r\n        } catch (_) { /* ignore */ }\r\n        if (this._imeComposing) return;\r\n        this._clearSettingsAutoClose();\r\n        this._settingsAutoCloseTimer = setTimeout(() => {\r\n            // 再次确认是否仍未悬停\r\n            const stillOpen = this.settingsPanel?.el && this.settingsPanel.el.getAttribute('data-open') === 'true';\r\n            if (!stillOpen) return;\r\n            if (this.settingsPanel?.isPinned && this.settingsPanel.isPinned()) return; // pinned 期间不关闭\r\n            // 输入法合成或面板内焦点期间不关闭\r\n            try {\r\n                const hasFocusInPanel2 = this.settingsPanel?.el?.contains?.((this.el && this.el.ownerDocument) ? this.el.ownerDocument.activeElement : document.activeElement);\r\n                if (hasFocusInPanel2) { this._scheduleSettingsAutoClose(); return; }\r\n            } catch (_) { }\r\n            if (this._imeComposing) { this._scheduleSettingsAutoClose(); return; }\r\n            // 如果鼠标当前在按钮或面板上则取消\r\n            try {\r\n                const btnHover = this._isElementHovered(this.settingsButton);\r\n                const panelHover = this._isElementHovered(this.settingsPanel.el);\r\n                if (btnHover || panelHover) { this._scheduleSettingsAutoClose(); return; }\r\n            } catch (_) { }\r\n            try { this.settingsPanel.hide(); } catch (_) { }\r\n        }, 100);\r\n    }\r\n\r\n    _clearSettingsAutoClose() {\r\n        if (this._settingsAutoCloseTimer) { try { clearTimeout(this._settingsAutoCloseTimer); } catch (_) { } this._settingsAutoCloseTimer = null; }\r\n    }\r\n\r\n    _isElementHovered(el) {\r\n        if (!el) return false;\r\n        try {\r\n            return el.parentElement && Array.from((el.ownerDocument || document).querySelectorAll(':hover')).includes(el);\r\n        } catch (_) { return false; }\r\n    }\r\n\r\n    _ensureOutsideClickBinding() {\r\n        try {\r\n            if (!this._outsideClickBound) {\r\n                document.addEventListener('mousedown', this._onDocumentClick, true);\r\n                this._outsideClickBound = true;\r\n            }\r\n        } catch (_) { }\r\n    }\r\n\r\n    _onDocumentClick(e) {\r\n        try {\r\n            if (!this.settingsPanel?.el) return;\r\n            const open = this.settingsPanel.el.getAttribute('data-open') === 'true';\r\n            if (!open) return;\r\n            // 固定状态下，点击外部不关闭\r\n            if (this.settingsPanel?.isPinned && this.settingsPanel.isPinned()) return;\r\n            // 输入法候选面板期间或面板内存在焦点时，不因外部点击立即关闭（避免误触）\r\n            try {\r\n                const hasFocusInPanel = this.settingsPanel?.el?.contains?.((this.el && this.el.ownerDocument) ? this.el.ownerDocument.activeElement : document.activeElement);\r\n                if (this._imeComposing || hasFocusInPanel) {\r\n                    // 若点击目标确实是完全外部区域，则仅在合成结束后再评估\r\n                    // 这里放行点击，但不主动关闭\r\n                    return;\r\n                }\r\n            } catch (_) { }\r\n            if (this.settingsPanel.el.contains(e.target) || this.settingsButton.contains(e.target)) return;\r\n            this.settingsPanel.hide();\r\n            this._clearSettingsAutoClose();\r\n        } catch (_) { }\r\n    }\r\n\r\n    _bindPanelFocusHandlers() {\r\n        if (!this.settingsPanel?.el) return;\r\n        if (this._panelFocusBound) return;\r\n        const panelEl = this.settingsPanel.el;\r\n        // 定义回调（惰性创建）\r\n        if (!this._onPanelFocusIn) {\r\n            this._onPanelFocusIn = () => {\r\n                this._panelHasFocus = true;\r\n                this._clearSettingsAutoClose();\r\n            };\r\n        }\r\n        if (!this._onPanelFocusOut) {\r\n            this._onPanelFocusOut = () => {\r\n                // 延迟检查当前 activeElement 是否仍位于面板\r\n                setTimeout(() => {\r\n                    try {\r\n                        const ae = (this.el && this.el.ownerDocument) ? this.el.ownerDocument.activeElement : document.activeElement;\r\n                        this._panelHasFocus = !!this.settingsPanel?.el?.contains?.(ae);\r\n                        if (!this._panelHasFocus) {\r\n                            this._scheduleSettingsAutoClose();\r\n                        }\r\n                    } catch (_) { /* ignore */ }\r\n                }, 50);\r\n            };\r\n        }\r\n        if (!this._onCompositionStart) {\r\n            this._onCompositionStart = () => {\r\n                this._imeComposing = true;\r\n                this._clearSettingsAutoClose();\r\n            };\r\n        }\r\n        if (!this._onCompositionEnd) {\r\n            this._onCompositionEnd = () => {\r\n                this._imeComposing = false;\r\n                // 合成结束后，若鼠标不在面板/按钮且无焦点，再次评估是否需要关闭\r\n                this._scheduleSettingsAutoClose();\r\n            };\r\n        }\r\n        // 使用捕获阶段监听，保证能接收到内部控件事件\r\n        try {\r\n            panelEl.addEventListener('focusin', this._onPanelFocusIn, true);\r\n            panelEl.addEventListener('focusout', this._onPanelFocusOut, true);\r\n            panelEl.addEventListener('compositionstart', this._onCompositionStart, true);\r\n            panelEl.addEventListener('compositionend', this._onCompositionEnd, true);\r\n        } catch (_) { /* ignore */ }\r\n        this._panelFocusBound = true;\r\n    }\r\n\r\n    _injectStylesIfNeeded() {\r\n        if (typeof document === 'undefined') return;\r\n        const id = 'danmakuButtonsStyles';\r\n        if (document.getElementById(id)) return;\r\n        // 局部：生成 data-uri\r\n        const svgDataUri = (svg) => {\r\n            try {\r\n                const encoded = encodeURIComponent(svg)\r\n                    .replace(/'/g, '%27')\r\n                    .replace(/\\(/g, '%28')\r\n                    .replace(/\\)/g, '%29');\r\n                return `data:image/svg+xml;charset=UTF-8,${encoded}`;\r\n            } catch (_) { return ''; }\r\n        };\r\n        const SVG_TOGGLE_OFF = `<svg id=\"Layer_1\" viewBox=\"0 0 24 24\" xmlns=\"http://www.w3.org/2000/svg\" data-name=\"Layer 1\"><path d=\"m2.422 7.365 13.5 13.5c-.357.042-.717.08-1.075.108-.767.849-2.159 1.977-2.767 2.023-.76.042-2.069-1.124-2.927-2.023-2.545-.201-5.219-.806-5.338-.833-.333-.076-.604-.316-.719-.638-.011-.03-1.096-3.112-1.096-7.457 0-1.809.196-3.421.422-4.68zm20.139 13.074-1.486-1.486c.308-1.072.925-3.629.925-6.908 0-4.174-1.043-7.309-1.088-7.44-.109-.322-.375-.567-.705-.65-.156-.039-3.871-.955-8.208-.955-2.505 0-4.781.303-6.309.57l-2.129-2.131c-.586-.586-1.535-.586-2.121 0-.586.585-.586 1.536 0 2.121l18.999 19.001c.586.586 1.535.586 2.121 0 .586-.585.586-1.536 0-2.121z\"/></svg>`;\r\n        const SVG_TOGGLE_ON = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\\n<svg xmlns=\"http://www.w3.org/2000/svg\" id=\"Layer_1\" data-name=\"Layer 1\" viewBox=\"0 0 24 24\">\\n  <path d=\"M21.795,2.883c-.11-.32-.375-.562-.703-.644-.172-.043-4.259-1.047-9.092-1.047C7.254,1.192,3.088,2.196,2.913,2.238c-.332,.082-.6,.327-.71,.651-.049,.145-1.203,3.605-1.203,8.151s1.154,8.006,1.203,8.151c.11,.326,.38,.572,.715,.652,.109,.026,2.649,.628,5.954,.907,1.32,1.184,2.582,1.897,2.639,1.929,.151,.085,.32,.128,.489,.128,.162,0,.324-.04,.473-.119,.054-.029,1.274-.689,2.652-1.933,3.372-.277,5.858-.888,5.966-.915,.33-.082,.596-.326,.705-.647,.049-.144,1.204-3.579,1.204-8.153,0-4.614-1.156-8.015-1.205-8.157ZM7.437,5.846h3.096c.553,0,1,.448,1,1s-.447,1-1,1h-3.096c-.553,0-1-.448-1-1s.447-1,1-1Zm9.127,10.042H7.437c-.553,0-1-.448-1-1s.447-1,1-1h9.127c.553,0,1,.448,1,1s-.447,1-1,1Zm1-4.021H6.437c-.553,0-1-.448-1-1s.447-1,1-1h11.127c.553,0,1,.448,1,1s-.447,1-1,1Z\"/>\\n</svg>`;\r\n        const SVG_SETTINGS = `<svg id=\\\"Layer_1\\\" viewBox=\\\"0 0 24 24\\\" xmlns=\\\"http://www.w3.org/2000/svg\\\" data-name=\\\"Layer 1\\\"><path d=\\\"m21.977 2.786c-.083-.381-.381-.679-.762-.762-.19-.042-4.713-1.023-9.214-1.023s-9.025.98-9.215 1.022c-.381.083-.679.381-.762.762-.042.19-1.023 4.713-1.023 9.214s.981 9.024 1.023 9.214c.083.381.381.679.762.762.19.042 4.713 1.023 9.214 1.023s9.024-.981 9.214-1.023c.381-.083.679-.381.762-.762.042-.19 1.023-4.713 1.023-9.214s-.981-9.024-1.023-9.214zm-4.119 14.677c-.533-.077-1.165-.159-1.857-.232v.77c0 .552-.448 1-1 1s-1-.448-1-1v-.935c-.654-.039-1.327-.065-2-.065-1.724 0-3.749.161-5.857.465-.535.081-1.056-.297-1.133-.847-.079-.547.3-1.054.847-1.133 2.233-.322 4.299-.486 6.143-.486.674 0 1.345.024 2 .061v-1.061c0-.552.448-1 1-1s1 .448 1 1v1.22c.803.082 1.536.175 2.143.263.547.079.926.586.847 1.132-.079.547-.587.923-1.132.847zm0-8c-1.464-.211-3.669-.462-5.857-.462-.627 0-1.304.029-2 .07v.93c0 .552-.448 1-1 1s-1-.448-1-1v-.764c-.609.065-1.227.139-1.857.229-.535.081-1.056-.297-1.133-.847-.079-.547.3-1.054.847-1.133.736-.106 1.446-.189 2.143-.26v-1.226c0-.552.448-1 1-1s1 .448 1 1v1.066c.689-.039 1.362-.066 2-.066 2.307 0 4.614.263 6.143.483.547.079.926.586.847 1.132-.079.547-.587.923-1.132.847z\\\"/></svg>`;\r\n        const ICON_TOGGLE_OFF = svgDataUri(SVG_TOGGLE_OFF);\r\n        const ICON_TOGGLE_ON = svgDataUri(SVG_TOGGLE_ON);\r\n        const ICON_SETTINGS = svgDataUri(SVG_SETTINGS);\r\n        const css = `\r\n        /* 尽量贴近 Jellyfin：最小化覆盖，仅定义图标 span 的显示与 mask */\r\n        [data-danmaku-buttons] .danmaku-input-wrapper { display:flex; align-items:center; }\r\n        [data-danmaku-buttons] .danmaku-text-input {\r\n            width: 80px; max-width:200px; height:24px; box-sizing:border-box;\r\n            background: rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.25); color:#fff;\r\n            border-radius:4px; padding:0 6px; font-size:12px; line-height:22px; outline:none;\r\n            transition: width .25s ease, border-color .2s ease;\r\n        }\r\n        [data-danmaku-buttons] .danmaku-text-input:focus { border-color:#3fa9ff; }\r\n        [data-danmaku-buttons][data-enabled=\"false\"] .danmaku-text-input { opacity:.7; }\r\n        [data-danmaku-buttons] .danmaku-input-wrapper.active .danmaku-text-input { width:160px; }\r\n        [data-danmaku-buttons] .danmaku-send-btn { display:none; margin-left:4px; background:rgba(63,169,255,0.15); border:1px solid rgba(63,169,255,0.6); color:#fff; border-radius:4px; padding:0 6px; height:24px; font-size:12px; cursor:pointer; }\r\n        [data-danmaku-buttons] .danmaku-send-btn:hover { background:rgba(63,169,255,0.25); }\r\n        [data-danmaku-buttons] .danmaku-input-wrapper.active .danmaku-send-btn { display:inline-flex; align-items:center; }\r\n        [data-danmaku-buttons] .danmaku-btn {\r\n            background: none;\r\n            border: 0;\r\n            color: inherit;\r\n            cursor: pointer;\r\n        }\r\n        [data-danmaku-buttons] .danmaku-icon {\r\n            display: inline-block;\r\n            width: 24px; height: 24px;\r\n            background-color: currentColor;\r\n            -webkit-mask-position: center; mask-position: center;\r\n            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;\r\n            -webkit-mask-size: 24px 24px; mask-size: 24px 24px;\r\n        }\r\n        [data-danmaku-buttons] .danmaku-settings-btn .danmaku-icon {\r\n            -webkit-mask-image: url(${ICON_SETTINGS});\r\n            mask-image: url(${ICON_SETTINGS});\r\n        }\r\n        [data-danmaku-buttons] .danmaku-toggle-btn .danmaku-icon {\r\n            -webkit-mask-image: url(${ICON_TOGGLE_OFF});\r\n            mask-image: url(${ICON_TOGGLE_OFF});\r\n        }\r\n        [data-danmaku-buttons][data-enabled=\"true\"] .danmaku-toggle-btn .danmaku-icon {\r\n            -webkit-mask-image: url(${ICON_TOGGLE_ON});\r\n            mask-image: url(${ICON_TOGGLE_ON});\r\n        }\r\n        `;\r\n        const style = document.createElement('style');\r\n        style.id = id;\r\n        style.appendChild(document.createTextNode(css));\r\n        try { (document.head || document.documentElement).appendChild(style); } catch (_) { }\r\n    }\r\n\r\n    _createToggleButton() {\r\n        const btn = document.createElement('button');\r\n        btn.type = 'button';\r\n        btn.textContent = '';\r\n        // 适配控制条原生按钮的结构标记，避免被样式隐藏\r\n        btn.setAttribute('is', 'paper-icon-button-light');\r\n        btn.className = 'paper-icon-button-light autoSize danmaku-btn danmaku-toggle-btn btnDanmakuToggle';\r\n        btn.setAttribute('data-danmaku-btn', 'toggle');\r\n        btn.setAttribute('title', '弹幕开关');\r\n        btn.setAttribute('aria-pressed', 'false');\r\n        // 内层 span，贴近 Jellyfin DOM 结构\r\n        const icon = document.createElement('span');\r\n        icon.className = 'xlargePaperIconButton material-icons danmaku-icon';\r\n        icon.setAttribute('aria-hidden', 'true');\r\n        btn.appendChild(icon);\r\n        return btn;\r\n    }\r\n\r\n    _createTextInput() {\r\n        const wrap = document.createElement('div');\r\n        wrap.className = 'danmaku-input-wrapper';\r\n        const input = document.createElement('input');\r\n        input.type = 'text';\r\n        input.placeholder = '发送弹幕';\r\n        input.className = 'danmaku-text-input';\r\n        input.setAttribute('data-danmaku-input', 'text');\r\n        input.id = 'danmakuInputField';\r\n        input.name = 'danmakuInput';\r\n        input.setAttribute('aria-label', '弹幕输入');\r\n        const sendBtn = document.createElement('button');\r\n        sendBtn.type = 'button';\r\n        sendBtn.textContent = '发送';\r\n        sendBtn.className = 'danmaku-send-btn';\r\n        sendBtn.setAttribute('aria-label', '发送弹幕');\r\n        // Enter 时简单记录日志（未来可接入真实发送逻辑）\r\n        try {\r\n            const sendCurrent = (keepFocus = true) => {\r\n                const txt = input.value.trim();\r\n                if (!txt) return;\r\n                // 获取全局 danmakuRenderer\r\n                let emitted = false;\r\n                try {\r\n                    const g = (typeof window !== 'undefined') ? window.__jfDanmakuGlobal__ : null;\r\n                    const renderer = g?.danmakuRenderer;\r\n                    if (renderer) {\r\n                        // 选择时间：优先使用绑定媒体的 currentTime；否则使用 0\r\n                        const t = (renderer.media && !isNaN(renderer.media.currentTime)) ? renderer.media.currentTime : 0;\r\n                        renderer.emit({\r\n                            text: txt,\r\n                            time: t,\r\n                            mode: 'rtl',\r\n                            style: {\r\n                                font: '25px sans-serif',\r\n                                fillStyle: '#FFFFFF',\r\n                                strokeStyle: '#000',\r\n                                lineWidth: 2,\r\n                                textBaseline: 'bottom'\r\n                            }\r\n                        });\r\n                        // 确保显示/播放\r\n                        try { renderer.show && renderer.show(); } catch (_) { }\r\n                        emitted = true;\r\n                    }\r\n                } catch (err) {\r\n                    this.logger?.warn?.('发送弹幕失败(emit异常)', err);\r\n                }\r\n                if (emitted) {\r\n                    this.logger?.info?.('发送弹幕: ' + txt);\r\n                } else {\r\n                    this.logger?.info?.('发送弹幕失败: 找不到全局 danmakuRenderer');\r\n                }\r\n                input.value = '';\r\n                // 发送后保持展开\r\n                wrap.classList.add('active');\r\n                if (keepFocus) {\r\n                    try { input.focus(); } catch (_) { }\r\n                }\r\n            };\r\n            input.addEventListener('keydown', (e) => {\r\n                if (e.key === 'Enter') {\r\n                    e.preventDefault();\r\n                    sendCurrent(true); // Enter 保持焦点\r\n                }\r\n            });\r\n            input.addEventListener('focus', () => {\r\n                wrap.classList.add('active');\r\n                // 安装全局快捷键拦截\r\n                if (!this._globalKeyInterceptor) {\r\n                    this._globalKeyInterceptor = (ev) => {\r\n                        // 只在当前输入框保持焦点时拦截\r\n                        if (document.activeElement === input) {\r\n                            // 允许的按键（不拦截）：组合键(含Ctrl/Alt/Meta)、Tab、Escape 让其正常冒泡\r\n                            if (ev.key === 'Escape') { return; }\r\n                            if (ev.ctrlKey || ev.metaKey || ev.altKey) { return; }\r\n                            // 放行 Enter 以便输入框自身监听处理发送\r\n                            if (ev.key === 'Enter') { return; }\r\n                            // 其它按键阻断到播放器的全局监听\r\n                            ev.stopPropagation();\r\n                            ev.stopImmediatePropagation?.();\r\n                            // Space 防止页面滚动\r\n                            if (ev.key === ' ' || ev.code === 'Space') {\r\n                                ev.preventDefault();\r\n                            }\r\n                        }\r\n                    };\r\n                }\r\n                try { document.addEventListener('keydown', this._globalKeyInterceptor, true); } catch (_) { }\r\n            });\r\n            input.addEventListener('blur', (e) => {\r\n                // 若为空则收起（延迟允许点击按钮）\r\n                setTimeout(() => {\r\n                    if (!input.value.trim()) wrap.classList.remove('active');\r\n                    // 失焦解除拦截\r\n                    try { document.removeEventListener('keydown', this._globalKeyInterceptor, true); } catch (_) { }\r\n                }, 120);\r\n            });\r\n            sendBtn.addEventListener('click', () => {\r\n                if (!input.value.trim()) { wrap.classList.remove('active'); return; }\r\n                sendCurrent(false); // 点击发送后不保留焦点\r\n                try { input.blur(); } catch (_) { }\r\n            });\r\n        } catch (_) { }\r\n        wrap.appendChild(input);\r\n        wrap.appendChild(sendBtn);\r\n        return wrap;\r\n    }\r\n\r\n    _createSettingsButton() {\r\n        const btn = document.createElement('button');\r\n        btn.type = 'button';\r\n        btn.textContent = '';\r\n        // 适配控制条原生按钮的结构标记，避免被样式隐藏\r\n        btn.setAttribute('is', 'paper-icon-button-light');\r\n        btn.className = 'paper-icon-button-light autoSize danmaku-btn danmaku-settings-btn btnDanmakuSettings';\r\n        btn.setAttribute('data-danmaku-btn', 'settings');\r\n        btn.setAttribute('title', '弹幕设置');\r\n        const icon = document.createElement('span');\r\n        icon.className = 'xlargePaperIconButton material-icons danmaku-icon';\r\n        icon.setAttribute('aria-hidden', 'true');\r\n        btn.appendChild(icon);\r\n        return btn;\r\n    }\r\n    // 销毁（供外部在 destroy 时调用）\r\n    destroy() {\r\n        if (this._toggleRetryTimer) { try { clearTimeout(this._toggleRetryTimer); } catch (_) { } this._toggleRetryTimer = null; }\r\n        try { this.toggleButton?.removeEventListener('click', this._onToggle); } catch (_) { }\r\n        try { this.settingsButton?.removeEventListener('click', this._onOpenSettings); } catch (_) { }\r\n        try { this.settingsButton?.removeEventListener('mouseenter', this._onSettingsHoverOpen); } catch (_) { }\r\n        try { this.settingsButton?.removeEventListener('mouseleave', this._onSettingsButtonMouseLeave); } catch (_) { }\r\n        try { this.inputEl?.querySelector?.('input')?.removeEventListener?.('keydown'); } catch (_) { }\r\n        try { document.removeEventListener('keydown', this._globalKeyInterceptor, true); } catch (_) { }\r\n        try { document.removeEventListener('mousedown', this._onDocumentClick, true); } catch (_) { }\r\n        // 粗略清理自定义事件（直接置空 wrapper 即可被 GC）\r\n        try { this.el?.parentElement?.removeChild(this.el); } catch (_) { }\r\n        if (this.settingsPanel?.el) {\r\n            try { this.settingsPanel.el.removeEventListener('mouseenter', this._onPanelMouseEnter); } catch (_) { }\r\n            try { this.settingsPanel.el.removeEventListener('mouseleave', this._onPanelMouseLeave); } catch (_) { }\r\n            try { this.settingsPanel.el.removeEventListener('focusin', this._onPanelFocusIn, true); } catch (_) { }\r\n            try { this.settingsPanel.el.removeEventListener('focusout', this._onPanelFocusOut, true); } catch (_) { }\r\n            try { this.settingsPanel.el.removeEventListener('compositionstart', this._onCompositionStart, true); } catch (_) { }\r\n            try { this.settingsPanel.el.removeEventListener('compositionend', this._onCompositionEnd, true); } catch (_) { }\r\n        }\r\n        this._clearSettingsAutoClose();\r\n        try { this.settingsPanel?.destroy?.(); } catch (_) { }\r\n        this.el = null;\r\n        this.inputEl = null;\r\n        this.toggleButton = null;\r\n        this.settingsButton = null;\r\n    }\r\n}\r\n","/**\r\n * 弹幕热力图渲染器类\r\n * 用于生成弹幕密度的可视化热力图\r\n * \r\n */\r\n\r\n// 通过 ES Module 导出，便于 Rollup 打包。\r\nexport class DanmakuHeatmapRenderer {\r\n    /**\r\n     * 构造函数\r\n     * @param {Object} options - 配置选项\r\n     * @param {number} options.width - Canvas宽度，默认800（如果autoResize为true则会被覆盖）\r\n     * @param {number} options.height - Canvas高度，默认60\r\n     * @param {boolean} options.debug - 是否开启调试模式，默认false\r\n     * @param {boolean} options.autoResize - 是否自动响应父容器宽度变化，默认false\r\n     * @param {number} options.resizeThreshold - 重新渲染的宽度变化阈值，默认50像素\r\n     * @param {number} options.resizeDebounceDelay - 宽度变化防抖延迟时间（毫秒），默认300\r\n     * @param {number} options.lineWidth - 线条宽度，默认1\r\n     * @param {string} options.color - 颜色方案，可选：'blue', 'red', 'green', 'purple', 'orange'，默认'blue'\r\n    * @param {string} options.canvasId - 生成的Canvas元素ID，默认 'danmaku-heatmap-canvas'\r\n     */\r\n    constructor(options = {}) {\r\n        // 颜色预设方案\r\n        const colorPresets = {\r\n            blue: {\r\n                lineColor: '#3498db',\r\n                gradientColorStart: 'rgba(52, 152, 219, 0.08)',\r\n                gradientColorEnd: 'rgba(52, 152, 219, 0.25)'\r\n            },\r\n            red: {\r\n                lineColor: '#e74c3c',\r\n                gradientColorStart: 'rgba(231, 76, 60, 0.1)',\r\n                gradientColorEnd: 'rgba(231, 76, 60, 0.4)'\r\n            },\r\n            green: {\r\n                lineColor: '#27ae60',\r\n                gradientColorStart: 'rgba(39, 174, 96, 0.1)',\r\n                gradientColorEnd: 'rgba(39, 174, 96, 0.3)'\r\n            },\r\n            purple: {\r\n                lineColor: '#8e44ad',\r\n                gradientColorStart: 'rgba(142, 68, 173, 0.15)',\r\n                gradientColorEnd: 'rgba(142, 68, 173, 0.45)'\r\n            },\r\n            orange: {\r\n                lineColor: '#f39c12',\r\n                gradientColorStart: 'rgba(243, 156, 18, 0.1)',\r\n                gradientColorEnd: 'rgba(243, 156, 18, 0.3)'\r\n            }\r\n        };\r\n\r\n        // 获取颜色方案\r\n        const colorScheme = options.color || 'blue';\r\n        const selectedColors = colorPresets[colorScheme] || colorPresets.blue;\r\n\r\n        this.options = {\r\n            width: options.width || 800,\r\n            height: options.height || 60,\r\n            debug: options.debug || false,\r\n            autoResize: options.autoResize || false,\r\n\r\n            // 线条样式配置\r\n            lineWidth: options.lineWidth || 1,\r\n            color: colorScheme,\r\n\r\n            // 从预设方案中获取的颜色配置\r\n            lineColor: selectedColors.lineColor,\r\n            gradientColorStart: selectedColors.gradientColorStart,\r\n            gradientColorEnd: selectedColors.gradientColorEnd,\r\n            canvasId: options.canvasId || 'danmaku-heatmap-canvas',\r\n\r\n            ...options\r\n        };\r\n\r\n        this.canvas = null;\r\n        this.ctx = null;\r\n        this.rawData = [];          // 原始热力图数据\r\n        this.processedData = [];    // 处理后的数据\r\n        this.actualDuration = 0;    // 视频实际时长（秒）\r\n        this.maxDensity = 0;\r\n        this.minDensity = 0;\r\n        this.resizeObserver = null; // ResizeObserver实例\r\n        this.parentContainer = null; // 父容器引用\r\n\r\n        // 缓存和性能优化相关\r\n        this.lastRenderedWidth = 0;                              // 上次渲染的宽度\r\n        this.resizeThreshold = options.resizeThreshold || 10;    // 重新渲染的宽度变化阈值\r\n        this.cachedCanvas = null;                                // 缓存的Canvas内容\r\n\r\n        // 防抖相关属性\r\n        this.resizeDebounceTimer = null;                         // 防抖计时器\r\n        this.resizeDebounceDelay = options.resizeDebounceDelay || 300; // 防抖延迟时间（毫秒）\r\n        this.pendingWidth = null;                                // 等待处理的宽度值\r\n\r\n        this.debugLog('热力图渲染器已初始化');\r\n        this.debugLog('样式配置:', {\r\n            lineWidth: this.options.lineWidth,\r\n            color: this.options.color,\r\n            lineColor: this.options.lineColor,\r\n            gradientColorStart: this.options.gradientColorStart,\r\n            gradientColorEnd: this.options.gradientColorEnd,\r\n            autoResize: this.options.autoResize\r\n        });\r\n    }\r\n\r\n    /**\r\n     * 调试日志输出\r\n     * @param {string} message - 日志消息\r\n     * @param {...any} args - 额外参数\r\n     */\r\n    debugLog(message, ...args) {\r\n        if (this.options.debug) {\r\n            console.log(`[弹幕热力图] ${message}`, ...args);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 设置热力图原始数据\r\n     * @param {Array} data - 热力图数据数组\r\n     * @param {number} data[].start_time_seconds - 开始时间（秒）\r\n     * @param {number} data[].end_time_seconds - 结束时间（秒）\r\n     * @param {number} data[].average_density - 平均密度\r\n     */\r\n    setHeatmapData(data) {\r\n        // 允许 data 为空或未定义：视为“无数据”正常场景\r\n        if (data == null) data = [];\r\n        if (!Array.isArray(data)) {\r\n            throw new Error('热力图数据必须是数组格式');\r\n        }\r\n\r\n        // 空数组保持 rawData = []，后续流程会创建空白 Canvas\r\n        if (data.length === 0) {\r\n            this.rawData = [];\r\n            this.debugLog('设置热力图数据：空数组（正常化处理）');\r\n            return this;\r\n        }\r\n\r\n        this.rawData = data.map(item => ({\r\n            start_time_seconds: Number(item.start_time_seconds),\r\n            end_time_seconds: Number(item.end_time_seconds),\r\n            average_density: Number(item.average_density)\r\n        }));\r\n\r\n        this.debugLog('设置热力图数据，共', this.rawData.length, '个数据段');\r\n        this.debugLog('原始数据详情:', JSON.stringify(this.rawData, null, 2));\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * 设置视频实际时长\r\n     * @param {number} duration - 视频时长（秒）\r\n     */\r\n    setActualDuration(duration) {\r\n        this.actualDuration = Number(duration);\r\n        this.debugLog('设置视频实际时长:', this.actualDuration, '秒');\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * 预处理热力图数据\r\n     * 根据视频实际时长调整数据范围和填充\r\n     */\r\n    preprocessData() {\r\n        if (this.rawData.length === 0) {\r\n            this.debugLog('没有原始数据，跳过预处理');\r\n            return this;\r\n        }\r\n\r\n        // 1. 排序数据\r\n        let data = [...this.rawData].sort((a, b) => a.start_time_seconds - b.start_time_seconds);\r\n        this.debugLog('排序后数据:', JSON.stringify(data, null, 2));\r\n\r\n        // 2. 获取数据时长\r\n        const dataDuration = data[data.length - 1].end_time_seconds;\r\n        this.debugLog('数据时长:', dataDuration, '秒');\r\n\r\n        if (this.actualDuration <= 0) {\r\n            this.debugLog('未设置视频时长，使用原始数据');\r\n            this.processedData = data;\r\n            this.debugLog('最终处理数据:', JSON.stringify(this.processedData, null, 2));\r\n            return this;\r\n        }\r\n\r\n        // 3. 根据实际时长调整数据\r\n        data = this.adjustDataByDuration(data, dataDuration, this.actualDuration);\r\n        this.processedData = data;\r\n\r\n        this.debugLog('数据预处理完成，最终数据段数量:', this.processedData.length);\r\n        this.debugLog('最终处理数据:', JSON.stringify(this.processedData, null, 2));\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * 根据实际时长调整数据\r\n     * @param {Array} data - 数据数组\r\n     * @param {number} dataDuration - 数据时长\r\n     * @param {number} actualDuration - 实际时长\r\n     * @returns {Array} 调整后的数据\r\n     */\r\n    adjustDataByDuration(data, dataDuration, actualDuration) {\r\n        const timeDiff = dataDuration - actualDuration;\r\n        this.debugLog('时间差:', timeDiff, '秒');\r\n        this.debugLog('调整前数据:', JSON.stringify(data, null, 2));\r\n\r\n        if (timeDiff > 0) {\r\n            // 数据时长比视频总时长长，删除多余数据\r\n            this.debugLog('删除超出视频时长的数据');\r\n            const originalLength = data.length;\r\n            data = data.filter(item => item.start_time_seconds < actualDuration);\r\n            this.debugLog(`过滤后: ${originalLength} -> ${data.length} 个数据段`);\r\n\r\n            // 调整最后一个数据的结束时间\r\n            if (data.length > 0) {\r\n                const lastItem = data[data.length - 1];\r\n                if (lastItem.end_time_seconds > actualDuration) {\r\n                    const oldEndTime = lastItem.end_time_seconds;\r\n                    lastItem.end_time_seconds = actualDuration;\r\n                    this.debugLog(`调整最后一个数据的结束时间: ${oldEndTime} -> ${actualDuration}`);\r\n                }\r\n            }\r\n        } else if (timeDiff < -2) {\r\n            // 数据时长比视频总时长短2秒以上，添加填充数据\r\n            this.debugLog('添加填充数据到视频结尾');\r\n\r\n            // 第一个填充数据：密度为0，持续1秒\r\n            const firstPadding = {\r\n                start_time_seconds: dataDuration,\r\n                end_time_seconds: dataDuration + 1,\r\n                average_density: 0\r\n            };\r\n            data.push(firstPadding);\r\n            this.debugLog('添加第一个填充数据:', JSON.stringify(firstPadding, null, 2));\r\n\r\n            // 第二个填充数据：密度为0，到视频结尾\r\n            const secondPadding = {\r\n                start_time_seconds: dataDuration + 1,\r\n                end_time_seconds: actualDuration,\r\n                average_density: 0\r\n            };\r\n            data.push(secondPadding);\r\n            this.debugLog('添加第二个填充数据:', JSON.stringify(secondPadding, null, 2));\r\n\r\n            this.debugLog('添加了2个填充数据段');\r\n        }\r\n\r\n        this.debugLog('调整后数据:', JSON.stringify(data, null, 2));\r\n        return data;\r\n    }\r\n\r\n    /**\r\n     * 计算密度范围\r\n     */\r\n    calculateDensityRange() {\r\n        if (this.processedData.length === 0) return;\r\n\r\n        this.maxDensity = Math.max(...this.processedData.map(d => d.average_density));\r\n        this.minDensity = Math.min(...this.processedData.map(d => d.average_density));\r\n\r\n        // 确保有一定的范围，即使所有值相同\r\n        if (this.maxDensity === this.minDensity) {\r\n            this.maxDensity += 1;\r\n        }\r\n\r\n        this.debugLog('密度范围:', this.minDensity, '到', this.maxDensity);\r\n    }\r\n\r\n    /**\r\n     * 设置ResizeObserver来监听父容器尺寸变化\r\n     */\r\n    setupResizeObserver() {\r\n        if (!this.canvas) return;\r\n\r\n        // 检查浏览器是否支持ResizeObserver\r\n        if (typeof ResizeObserver === 'undefined') {\r\n            this.debugLog('浏览器不支持ResizeObserver，跳过自动调整大小功能');\r\n            return;\r\n        }\r\n\r\n        // 获取父容器\r\n        this.parentContainer = this.canvas.parentElement;\r\n        if (!this.parentContainer) {\r\n            this.debugLog('未找到父容器，等待Canvas插入DOM后再设置ResizeObserver');\r\n            return;\r\n        }\r\n\r\n        this.debugLog('设置ResizeObserver，监听父容器:', this.parentContainer);\r\n\r\n        // 创建ResizeObserver\r\n        this.resizeObserver = new ResizeObserver((entries) => {\r\n            for (const entry of entries) {\r\n                this.handleResize(entry);\r\n            }\r\n        });\r\n\r\n        // 开始监听父容器\r\n        this.resizeObserver.observe(this.parentContainer);\r\n\r\n        // 立即进行一次尺寸调整\r\n        this.updateCanvasSize();\r\n    }\r\n\r\n    /**\r\n     * 处理容器尺寸变化（带防抖功能）\r\n     * @param {ResizeObserverEntry} entry - ResizeObserver条目\r\n     */\r\n    handleResize(entry) {\r\n        const newWidth = Math.floor(entry.contentRect.width);\r\n\r\n        if (newWidth !== this.options.width && newWidth > 0) {\r\n            this.debugLog(`容器宽度变化检测: ${this.options.width}px -> ${newWidth}px`);\r\n\r\n            // 立即更新Canvas尺寸以保持视觉连续性\r\n            this.options.width = newWidth;\r\n            this.updateCanvasSize();\r\n\r\n            // 立即进行临时的缩放渲染，避免热力图消失\r\n            this.performQuickResize();\r\n\r\n            // 存储待处理的宽度值\r\n            this.pendingWidth = newWidth;\r\n\r\n            // 清除之前的防抖计时器\r\n            if (this.resizeDebounceTimer) {\r\n                clearTimeout(this.resizeDebounceTimer);\r\n                this.debugLog('清除之前的防抖计时器');\r\n            }\r\n\r\n            // 设置新的防抖计时器\r\n            this.resizeDebounceTimer = setTimeout(() => {\r\n                this.processResizeChange();\r\n            }, this.resizeDebounceDelay);\r\n\r\n            this.debugLog(`设置防抖计时器，${this.resizeDebounceDelay}ms后执行重新计算`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 快速调整尺寸 - 使用缓存内容进行简单缩放\r\n     */\r\n    performQuickResize() {\r\n        if (this.cachedCanvas) {\r\n            // 使用缓存的内容进行快速缩放\r\n            this.ctx.clearRect(0, 0, this.options.width, this.options.height);\r\n\r\n            // 计算设备像素比\r\n            const devicePixelRatio = window.devicePixelRatio || 1;\r\n\r\n            // 计算缓存内容的逻辑尺寸\r\n            const cacheLogicalWidth = this.cachedCanvas.width / devicePixelRatio;\r\n            const cacheLogicalHeight = this.cachedCanvas.height / devicePixelRatio;\r\n\r\n            // 直接缩放绘制缓存内容到新尺寸\r\n            this.ctx.drawImage(\r\n                this.cachedCanvas,\r\n                0, 0, this.cachedCanvas.width, this.cachedCanvas.height,\r\n                0, 0, this.options.width, this.options.height\r\n            );\r\n\r\n            this.debugLog(`使用缓存内容进行快速缩放: ${cacheLogicalWidth}x${cacheLogicalHeight} -> ${this.options.width}x${this.options.height}`);\r\n        } else if (this.processedData && this.processedData.length > 0) {\r\n            // 如果没有缓存，进行快速重绘\r\n            this.drawHeatmap();\r\n            this.debugLog('执行快速重绘');\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 处理防抖后的尺寸变化\r\n     */\r\n    processResizeChange() {\r\n        if (this.pendingWidth === null) return;\r\n\r\n        const widthDifference = Math.abs(this.pendingWidth - this.lastRenderedWidth);\r\n\r\n        this.debugLog(`防抖处理完成，最终宽度: ${this.pendingWidth}px`);\r\n        this.debugLog(`与上次渲染宽度(${this.lastRenderedWidth}px)差值: ${widthDifference}px, 阈值: ${this.resizeThreshold}px`);\r\n\r\n        // 检查是否需要重新渲染\r\n        if (widthDifference >= this.resizeThreshold) {\r\n            this.debugLog('宽度变化超过阈值，执行重新渲染');\r\n            this.redraw();\r\n            this.lastRenderedWidth = this.pendingWidth;\r\n            this.cacheCanvas(); // 缓存新的渲染结果\r\n        } else {\r\n            this.debugLog('宽度变化未超过阈值，使用缓存内容');\r\n            this.restoreFromCache();\r\n        }\r\n\r\n        // 清理\r\n        this.pendingWidth = null;\r\n        this.resizeDebounceTimer = null;\r\n    }\r\n\r\n    /**\r\n     * 更新Canvas尺寸\r\n     */\r\n    updateCanvasSize() {\r\n        if (!this.canvas) return;\r\n\r\n        // 获取设备像素比，确保高清显示\r\n        const devicePixelRatio = window.devicePixelRatio || 1;\r\n\r\n        this.debugLog('更新Canvas尺寸:', this.options.width, 'x', this.options.height, '设备像素比:', devicePixelRatio);\r\n\r\n        // 设置Canvas的内部分辨率（考虑设备像素比）\r\n        this.canvas.width = this.options.width * devicePixelRatio;\r\n        this.canvas.height = this.options.height * devicePixelRatio;\r\n\r\n        // 设置Canvas的CSS显示尺寸\r\n        this.canvas.style.width = this.options.width + 'px';\r\n        this.canvas.style.height = this.options.height + 'px';\r\n\r\n        // 重新获取上下文（Canvas尺寸变化后上下文会重置）\r\n        this.ctx = this.canvas.getContext('2d');\r\n\r\n        // 缩放上下文以匹配设备像素比\r\n        this.ctx.scale(devicePixelRatio, devicePixelRatio);\r\n\r\n        this.debugLog('Canvas分辨率已设置为:', this.canvas.width, 'x', this.canvas.height);\r\n        this.debugLog('Canvas显示尺寸:', this.canvas.style.width, 'x', this.canvas.style.height);\r\n    }\r\n\r\n    /**\r\n     * 重新绘制热力图\r\n     */\r\n    redraw() {\r\n        if (!this.processedData || this.processedData.length === 0) {\r\n            this.debugLog('没有处理过的数据，跳过重绘');\r\n            return;\r\n        }\r\n\r\n        this.debugLog('重新绘制热力图');\r\n\r\n        // 重新应用缩放（因为updateCanvasSize会重置上下文）\r\n        const devicePixelRatio = window.devicePixelRatio || 1;\r\n        this.ctx.setTransform(1, 0, 0, 1, 0, 0); // 重置变换\r\n        this.ctx.scale(devicePixelRatio, devicePixelRatio);\r\n\r\n        this.calculateDensityRange();\r\n        this.drawHeatmap();\r\n\r\n        // 重绘完成后缓存新内容\r\n        this.cacheCanvas();\r\n    }\r\n\r\n    /**\r\n     * 销毁ResizeObserver和清理资源\r\n     */\r\n    destroy() {\r\n        // 清理防抖计时器\r\n        if (this.resizeDebounceTimer) {\r\n            clearTimeout(this.resizeDebounceTimer);\r\n            this.resizeDebounceTimer = null;\r\n            this.debugLog('防抖计时器已清理');\r\n        }\r\n\r\n        if (this.resizeObserver) {\r\n            this.resizeObserver.disconnect();\r\n            this.resizeObserver = null;\r\n            this.debugLog('ResizeObserver已销毁');\r\n        }\r\n\r\n        // 清理缓存和待处理状态\r\n        this.cachedCanvas = null;\r\n        this.pendingWidth = null;\r\n    }\r\n\r\n    /**\r\n     * 缓存当前Canvas内容\r\n     */\r\n    cacheCanvas() {\r\n        if (!this.canvas) return;\r\n\r\n        try {\r\n            // 创建缓存Canvas\r\n            this.cachedCanvas = document.createElement('canvas');\r\n            this.cachedCanvas.width = this.canvas.width;\r\n            this.cachedCanvas.height = this.canvas.height;\r\n\r\n            const cacheCtx = this.cachedCanvas.getContext('2d');\r\n            cacheCtx.drawImage(this.canvas, 0, 0);\r\n\r\n            this.debugLog('Canvas内容已缓存，尺寸:', this.canvas.width, 'x', this.canvas.height);\r\n        } catch (error) {\r\n            this.debugLog('缓存Canvas失败:', error);\r\n            this.cachedCanvas = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 从缓存恢复Canvas内容\r\n     */\r\n    restoreFromCache() {\r\n        if (!this.cachedCanvas || !this.canvas || !this.ctx) {\r\n            this.debugLog('无法从缓存恢复：缓存不存在或Canvas未初始化');\r\n            return false;\r\n        }\r\n\r\n        try {\r\n            // 清空当前Canvas\r\n            this.ctx.clearRect(0, 0, this.options.width, this.options.height);\r\n\r\n            // 计算缩放比例以适应新的Canvas尺寸\r\n            const scaleX = this.options.width / (this.cachedCanvas.width / (window.devicePixelRatio || 1));\r\n            const scaleY = this.options.height / (this.cachedCanvas.height / (window.devicePixelRatio || 1));\r\n\r\n            // 保存当前状态\r\n            this.ctx.save();\r\n\r\n            // 应用缩放\r\n            this.ctx.scale(scaleX, scaleY);\r\n\r\n            // 绘制缓存的内容\r\n            this.ctx.drawImage(this.cachedCanvas, 0, 0, this.cachedCanvas.width / (window.devicePixelRatio || 1), this.cachedCanvas.height / (window.devicePixelRatio || 1));\r\n\r\n            // 恢复状态\r\n            this.ctx.restore();\r\n\r\n            this.debugLog('从缓存恢复Canvas内容，缩放比例:', scaleX.toFixed(2), 'x', scaleY.toFixed(2));\r\n            return true;\r\n        } catch (error) {\r\n            this.debugLog('从缓存恢复失败:', error);\r\n            return false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 创建并渲染Canvas元素\r\n     * @param {Object} styleOptions - 样式选项\r\n     * @returns {HTMLCanvasElement} 渲染好的Canvas元素\r\n     */\r\n    createCanvas(styleOptions = {}) {\r\n    // 允许 processedData 为空：返回空白（透明）Canvas，供外层正常挂载\r\n    const noData = !this.processedData || this.processedData.length === 0;\r\n\r\n        // 获取设备像素比，确保高清显示\r\n        const devicePixelRatio = window.devicePixelRatio || 1;\r\n\r\n        // 创建Canvas元素\r\n        this.canvas = document.createElement('canvas');\r\n        this.canvas.id = this.options.canvasId; // 使用可自定义的ID\r\n\r\n        // 设置Canvas的内部分辨率（考虑设备像素比）\r\n        this.canvas.width = this.options.width * devicePixelRatio;\r\n        this.canvas.height = this.options.height * devicePixelRatio;\r\n\r\n        // 应用默认样式\r\n        const defaultStyle = {\r\n            width: '100%',\r\n            height: '40px',\r\n            display: 'block',\r\n            margin: '0',\r\n            padding: '0',\r\n            borderRadius: '4px',\r\n            background: 'transparent',\r\n            pointerEvents: 'none',\r\n            position: 'absolute',\r\n            top: '-47px',\r\n            left: '0',\r\n            zIndex: '1',\r\n            opacity: '0.8'\r\n        };\r\n\r\n        const finalStyle = { ...defaultStyle, ...styleOptions };\r\n        Object.assign(this.canvas.style, finalStyle);\r\n\r\n        // 确保CSS显示尺寸正确\r\n        this.canvas.style.width = this.options.width + 'px';\r\n        this.canvas.style.height = this.options.height + 'px';\r\n\r\n        this.ctx = this.canvas.getContext('2d');\r\n\r\n        // 缩放上下文以匹配设备像素比\r\n        this.ctx.scale(devicePixelRatio, devicePixelRatio);\r\n\r\n        // 如果启用了自动调整大小，设置ResizeObserver\r\n        if (this.options.autoResize) {\r\n            // 延迟设置，确保Canvas已插入DOM\r\n            setTimeout(() => {\r\n                this.setupResizeObserver();\r\n            }, 0);\r\n        }\r\n\r\n        if (noData) {\r\n            // 空数据：不绘制，仅返回空白透明画布\r\n            this.debugLog('空数据：创建空白热力图 Canvas');\r\n        } else {\r\n            // 计算密度范围并绘制\r\n            this.calculateDensityRange();\r\n            this.debugLog('绘制前数据点映射:');\r\n            this.debugLog('- 数据段数量:', this.processedData.length);\r\n            this.debugLog('- 密度范围:', this.minDensity, '到', this.maxDensity);\r\n            this.debugLog('- Canvas尺寸:', this.options.width, 'x', this.options.height);\r\n            this.debugLog('- Canvas分辨率:', this.canvas.width, 'x', this.canvas.height);\r\n            this.debugLog('- 设备像素比:', devicePixelRatio);\r\n            this.drawHeatmap();\r\n        }\r\n\r\n        // 记录初始渲染宽度并缓存结果\r\n        this.lastRenderedWidth = this.options.width;\r\n        this.cacheCanvas();\r\n\r\n        this.debugLog('Canvas创建完成');\r\n        return this.canvas;\r\n    }\r\n\r\n    /**\r\n     * 绘制热力图\r\n     */\r\n    drawHeatmap() {\r\n        if (!this.ctx || this.processedData.length === 0) return;\r\n\r\n        // 清空画布\r\n        this.ctx.clearRect(0, 0, this.options.width, this.options.height);\r\n\r\n        const paddingVertical = 5;  // 只保留上下边距\r\n        const graphWidth = this.options.width;  // 使用完整宽度，不减去左右边距\r\n        const graphHeight = this.options.height - 2 * paddingVertical;\r\n\r\n        // 计算数据点坐标 - 基于时间而不是索引\r\n        const points = this.processedData.map((dataPoint, index) => {\r\n            const normalizedDensity = (dataPoint.average_density - this.minDensity) /\r\n                (this.maxDensity - this.minDensity);\r\n\r\n            // 基于时间计算X坐标：使用数据段的中点时间\r\n            const midTime = (dataPoint.start_time_seconds + dataPoint.end_time_seconds) / 2;\r\n            const x = (midTime / this.actualDuration) * graphWidth;  // 基于时间比例计算X坐标\r\n            const y = paddingVertical + graphHeight - (normalizedDensity * graphHeight);\r\n\r\n            return { x, y, density: dataPoint.average_density, midTime };\r\n        });\r\n\r\n        // 添加起始点和结束点的延伸\r\n        if (points.length >= 2) {\r\n            // 计算开头的延伸点（x=0）\r\n            const p1 = points[0];\r\n            const p2 = points[1];\r\n            const slope = (p2.y - p1.y) / (p2.x - p1.x);\r\n            let startY = p1.y - slope * p1.x;  // 延伸到x=0时的y坐标\r\n\r\n            // 限制起始点Y坐标在合理范围内\r\n            startY = Math.max(paddingVertical, Math.min(paddingVertical + graphHeight, startY));\r\n            const startPoint = { x: 0, y: startY, density: p1.density, midTime: 0, isExtended: true };\r\n\r\n            // 计算结尾的延伸点（x=graphWidth）\r\n            const pn2 = points[points.length - 2];\r\n            const pn1 = points[points.length - 1];\r\n            const endSlope = (pn1.y - pn2.y) / (pn1.x - pn2.x);\r\n            let endY = pn1.y + endSlope * (graphWidth - pn1.x);  // 延伸到x=graphWidth时的y坐标\r\n\r\n            // 限制结束点Y坐标在合理范围内\r\n            endY = Math.max(paddingVertical, Math.min(paddingVertical + graphHeight, endY));\r\n            const endPoint = { x: graphWidth, y: endY, density: pn1.density, midTime: this.actualDuration, isExtended: true };\r\n\r\n            // 插入起始点和结束点\r\n            points.unshift(startPoint);\r\n            points.push(endPoint);\r\n\r\n            this.debugLog('添加了延伸点:');\r\n            this.debugLog(`起始点: 时间0s -> 坐标(${startPoint.x.toFixed(1)}, ${startPoint.y.toFixed(1)})`);\r\n            this.debugLog(`结束点: 时间${this.actualDuration}s -> 坐标(${endPoint.x.toFixed(1)}, ${endPoint.y.toFixed(1)})`);\r\n        }\r\n\r\n        this.debugLog('坐标点映射详情:');\r\n        points.forEach((point, index) => {\r\n            if (point.isExtended) {\r\n                this.debugLog(`点${index}: [延伸点] 时间${point.midTime}s -> 坐标(${point.x.toFixed(1)}, ${point.y.toFixed(1)})`);\r\n            } else {\r\n                // 对于非延伸点，需要考虑延伸点的偏移\r\n                const dataIndex = points[0].isExtended ? index - 1 : index;\r\n                if (dataIndex >= 0 && dataIndex < this.processedData.length) {\r\n                    const dataPoint = this.processedData[dataIndex];\r\n                    this.debugLog(`点${index}: 时间${dataPoint.start_time_seconds}-${dataPoint.end_time_seconds}s(中点${point.midTime}s), 密度${dataPoint.average_density} -> 坐标(${point.x.toFixed(1)}, ${point.y.toFixed(1)})`);\r\n                }\r\n            }\r\n        });\r\n\r\n        // 绘制填充区域\r\n        this.drawFillArea(points, paddingVertical, graphHeight);\r\n\r\n        // 绘制平滑曲线\r\n        this.drawSmoothCurve(points);\r\n\r\n        this.debugLog('热力图绘制完成');\r\n\r\n        // 更新缓存\r\n        this.cacheCanvas();\r\n    }\r\n\r\n    /**\r\n     * 绘制填充区域\r\n     * @param {Array} points - 数据点数组\r\n     * @param {number} paddingVertical - 上下边距\r\n     * @param {number} graphHeight - 图表高度\r\n     */\r\n    drawFillArea(points, paddingVertical, graphHeight) {\r\n        if (points.length === 0) return;\r\n\r\n        // 确保填充区域不影响线条渲染\r\n        this.ctx.save();  // 保存当前状态\r\n\r\n        // 使用渐变填充\r\n        const gradient = this.ctx.createLinearGradient(0, paddingVertical + graphHeight, 0, paddingVertical);\r\n        gradient.addColorStop(0, this.options.gradientColorStart);  // 使用用户配置的渐变起始颜色\r\n        gradient.addColorStop(1, this.options.gradientColorEnd);    // 使用用户配置的渐变结束颜色\r\n\r\n        this.ctx.fillStyle = gradient;\r\n        this.ctx.beginPath();\r\n        this.ctx.moveTo(Math.round(points[0].x), paddingVertical + graphHeight);\r\n        this.ctx.lineTo(Math.round(points[0].x), Math.round(points[0].y));\r\n\r\n        this.drawMonotonicSpline(points);\r\n\r\n        this.ctx.lineTo(Math.round(points[points.length - 1].x), paddingVertical + graphHeight);\r\n        this.ctx.closePath();\r\n        this.ctx.fill();\r\n\r\n        this.ctx.restore();  // 恢复状态\r\n    }\r\n\r\n    /**\r\n     * 绘制平滑曲线\r\n     * @param {Array} points - 数据点数组\r\n     */\r\n    drawSmoothCurve(points) {\r\n        if (points.length === 0) return;\r\n\r\n        // 优化Canvas渲染设置\r\n        this.ctx.imageSmoothingEnabled = true;\r\n        this.ctx.imageSmoothingQuality = 'high';\r\n\r\n        // 设置曲线样式 - 使用用户配置的颜色和线宽\r\n        this.ctx.strokeStyle = this.options.lineColor;\r\n        this.ctx.lineWidth = this.options.lineWidth;\r\n        this.ctx.lineCap = 'round';\r\n        this.ctx.lineJoin = 'round';\r\n\r\n        // 确保没有阴影效果\r\n        this.ctx.shadowColor = 'transparent';\r\n        this.ctx.shadowBlur = 0;\r\n        this.ctx.shadowOffsetX = 0;\r\n        this.ctx.shadowOffsetY = 0;\r\n\r\n        this.ctx.beginPath();\r\n        this.ctx.moveTo(Math.round(points[0].x), Math.round(points[0].y));  // 使用整数坐标\r\n        this.drawMonotonicSpline(points);\r\n        this.ctx.stroke();\r\n    }\r\n\r\n    /**\r\n     * 绘制单调样条曲线\r\n     * @param {Array} points - 数据点数组\r\n     */\r\n    drawMonotonicSpline(points) {\r\n        if (points.length < 3) {\r\n            for (let i = 1; i < points.length; i++) {\r\n                // 使用整数坐标避免线条模糊\r\n                this.ctx.lineTo(Math.round(points[i].x), Math.round(points[i].y));\r\n            }\r\n            return;\r\n        }\r\n\r\n        const slopes = this.calculateMonotonicSlopes(points);\r\n\r\n        for (let i = 0; i < points.length - 1; i++) {\r\n            const p1 = points[i];\r\n            const p2 = points[i + 1];\r\n            const m1 = slopes[i];\r\n            const m2 = slopes[i + 1];\r\n\r\n            // 计算插值步数：对于延伸点使用固定步数，对于数据点使用时间长度\r\n            let steps;\r\n            if (p1.isExtended || p2.isExtended) {\r\n                // 延伸点使用固定步数\r\n                steps = 10;\r\n            } else {\r\n                // 数据点：根据时间段长度动态计算插值步数\r\n                const dataIndex1 = points[0].isExtended ? i - 1 : i;\r\n                const dataIndex2 = points[0].isExtended ? i : i + 1;\r\n\r\n                if (dataIndex1 >= 0 && dataIndex2 < this.processedData.length) {\r\n                    const currentData = this.processedData[dataIndex1];\r\n                    const nextData = this.processedData[dataIndex2];\r\n                    const timeDuration = Math.abs(nextData.start_time_seconds - currentData.start_time_seconds);\r\n                    steps = Math.max(5, Math.min(20, Math.ceil(timeDuration / 5)));\r\n                } else {\r\n                    steps = 10; // 默认步数\r\n                }\r\n            }\r\n\r\n            for (let t = 0; t <= steps; t++) {\r\n                const u = t / steps;\r\n                const point = this.hermiteInterpolation(p1, p2, m1, m2, u);\r\n                // 使用整数坐标避免线条模糊\r\n                this.ctx.lineTo(Math.round(point.x), Math.round(point.y));\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 计算单调样条的斜率\r\n     * @param {Array} points - 数据点数组\r\n     * @returns {Array} 斜率数组\r\n     */\r\n    calculateMonotonicSlopes(points) {\r\n        const slopes = new Array(points.length);\r\n\r\n        for (let i = 0; i < points.length; i++) {\r\n            if (i === 0) {\r\n                slopes[i] = {\r\n                    x: (points[1].x - points[0].x),\r\n                    y: (points[1].y - points[0].y) / (points[1].x - points[0].x)\r\n                };\r\n            } else if (i === points.length - 1) {\r\n                slopes[i] = {\r\n                    x: (points[i].x - points[i - 1].x),\r\n                    y: (points[i].y - points[i - 1].y) / (points[i].x - points[i - 1].x)\r\n                };\r\n            } else {\r\n                const dx1 = points[i].x - points[i - 1].x;\r\n                const dy1 = points[i].y - points[i - 1].y;\r\n                const dx2 = points[i + 1].x - points[i].x;\r\n                const dy2 = points[i + 1].y - points[i].y;\r\n\r\n                const w1 = dx2 / (dx1 + dx2);\r\n                const w2 = dx1 / (dx1 + dx2);\r\n\r\n                slopes[i] = {\r\n                    x: dx1,\r\n                    y: w1 * (dy1 / dx1) + w2 * (dy2 / dx2)\r\n                };\r\n\r\n                const slope1 = dy1 / dx1;\r\n                const slope2 = dy2 / dx2;\r\n\r\n                if (slope1 * slope2 <= 0) {\r\n                    slopes[i].y = 0;\r\n                } else {\r\n                    const minSlope = Math.min(Math.abs(slope1), Math.abs(slope2));\r\n                    const sign = Math.sign(slopes[i].y);\r\n                    slopes[i].y = sign * Math.min(Math.abs(slopes[i].y), 3 * minSlope);\r\n                }\r\n            }\r\n        }\r\n\r\n        return slopes;\r\n    }\r\n\r\n    /**\r\n     * Hermite插值计算\r\n     * @param {Object} p1 - 起始点\r\n     * @param {Object} p2 - 结束点\r\n     * @param {Object} m1 - 起始点切线\r\n     * @param {Object} m2 - 结束点切线\r\n     * @param {number} t - 插值参数 [0,1]\r\n     * @returns {Object} 插值点坐标\r\n     */\r\n    hermiteInterpolation(p1, p2, m1, m2, t) {\r\n        const t2 = t * t;\r\n        const t3 = t2 * t;\r\n\r\n        const h00 = 2 * t3 - 3 * t2 + 1;\r\n        const h10 = t3 - 2 * t2 + t;\r\n        const h01 = -2 * t3 + 3 * t2;\r\n        const h11 = t3 - t2;\r\n\r\n        const dx = p2.x - p1.x;\r\n\r\n        return {\r\n            x: p1.x + t * dx,\r\n            y: h00 * p1.y + h10 * dx * m1.y + h01 * p2.y + h11 * dx * m2.y\r\n        };\r\n    }\r\n\r\n    /**\r\n     * 显示错误信息\r\n     * @param {string} message - 错误消息\r\n     */\r\n    showError(message = '热力图渲染失败') {\r\n        if (!this.ctx) return;\r\n\r\n        this.ctx.clearRect(0, 0, this.options.width, this.options.height);\r\n        this.ctx.fillStyle = 'rgba(220, 53, 69, 0.1)';\r\n        this.ctx.fillRect(0, 0, this.options.width, this.options.height);\r\n\r\n        this.ctx.fillStyle = '#dc3545';\r\n        this.ctx.font = '14px Arial';\r\n        this.ctx.textAlign = 'center';\r\n        this.ctx.fillText(message, this.options.width / 2, this.options.height / 2);\r\n    }\r\n\r\n    /**\r\n     * 一键处理：设置数据、预处理、创建Canvas\r\n     * @param {Array} heatmapData - 热力图数据\r\n     * @param {number} videoDuration - 视频时长\r\n     * @param {Object} styleOptions - 样式选项\r\n     * @returns {HTMLCanvasElement} 渲染好的Canvas元素\r\n     */\r\n    process(heatmapData, videoDuration, styleOptions = {}) {\r\n        try {\r\n            // 允许 heatmapData 为空：内部将生成空白 Canvas\r\n            if (heatmapData == null) heatmapData = [];\r\n            return this\r\n                .setHeatmapData(heatmapData)\r\n                .setActualDuration(videoDuration)\r\n                .preprocessData()\r\n                .createCanvas(styleOptions);\r\n        } catch (error) {\r\n            this.debugLog('处理失败:', error);\r\n            this.showError(error.message);\r\n            return this.canvas;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 重新计算和绘制热力图\r\n     * - 可选传入新数据和/或新时长，内部会自动规范化\r\n     * @param {Array} [newData] 可选的新原始数据（同 setHeatmapData 的输入）\r\n     * @param {number} [newDuration] 可选的新视频时长（秒）\r\n     * @returns {DanmakuHeatmapRenderer} 返回自身以支持链式调用\r\n     */\r\n    recalculate(newData, newDuration) {\r\n        try {\r\n            if (!this.canvas) {\r\n                this.debugLog('Canvas未创建，无法重新计算');\r\n                return this;\r\n            }\r\n\r\n            // 如提供新数据/时长，则优先更新\r\n            if (typeof newDuration === 'number' && isFinite(newDuration) && newDuration > 0) {\r\n                this.setActualDuration(newDuration);\r\n            }\r\n            if (Array.isArray(newData)) {\r\n                // 使用标准入口规范化，而不是直接赋值 rawData\r\n                this.setHeatmapData(newData);\r\n            }\r\n\r\n            if (!this.rawData || this.rawData.length === 0) {\r\n                // 无数据：清空画布并缓存空状态\r\n                this.debugLog('没有原始数据：清空画布并保持空白');\r\n                this.ctx.clearRect(0, 0, this.options.width, this.options.height);\r\n                this.cacheCanvas();\r\n                return this;\r\n            }\r\n\r\n            this.debugLog('开始重新计算热力图');\r\n\r\n            // 重新预处理数据\r\n            this.preprocessData();\r\n\r\n            // 重新计算密度范围\r\n            this.calculateDensityRange();\r\n\r\n            // 重新绘制\r\n            this.drawHeatmap();\r\n\r\n            // 更新缓存\r\n            this.lastRenderedWidth = this.options.width;\r\n            this.cacheCanvas();\r\n\r\n            this.debugLog('重新计算完成');\r\n            return this;\r\n\r\n        } catch (error) {\r\n            this.debugLog('重新计算失败:', error);\r\n            this.showError('重新计算失败: ' + error.message);\r\n            return this;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * 隐藏热力图\r\n     * @returns {DanmakuHeatmapRenderer} 返回自身以支持链式调用\r\n     */\r\n    hide() {\r\n        if (!this.canvas) {\r\n            this.debugLog('Canvas未创建，无法隐藏');\r\n            return this;\r\n        }\r\n\r\n        this.canvas.style.display = 'none';\r\n        this.debugLog('热力图已隐藏');\r\n        return this;\r\n    }\r\n\r\n    /**\r\n     * 显示热力图\r\n     * @returns {DanmakuHeatmapRenderer} 返回自身以支持链式调用\r\n     */\r\n    show() {\r\n        if (!this.canvas) {\r\n            this.debugLog('Canvas未创建，无法显示');\r\n            return this;\r\n        }\r\n\r\n        this.canvas.style.display = 'block';\r\n        this.debugLog('热力图已显示');\r\n        return this;\r\n    }\r\n}\r\n\r\n// 如果在Node.js环境中\r\n// （可选）保留全局暴露逻辑：由入口 index.js 再次挂载到命名空间，避免不必要的全局污染。\r\n// 如需直接全局访问，可解除下面注释。\r\n// if (typeof window !== 'undefined') {\r\n//     window.DanmakuHeatmapRenderer = DanmakuHeatmapRenderer;\r\n// }\r\n","/**\r\n * 弹幕Canvas渲染引擎\r\n * \r\n * 这是一个基于Canvas的弹幕渲染系统，支持以下功能：\r\n * - 多种弹幕模式：滚动弹幕（从右到左、从左到右）、固定弹幕（顶部、底部）\r\n * - 自动碰撞检测和位置分配\r\n * - 媒体元素同步播放\r\n * - 高分辨率屏幕适配\r\n * - 自定义样式和渲染函数\r\n * - 动态添加弹幕\r\n * - 性能优化的Canvas渲染\r\n * \r\n * @author WeChat FE Team\r\n * @version 1.0.0\r\n */\r\n\r\n/**\r\n * 弹幕Canvas渲染引擎\r\n * 用于在Canvas上渲染和控制弹幕的显示效果\r\n */\r\n\r\n/**\r\n * 自动检测浏览器支持的CSS Transform属性\r\n * 兼容不同浏览器的前缀版本\r\n */\r\nvar transform = (function () {\r\n  /* istanbul ignore next */\r\n  if (typeof document === 'undefined') return 'transform';\r\n  var properties = [\r\n    'oTransform', // Opera 11.5\r\n    'msTransform', // IE 9\r\n    'mozTransform',\r\n    'webkitTransform',\r\n    'transform'\r\n  ];\r\n  var style = document.createElement('div').style;\r\n  for (var i = 0; i < properties.length; i++) {\r\n    /* istanbul ignore else */\r\n    if (properties[i] in style) {\r\n      return properties[i];\r\n    }\r\n  }\r\n  /* istanbul ignore next */\r\n  return 'transform';\r\n}());\r\n\r\n/**\r\n * 获取设备像素比，用于高分辨率屏幕适配\r\n */\r\nvar dpr = typeof window !== 'undefined' && window.devicePixelRatio || 1;\r\n\r\n/**\r\n * Canvas高度缓存，避免重复计算字体高度\r\n */\r\nvar canvasHeightCache = Object.create(null);\r\n\r\n/**\r\n * 远程字体支持（/danmaku/font/ 前缀）\r\n * - 使用 FontFace 动态加载\r\n * - 通过 Jellyfin ApiClient.getUrl 生成绝对地址\r\n * - 结果缓存在 window.__jfDanmakuGlobal__.remoteFontCache 中\r\n * - 加载失败回退到系统 sans-serif\r\n */\r\nfunction __getGlobal() {\r\n  try {\r\n    // eslint-disable-next-line no-return-assign\r\n    return (window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {});\r\n  } catch (_) {\r\n    return {};\r\n  }\r\n}\r\n\r\nfunction __getRemoteFontCache() {\r\n  var g = __getGlobal();\r\n  g.remoteFontCache = g.remoteFontCache || {};\r\n  return g.remoteFontCache;\r\n}\r\n\r\nfunction __normalizeRel(path) {\r\n  // 去除开头的 '/'\r\n  return (path || '').replace(/^\\/+/, '');\r\n}\r\n\r\n/**\r\n * 确保以 /danmaku/font/ 开头的字体已加载至 document.fonts\r\n * @param {string} urlPath 形如 /danmaku/font/DejaVuSans.ttf\r\n * @returns {Promise<string|null>} 解析为字体家族名或 null\r\n */\r\nfunction ensureRemoteFontLoaded(urlPath) {\r\n  try {\r\n    if (!urlPath || typeof urlPath !== 'string' || urlPath.indexOf('/danmaku/font/') !== 0) return Promise.resolve(null);\r\n    var cache = __getRemoteFontCache();\r\n    if (cache[urlPath] && cache[urlPath].status === 'loaded') {\r\n      return Promise.resolve(cache[urlPath].family);\r\n    }\r\n    if (cache[urlPath] && cache[urlPath].status === 'loading' && cache[urlPath].promise) {\r\n      return cache[urlPath].promise;\r\n    }\r\n\r\n    var filename = (urlPath.split('/').pop() || 'RemoteFont');\r\n    var base = filename.replace(/\\.[a-z0-9]+$/i, '');\r\n    var family = 'JFDanmaku_' + base;\r\n    var rel = __normalizeRel(urlPath);\r\n    var absUrl = rel;\r\n    try {\r\n      if (typeof ApiClient !== 'undefined' && ApiClient.getUrl) {\r\n        absUrl = ApiClient.getUrl(rel);\r\n      }\r\n    } catch (_) { /* ignore */ }\r\n\r\n    var ff;\r\n    try {\r\n      ff = new FontFace(family, \"url(\" + absUrl + \")\", { style: 'normal', weight: '400', display: 'swap' });\r\n    } catch (e) {\r\n      // 无法构造 FontFace，直接标记失败\r\n      cache[urlPath] = { status: 'failed', error: String(e) };\r\n      return Promise.resolve(null);\r\n    }\r\n\r\n    var p = ff.load().then(function(loaded){\r\n      try { document.fonts.add(loaded); } catch (_) {}\r\n      cache[urlPath] = { status: 'loaded', family: family, fontFace: loaded };\r\n      try { __getGlobal().danmakuRemoteFontFamilyName = family; } catch (_) {}\r\n      return family;\r\n    }).catch(function(err){\r\n      cache[urlPath] = { status: 'failed', error: String(err) };\r\n      return null;\r\n    });\r\n    cache[urlPath] = { status: 'loading', family: family, promise: p };\r\n    return p;\r\n  } catch (e) {\r\n    return Promise.resolve(null);\r\n  }\r\n}\r\n\r\n// 将加载器暴露到全局，便于设置页等直接调用\r\ntry { __getGlobal().ensureRemoteFontLoaded = ensureRemoteFontLoaded; } catch (_) {}\r\n\r\n/**\r\n * 若 style.font 中包含 /danmaku/font/ 路径，则在可用时替换为已加载的家族名；失败则替换为 sans-serif。\r\n * 注意：该操作是就地修改 style.font。\r\n */\r\nfunction maybeRewriteStyleFont(style) {\r\n  try {\r\n    if (!style || !style.font || typeof style.font !== 'string') return;\r\n    if (style.font.indexOf('/danmaku/font/') === -1) return;\r\n    var m = style.font.match(/\\/danmaku\\/font\\/[^\"',)\\s]+/);\r\n    if (!m) return;\r\n    var url = m[0];\r\n    var cache = __getRemoteFontCache();\r\n    if (cache[url] && cache[url].status === 'loaded' && cache[url].family) {\r\n      var fam = cache[url].family;\r\n      style.font = style.font.replace(url, \"'\" + fam + \"'\");\r\n      return;\r\n    }\r\n    if (cache[url] && cache[url].status === 'failed') {\r\n      style.font = style.font.replace(url, 'sans-serif');\r\n      return;\r\n    }\r\n    // 触发加载，但本次仍使用原始值（浏览器会回退）\r\n    ensureRemoteFontLoaded(url);\r\n  } catch (_) { /* ignore */ }\r\n}\r\n\r\n/**\r\n * 计算字体在Canvas中的实际高度\r\n * @param {string} font - CSS字体样式字符串\r\n * @param {Object} fontSize - 字体大小配置对象\r\n * @returns {number} 计算后的字体高度\r\n */\r\nfunction canvasHeight(font, fontSize) {\r\n  // 如果已缓存则直接返回\r\n  if (canvasHeightCache[font]) {\r\n    return canvasHeightCache[font];\r\n  }\r\n  var height = 12;\r\n  // 匹配CSS字体样式的正则表达式\r\n  var regex = /(\\d+(?:\\.\\d+)?)(px|%|em|rem)(?:\\s*\\/\\s*(\\d+(?:\\.\\d+)?)(px|%|em|rem)?)?/;\r\n  var p = font.match(regex);\r\n  if (p) {\r\n    var fs = p[1] * 1 || 10;    // 字体大小\r\n    var fsu = p[2];             // 字体大小单位\r\n    var lh = p[3] * 1 || 1.2;   // 行高\r\n    var lhu = p[4];             // 行高单位\r\n\r\n    // 根据不同单位转换字体大小\r\n    if (fsu === '%') fs *= fontSize.container / 100;\r\n    if (fsu === 'em') fs *= fontSize.container;\r\n    if (fsu === 'rem') fs *= fontSize.root;\r\n\r\n    // 根据不同单位计算行高\r\n    if (lhu === 'px') height = lh;\r\n    if (lhu === '%') height = fs * lh / 100;\r\n    if (lhu === 'em') height = fs * lh;\r\n    if (lhu === 'rem') height = fontSize.root * lh;\r\n    if (lhu === undefined) height = fs * lh;\r\n  }\r\n  // 缓存计算结果\r\n  canvasHeightCache[font] = height;\r\n  return height;\r\n}\r\n\r\n/**\r\n * 创建弹幕文本的Canvas画布\r\n * @param {Object} cmt - 弹幕评论对象\r\n * @param {Object} fontSize - 字体大小配置\r\n * @returns {HTMLCanvasElement} 渲染好的Canvas元素\r\n */\r\nfunction createCommentCanvas(cmt, fontSize) {\r\n  // 如果弹幕有自定义渲染函数，优先使用\r\n  if (typeof cmt.render === 'function') {\r\n    var cvs = cmt.render();\r\n    if (cvs instanceof HTMLCanvasElement) {\r\n      cmt.width = cvs.width;\r\n      cmt.height = cvs.height;\r\n      return cvs;\r\n    }\r\n  }\r\n\r\n  // 创建新的Canvas元素\r\n  var canvas = document.createElement('canvas');\r\n  var ctx = canvas.getContext('2d');\r\n  var style = cmt.style || {};\r\n\r\n  // 设置默认样式\r\n  style.font = style.font || '10px sans-serif';\r\n  style.textBaseline = style.textBaseline || 'bottom';\r\n\r\n  // 如包含远程字体占位，尽量重写为已加载的家族名\r\n  maybeRewriteStyleFont(style);\r\n\r\n  // 计算描边宽度\r\n  var strokeWidth = style.lineWidth * 1;\r\n  strokeWidth = (strokeWidth > 0 && strokeWidth !== Infinity)\r\n    ? Math.ceil(strokeWidth)\r\n    : !!style.strokeStyle * 1;\r\n\r\n  // 设置字体并测量文本尺寸\r\n  ctx.font = style.font;\r\n  cmt.width = cmt.width ||\r\n    Math.max(1, Math.ceil(ctx.measureText(cmt.text).width) + strokeWidth * 2);\r\n  cmt.height = cmt.height ||\r\n    Math.ceil(canvasHeight(style.font, fontSize)) + strokeWidth * 2;\r\n\r\n  // 设置Canvas尺寸（考虑设备像素比）\r\n  canvas.width = cmt.width * dpr;\r\n  canvas.height = cmt.height * dpr;\r\n  ctx.scale(dpr, dpr);\r\n\r\n  // 应用样式到Canvas上下文\r\n  for (var key in style) {\r\n    ctx[key] = style[key];\r\n  }\r\n\r\n  // 根据文本基线计算绘制位置\r\n  var baseline = 0;\r\n  switch (style.textBaseline) {\r\n    case 'top':\r\n    case 'hanging':\r\n      baseline = strokeWidth;\r\n      break;\r\n    case 'middle':\r\n      baseline = cmt.height >> 1;\r\n      break;\r\n    default:\r\n      baseline = cmt.height - strokeWidth;\r\n  }\r\n\r\n  // 绘制文本（先描边后填充）\r\n  if (style.strokeStyle) {\r\n    ctx.strokeText(cmt.text, strokeWidth, baseline);\r\n  }\r\n  ctx.fillText(cmt.text, strokeWidth, baseline);\r\n  return canvas;\r\n}\r\n\r\n/**\r\n * 计算指定元素的字体大小（以px为单位）\r\n * @param {HTMLElement} el - 目标元素\r\n * @returns {number} 字体大小的像素值\r\n */\r\nfunction computeFontSize(el) {\r\n  return window\r\n    .getComputedStyle(el, null)\r\n    .getPropertyValue('font-size')\r\n    .match(/(.+)px/)[1] * 1;\r\n}\r\n\r\n/**\r\n * 初始化Canvas舞台\r\n * @param {HTMLElement} container - 容器元素\r\n * @returns {HTMLCanvasElement} 初始化后的Canvas舞台\r\n */\r\nfunction init(container) {\r\n  var stage = document.createElement('canvas');\r\n  stage.context = stage.getContext('2d');\r\n  // 计算字体大小配置（根元素和容器元素）\r\n  stage._fontSize = {\r\n    root: computeFontSize(document.getElementsByTagName('html')[0]),\r\n    container: computeFontSize(container)\r\n  };\r\n  return stage;\r\n}\r\n\r\n/**\r\n * 清空舞台并释放弹幕Canvas缓存\r\n * @param {HTMLCanvasElement} stage - Canvas舞台\r\n * @param {Array} comments - 弹幕数组\r\n */\r\nfunction clear(stage, comments) {\r\n  stage.context.clearRect(0, 0, stage.width, stage.height);\r\n  // 避免缓存Canvas以减少内存使用\r\n  for (var i = 0; i < comments.length; i++) {\r\n    comments[i].canvas = null;\r\n  }\r\n}\r\n\r\n/**\r\n * 调整舞台尺寸\r\n * @param {HTMLCanvasElement} stage - Canvas舞台\r\n * @param {number} width - 新宽度\r\n * @param {number} height - 新高度\r\n */\r\nfunction resize(stage, width, height) {\r\n  stage.width = width * dpr;\r\n  stage.height = height * dpr;\r\n  stage.style.width = width + 'px';\r\n  stage.style.height = height + 'px';\r\n}\r\n\r\n/**\r\n * 清空一帧准备下一帧渲染\r\n * @param {HTMLCanvasElement} stage - Canvas舞台\r\n */\r\nfunction framing(stage) {\r\n  stage.context.clearRect(0, 0, stage.width, stage.height);\r\n}\r\n\r\n/**\r\n * 为弹幕数组设置Canvas画布\r\n * @param {HTMLCanvasElement} stage - Canvas舞台\r\n * @param {Array} comments - 弹幕数组\r\n */\r\nfunction setup(stage, comments) {\r\n  for (var i = 0; i < comments.length; i++) {\r\n    var cmt = comments[i];\r\n    cmt.canvas = createCommentCanvas(cmt, stage._fontSize);\r\n  }\r\n}\r\n\r\n/**\r\n * 渲染单个弹幕到舞台\r\n * @param {HTMLCanvasElement} stage - Canvas舞台\r\n * @param {Object} cmt - 弹幕对象\r\n */\r\nfunction render(stage, cmt) {\r\n  stage.context.drawImage(cmt.canvas, cmt.x * dpr, cmt.y * dpr);\r\n}\r\n\r\n/**\r\n * 移除弹幕并释放资源\r\n * @param {HTMLCanvasElement} stage - Canvas舞台\r\n * @param {Object} cmt - 弹幕对象\r\n */\r\nfunction remove(stage, cmt) {\r\n  // 避免缓存Canvas以减少内存使用\r\n  cmt.canvas = null;\r\n}\r\n\r\n/**\r\n * Canvas渲染引擎对象\r\n * 包含Canvas渲染相关的所有方法\r\n */\r\nvar canvasEngine = {\r\n  name: 'canvas',\r\n  init: init,\r\n  clear: clear,\r\n  resize: resize,\r\n  framing: framing,\r\n  setup: setup,\r\n  render: render,\r\n  remove: remove,\r\n};\r\n\r\n/**\r\n * 跨浏览器的requestAnimationFrame实现\r\n * 优先使用原生API，不支持时降级为setTimeout\r\n */\r\nvar raf = (function () {\r\n  if (typeof window !== 'undefined') {\r\n    var rAF = (\r\n      window.requestAnimationFrame ||\r\n      window.mozRequestAnimationFrame ||\r\n      window.webkitRequestAnimationFrame\r\n    );\r\n    if (rAF) return rAF.bind(window);\r\n  }\r\n  // 降级方案：使用setTimeout模拟60fps\r\n  return function (cb) {\r\n    return setTimeout(cb, 50 / 3);\r\n  };\r\n})();\r\n\r\n/**\r\n * 跨浏览器的cancelAnimationFrame实现\r\n * 用于取消动画帧请求\r\n */\r\nvar caf = (function () {\r\n  if (typeof window !== 'undefined') {\r\n    var cAF = (\r\n      window.cancelAnimationFrame ||\r\n      window.mozCancelAnimationFrame ||\r\n      window.webkitCancelAnimationFrame\r\n    );\r\n    if (cAF) return cAF.bind(window);\r\n  }\r\n  return clearTimeout;\r\n})();\r\n\r\n/**\r\n * 二分查找算法\r\n * 在已排序数组中查找指定属性值的位置\r\n * @param {Array} arr - 已排序的数组\r\n * @param {string} prop - 要比较的属性名\r\n * @param {*} key - 要查找的值\r\n * @returns {number} 插入位置的索引\r\n */\r\nfunction binsearch(arr, prop, key) {\r\n  try { console.log(LOG_PREFIX, 'binsearch: start', { length: arr && arr.length, prop: prop, key: key }); } catch (e) {}\r\n  // 返回插入位置 (0..arr.length)\r\n  var left = 0;\r\n  var right = arr.length; // 区间: [left, right)\r\n  while (left < right) {\r\n    var mid = (left + right) >> 1;\r\n    var v = arr[mid][prop];\r\n    if (v <= key) {\r\n      left = mid + 1; // 插入点在右侧\r\n    } else {\r\n      right = mid;\r\n    }\r\n  }\r\n  // left 即为插入点\r\n  try { console.log(LOG_PREFIX, 'binsearch: end', { insertion: left }); } catch (e) {}\r\n  return left;\r\n}\r\n/**\r\n * 格式化弹幕模式\r\n * @param {string} mode - 弹幕模式\r\n * @returns {string} 标准化的弹幕模式\r\n */\r\nfunction formatMode(mode) {\r\n  // 只允许左到右、顶部、底部三种模式，其他默认为右到左\r\n  if (!/^(ltr|top|bottom)$/i.test(mode)) {\r\n    return 'rtl';\r\n  }\r\n  return mode.toLowerCase();\r\n}\r\n\r\n/**\r\n * 创建碰撞检测范围的初始边界\r\n * @returns {Array} 包含初始和结束边界的数组\r\n */\r\nfunction collidableRange() {\r\n  var max = 9007199254740991; // JavaScript最大安全整数\r\n  return [\r\n    { range: 0, time: -max, width: max, height: 0 },      // 起始边界\r\n    { range: max, time: max, width: 0, height: 0 }        // 结束边界\r\n  ];\r\n}\r\n\r\n/**\r\n * 重置弹幕空间分配器\r\n * @param {Object} space - 空间分配对象\r\n */\r\nfunction resetSpace(space) {\r\n  space.ltr = collidableRange();     // 左到右弹幕空间\r\n  space.rtl = collidableRange();     // 右到左弹幕空间\r\n  space.top = collidableRange();     // 顶部弹幕空间\r\n  space.bottom = collidableRange();  // 底部弹幕空间\r\n}\r\n\r\n/**\r\n * 获取当前时间戳\r\n * 优先使用高精度计时器，降级为Date.now()\r\n * @returns {number} 当前时间戳（毫秒）\r\n */\r\nfunction now() {\r\n  return typeof window.performance !== 'undefined' && window.performance.now\r\n    ? window.performance.now()\r\n    : Date.now();\r\n}\r\n\r\n/**\r\n * 为弹幕分配显示位置（避免碰撞）\r\n * @param {Object} cmt - 弹幕对象\r\n * @returns {number} 分配的Y坐标位置\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction allocate(cmt) {\r\n  var that = this;\r\n  var ct = this.media ? this.media.currentTime : now() / 1000;  // 当前时间\r\n  var pbr = this.media ? this.media.playbackRate : 1;           // 播放速率\r\n\r\n  /**\r\n   * 判断两个弹幕是否会发生碰撞\r\n   * @param {Object} cr - 已存在的弹幕\r\n   * @param {Object} cmt - 新弹幕\r\n   * @returns {boolean} 是否会碰撞\r\n   */\r\n  function willCollide(cr, cmt) {\r\n    // 顶部和底部弹幕只需要检查时间重叠\r\n    if (cmt.mode === 'top' || cmt.mode === 'bottom') {\r\n      return ct - cr.time < that._.duration;\r\n    }\r\n\r\n    // 滚动弹幕需要计算运动轨迹\r\n    var crTotalWidth = that._.width + cr.width;\r\n    var crElapsed = crTotalWidth * (ct - cr.time) * pbr / that._.duration;\r\n    if (cr.width > crElapsed) {\r\n      return true;\r\n    }\r\n\r\n    // RTL模式：计算右端移出左侧的时间\r\n    var crLeftTime = that._.duration + cr.time - ct;\r\n    var cmtTotalWidth = that._.width + cmt.width;\r\n    var cmtTime = that.media ? cmt.time : cmt._utc;\r\n    var cmtElapsed = cmtTotalWidth * (ct - cmtTime) * pbr / that._.duration;\r\n    var cmtArrival = that._.width - cmtElapsed;\r\n\r\n    // RTL模式：计算左端到达左侧的时间\r\n    var cmtArrivalTime = that._.duration * cmtArrival / (that._.width + cmt.width);\r\n    return crLeftTime > cmtArrivalTime;\r\n  }\r\n\r\n  var crs = this._.space[cmt.mode];  // 获取对应模式的空间数组\r\n  var last = 0;\r\n  var curr = 0;\r\n\r\n  // 寻找合适的插入位置\r\n  for (var i = 1; i < crs.length; i++) {\r\n    var cr = crs[i];\r\n    var requiredRange = cmt.height;\r\n    if (cmt.mode === 'top' || cmt.mode === 'bottom') {\r\n      requiredRange += cr.height;\r\n    }\r\n\r\n    // 检查是否有足够空间\r\n    if (cr.range - cr.height - crs[last].range >= requiredRange) {\r\n      curr = i;\r\n      break;\r\n    }\r\n\r\n    // 检查碰撞\r\n    if (willCollide(cr, cmt)) {\r\n      last = i;\r\n    }\r\n  }\r\n\r\n  var channel = crs[last].range;\r\n  // 创建新的碰撞记录\r\n  var crObj = {\r\n    range: channel + cmt.height,\r\n    time: this.media ? cmt.time : cmt._utc,\r\n    width: cmt.width,\r\n    height: cmt.height\r\n  };\r\n  crs.splice(last + 1, curr - last - 1, crObj);\r\n\r\n  // 底部弹幕需要从下往上计算位置\r\n  if (cmt.mode === 'bottom') {\r\n    return this._.height - cmt.height - channel % this._.height;\r\n  }\r\n  return channel % (this._.height - cmt.height);\r\n}\r\n\r\n/**\r\n * 创建渲染引擎函数\r\n * @param {Function} framing - 帧初始化函数\r\n * @param {Function} setup - 弹幕设置函数\r\n * @param {Function} render - 弹幕渲染函数\r\n * @param {Function} remove - 弹幕移除函数\r\n * @returns {Function} 渲染引擎函数\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction createEngine(framing, setup, render, remove) {\r\n  return function (_timestamp) {\r\n    framing(this._.stage);  // 清空画布准备新一帧\r\n    var timestamp = _timestamp || now();\r\n    var dn = timestamp / 1000;\r\n    var ct = this.media ? this.media.currentTime : dn;    // 当前时间\r\n    var pbr = this.media ? this.media.playbackRate : 1;   // 播放速率\r\n    // 速率变化补偿：确保不会出现一帧使用新速率但旧 _utc 造成位置跳变\r\n    if (this.media) {\r\n      var prev = this._.lastPbr || 1;\r\n      if (Math.abs(pbr - prev) > 1e-6) {\r\n        // 在同一帧内平滑修正所有运行中的弹幕参考时间\r\n        for (var ai = 0; ai < this._.runningList.length; ai++) {\r\n          var ac = this._.runningList[ai];\r\n          ac._utc = dn - (dn - ac._utc) * prev / pbr;\r\n        }\r\n        this._.lastPbr = pbr;\r\n      }\r\n    }\r\n    var cmt = null;\r\n    var cmtt = 0;\r\n    var i = 0;\r\n\r\n    // 移除过期的弹幕\r\n    for (i = this._.runningList.length - 1; i >= 0; i--) {\r\n      cmt = this._.runningList[i];\r\n      cmtt = this.media ? cmt.time : cmt._utc;\r\n      if (ct - cmtt > this._.duration) {\r\n        remove(this._.stage, cmt);\r\n        this._.runningList.splice(i, 1);\r\n      }\r\n    }\r\n\r\n    // 处理待显示的弹幕\r\n    var pendingList = [];\r\n    while (this._.position < this.comments.length) {\r\n      cmt = this.comments[this._.position];\r\n      cmtt = this.media ? cmt.time : cmt._utc;\r\n      if (cmtt >= ct) {\r\n        break;  // 还未到显示时间\r\n      }\r\n\r\n      // 跳过超出持续时间的弹幕\r\n      // 当点击控件跳转时，media.currentTime可能在pause事件触发前改变\r\n      // 详见 https://github.com/weizhenye/Danmaku/pull/30\r\n      if (ct - cmtt > this._.duration) {\r\n        ++this._.position;\r\n        continue;\r\n      }\r\n\r\n      // 设置弹幕的UTC时间\r\n      if (this.media) {\r\n        cmt._utc = dn - (this.media.currentTime - cmt.time);\r\n      }\r\n      pendingList.push(cmt);\r\n      ++this._.position;\r\n    }\r\n\r\n    // 为新弹幕创建Canvas\r\n    setup(this._.stage, pendingList);\r\n\r\n    // 为新弹幕分配位置并加入运行列表\r\n    for (i = 0; i < pendingList.length; i++) {\r\n      cmt = pendingList[i];\r\n      cmt.y = allocate.call(this, cmt);\r\n      this._.runningList.push(cmt);\r\n    }\r\n\r\n    // 渲染所有正在运行的弹幕\r\n    for (i = 0; i < this._.runningList.length; i++) {\r\n      cmt = this._.runningList[i];\r\n      var totalWidth = this._.width + cmt.width;\r\n      var elapsed = totalWidth * (dn - cmt._utc) * pbr / this._.duration;\r\n\r\n      // 根据弹幕模式计算X坐标\r\n      if (cmt.mode === 'ltr') cmt.x = elapsed - cmt.width;        // 左到右\r\n      if (cmt.mode === 'rtl') cmt.x = this._.width - elapsed;     // 右到左\r\n      if (cmt.mode === 'top' || cmt.mode === 'bottom') {          // 顶部/底部居中\r\n        cmt.x = (this._.width - cmt.width) >> 1;\r\n      }\r\n      render(this._.stage, cmt);\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * 开始播放弹幕动画\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction play() {\r\n  if (!this._.visible || !this._.paused) {\r\n    return this;\r\n  }\r\n  this._.paused = false;\r\n\r\n  // 如果有媒体元素，更新所有运行中弹幕的UTC时间\r\n  if (this.media) {\r\n    for (var i = 0; i < this._.runningList.length; i++) {\r\n      var cmt = this._.runningList[i];\r\n      cmt._utc = now() / 1000 - (this.media.currentTime - cmt.time);\r\n    }\r\n  }\r\n\r\n  var that = this;\r\n  var engine = createEngine(\r\n    this._.engine.framing.bind(this),\r\n    this._.engine.setup.bind(this),\r\n    this._.engine.render.bind(this),\r\n    this._.engine.remove.bind(this)\r\n  );\r\n\r\n  // 动画循环函数\r\n  function frame(timestamp) {\r\n    engine.call(that, timestamp);\r\n    that._.requestID = raf(frame);\r\n  }\r\n  this._.requestID = raf(frame);\r\n  return this;\r\n}\r\n\r\n/**\r\n * 暂停弹幕动画\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction pause() {\r\n  if (!this._.visible || this._.paused) {\r\n    return this;\r\n  }\r\n  this._.paused = true;\r\n  caf(this._.requestID);  // 取消动画帧请求\r\n  this._.requestID = 0;\r\n  return this;\r\n}\r\n\r\n/**\r\n * 媒体倍速变化时平滑过渡，避免弹幕位置瞬移\r\n * 原理：x 位置公式使用 (dn - _utc) * playbackRate\r\n * 当倍速由 r0 切换为 r1 时，保持当前位置不变，需令\r\n * (dn - _utc_new) * r1 = (dn - _utc_old) * r0 => _utc_new = dn - (dn - _utc_old) * r0 / r1\r\n * @returns {Object}\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction ratechange() {\r\n  if (!this.media) return this;\r\n  var newRate = this.media.playbackRate || 1;\r\n  if (this._.paused) { // 暂停状态不需要修正，恢复播放时已按当前速率计算\r\n    this._.lastPbr = newRate;\r\n    return this;\r\n  }\r\n  var oldRate = this._.lastPbr || 1;\r\n  if (!newRate || newRate <= 0 || Math.abs(newRate - oldRate) < 1e-6) {\r\n    this._.lastPbr = newRate;\r\n    return this;\r\n  }\r\n  var dn = now() / 1000;\r\n  for (var i = 0; i < this._.runningList.length; i++) {\r\n    var c = this._.runningList[i];\r\n    c._utc = dn - (dn - c._utc) * oldRate / newRate;\r\n  }\r\n  this._.lastPbr = newRate;\r\n  return this;\r\n}\r\n\r\n/**\r\n * 跳转到指定时间位置\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction seek() {\r\n  if (!this.media) {\r\n    return this;\r\n  }\r\n  this.clear();\r\n  resetSpace(this._.space);\r\n  // 使用二分查找找到当前时间对应的弹幕位置\r\n  var position = binsearch(this.comments, 'time', this.media.currentTime);\r\n  // 默认策略：按原库逻辑让 position 指向 \"当前时间之前的最后一条\"，首帧再回填其后仍在持续窗口内的弹幕\r\n  this._.position = Math.max(0, position - 1);\r\n\r\n  // 可选：在 seek 当下直接预回填一批历史弹幕，使“本应仍在屏幕上的”弹幕立即出现，减少视觉空窗\r\n  if (this._.backfillOnSeek) {\r\n    try {\r\n      var ct = this.media.currentTime;\r\n      var windowStart = Math.max(0, ct - (this._.backfillDuration || this._.duration));\r\n      // 找到窗口起点索引（第一个 > windowStart 的插入点 -> 前一个即 <= windowStart）\r\n      var wsIndex = binsearch(this.comments, 'time', windowStart) - 1;\r\n      if (wsIndex < -1) wsIndex = -1;\r\n      var start = wsIndex + 1;\r\n      var end = position; // 不含 position (position 为第一个 > ct 的插入点)\r\n      var pool = [];\r\n      for (var i = start; i < end; i++) {\r\n        var c = this.comments[i];\r\n        // 过滤：仅回填真正落在窗口内的；并限制数量\r\n        if (c.time <= ct && c.time >= windowStart) {\r\n          pool.push(c);\r\n          if (this._.maxBackfill && pool.length >= this._.maxBackfill) break;\r\n        }\r\n      }\r\n      if (pool.length) {\r\n        // 创建 canvas（避免首帧重复 setup）\r\n        this._.engine.setup(this._.stage, pool);\r\n        var dn = now() / 1000;\r\n        for (var j = 0; j < pool.length; j++) {\r\n          var cmt = pool[j];\r\n          // 复现其 _utc：等价于正常进入时的计算，使滚动位置正确\r\n          cmt._utc = dn - (ct - cmt.time);\r\n          // 分配 Y（按时间顺序保证占道逻辑正确）\r\n          cmt.y = allocate.call(this, cmt);\r\n          this._.runningList.push(cmt);\r\n        }\r\n        // 为避免 engine 再次把这些回填的弹幕判定为“待进入”，直接将游标推进到 position\r\n        this._.position = position;\r\n\r\n        // 如果当前是暂停状态（或可见但未播放），需要立即渲染一个静态帧，否则用户看不到回填结果\r\n        if (this._.paused || (this.media && this.media.paused)) {\r\n          try {\r\n            // 清帧\r\n            this._.engine.framing(this._.stage);\r\n            var pbr = this.media ? this.media.playbackRate : 1;\r\n            for (var k = 0; k < this._.runningList.length; k++) {\r\n              var rc = this._.runningList[k];\r\n              var totalWidth = this._.width + rc.width;\r\n              // 使用 media.currentTime 保持与真正播放时的一致位置\r\n              var elapsed = totalWidth * (ct - rc.time) * pbr / this._.duration;\r\n              if (rc.mode === 'ltr') rc.x = elapsed - rc.width;\r\n              if (rc.mode === 'rtl') rc.x = this._.width - elapsed;\r\n              if (rc.mode === 'top' || rc.mode === 'bottom') rc.x = (this._.width - rc.width) >> 1;\r\n              this._.engine.render(this._.stage, rc);\r\n            }\r\n          } catch (re) { try { console.warn('[Danmaku] seek backfill static render error', re); } catch (_) {} }\r\n        }\r\n      }\r\n    } catch (e) {\r\n      try { console.warn('[Danmaku] seek backfill error', e); } catch (_) {}\r\n    }\r\n  }\r\n  return this;\r\n}\r\n\r\n/**\r\n * 绑定媒体元素事件监听器\r\n * @param {Object} _ - 监听器存储对象\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction bindEvents(_) {\r\n  _.play = play.bind(this);\r\n  _.pause = pause.bind(this);\r\n  _.seeking = seek.bind(this);\r\n  _.ratechange = ratechange.bind(this);\r\n  this.media.addEventListener('play', _.play);\r\n  this.media.addEventListener('pause', _.pause);\r\n  this.media.addEventListener('playing', _.play);\r\n  this.media.addEventListener('waiting', _.pause);\r\n  this.media.addEventListener('seeking', _.seeking);\r\n  this.media.addEventListener('ratechange', _.ratechange);\r\n}\r\n\r\n/**\r\n * 解绑媒体元素事件监听器\r\n * @param {Object} _ - 监听器存储对象\r\n */\r\n/* eslint no-invalid-this: 0 */\r\nfunction unbindEvents(_) {\r\n  this.media.removeEventListener('play', _.play);\r\n  this.media.removeEventListener('pause', _.pause);\r\n  this.media.removeEventListener('playing', _.play);\r\n  this.media.removeEventListener('waiting', _.pause);\r\n  this.media.removeEventListener('seeking', _.seeking);\r\n  this.media.removeEventListener('ratechange', _.ratechange);\r\n  _.play = null;\r\n  _.pause = null;\r\n  _.seeking = null;\r\n  _.ratechange = null;\r\n}\r\n\r\n/**\r\n * 初始化弹幕实例\r\n * @param {Object} opt - 初始化选项\r\n * @param {HTMLElement} [opt.container] - 弹幕容器元素\r\n * @param {HTMLMediaElement} [opt.media] - 关联的媒体元素\r\n * @param {number} [opt.speed] - 弹幕滚动速度\r\n * @param {Array} [opt.comments] - 弹幕数据数组\r\n * @returns {Object} 弹幕实例\r\n */\r\n/* eslint-disable no-invalid-this */\r\nfunction init$1(opt) {\r\n  this._ = {};\r\n  this.container = opt.container || document.createElement('div');\r\n  this.media = opt.media;\r\n  this._.visible = true;\r\n\r\n  /* istanbul ignore next */\r\n  {\r\n    this.engine = 'canvas';\r\n    this._.engine = canvasEngine;\r\n  }\r\n  /* eslint-enable no-undef */\r\n  this._.requestID = 0;\r\n\r\n  // 设置弹幕速度和持续时间\r\n  this._.speed = Math.max(0, opt.speed) || 144;  // 像素/秒\r\n  this._.duration = 4;                           // 默认持续时间（秒）\r\n  this._.lastPbr = this.media ? (this.media.playbackRate || 1) : 1; // 记录上一次播放速率\r\n\r\n  // 回填配置（可选）\r\n  this._.backfillOnSeek = opt.backfillOnSeek !== undefined ? !!opt.backfillOnSeek : true; // 默认开启\r\n  this._.backfillDuration = typeof opt.backfillDuration === 'number' && opt.backfillDuration > 0\r\n    ? opt.backfillDuration\r\n    : undefined; // 缺省时使用 this._.duration\r\n  this._.maxBackfill = typeof opt.maxBackfill === 'number' && opt.maxBackfill > 0\r\n    ? opt.maxBackfill\r\n    : 120; // 防止 seek 回填过多影响性能\r\n\r\n  // 右键复制菜单配置\r\n  this._.enableCopyMenu = opt.enableCopyMenu !== undefined ? !!opt.enableCopyMenu : true;\r\n  this._.copyMenu = null; // DOM 元素\r\n  this._.copyMenuHandlers = null; // 保存监听器引用\r\n\r\n  // 处理弹幕数据\r\n  this.comments = opt.comments || [];\r\n  this.comments.sort(function (a, b) {\r\n    return a.time - b.time;  // 按时间排序\r\n  });\r\n  // 格式化弹幕模式\r\n  for (var i = 0; i < this.comments.length; i++) {\r\n    this.comments[i].mode = formatMode(this.comments[i].mode);\r\n  }\r\n  this._.runningList = [];  // 正在运行的弹幕列表\r\n  this._.position = 0;      // 当前处理位置\r\n\r\n  this._.paused = true;\r\n\r\n  // 如果有媒体元素，绑定事件监听器\r\n  if (this.media) {\r\n    this._.listener = {};\r\n    bindEvents.call(this, this._.listener);\r\n  }\r\n\r\n  // 初始化渲染舞台\r\n  this._.stage = this._.engine.init(this.container);\r\n  this._.stage.style.cssText += 'position:relative;pointer-events:none;';\r\n\r\n  this.resize();  // 设置尺寸\r\n  this.container.appendChild(this._.stage);\r\n\r\n  // 若全局设置指定了远程字体（/danmaku/font/），尝试预加载并应用到容器，失败则忽略\r\n  try {\r\n    var g = __getGlobal();\r\n    var ff = g?.danmakuSettings?.get?.('font_family');\r\n    if (typeof ff === 'string' && ff.indexOf('/danmaku/font/') === 0) {\r\n      ensureRemoteFontLoaded(ff).then(function(fam){\r\n        if (fam) {\r\n          try { (g.danmakuRenderer?.container || this.container).style.fontFamily = \"'\" + fam + \"', sans-serif\"; } catch (_) {}\r\n        }\r\n      }.bind(this));\r\n    }\r\n  } catch (_) { /* ignore */ }\r\n\r\n  // 初始化右键复制菜单（使用 document 捕获, 不改变 pointer-events 行为）\r\n  if (this._.enableCopyMenu) {\r\n    setupCopyContextMenu.call(this);\r\n  }\r\n\r\n  // 初始化空间分配器\r\n  this._.space = {};\r\n  resetSpace(this._.space);\r\n\r\n  // 如果媒体未暂停或没有媒体元素，开始播放\r\n  if (!this.media || !this.media.paused) {\r\n    seek.call(this);\r\n    play.call(this);\r\n  }\r\n  return this;\r\n}\r\n\r\n/**\r\n * 销毁弹幕实例，清理所有资源\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint-disable no-invalid-this */\r\nfunction destroy() {\r\n  if (!this.container) {\r\n    return this;\r\n  }\r\n\r\n  pause.call(this);   // 停止动画\r\n  this.clear();       // 清空弹幕\r\n  this.container.removeChild(this._.stage);  // 移除Canvas元素\r\n\r\n  // 如果有媒体元素，解绑事件监听器\r\n  if (this.media) {\r\n    unbindEvents.call(this, this._.listener);\r\n  }\r\n\r\n  // 移除右键菜单监听\r\n  if (this._.copyMenuHandlers) {\r\n    try { document.removeEventListener('contextmenu', this._.copyMenuHandlers.onContext, true); } catch (_) {}\r\n    try { document.removeEventListener('click', this._.copyMenuHandlers.onDocClick, true); } catch (_) {}\r\n    try { document.removeEventListener('scroll', this._.copyMenuHandlers.onScroll, true); } catch (_) {}\r\n  }\r\n  if (this._.copyMenu && this._.copyMenu.parentElement) {\r\n    try { this._.copyMenu.parentElement.removeChild(this._.copyMenu); } catch (_) {}\r\n  }\r\n\r\n  // 清空所有属性\r\n  for (var key in this) {\r\n    /* istanbul ignore else  */\r\n    if (Object.prototype.hasOwnProperty.call(this, key)) {\r\n      this[key] = null;\r\n    }\r\n  }\r\n  return this;\r\n}\r\n\r\n/**\r\n * 弹幕对象的有效属性列表\r\n */\r\nvar properties = ['mode', 'time', 'text', 'render', 'style'];\r\n\r\n/**\r\n * 发送新弹幕\r\n * @param {Object} obj - 弹幕对象\r\n * @param {string} [obj.mode] - 弹幕模式 (rtl/ltr/top/bottom)\r\n * @param {number} [obj.time] - 显示时间\r\n * @param {string} obj.text - 弹幕文本\r\n * @param {Function} [obj.render] - 自定义渲染函数\r\n * @param {Object} [obj.style] - 样式对象\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint-disable no-invalid-this */\r\nfunction emit(obj) {\r\n  if (!obj || Object.prototype.toString.call(obj) !== '[object Object]') {\r\n    return this;\r\n  }\r\n\r\n  var cmt = {};\r\n  // 只保留有效属性\r\n  for (var i = 0; i < properties.length; i++) {\r\n    if (obj[properties[i]] !== undefined) {\r\n      cmt[properties[i]] = obj[properties[i]];\r\n    }\r\n  }\r\n\r\n  cmt.text = (cmt.text || '').toString();  // 确保文本为字符串\r\n  cmt.mode = formatMode(cmt.mode);         // 格式化模式\r\n  cmt._utc = now() / 1000;                 // 设置UTC时间\r\n\r\n  if (this.media) {\r\n    var position = 0;\r\n    if (cmt.time === undefined) {\r\n      // 如果未指定时间，使用当前媒体时间\r\n      cmt.time = this.media.currentTime;\r\n      position = this._.position;\r\n    } else {\r\n      // 查找插入位置\r\n      position = binsearch(this.comments, 'time', cmt.time);\r\n      if (position < this._.position) {\r\n        this._.position += 1;  // 更新当前位置\r\n      }\r\n    }\r\n    this.comments.splice(position, 0, cmt);\r\n  } else {\r\n    this.comments.push(cmt);\r\n  }\r\n  return this;\r\n}\r\n\r\n/**\r\n * 显示弹幕\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint-disable no-invalid-this */\r\nfunction show() {\r\n  if (this._.visible) {\r\n    return this;\r\n  }\r\n  this._.visible = true;\r\n  // 始终执行 seek 以重建运行列表并触发回填逻辑（即使媒体处于暂停状态）\r\n  // 这样在 hide() -> show() 且视频暂停时，也能看到当前时间窗口内应在屏幕上的弹幕\r\n  seek.call(this);\r\n  // 如果媒体正在播放则恢复动画帧；若暂停则 seek 内部已静态渲染一帧\r\n  if (!(this.media && this.media.paused)) {\r\n    play.call(this);\r\n  }\r\n  return this;\r\n}\r\n\r\n/**\r\n * 隐藏弹幕\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint-disable no-invalid-this */\r\nfunction hide() {\r\n  if (!this._.visible) {\r\n    return this;\r\n  }\r\n  pause.call(this);\r\n  this.clear();\r\n  this._.visible = false;\r\n  return this;\r\n}\r\n\r\n/**\r\n * 清空当前显示的所有弹幕\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint-disable no-invalid-this */\r\nfunction clear$1() {\r\n  this._.engine.clear(this._.stage, this._.runningList);\r\n  this._.runningList = [];\r\n  return this;\r\n}\r\n\r\n/**\r\n * 重新调整弹幕容器尺寸\r\n * @returns {Object} 弹幕实例（支持链式调用）\r\n */\r\n/* eslint-disable no-invalid-this */\r\nfunction resize$1() {\r\n  this._.width = this.container.offsetWidth;\r\n  this._.height = this.container.offsetHeight;\r\n  this._.engine.resize(this._.stage, this._.width, this._.height);\r\n  this._.duration = this._.width / this._.speed;  // 重新计算持续时间\r\n  return this;\r\n}\r\n\r\n/**\r\n * 弹幕滚动速度属性描述符\r\n * 提供getter和setter方法\r\n */\r\nvar speed = {\r\n  /**\r\n   * 获取当前滚动速度\r\n   * @returns {number} 当前速度值\r\n   */\r\n  get: function () {\r\n    return this._.speed;\r\n  },\r\n  /**\r\n   * 设置滚动速度\r\n   * @param {number} s - 新的速度值\r\n   * @returns {number} 设置后的速度值\r\n   */\r\n  set: function (s) {\r\n    if (typeof s !== 'number' ||\r\n      isNaN(s) ||\r\n      !isFinite(s) ||\r\n      s <= 0) {\r\n      return this._.speed;  // 无效值时返回当前速度\r\n    }\r\n    this._.speed = s;\r\n    if (this._.width) {\r\n      this._.duration = this._.width / s;  // 重新计算持续时间\r\n    }\r\n    return s;\r\n  }\r\n};\r\n\r\n/**\r\n * 弹幕构造函数\r\n * @param {Object} [opt] - 初始化选项\r\n * @constructor\r\n */\r\nfunction Danmaku(opt) {\r\n  opt && init$1.call(this, opt);\r\n}\r\n\r\n// 原型方法定义\r\nDanmaku.prototype.destroy = function () {\r\n  return destroy.call(this);\r\n};\r\nDanmaku.prototype.emit = function (cmt) {\r\n  return emit.call(this, cmt);\r\n};\r\nDanmaku.prototype.show = function () {\r\n  return show.call(this);\r\n};\r\nDanmaku.prototype.hide = function () {\r\n  return hide.call(this);\r\n};\r\nDanmaku.prototype.clear = function () {\r\n  return clear$1.call(this);\r\n};\r\nDanmaku.prototype.resize = function () {\r\n  return resize$1.call(this);\r\n};\r\n\r\n// 对实例暴露字体加载器（语义代理）\r\nDanmaku.prototype.ensureRemoteFontLoaded = function(url){\r\n  return ensureRemoteFontLoaded(url);\r\n};\r\n\r\n// 定义speed属性的getter和setter\r\nObject.defineProperty(Danmaku.prototype, 'speed', speed);\r\n\r\n/**\r\n * 命中检测：在当前运行列表中找到与点击坐标匹配的弹幕\r\n * @param {number} x 相对 stage 左上角坐标\r\n * @param {number} y 相对 stage 左上角坐标\r\n */\r\nfunction hitDanmaku(x, y) {\r\n  // 从最上层(后绘制)开始，便于选择视觉上前景的弹幕\r\n  for (var i = this._.runningList.length - 1; i >= 0; i--) {\r\n    var c = this._.runningList[i];\r\n    if (x >= c.x && x <= c.x + c.width && y >= c.y && y <= c.y + c.height) return c;\r\n  }\r\n  return null;\r\n}\r\n\r\n/**\r\n * 创建右键复制菜单\r\n */\r\nfunction setupCopyContextMenu() {\r\n  var that = this;\r\n  if (this._.copyMenuHandlers) return; // 已初始化\r\n  var menu = document.createElement('div');\r\n  menu.style.position = 'fixed';\r\n  menu.style.zIndex = '2147483646';\r\n  menu.style.background = 'rgba(30,30,30,0.95)';\r\n  menu.style.backdropFilter = 'blur(4px)';\r\n  menu.style.border = '1px solid rgba(255,255,255,0.15)';\r\n  menu.style.borderRadius = '6px';\r\n  menu.style.padding = '4px 0';\r\n  menu.style.minWidth = '96px';\r\n  menu.style.font = '12px/1.4 system-ui, sans-serif';\r\n  menu.style.color = '#f0f0f0';\r\n  menu.style.boxShadow = '0 4px 18px rgba(0,0,0,0.4)';\r\n  menu.style.userSelect = 'none';\r\n  menu.style.display = 'none';\r\n  menu.setAttribute('data-danmaku-copy-menu', '');\r\n\r\n  // 预览框（显示被命中的弹幕文本）\r\n  var preview = document.createElement('div');\r\n  preview.style.padding = '6px 10px 6px 10px';\r\n  preview.style.fontSize = '12px';\r\n  preview.style.lineHeight = '1.35';\r\n  preview.style.color = '#e5f6ff';\r\n  preview.style.maxWidth = '360px';\r\n  preview.style.maxHeight = '120px';\r\n  preview.style.overflow = 'auto';\r\n  preview.style.wordBreak = 'break-all';\r\n  preview.style.whiteSpace = 'pre-wrap';\r\n  preview.style.borderBottom = '1px solid rgba(255,255,255,0.08)';\r\n  preview.style.boxSizing = 'border-box';\r\n  preview.setAttribute('data-danmaku-preview','');\r\n  menu.appendChild(preview);\r\n\r\n  function addItem(label, onClick) {\r\n    var item = document.createElement('div');\r\n    item.textContent = label;\r\n    item.style.padding = '4px 12px';\r\n    item.style.cursor = 'pointer';\r\n    item.style.whiteSpace = 'nowrap';\r\n    item.addEventListener('mouseenter', function(){ item.style.background = 'rgba(255,255,255,0.08)'; });\r\n    item.addEventListener('mouseleave', function(){ item.style.background = 'transparent'; });\r\n    item.addEventListener('click', function(e){\r\n      e.stopPropagation();\r\n      try { onClick(); } catch(_) {}\r\n      hideMenu();\r\n    });\r\n    // 备用：提供 mousedown 触发兼容（不再打印日志）\r\n    item.addEventListener('mousedown', function(e){ if (e.button !== 0) return; });\r\n    menu.appendChild(item);\r\n  }\r\n\r\n  var currentCmt = null;\r\n\r\n  function hideMenu() {\r\n    menu.style.display = 'none';\r\n    currentCmt = null;\r\n  }\r\n\r\n  addItem('复制', function(){\r\n    if (!currentCmt) return;\r\n    var text = currentCmt.text || '';\r\n    try {\r\n      if (navigator.clipboard && navigator.clipboard.writeText) {\r\n        var p = navigator.clipboard.writeText(text);\r\n        if (p && typeof p.then === 'function') {\r\n          p.then(function(){\r\n          }).catch(function(err){\r\n            // 降级时输出一次警告\r\n            console.warn('[Danmaku] copy async failed, fallback to execCommand', err);\r\n            fallbackCopy(text);\r\n          });\r\n        }\r\n      } else {\r\n        fallbackCopy(text);\r\n      }\r\n    } catch (err) {\r\n      console.warn('[Danmaku] copy threw, fallback', err);\r\n      try { fallbackCopy(text); } catch(_) {}\r\n    }\r\n  });\r\n\r\n  document.body.appendChild(menu);\r\n  this._.copyMenu = menu;\r\n\r\n  function showAt(x, y) {\r\n    // 防溢出\r\n    var vw = window.innerWidth, vh = window.innerHeight;\r\n    menu.style.left = Math.min(x, vw - menu.offsetWidth - 4) + 'px';\r\n    menu.style.top = Math.min(y, vh - menu.offsetHeight - 4) + 'px';\r\n    menu.style.display = 'block';\r\n  }\r\n\r\n  function onContext(e) {\r\n    // 仅当点击区域覆盖在 stage 上方才检测\r\n    if (!that._.stage || !that._.stage.parentElement) return;\r\n    // 允许其他右键操作通过：如果点击目标在复制菜单内部直接返回\r\n    if (menu.contains(e.target)) return;\r\n    var rect = that._.stage.getBoundingClientRect();\r\n    var x = e.clientX - rect.left;\r\n    var y = e.clientY - rect.top;\r\n    if (x < 0 || y < 0 || x > rect.width || y > rect.height) return; // 不在画布区域\r\n    // 进行命中检测\r\n  var cmt = hitDanmaku.call(that, x, y);\r\n  if (!cmt) return; // 没有弹幕，不拦截\r\n  if (menu.style.display === 'block') menu.style.display = 'none';\r\n  currentCmt = cmt;\r\n  preview.textContent = cmt.text || '';\r\n  e.preventDefault();\r\n  e.stopPropagation();\r\n  menu.style.display='block';\r\n  showAt(e.clientX, e.clientY);\r\n  }\r\n\r\n  function onScroll() { hideMenu(); }\r\n  function onDocClickWrapped(e) { if (!menu.contains(e.target)) hideMenu(); }\r\n\r\n  document.addEventListener('contextmenu', onContext, true); // 仍用捕获，优先拦截\r\n  document.addEventListener('click', onDocClickWrapped, false); // 改为冒泡，避免抢先隐藏\r\n  document.addEventListener('scroll', onScroll, true);\r\n  this._.copyMenuHandlers = { onContext, onDocClick: onDocClickWrapped, onScroll };\r\n\r\n  function fallbackCopy(text) {\r\n    try {\r\n      var ta = document.createElement('textarea');\r\n      ta.value = text;\r\n      ta.style.position='fixed';ta.style.top='-9999px';\r\n      document.body.appendChild(ta); ta.select();\r\n      var ok = false;\r\n      try { ok = document.execCommand('copy'); } catch(e){ console.warn('[Danmaku] execCommand copy error', e); }\r\n      document.body.removeChild(ta);\r\n    } catch(e) { console.warn('[Danmaku] fallback copy failed', e); }\r\n  }\r\n}\r\n\r\n// 暴露为内部方法（如果未来需要外部开关）\r\nDanmaku.prototype._setupCopyContextMenu = function(){ setupCopyContextMenu.call(this); };\r\n\r\n/**\r\n * 原地替换整批弹幕数据，预处理完成后一次性切换，尽量减少可见空窗。\r\n * @param {Array} newComments 新的弹幕数组（元素需包含 time / text / mode 等）\r\n * @param {Object} [opt]\r\n * @param {boolean} [opt.preserveState=true] 是否保持当前播放/暂停与显示状态\r\n * @param {boolean} [opt.resetCopyMenu=false] 是否重建右键菜单（一般不需要）\r\n * @returns {Danmaku} this\r\n */\r\nDanmaku.prototype.replaceComments = function(newComments, opt){\r\n  opt = opt || {};\r\n  if (!Array.isArray(newComments)) return this;\r\n  // 拷贝 & 排序 & 标准化（不修改传入数组引用）\r\n  var prepared = newComments.slice();\r\n  prepared.sort(function(a,b){ return (a.time||0) - (b.time||0); });\r\n  for (var i=0;i<prepared.length;i++) {\r\n    var c = prepared[i];\r\n    c.mode = formatMode(c.mode);\r\n    // 规范 text\r\n    c.text = (c.text==null? '' : String(c.text));\r\n  }\r\n\r\n  // 计算当前参考时间\r\n  var media = this.media;\r\n  var ct = media ? media.currentTime : (now()/1000);\r\n  var duration = this._.duration || 4;\r\n  var windowStart = ct - duration;\r\n\r\n  // 预建空间/运行列表（不影响现有实例状态）\r\n  var newSpace = {};\r\n  resetSpace(newSpace);\r\n  var visibleList = [];\r\n\r\n  // 二分找到显示窗口起点\r\n  var startIndex = binsearch(prepared, 'time', windowStart) - 1; // bins 返回插入点，前一条可能仍在窗口\r\n  if (startIndex < -1) startIndex = -1;\r\n  var idx = startIndex + 1;\r\n  var dn = now()/1000;\r\n  var pbr = media ? (media.playbackRate||1) : 1;\r\n  // 临时上下文用于 allocate\r\n  var tempCtx = {\r\n    media: media,\r\n    _: {\r\n      duration: duration,\r\n      width: this._.width,\r\n      height: this._.height,\r\n      space: newSpace\r\n    }\r\n  };\r\n  // 需要字体尺寸用于 createCommentCanvas\r\n  var fontSize = this._.stage? this._.stage._fontSize : { root: 16, container: 16 };\r\n\r\n  while (idx < prepared.length) {\r\n    var cm = prepared[idx];\r\n    var t = cm.time||0;\r\n    if (t > ct) break; // 之后都是未来弹幕\r\n    if (t >= windowStart) {\r\n      // 预创建 canvas\r\n      try { cm.canvas = createCommentCanvas(cm, fontSize); } catch(e) { cm.canvas = null; }\r\n      // 计算 _utc 以保持位置连贯\r\n      cm._utc = dn - (ct - t);\r\n      // 分配 y\r\n      try { cm.y = allocate.call(tempCtx, cm); } catch(e) { cm.y = 0; }\r\n      visibleList.push(cm);\r\n    }\r\n    idx++;\r\n  }\r\n\r\n  // 计算新的 position（下一条待进入的索引）\r\n  var position = binsearch(prepared, 'time', ct) - 1; // 与 seek 中逻辑保持一致\r\n  if (position < 0) position = 0;\r\n  // NOTE: engine 在帧循环里会 ++position 后读取，保持与内部一致性\r\n\r\n  var wasPaused = this._.paused;\r\n  var wasVisible = this._.visible;\r\n  // 暂停动画循环（如果在运行）\r\n  if (!wasPaused) {\r\n    try { caf(this._.requestID); } catch(_) {}\r\n    this._.requestID = 0;\r\n  // 关键修复：原来未将 paused 置回 true，随后调用 play() 会因 this._.paused===false 直接返回，导致动画不再恢复。\r\n  // 这里显式标记为暂停状态，使 play() 能重新建立 rAF 循环。\r\n  this._.paused = true;\r\n  }\r\n\r\n  // 原子替换内部结构\r\n  this.comments = prepared;\r\n  this._.space = newSpace;\r\n  this._.runningList = visibleList; // 立即可渲染列表\r\n  this._.position = position; // 下次帧循环从此处继续\r\n\r\n  // 清帧并静态渲染一帧（避免空白）\r\n  try {\r\n    this._.engine.framing(this._.stage);\r\n    for (var ri=0; ri<visibleList.length; ri++) {\r\n      var vc = visibleList[ri];\r\n      // 根据模式计算 x（复制 engine 内逻辑）\r\n      var totalWidth = this._.width + vc.width;\r\n      var elapsed = totalWidth * (dn - vc._utc) * pbr / duration;\r\n      if (vc.mode === 'ltr') vc.x = elapsed - vc.width;\r\n      if (vc.mode === 'rtl') vc.x = this._.width - elapsed;\r\n      if (vc.mode === 'top' || vc.mode === 'bottom') vc.x = (this._.width - vc.width) >> 1;\r\n      this._.engine.render(this._.stage, vc);\r\n    }\r\n  } catch(e) { /* ignore */ }\r\n\r\n  // 恢复播放状态\r\n  if (wasVisible) {\r\n    if (!wasPaused) {\r\n      // 继续动画\r\n      play.call(this);\r\n    } else {\r\n      // 暂停但可见：保持静态帧即可\r\n    }\r\n  }\r\n\r\n  // 可选重建右键菜单（通常不需要）\r\n  if (opt.resetCopyMenu && this._.enableCopyMenu) {\r\n    try { this._setupCopyContextMenu(); } catch(_) {}\r\n  }\r\n  return this;\r\n};\r\n\r\nexport default Danmaku;","/**\r\n * Danmaku 操作集合\r\n * 暴露三个创建方法：attachButtonsGroup, generateHeatmap, renderDanmaku\r\n */\r\n\r\nimport { DanmakuButtonsGroup } from './ui/buttons';\r\nimport { DanmakuHeatmapRenderer } from './render/heatmapRenderer';\r\nimport Danmaku from './render/danmakuCanvas.js';\r\n\r\nconst GLOBAL_NS = '__jfDanmakuGlobal__';\r\nfunction getGlobal() {\r\n    if (typeof window === 'undefined') return {};\r\n    window[GLOBAL_NS] = window[GLOBAL_NS] || {};\r\n    return window[GLOBAL_NS];\r\n}\r\n\r\n// 可见性判断\r\nfunction isVisible(el) {\r\n    if (!el) return false;\r\n    if (el.offsetParent !== null) return true;\r\n    try {\r\n        const cs = window.getComputedStyle(el);\r\n        return cs && cs.display !== 'none' && cs.visibility !== 'hidden' && cs.opacity !== '0';\r\n    } catch (_) { return false; }\r\n}\r\n\r\n// 获取当前活跃的 OSD 根节点（优先包含当前 video 的且可见的 data-type=video-osd 容器）\r\nfunction getActiveOsdRoot() {\r\n    const video = document.querySelector('video.htmlvideoplayer');\r\n    const roots = Array.from(document.querySelectorAll(\"div[data-type='video-osd']\"));\r\n    const visibleRoots = roots.filter(isVisible);\r\n    if (video) {\r\n        const owner = visibleRoots.find(r => r.contains(video));\r\n        if (owner) return owner;\r\n    }\r\n    return visibleRoots[0] || roots[0] || null;\r\n}\r\n\r\n// 在活跃 OSD 内查找热力图可挂载的进度条容器（更鲁棒的选择器集）\r\nfunction findHeatmapContainer() {\r\n    const root = getActiveOsdRoot() || document;\r\n    const candidates = [\r\n        '.sliderMarkerContainer',\r\n        '.osdProgressInner .sliderMarkerContainer',\r\n        '.osdProgressInner',\r\n        '.positionSlider',\r\n        '.emby-slider',\r\n        '.noUi-target',\r\n        '[role=\"slider\"]',\r\n        'input[type=\"range\"]'\r\n    ];\r\n    for (const sel of candidates) {\r\n        const nodes = Array.from(root.querySelectorAll(sel));\r\n        for (const n of nodes) {\r\n            let el = n;\r\n            // 如果命中的是 slider 控件本体，倾向使用其父容器\r\n            if (el.tagName === 'INPUT' || el.getAttribute('role') === 'slider') {\r\n                el = el.parentElement || el;\r\n            }\r\n            if (isVisible(el) && (el.offsetWidth || el.scrollWidth)) {\r\n                return el;\r\n            }\r\n        }\r\n    }\r\n    // 全局兜底\r\n    const fallback = document.querySelector('.sliderMarkerContainer');\r\n    return fallback || null;\r\n}\r\n\r\n// 查找播放器按钮容器（优先在活跃 OSD 根内）\r\nfunction findButtonsContainer() {\r\n    const osdRoot = getActiveOsdRoot();\r\n    const searchIn = (root) => {\r\n        if (!root) return null;\r\n        const anchors = ['.btnVideoOsdSettings', '.btnVideoOsd', '.pause'];\r\n        for (const sel of anchors) {\r\n            const nodes = root.querySelectorAll(sel);\r\n            for (const n of nodes) {\r\n                if (!isVisible(n)) continue;\r\n                const container = n.closest('.buttons.focuscontainer-x');\r\n                if (container && isVisible(container)) return container;\r\n            }\r\n        }\r\n        const list = root.querySelectorAll('.buttons.focuscontainer-x');\r\n        for (const el of list) { if (isVisible(el)) return el; }\r\n        return list[0] || null;\r\n    };\r\n\r\n    // 先在活跃 OSD 内找；找不到再全局兜底\r\n    return searchIn(osdRoot) || searchIn(document);\r\n}\r\n\r\n/**\r\n * 创建并插入“弹幕按钮组”。\r\n * 返回 { status: 'created'|'exists'|'no-container', instance?, element? }\r\n */\r\nexport function attachButtonsGroup(logger = null) {\r\n    const container = findButtonsContainer();\r\n    if (!container) {\r\n        logger?.debug?.('按钮容器未就绪');\r\n        return { status: 'no-container' };\r\n    }\r\n\r\n    const g = getGlobal();\r\n    // 幂等：优先复用现有实例（如存在则只移动，不重建）\r\n    const existing = g.danmakuButtonsGroup;\r\n    const existingEl = existing?.getElement?.();\r\n    const insertIndex = 1;\r\n    const beforeNode = container.children && container.children.length > insertIndex ? container.children[insertIndex] : null;\r\n\r\n    if (existing && existingEl) {\r\n        // 移除同容器内除现有元素之外的重复项\r\n        try {\r\n            container.querySelectorAll('[data-danmaku-buttons]')?.forEach(node => {\r\n                if (node !== existingEl) { try { node.remove(); } catch (_) { } }\r\n            });\r\n        } catch (_) { }\r\n        // 不同父容器：移动现有元素\r\n        if (existingEl.parentElement !== container) {\r\n            try { container.insertBefore(existingEl, beforeNode); } catch (_) { try { container.appendChild(existingEl); } catch (_) { } }\r\n            logger?.info?.('弹幕按钮组已移动到当前容器');\r\n            return { status: 'moved', instance: existing, element: existingEl };\r\n        }\r\n        // 相同父容器但索引不同：调整位置\r\n        const currentIndex = Array.prototype.indexOf.call(container.children, existingEl);\r\n        if (currentIndex !== insertIndex) {\r\n            try { container.insertBefore(existingEl, beforeNode); } catch (_) { }\r\n        }\r\n        return { status: 'exists', instance: existing, element: existingEl };\r\n    }\r\n\r\n    // 不存在则创建\r\n    const group = new DanmakuButtonsGroup({ logger });\r\n    const el = group.getElement();\r\n    el?.setAttribute?.('data-danmaku-buttons', 'true');\r\n    try {\r\n        container.querySelectorAll('[data-danmaku-buttons]')?.forEach(node => { if (node !== el) { try { node.remove(); } catch (_) { } } });\r\n    } catch (_) { }\r\n    try { container.insertBefore(el, beforeNode); } catch (_) { try { container.appendChild(el); } catch (_) { } }\r\n    g.danmakuButtonsGroup = group;\r\n    logger?.info?.('弹幕按钮组已插入');\r\n    return { status: 'created', instance: group, element: el };\r\n}\r\n\r\n/**\r\n * 创建热力图 Canvas 并追加到进度条容器\r\n * 返回 { status: 'created'|'exists'|null, canvas? }\r\n */\r\nexport function generateHeatmap(logger = null) {\r\n    const g = getGlobal();\r\n    const heatmapData = g?.danmakuData?.heatmap_data;\r\n    const heatmapArray = heatmapData ? Object.values(heatmapData) : [];\r\n    const CANVAS_ID = 'danmaku-heatmap-canvas';\r\n    const container = findHeatmapContainer();\r\n    const video = document.querySelector('video');\r\n    const duration = video?.duration || 0;\r\n    if (!container || !video) {\r\n        logger?.debug?.('热力图容器/视频未就绪');\r\n        return null;\r\n    }\r\n\r\n    // 若已存在 renderer 或 canvas：优先移动到当前容器，避免重建闪烁\r\n    const existingCanvas = document.getElementById(CANVAS_ID);\r\n    if (existingCanvas) {\r\n        if (!container.contains(existingCanvas)) {\r\n            try { container.appendChild(existingCanvas); } catch (_) { }\r\n            logger?.info?.('热力图已移动到当前容器');\r\n            return { status: 'moved', canvas: existingCanvas };\r\n        }\r\n        return { status: 'exists', canvas: existingCanvas };\r\n    }\r\n    if (!duration || !isFinite(duration) || duration <= 0) {\r\n        try {\r\n            logger?.debug?.('video.duration 未就绪，等待 loadedmetadata 再生成热力图');\r\n            const once = () => {\r\n                try { video.removeEventListener('loadedmetadata', once); } catch (_) { }\r\n                try { generateHeatmap(logger); } catch (_) { }\r\n            };\r\n            video.addEventListener('loadedmetadata', once, { once: true });\r\n        } catch (_) { }\r\n        return null;\r\n    }\r\n\r\n    const checkAgain = document.getElementById(CANVAS_ID);\r\n    if (checkAgain && checkAgain.parentNode) {\r\n        return { status: 'exists', canvas: checkAgain };\r\n    }\r\n\r\n    try {\r\n    const width = container.scrollWidth || container.offsetWidth || 3840;\r\n        // 若已有 renderer，复用实例，仅 process 生成画布\r\n        if (!g.heatmapRenderer) {\r\n            g.heatmapRenderer = new DanmakuHeatmapRenderer({\r\n            autoResize: true,\r\n            resizeThreshold: 50,\r\n            resizeDebounceDelay: 100,\r\n            debug: false,\r\n            color: 'blue',\r\n            canvasId: CANVAS_ID\r\n            });\r\n        }\r\n\r\n        const canvas = g.heatmapRenderer.process(heatmapArray, duration, width);\r\n        canvas.id = CANVAS_ID;\r\n        canvas.setAttribute('data-danmaku-heatmap', 'true');\r\n        container.appendChild(canvas);\r\n        logger?.info?.('热力图创建成功');\r\n        return { status: 'created', canvas };\r\n    } catch (err) {\r\n        logger?.warn?.('热力图绘制异常', err);\r\n        return null;\r\n    }\r\n}\r\n\r\n// 供外部在数据变化后主动刷新热力图（若已创建）\r\nexport function refreshHeatmapWithData(logger = null) {\r\n    const g = getGlobal();\r\n    const container = findHeatmapContainer();\r\n    const video = document.querySelector('video');\r\n    const duration = video?.duration || 0;\r\n    const heatmapData = g?.danmakuData?.heatmap_data;\r\n    const heatmapArray = heatmapData ? Object.values(heatmapData) : [];\r\n    if (!g.heatmapRenderer || !container || !video) return false;\r\n    try {\r\n        g.heatmapRenderer.recalculate(heatmapArray, duration);\r\n        logger?.info?.('热力图已根据新数据重新计算');\r\n        return true;\r\n    } catch (e) {\r\n        logger?.warn?.('热力图重新计算失败', e);\r\n        return false;\r\n    }\r\n}\r\n\r\n/**\r\n * 渲染弹幕到视频上方\r\n * 返回 { status: 'created'|null, comments?: number }\r\n */\r\nexport function renderDanmaku(logger = null) {\r\n    const g = getGlobal();\r\n    const comments = g?.danmakuData?.comments || [];\r\n    logger?.info?.('开始渲染弹幕', { 弹幕数量: comments.length });\r\n\r\n    const videoEl = document.querySelector('video');\r\n    if (!videoEl || !videoEl.parentElement) {\r\n        logger?.debug?.('视频元素未就绪');\r\n        return null;\r\n    }\r\n\r\n    const parent = videoEl.parentElement;\r\n    const cs = window.getComputedStyle(parent);\r\n    if (!/(relative|absolute|fixed|sticky)/.test(cs.position)) {\r\n        parent.style.position = 'relative';\r\n    }\r\n    const layerId = 'danmaku-layer';\r\n    const existing = document.getElementById(layerId);\r\n    if (existing) {\r\n        if (existing.parentElement !== parent) {\r\n            // 仅搬移，不销毁重建\r\n            try { parent.appendChild(existing); } catch (_) { }\r\n        }\r\n        // 若渲染器已存在，仅刷新尺寸\r\n        if (g.danmakuRenderer) {\r\n            try { g.danmakuRenderer.resize?.(); } catch (_) { }\r\n            return { status: 'exists', comments: comments.length };\r\n        }\r\n        // 没有渲染器但有图层：继续在现有层上创建实例\r\n    }\r\n\r\n    // 复用现有图层或新建\r\n    let layer = existing;\r\n    let innerWrapper = null;\r\n    if (!layer) {\r\n        layer = document.createElement('div');\r\n        layer.setAttribute('data-danmaku-layer', 'true');\r\n        layer.id = layerId;\r\n        layer.style.cssText = [\r\n            'position:absolute',\r\n            'left:0', 'top:0', 'right:0', 'bottom:0',\r\n            'width:100%', 'height:100%',\r\n            'pointer-events:none',\r\n            'overflow:hidden',\r\n        ].join(';');\r\n        try {\r\n            const opacitySetting = g?.danmakuSettings?.get('opacity');\r\n            const opacity = Math.min(1, Math.max(0, (opacitySetting ?? 70) / 100));\r\n            layer.style.opacity = String(opacity);\r\n        } catch (_) {\r\n            layer.style.opacity = '0.7';\r\n        }\r\n        try { parent.appendChild(layer); } catch (_) { }\r\n    }\r\n\r\n    // 确保内层 wrapper 存在并应用显示范围\r\n    innerWrapper = layer.querySelector('#danmaku-layer-inner');\r\n    const displayTop = (() => { try { return Number(g?.danmakuSettings?.get('display_top_pct')); } catch (_) { return 0; } })();\r\n    const displayBottom = (() => { try { return Number(g?.danmakuSettings?.get('display_bottom_pct')); } catch (_) { return 100; } })();\r\n    const topPct = isFinite(displayTop) ? Math.min(99, Math.max(0, displayTop)) : 0;\r\n    const bottomPct = isFinite(displayBottom) ? Math.min(100, Math.max(topPct + 1, displayBottom)) : 100;\r\n    if (!innerWrapper) {\r\n        innerWrapper = document.createElement('div');\r\n        innerWrapper.id = 'danmaku-layer-inner';\r\n        layer.appendChild(innerWrapper);\r\n    }\r\n    innerWrapper.style.cssText = [\r\n        'position:absolute',\r\n        `top:${topPct}%`,\r\n        `height:${bottomPct - topPct}%`,\r\n        'left:0', 'right:0',\r\n        'overflow:hidden',\r\n        'width:100%',\r\n        'pointer-events:none'\r\n    ].join(';');\r\n\r\n    // 仅在不存在实例时创建，避免反复销毁/重建\r\n    if (!g.danmakuRenderer) {\r\n        const danmakuInstance = g.danmakuRenderer = new Danmaku({\r\n        container: innerWrapper,\r\n        media: videoEl,\r\n        comments: comments,\r\n        speed: (() => {\r\n            try {\r\n                const v = g.danmakuSettings?.get('speed');\r\n                const num = Number(v);\r\n                if (!Number.isFinite(num)) return 144;\r\n                return Math.min(600, Math.max(24, num));\r\n            } catch (_) { return 144; }\r\n        })(),\r\n        });\r\n\r\n    // 应用“是否显示”的本地记忆\r\n    try {\r\n        const key = 'jf_danmaku_enabled';\r\n        if (typeof window !== 'undefined' && window.localStorage) {\r\n            const v = window.localStorage.getItem(key);\r\n            if (v === null) {\r\n                try { window.localStorage.setItem(key, '1'); } catch (_) { }\r\n                try { danmakuInstance.show?.(); } catch (_) { }\r\n                logger?.info?.('弹幕记忆缺失: 默认开启并写入');\r\n            } else if (v === '0') {\r\n                try { danmakuInstance.hide?.(); } catch (_) { }\r\n                logger?.info?.('读取记忆: 弹幕初始隐藏');\r\n            } else if (v === '1') {\r\n                try { danmakuInstance.show?.(); } catch (_) { }\r\n                logger?.info?.('读取记忆: 弹幕初始显示');\r\n            }\r\n        }\r\n    } catch (_) { }\r\n\r\n    // 尺寸自适应\r\n    if (typeof ResizeObserver !== 'undefined') {\r\n        const resizeDebounceDelay = 50;\r\n        let resizeTimer = null;\r\n        const ro = new ResizeObserver(() => {\r\n            if (!g.danmakuRenderer) return;\r\n            if (resizeTimer) clearTimeout(resizeTimer);\r\n            resizeTimer = setTimeout(() => {\r\n                try { g.danmakuRenderer.resize(); } catch (_) { }\r\n            }, resizeDebounceDelay);\r\n        });\r\n        try { ro.observe(parent); } catch (_) { }\r\n        // 存到全局，便于 index.js 主流程在销毁时断开\r\n        g.__danmakuResizeObserver = ro;\r\n        g.__danmakuResizeTimerCancel = () => { if (resizeTimer) { try { clearTimeout(resizeTimer); } catch (_) { } resizeTimer = null; } };\r\n    } else {\r\n        const handleWindowResize = () => { try { g.danmakuRenderer?.resize?.(); } catch (_) { } };\r\n        window.addEventListener('resize', handleWindowResize);\r\n        g.__danmakuWindowResizeHandler = handleWindowResize;\r\n    }\r\n\r\n        logger?.info?.('弹幕渲染器创建完成');\r\n        return { status: 'created', comments: comments.length };\r\n    }\r\n    // 已有实例场景\r\n    return { status: 'exists', comments: comments.length };\r\n}\r\n\r\n// 提供少量辅助清理（可选使用）——非必须接口\r\nexport function cleanupAll(logger = null) {\r\n    const g = getGlobal();\r\n    try { g.danmakuButtonsGroup?.destroy?.(); } catch (_) { }\r\n    g.danmakuButtonsGroup = null;\r\n\r\n    try { g.danmakuRenderer?.destroy?.(); } catch (_) { }\r\n    g.danmakuRenderer = null;\r\n    try {\r\n        const layer = document.getElementById('danmaku-layer');\r\n        if (layer?.parentElement) layer.parentElement.removeChild(layer);\r\n    } catch (_) { }\r\n\r\n    try { g.heatmapRenderer?.destroy?.(); } catch (_) { }\r\n    g.heatmapRenderer = null;\r\n    try {\r\n        const canvas = document.getElementById('danmaku-heatmap-canvas');\r\n        if (canvas?.parentElement) canvas.parentElement.removeChild(canvas);\r\n    } catch (_) { }\r\n\r\n    try { g.__danmakuResizeObserver?.disconnect?.(); } catch (_) { }\r\n    g.__danmakuResizeObserver = null;\r\n    try { g.__danmakuResizeTimerCancel?.(); } catch (_) { }\r\n    g.__danmakuResizeTimerCancel = null;\r\n    try {\r\n        if (g.__danmakuWindowResizeHandler) {\r\n            window.removeEventListener('resize', g.__danmakuWindowResizeHandler);\r\n        }\r\n    } catch (_) { }\r\n    g.__danmakuWindowResizeHandler = null;\r\n    logger?.info?.('已清理弹幕相关 UI/实例');\r\n}\r\n","/**\r\n * Logger - 轻量日志器\r\n * 用于在调试模式下输出日志；非调试模式静默。\r\n */\r\nexport default class Logger {\r\n  constructor({ debug = false, prefix = 'Danmaku', maxLines = 100 } = {}) {\r\n    this._debug = !!debug;\r\n    this._prefix = prefix;\r\n    this._maxLines = maxLines;\r\n    this._overlay = null; // DOM 节点\r\n  this._overlayWrap = null; // 外层包裹，用于正确显示/隐藏\r\n    this._buffer = []; // 在 overlay 未就绪前暂存的日志\r\n    this._lastOverlayTsMs = 0; // 上一条覆盖层日志的时间戳\r\n    this._altFlip = false; // 覆盖层行配色交替开关\r\n    if (this._debug) this._ensureOverlay();\r\n  }\r\n\r\n  setDebug(v) {\r\n    const next = !!v;\r\n    if (this._debug === next) return;\r\n    this._debug = next;\r\n    if (this._debug) {\r\n      this._ensureOverlay();\r\n      this.info('调试:开启');\r\n    } else {\r\n      this.info('调试:关闭');\r\n      this._hideOverlay();\r\n    }\r\n  }\r\n  getDebug() { return this._debug; }\r\n  setPrefix(p) { this._prefix = String(p || ''); }\r\n\r\n  _fmt(args) {\r\n    try {\r\n      return [`[${this._prefix}]`, ...args];\r\n    } catch (_) {\r\n      return args;\r\n    }\r\n  }\r\n\r\n  _stringify(arg) {\r\n    const t = typeof arg;\r\n    if (arg == null || t === 'number' || t === 'boolean' || t === 'bigint' || t === 'symbol') {\r\n      return String(arg);\r\n    }\r\n    if (t === 'string') return arg;\r\n    try {\r\n      return JSON.stringify(arg);\r\n    } catch (_) {\r\n      try { return String(arg); } catch (_) { return '[Unserializable]'; }\r\n    }\r\n  }\r\n\r\n  _appendToOverlay(level, args) {\r\n    if (!this._debug) return;\r\n    this._ensureOverlay();\r\n    if (!this._overlay) return;\r\n    const now = new Date();\r\n    const nowMs = now.getTime();\r\n    const pad2 = (n) => String(n).padStart(2, '0');\r\n    const ts = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;\r\n    const delta = this._lastOverlayTsMs ? (nowMs - this._lastOverlayTsMs) : 0;\r\n    this._lastOverlayTsMs = nowMs;\r\n    // 覆盖层：不显示前缀，显示时间(无毫秒) + 与上一条的间隔毫秒\r\n    const line = `${ts}(${delta}ms) ${level.toUpperCase()} ${args.map(a => this._stringify(a)).join(' ')}`;\r\n\r\n    // 如果 overlay 还未挂载，缓冲\r\n    if (!this._overlay._ready) {\r\n      this._buffer.push(line);\r\n      return;\r\n    }\r\n\r\n    const pre = document.createElement('div');\r\n    pre.textContent = line;\r\n    pre.style.whiteSpace = 'pre-wrap';\r\n    pre.style.wordBreak = 'break-word';\r\n    if (level === 'warn') {\r\n      pre.style.color = '#ffda6b';\r\n    } else if (level === 'error') {\r\n      pre.style.color = '#ff6b6b';\r\n    } else {\r\n      // 普通级别交替颜色，提升可读性\r\n      this._altFlip = !this._altFlip;\r\n      pre.style.color = this._altFlip ? '#dbffb9ff' : '#9ec7f0ff';\r\n    }\r\n    this._overlay.appendChild(pre);\r\n\r\n    // 截断到最大行数\r\n    while (this._overlay.childNodes.length > this._maxLines) {\r\n      this._overlay.removeChild(this._overlay.firstChild);\r\n    }\r\n    this._overlay.scrollTop = this._overlay.scrollHeight;\r\n  }\r\n\r\n  _ensureOverlay() {\r\n    if (this._overlay) {\r\n      // 仅重新显示外层容器\r\n      try {\r\n        (this._overlayWrap || this._overlay.parentElement)?.style && ((this._overlayWrap || this._overlay.parentElement).style.display = 'block');\r\n      } catch (_) { }\r\n      return;\r\n    }\r\n    const mount = () => {\r\n      if (this._overlay) return;\r\n      const wrap = document.createElement('div');\r\n      wrap.setAttribute('data-danmaku-debug', 'overlay');\r\n      wrap.style.position = 'fixed';\r\n      wrap.style.top = '8px';\r\n      wrap.style.right = '8px';\r\n      wrap.style.width = '320px';\r\n      wrap.style.height = '180px';\r\n      // 允许拖动底部调整高度（浏览器原生）\r\n      wrap.style.resize = 'vertical';\r\n      wrap.style.minHeight = '14px';\r\n      wrap.style.maxHeight = '90vh';\r\n      wrap.style.padding = '6px 8px';\r\n      wrap.style.background = 'rgba(0,0,0,0.7)';\r\n      wrap.style.border = '1px solid rgba(255,255,255,0.2)';\r\n      wrap.style.borderRadius = '6px';\r\n      wrap.style.color = '#9ef09e';\r\n      wrap.style.fontFamily = 'ui-monospace, SFMono-Regular, Menlo, Consolas, Monospace';\r\n      wrap.style.fontSize = '12px';\r\n      wrap.style.lineHeight = '1.25';\r\n      wrap.style.zIndex = '2147483647';\r\n      wrap.style.overflow = 'auto';\r\n      wrap.style.pointerEvents = 'auto';\r\n      wrap.style.userSelect = 'text';\r\n      wrap.style.boxShadow = '0 2px 12px rgba(0,0,0,0.4)';\r\n\r\n      // 标题栏（拖拽和清理可以后续再做，这里仅标题）\r\n      const title = document.createElement('div');\r\n      title.textContent = 'Danmaku Debug Logs';\r\n      title.style.fontWeight = '600';\r\n      title.style.marginBottom = '4px';\r\n      title.style.color = '#d1ffe2';\r\n      title.style.cursor = 'pointer';\r\n      title.title = '点击收起/展开';\r\n      wrap.appendChild(title);\r\n\r\n      // 内容容器\r\n      const content = document.createElement('div');\r\n      content.style.height = 'calc(100% - 20px)';\r\n      content.style.overflow = 'auto';\r\n      wrap.appendChild(content);\r\n\r\n      // 折叠/展开逻辑（点击标题切换）\r\n      let __collapsed = false;\r\n      let __prevHeight = '';\r\n      let __prevResize = '';\r\n      let __prevMinHeight = '';\r\n      const setCollapsed = (next) => {\r\n        __collapsed = !!next;\r\n        if (__collapsed) {\r\n          __prevHeight = wrap.style.height;\r\n          __prevResize = wrap.style.resize;\r\n          __prevMinHeight = wrap.style.minHeight;\r\n          content.style.display = 'none';\r\n          try {\r\n            wrap.style.resize = 'none';\r\n            wrap.style.minHeight = '14px';\r\n            wrap.style.height = '14px';\r\n          } catch (_) { }\r\n        } else {\r\n          content.style.display = 'block';\r\n          try {\r\n            wrap.style.resize = __prevResize || 'vertical';\r\n            wrap.style.minHeight = __prevMinHeight || '200px';\r\n            wrap.style.height = __prevHeight || '640px';\r\n          } catch (_) { }\r\n        }\r\n      };\r\n      try { title.addEventListener('click', () => setCollapsed(!__collapsed)); } catch (_) { }\r\n\r\n      // 将内容容器作为 overlay 主体\r\n  this._overlay = content;\r\n  this._overlayWrap = wrap;\r\n      this._overlay._ready = true;\r\n      document.body ? document.body.appendChild(wrap) : document.documentElement.appendChild(wrap);\r\n\r\n      // 刷新缓冲\r\n      if (this._buffer.length) {\r\n        for (const line of this._buffer) {\r\n          const div = document.createElement('div');\r\n          div.textContent = line;\r\n          this._overlay.appendChild(div);\r\n        }\r\n        this._buffer.length = 0;\r\n        this._overlay.scrollTop = this._overlay.scrollHeight;\r\n      }\r\n    };\r\n\r\n    if (document.readyState === 'loading') {\r\n      document.addEventListener('DOMContentLoaded', () => mount(), { once: true });\r\n    } else {\r\n      mount();\r\n    }\r\n  }\r\n\r\n  _hideOverlay() {\r\n  const container = this._overlayWrap || this._overlay?.parentElement;\r\n  if (container) container.style.display = 'none';\r\n  }\r\n\r\n  clear() {\r\n    if (this._overlay) this._overlay.innerHTML = '';\r\n    this._buffer.length = 0;\r\n    this._altFlip = false;\r\n  }\r\n\r\n  log(...args) {\r\n  this._appendToOverlay('log', args);\r\n  }\r\n  info(...args) {\r\n  this._appendToOverlay('info', args);\r\n  }\r\n  warn(...args) {\r\n  this._appendToOverlay('warn', args);\r\n  }\r\n  error(...args) {\r\n  this._appendToOverlay('error', args);\r\n  }\r\n}\r\n","/*\r\n * Jellyfin Web Player State Detector\r\n * - 判定条件：DOM 中是否存在 <video class=\"htmlvideoplayer\">\r\n * - 策略：低频轮询 + DOM 变动监听（MutationObserver）\r\n * - 判断是否为视频页并在激活时创建按钮组/热力图/弹幕\r\n */\r\nimport { attachButtonsGroup, generateHeatmap, renderDanmaku, cleanupAll } from './danmakuActions';\r\nimport { updateDanmakuSettings, fetchDanmakuData } from './api/fetch';\r\nimport { createAndMountDanmakuSettings } from './api/settings';\r\nimport Logger from './log';\r\n\r\n(function () {\r\n    'use strict';\r\n\r\n    const NS = '__jfDanmakuGlobal__';\r\n    if (typeof window !== 'undefined') {\r\n        const existing = window[NS];\r\n        if (existing && existing.__webPlayerStateInstalled) {\r\n            return; // 已安装\r\n        }\r\n    }\r\n\r\n    const POLL_INTERVAL_MS = 3000; // 低频轮询，3s 一次\r\n    const MUTATION_DEBOUNCE_MS = 120; // DOM 变动去抖\r\n\r\n    const state = {\r\n        isActive: null, // null=未知，true/false=已判定\r\n        pollTimer: null,\r\n        observer: null,\r\n        mediaItemId: null, // 从 PlaybackInfo 抓到的媒体 ID\r\n    };\r\n\r\n    // 日志器（默认关闭调试，优先读取本地存储的开关）\r\n    let __initialDebug = false;\r\n    try {\r\n        // 仅当运行在浏览器环境且可访问 localStorage 时读取\r\n        const v = (typeof window !== 'undefined' && window.localStorage)\r\n            ? window.localStorage.getItem('danmaku_debug_enabled')\r\n            : null;\r\n        if (v === '1') __initialDebug = true;\r\n        else if (v === '0') __initialDebug = false;\r\n        // 其它/缺失情况保持默认 false\r\n    } catch (_) { /* ignore storage access issues */ }\r\n    const logger = new Logger({ debug: __initialDebug, prefix: 'JF-Danmaku' });\r\n\r\n    // 记录是否已在当前会话中创建过 UI（进入时创建，退出时销毁）\r\n    let uiActive = false;\r\n\r\n    // 辅助：判断元素是否可见\r\n    function isVisible(el) {\r\n        if (!el) return false;\r\n        if (el.offsetParent !== null) return true;\r\n        try {\r\n            const cs = window.getComputedStyle(el);\r\n            return cs && cs.display !== 'none' && cs.visibility !== 'hidden' && cs.opacity !== '0';\r\n        } catch (_) { return false; }\r\n    }\r\n\r\n    // 获取当前活跃的 OSD 根（优先包含当前 video 的且可见的 data-type=video-osd 容器）\r\n    function getActiveOsdRoot() {\r\n        const video = document.querySelector('video.htmlvideoplayer');\r\n        const roots = Array.from(document.querySelectorAll(\"div[data-type='video-osd']\"));\r\n        const visibleRoots = roots.filter(isVisible);\r\n        if (video) {\r\n            const owner = visibleRoots.find(r => r.contains(video));\r\n            if (owner) return owner;\r\n        }\r\n        return visibleRoots[0] || roots[0] || null;\r\n    }\r\n\r\n    function activateUI() {\r\n        if (uiActive) return;\r\n        const g = (typeof window !== 'undefined') ? (window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {}) : {};\r\n\r\n        // 根据媒体ID按需加载设置与数据（与按钮插入解耦）\r\n        const maybeLoadForMedia = (id) => {\r\n            if (!id) return;\r\n            try {\r\n                if (!g.__lastSettingsLoadedForId) g.__lastSettingsLoadedForId = null;\r\n                if (g.__lastSettingsLoadedForId === id) return;\r\n                if (!g.danmakuSettings) {\r\n                    createAndMountDanmakuSettings({});\r\n                    logger.debug && logger.debug('已初始化默认弹幕设置');\r\n                }\r\n                g.__lastSettingsLoadedForId = id; // 先占位，避免短时间重复触发\r\n                Promise.resolve(fetchDanmakuData(logger, id)).then(() => {\r\n                    // 数据到位后，尽力补齐渲染（容器未就绪时各自函数会自处理）\r\n                    try { generateHeatmap(logger); } catch (_) { }\r\n                    try { renderDanmaku(logger); } catch (_) { }\r\n                }).catch((e) => {\r\n                    logger.warn && logger.warn('updateDanmakuSettings 失败', e);\r\n                    // 失败时回滚标记以便后续重试\r\n                    try { if (g.__lastSettingsLoadedForId === id) g.__lastSettingsLoadedForId = null; } catch (_) {}\r\n                });\r\n            } catch (e) { /* ignore */ }\r\n        };\r\n\r\n        // 去重：清理多余的按钮/热力图\r\n        const cleanupDuplicates = () => {\r\n            try {\r\n                const root = getActiveOsdRoot();\r\n                if (root) {\r\n                    const buttons = Array.from(root.querySelectorAll('[data-danmaku-buttons]'));\r\n                    if (buttons.length > 1) {\r\n                        buttons.slice(1).forEach(n => { try { n.remove(); } catch (_) {} });\r\n                        logger.info(`清理冗余按钮组: ${buttons.length - 1}`);\r\n                    }\r\n                }\r\n            } catch (_) {}\r\n            try {\r\n                const root = getActiveOsdRoot();\r\n                if (root) {\r\n                    const canvases = Array.from(root.querySelectorAll('#danmaku-heatmap-canvas'));\r\n                    if (canvases.length > 1) {\r\n                        canvases.slice(1).forEach(n => { try { n.remove(); } catch (_) {} });\r\n                        logger.info(`清理冗余热力图: ${canvases.length - 1}`);\r\n                    }\r\n                }\r\n            } catch (_) {}\r\n        };\r\n\r\n        // 单次初始化尝试\r\n        const isButtonsReady = () => {\r\n            const root = getActiveOsdRoot();\r\n            return !!(root && root.querySelector('[data-danmaku-buttons]'));\r\n        };\r\n        const isHeatmapReady = () => {\r\n            const root = getActiveOsdRoot();\r\n            return !!(root && root.querySelector('#danmaku-heatmap-canvas'));\r\n        };\r\n        const isDanmakuReady = () => {\r\n            const video = document.querySelector('video.htmlvideoplayer');\r\n            const layer = document.getElementById('danmaku-layer');\r\n            return !!(video && layer && layer.parentElement === video.parentElement);\r\n        };\r\n        const allReady = () => isButtonsReady() && isHeatmapReady() && isDanmakuReady();\r\n\r\n        const tryInitOnce = () => {\r\n            const video = document.querySelector('video.htmlvideoplayer');\r\n            if (!video) return false;\r\n            cleanupDuplicates();\r\n\r\n            // 仅在未就绪时尝试插入/生成，避免频繁 resize / 重建\r\n            let btnRes = { status: 'skipped' };\r\n            if (!isButtonsReady()) {\r\n                btnRes = attachButtonsGroup(logger);\r\n            }\r\n            if (!isHeatmapReady()) {\r\n                generateHeatmap(logger);\r\n            }\r\n            if (!isDanmakuReady()) {\r\n                renderDanmaku(logger);\r\n            }\r\n\r\n            // 以“至少按钮插入成功”作为激活条件；所有组件就绪交给持久监听继续完成\r\n            return btnRes && btnRes.status !== 'no-container';\r\n        };\r\n\r\n        // 尝试一次；若未完成则开启短期观察+防抖重试\r\n        let done = false;\r\n        try { done = tryInitOnce(); } catch (e) { logger.warn && logger.warn('初始化尝试异常', e); }\r\n\r\n    const finishAndLoadData = () => {\r\n            if (uiActive) return;\r\n            uiActive = true;\r\n            logger.info('弹幕 UI 已激活');\r\n            // 准备设置与数据\r\n            try {\r\n        const itemId = (typeof g.getMediaId === 'function') ? g.getMediaId() : state.mediaItemId;\r\n        if (itemId) maybeLoadForMedia(itemId);\r\n        else logger.warn && logger.warn('未能获取媒体ID，等待 XHR 嗅探再加载');\r\n            } catch (e) {\r\n                logger.warn && logger.warn('激活后加载全局数据失败', e);\r\n            }\r\n        };\r\n\r\n        // 短期 -> 持久化观察器：等待关键锚点出现后再次尝试（直到全部就绪）\r\n        const debounce = (fn, delay) => {\r\n            let t = null; return (...args) => { if (t) clearTimeout(t); t = setTimeout(() => fn(...args), delay); };\r\n        };\r\n        const debouncedTry = debounce(() => {\r\n            try {\r\n                const res = tryInitOnce();\r\n                if (!done && res) {\r\n                    done = true;\r\n                    finishAndLoadData();\r\n                }\r\n                // 保持监听至整个活跃期结束（deactivateUI 中统一清理），以便 OSD DOM 重建时自愈\r\n            } catch (_) { /* ignore */ }\r\n        }, 150);\r\n\r\n        // 安装持久化监听与增强触发\r\n        const setupPersistentWatchers = () => {\r\n            // 1) MutationObserver：childList + attributes(style/class)，直到 allReady()\r\n            try {\r\n                const obs = new MutationObserver(() => {\r\n                    try { if (allReady()) return; } catch (_) {}\r\n                    debouncedTry();\r\n                });\r\n                obs.observe(document.body, {\r\n                    childList: true,\r\n                    subtree: true,\r\n                    attributes: true,\r\n                    attributeFilter: ['class', 'style']\r\n                });\r\n                g.__uiInitObserver = obs;\r\n            } catch (e) {\r\n                logger.warn && logger.warn('附加持久观察失败', e);\r\n            }\r\n\r\n            // 2) 周期轮询：每 1s 尝试一次，直至 allReady()\r\n            try {\r\n                g.__uiInitInterval = setInterval(() => {\r\n                    if (allReady()) {\r\n                        try { clearInterval(g.__uiInitInterval); } catch (_) {}\r\n                        g.__uiInitInterval = null;\r\n                        return;\r\n                    }\r\n                    debouncedTry();\r\n                }, 1000);\r\n            } catch (_) { }\r\n\r\n            // 3) 一次性 mousemove：控制条显隐常依赖鼠标，首次移动强制重试\r\n            try {\r\n                const onMove = () => { debouncedTry(); try { document.removeEventListener('mousemove', onMove); } catch (_) {} g.__uiInitMouseMove = null; };\r\n                document.addEventListener('mousemove', onMove, { once: true });\r\n                g.__uiInitMouseMove = onMove;\r\n            } catch (_) { }\r\n        };\r\n\r\n        const teardownPersistentWatchers = () => {\r\n            try { g.__uiInitObserver?.disconnect?.(); } catch (_) {}\r\n            g.__uiInitObserver = null;\r\n            try { if (g.__uiInitInterval) clearInterval(g.__uiInitInterval); } catch (_) {}\r\n            g.__uiInitInterval = null;\r\n            try { if (g.__uiInitMouseMove) document.removeEventListener('mousemove', g.__uiInitMouseMove); } catch (_) {}\r\n            g.__uiInitMouseMove = null;\r\n        };\r\n\r\n        // 若首次已达成“激活”条件，立即加载数据，但仍继续观察直至所有组件到位\r\n        if (done) {\r\n            finishAndLoadData();\r\n        }\r\n        // 即便未完成，也尝试基于当前已知媒体ID加载数据\r\n        try { const idNow = state.mediaItemId; if (idNow) maybeLoadForMedia(idNow); } catch (_) { }\r\n        setupPersistentWatchers();\r\n    }\r\n\r\n    function deactivateUI() {\r\n        if (!uiActive) return;\r\n        try { cleanupAll(logger); } catch (_) { }\r\n        uiActive = false;\r\n        logger.info('弹幕 UI 已销毁');\r\n        // 清理持久化初始化监听\r\n        try {\r\n            const g = window.__jfDanmakuGlobal__ || {};\r\n            try { g.__uiInitObserver?.disconnect?.(); } catch (_) {}\r\n            g.__uiInitObserver = null;\r\n            try { if (g.__uiInitInterval) clearInterval(g.__uiInitInterval); } catch (_) {}\r\n            g.__uiInitInterval = null;\r\n            try { if (g.__uiInitMouseMove) document.removeEventListener('mousemove', g.__uiInitMouseMove); } catch (_) {}\r\n            g.__uiInitMouseMove = null;\r\n        } catch (_) { }\r\n    }\r\n\r\n    // 拦截 XHR，监听 PlaybackInfo 响应以提取媒体 Id，并在ID变化时重建扩展实例\r\n    function installXHRSniffer() {\r\n        try {\r\n            const proto = XMLHttpRequest?.prototype;\r\n            if (!proto) return;\r\n            if (proto.open && proto.open.__jfPlaybackPatched) return;\r\n\r\n            const originalOpen = proto.open;\r\n            proto.open = function (method, url, ...rest) {\r\n                this.addEventListener('load', () => {\r\n                    const u = String(url || '');\r\n                    if (!u.endsWith('PlaybackInfo')) return;\r\n                    try {\r\n                        const res = JSON.parse(this.responseText);\r\n                        const id = res?.MediaSources?.[0]?.Id;\r\n                        if (!id) return;\r\n                        const prevId = state.mediaItemId;\r\n                        state.mediaItemId = id;\r\n                        if (prevId !== id) logger.info('PlaybackInfo 媒体ID', id);\r\n                        // 捕获到媒体ID后优先尝试加载数据（不依赖 UI 激活完成）\r\n                        try {\r\n                            const g = window.__jfDanmakuGlobal__ = window.__jfDanmakuGlobal__ || {};\r\n                            if (!g.__maybeLoadForMedia) {\r\n                                // 复用 activateUI 中的实现：简版保险（避免引用闭包）\r\n                                g.__maybeLoadForMedia = (mid, loggerRef) => {\r\n                                    if (!mid) return;\r\n                                    try {\r\n                                        if (!g.__lastSettingsLoadedForId) g.__lastSettingsLoadedForId = null;\r\n                                        if (g.__lastSettingsLoadedForId === mid) return;\r\n                                        if (!g.danmakuSettings) { try { createAndMountDanmakuSettings({}); } catch (_) {} }\r\n                                        g.__lastSettingsLoadedForId = mid;\r\n                                        Promise.resolve(fetchDanmakuData(loggerRef || logger, mid)).then(() => {\r\n                                            try { generateHeatmap(loggerRef || logger); } catch (_) {}\r\n                                            try { renderDanmaku(loggerRef || logger); } catch (_) {}\r\n                                        }).catch(() => { try { if (g.__lastSettingsLoadedForId === mid) g.__lastSettingsLoadedForId = null; } catch (_) {} });\r\n                                    } catch (_) { }\r\n                                };\r\n                            }\r\n                            g.__maybeLoadForMedia(id, logger);\r\n                        } catch (_) { }\r\n                        // 媒体 ID 变化时，做一次轻量的 UI 重建（清理后再激活）\r\n                        if (uiActive) { deactivateUI(); activateUI(); }\r\n                    } catch (_) { /* ignore parse errors */ }\r\n                }, { once: true });\r\n                return originalOpen.apply(this, [method, url, ...rest]);\r\n            };\r\n            proto.open.__jfPlaybackPatched = true;\r\n            logger.info('已安装 XMLHttpRequest 嗅探');\r\n        } catch (err) {\r\n            logger.warn && logger.warn('安装 XHR 嗅探失败', err);\r\n        }\r\n    }\r\n\r\n    function ensureExt(active) {\r\n        if (active) activateUI(); else deactivateUI();\r\n    }\r\n\r\n    function isInWebPlayer() {\r\n    // 需要同时存在视频元素与OSD容器，避免路由过渡时误判\r\n    const videoEl = document.querySelector('video.htmlvideoplayer');\r\n    const osdEl = document.querySelector(\"div[data-type='video-osd']\");\r\n    return !!(videoEl && osdEl);\r\n    }\r\n\r\n    function handleStateChange(newState) {\r\n        if (state.isActive === newState) return;\r\n        state.isActive = newState;\r\n        // 控制扩展实例的存活\r\n        ensureExt(newState);\r\n        logger.info('状态变更', { 是否激活: newState });\r\n    }\r\n\r\n    function runCheck() {\r\n        const active = isInWebPlayer();\r\n        handleStateChange(active);\r\n    }\r\n\r\n    // DOM 变动去抖\r\n    function debounce(fn, delay) {\r\n        let timer = null;\r\n        function wrapped(...args) {\r\n            if (timer) clearTimeout(timer);\r\n            timer = setTimeout(() => {\r\n                timer = null;\r\n                try { fn.apply(this, args); } catch (_) { /* no-op */ }\r\n            }, delay);\r\n        }\r\n        wrapped.cancel = () => { if (timer) { clearTimeout(timer); timer = null; } };\r\n        return wrapped;\r\n    }\r\n    const debouncedRunCheck = debounce(runCheck, MUTATION_DEBOUNCE_MS);\r\n\r\n    function start() {\r\n        // 安装 XHR 嗅探\r\n        installXHRSniffer();\r\n        // 低频轮询\r\n        state.pollTimer = setInterval(runCheck, POLL_INTERVAL_MS);\r\n        logger.info('轮询已启动');\r\n\r\n        // DOM 变动监听\r\n        if ('MutationObserver' in window) {\r\n            state.observer = new MutationObserver(() => {\r\n                debouncedRunCheck();\r\n            });\r\n            const target = document.documentElement || document.body;\r\n            if (target) {\r\n                state.observer.observe(target, {\r\n                    childList: true,\r\n                    subtree: true,\r\n                    attributes: true,\r\n                    attributeFilter: ['class', 'style'],\r\n                });\r\n                logger.info('DOM 变动监听已附加');\r\n            }\r\n        }\r\n\r\n        // 立即做一次初判\r\n        runCheck();\r\n    }\r\n\r\n    function ready(fn) {\r\n        if (document.readyState === 'loading') {\r\n            document.addEventListener('DOMContentLoaded', fn, { once: true });\r\n        } else {\r\n            fn();\r\n        }\r\n    }\r\n\r\n    // 暴露少量调试 API\r\n    if (typeof window !== 'undefined') {\r\n        const g = window[NS] = window[NS] || {};\r\n        Object.assign(g, {\r\n            start,\r\n            isInWebPlayer,\r\n            getState: () => state.isActive,\r\n            getExt: () => ({ uiActive }),\r\n            getMediaId: () => state.mediaItemId,\r\n            spawnExt: () => { try { deactivateUI(); } catch (_) {}; try { activateUI(); } catch (_) {} },\r\n            setDebug: (v) => logger.setDebug(v),\r\n            getDebug: () => logger.getDebug(),\r\n            getLogger: () => logger,\r\n            __webPlayerStateInstalled: true\r\n        });\r\n    }\r\n\r\n    // 自启动\r\n    ready(start);\r\n})();\r\n\r\n"],"names":["GLOBAL_NS","DanmakuSettings","constructor","raw","this","_schema","Object","freeze","chConvert","def","type","withRelated","enable_heatmap","font_size","font_family","opacity","speed","display_top_pct","display_bottom_pct","enable_combine","threshold_seconds","max_distance","max_cosine","use_pinyin","cross_mode","trim_ending","trim_space","trim_width","heatmap_style","mark_style","mark_threshold","mode_elevation","enlarge","scroll_threshold","shrink_threshold","drop_threshold","max_chunk_size","force_list","white_list","black_list","black_source_list","_values","key","keys","schema","rawVal","prototype","hasOwnProperty","call","_normalize","_unknown","filter","k","value","isNaN","n","Number","String","_","toJSON","out","get","set","patch","obj","v","entries","asBool","mountGlobal","window","danmakuSettings","resetToDefaults","getDefaultObject","tmp","createAndMountDanmakuSettings","g","async","updateDanmakuSettings","logger","item_id","danmaku_id","gSettings","__jfDanmakuGlobal__","warn","info","settingsObj","formParams","URLSearchParams","append","queryParts","push","encodeURIComponent","query","length","join","url","ApiClient","getUrl","result","ajax","data","toString","contentType","dataType","comments","undefined","settings","e","danmakuData","danmakuRenderer","replaceComments","preserveState","re","heatmap_data","heatmapValues","values","heatmapRenderer","recalculate","video","document","querySelector","duration","he","err","fetchDanmakuData","Array","isArray","_saveTimer","_pendingPromise","_pendingResolve","_pendingReject","_lastLogger","_clearPendingTimer","clearTimeout","_resetPendingState","saveIfAutoOn","danmakuAutoSave","delay","Promise","resolve","reject","setTimeout","currentLogger","mediaId","getMediaId","ret","then","val","catch","BasicSettingsPage","opts","getKey","getLabel","_createFontSizeRow","current","row","createElement","className","setAttribute","labelLine","labelSpan","textContent","appendChild","sliderWrap","style","display","alignItems","gap","range","min","max","step","flex","numberInput","width","applyValue","src","nv","parseInt","liveSettings","addEventListener","desc","_createOpacityRow","layer","Math","_createSpeedRow","_createFontFamilyRow","getElementById","styleEl","id","head","combo","input","genericPlaceholder","placeholder","list","allFonts","filtered","activeIndex","labelFor","f","indexOf","last","split","pop","decoded","decodeURIComponent","openList","closeList","renderList","innerHTML","forEach","idx","it","dataset","preventDefault","selectFont","activeElement","children","scrollIntoView","block","setFilter","kw","q","toLowerCase","includes","concat","x","blur","populateFonts","fontList","gset","Set","add","from","sort","a","b","localeCompare","unshift","availableFontFamilies","fonts","fams","navigator","meta","family","detectViaLocalFontAccess","serverFonts","res","map","Boolean","detectViaServerFonts","merged","canvasFonts","baseFonts","span","position","left","fontSize","body","baseMetrics","bf","fontFamily","w","offsetWidth","h","offsetHeight","available","font","detected","removeChild","detectViaCanvas","applyFam","famName","targetFam","container","loader","ensureRemoteFontLoaded","fam","contains","target","_createHeatmapModeRow","group","marginTop","hide","c","shown","show","canvas","getExt","_generateHeatmap","label","opt","btn","padding","lineHeight","borderRadius","border","background","color","cursor","transition","setActiveState","currentVal","borderColor","boxShadow","querySelectorAll","_createDisplayRangeRow","topInit","bottomInit","topVal","isFinite","round","bottomVal","wrapper","height","userSelect","track","right","top","transform","activeRange","updateActiveRange","handleStyle","el","handleTop","handleBottom","positionHandles","applyToSettings","inner","parentElement","clamp","dragging","onPointerDown","which","onPointerMove","onPointerUp","rect","getBoundingClientRect","pct","clientX","selfRef","removeEventListener","abs","tabIndex","_createChConvertRow","build","panel","CombinedSettingsPage","_ensureCombineUpdate","p","_updateCombineStats","_combineStatsEl","original","original_total","count","raw_total","original_comments","comments_before_merge","_pakkuTimeEl","rawTime","pakku_time","displayTime","_removed_countStatsEl","rawremoved_count","removed_count","num","_pinyinStatsEl","merge_counts","pinyin","debug","_editDistanceStatsEl","edit_distance","_vectorStatsEl","vector","_createCombineTimeRow","flexDirection","justifyContent","textAlign","fontWeight","_createMarkStyleRow","title","select","setProperty","appearance","webkitAppearance","mozAppearance","options","o","selected","focus","_createMarkThresholdRow","slider","accentColor","valSpan","minWidth","whiteSpace","overflow","textOverflow","sliderLine","maxWidth","_createUsePinyinRow","outline","knob","leftWrap","marginBottom","stats","_createEnlargeRow","_createEditDistanceRow","_createVectorRow","_createCrossModeRow","_createNormalizeRow","ending","space","_createThresholdSecondsRow","_createMaxChunkSizeRow","_createEnableCombineRow","letterSpacing","gridTemplateColumns","columnGap","rowGap","gridColumn","FilterSettingsPage","_sectionUpdaters","_commit","trigger","toStore","JSON","stringify","fn","_createSection","header","countBadge","toggleIcon","marginLeft","borderTop","listWrap","dataRaw","s","trimmed","trim","parsed","parse","expanded","updateHitBadge","rc","rule_counts","rcKey","hit","n2","rebuild","makeAddRow","addBtn","pattern","replace","isRegex","item","line","regexToggle","patternInput","replaceInput","delBtn","splice","footerNote","CommentPoolPage","_balls","_raf","_lastT","_boxEl","_panel","_resizeOb","_activeMo","_trashZoneEl","_readStats","source_stats","name","_readInitialBlacklist","arr","_createBox","box","touchAction","_makeBallEl","parts","countText","initial","boxSizing","willChange","bg","inset","pointerEvents","textShadow","zIndex","fg","_bgWatermark","_colorForIndex","i","palette","_initBalls","W","H","r","bgFS","random","y","tries","temp","overlap","dx","dy","hypot","mass","_driftAng","PI","_driftMag","ball","vx","vy","_px","_py","_pt","_driftFx","_driftFy","_driftTargetFx","cos","_driftTargetFy","sin","_driftNext","performance","now","_attachDrag","onDown","button","setPointerCapture","pointerId","inTrash","_ghostEl","_createGhostEl","visibility","clientY","_toLocal","_offsetX","_offsetY","stopPropagation","stopImmediatePropagation","onMove","nx","ny","_isPointInBox","_removeGhostEl","dt","rct","over","bottom","_overTrash","outlineColor","onUp","wasDragging","releasePointerCapture","overTrash","_isPointInTrash","slack","pointerType","overBox","nearBox","_isPointNearBox","_prevPosStyle","_prevLeft","_prevTop","_prevTransform","_moveBallToTrash","_moveBallBackToBox","onCancel","onEnter","hoverPause","_preHoverVx","_preHoverVy","onLeave","onCtx","_showBallMenu","passive","capture","_onDown","_onMove","_onUp","_onCancel","_onEnter","_onLeave","_onCtx","_closeMenu","menu","backdropFilter","mkItem","handler","danger","disabled","host","stopCap","ev","stopBub","_stopMenuCap","_stopMenuBubble","hostRect","onDocDown","onKey","onScroll","_menuEl","_menuBallRef","_onMenuDocDown","_onMenuScroll","_onMenuKey","rs","size","persist","margin","_blacklistUpdate","lower","_step","t","isConnected","getAttribute","c2","bounce","sumM","cx","cy","activeCount","m","virtM","totM","axDrag","ayDrag","DRIFT_LERP_TAU","DRIFT_SWITCH_MIN","DRIFT_SWITCH_MAX","ang","FMIN","FMAX","mag","alpha","dxC","dyC","theta","cosT","sinT","rx","ry","j","dist","minDist","invA","invC","invSum","corr","rel","jImp","impX","impY","requestAnimationFrame","align","z","minHeight","flexWrap","makeZone","legendTitle","legendWrap","renderLegend","balls","dot","marginRight","txt","empty","initialBlack","has","present","extraIdx","rawName","_ang","_FMIN","_FMAX","_mag","MutationObserver","observe","attributes","attributeFilter","ResizeObserver","destroy","cancelAnimationFrame","disconnect","SearchDanmakuPage","_headerBox","_imgEl","_titleValEl","_episodeTitleEl","_idValEl","_epIdValEl","_offsetInput","_matchData","_unbinds","_searchInput","_searchBtn","_searchPlaceholder","_resultsWrap","_listWrap","_detailWrap","_selectedItem","_detailUnbinds","_isAnimating","img","alt","objectFit","referrerPolicy","rightWrap","makeLine","labelText","valueNode","lab","wordBreak","titleNode","titleLine","epTitleNode","gInit","episodeTitle","epTitleLine","idNode","idLine","offsetInput","updateBtn","offsetValueWrap","offsetLine","epIdNode","epIdLine","onOffsetChange","offset","danmakuMatchData","onUpdateClick","form","g2","newEpTitle","deleteBar","onDeleteClick","ok","confirm","_clearHeaderInfo","searchWrap","searchInput","autocomplete","spellcheck","searchBtn","borderLeft","borderTopRightRadius","borderBottomRightRadius","svgNS","icon","createElementNS","circle","updatePlaceholder","focused","hasText","onFocus","onBlur","onInput","onSearchClick","resultsWrap","_bindSearchActions","_fetchMatchData","_fetchEpId","doSearch","_doSearch","onKeyDown","_renderSearchResults","_renderSearchLoading","animes","_renderSearchError","tip","card","_createResultCard","_enterDetail","aspectRatio","topBox","animeTitle","objectPosition","transformOrigin","imageUrl","removeAttribute","onerror","onload","overlay","typeDescription","parentNode","backBtn","onBack","_exitDetail","posterBox","posterImg","psrc","infoBox","summary","webkitLineClamp","webkitBoxOrient","actionBar","aidText","curAnimeId","animeId","seasonOffsetInput","confirmBtn","onConfirm","itemId","exists","g3","episodesWrap","loading","detail","dur","ease","finish","onEnd","_loadBangumiDetail","summaryEl","bangumi","episodes","ep","episodeNumber","toUpperCase","eid","episodeId","etitle","actionWrap","setBtn","onSet","prev","danmakuEpId","_applyMatchData","reason","aid","off","__","epId","ep_id","DanmakuSettingsPanel","_styleInjected","_id","_followRaf","_followAnchor","_lastPosKey","_wheelListener","_keyboardListener","_currentTab","_pinned","_vvListener","getElement","_injectStyles","wrap","_buildContent","_installWheelInterceptor","_installKeyboardInterceptor","anchorEl","documentElement","_updatePanelVhVar","_position","_beginFollow","_stopFollow","done","toggle","_ensureInViewport","_anchorInvisible","_reacquireTick","isAnchorVisible","getComputedStyle","parseFloat","reacquireAnchor","cand","_resizeListener","visualViewport","pinBtn","togglePin","closeBtn","tabsWrap","scrollWrap","_pages","panelsWrap","switchTab","tabKey","page","panelEl","footer","_buildActionBar","_renderRow","bar","debugWrap","debugCb","storedDebug","localStorage","getItem","initialDebug","getDebug","checked","setDebug","debugText","setItem","rightGroup","resetBtn","_showConfirm","message","confirmText","cancelText","_refreshPagesUI","saveBtn","setBusy","busy","autoWrap","autoCb","persisted","persistedBool","autoText","activeKey","remove","some","rootEl","ctrlKey","metaKey","altKey","code","mask","actions","btnCancel","btnOk","cleanup","keyHandler","unbind","_origCleanup","cleanupWrapped","onclick","vw","innerWidth","clientWidth","vh","innerHeight","clientHeight","centerX","changed","newTop","vv","oneVhPx","isPinned","DanmakuButtonsGroup","toggleButton","settingsButton","settingsPanel","_globalKeyInterceptor","_enabled","_storageKeyEnabled","_toggleRetryTimer","_onToggle","bind","_onOpenSettings","_onSettingsHoverOpen","_onDocumentClick","_onSettingsButtonMouseLeave","_onPanelMouseEnter","_onPanelMouseLeave","_settingsHoverTimer","_settingsAutoCloseTimer","_restored","_freezeClickUntil","_panelHasFocus","_imeComposing","_injectStylesIfNeeded","inputEl","_createTextInput","toggleBtn","_createToggleButton","settingsBtn","_createSettingsButton","_restoreEnabledState","_applyVisibilityWithRetry","_persistEnabledState","applyVisibility","renderer","Date","_ensureOutsideClickBinding","_afterMaybeOpened","_bindPanelHoverHandlers","_bindPanelFocusHandlers","_clearSettingsAutoClose","_panelHoverBound","_scheduleSettingsAutoClose","hasFocusInPanel","ownerDocument","hasFocusInPanel2","btnHover","_isElementHovered","panelHover","_outsideClickBound","_panelFocusBound","_onPanelFocusIn","_onPanelFocusOut","ae","_onCompositionStart","_onCompositionEnd","svgDataUri","svg","ICON_TOGGLE_OFF","ICON_TOGGLE_ON","ICON_SETTINGS","css","createTextNode","sendBtn","sendCurrent","keepFocus","emitted","media","currentTime","emit","text","time","mode","fillStyle","strokeStyle","lineWidth","textBaseline","classList","DanmakuHeatmapRenderer","colorPresets","blue","lineColor","gradientColorStart","gradientColorEnd","red","green","purple","orange","colorScheme","selectedColors","autoResize","canvasId","ctx","rawData","processedData","actualDuration","maxDensity","minDensity","resizeObserver","parentContainer","lastRenderedWidth","resizeThreshold","cachedCanvas","resizeDebounceTimer","resizeDebounceDelay","pendingWidth","debugLog","args","console","log","setHeatmapData","Error","start_time_seconds","end_time_seconds","average_density","setActualDuration","preprocessData","dataDuration","adjustDataByDuration","timeDiff","originalLength","lastItem","oldEndTime","firstPadding","secondPadding","calculateDensityRange","d","setupResizeObserver","entry","handleResize","updateCanvasSize","newWidth","floor","contentRect","performQuickResize","processResizeChange","clearRect","devicePixelRatio","cacheLogicalWidth","cacheLogicalHeight","drawImage","drawHeatmap","widthDifference","redraw","cacheCanvas","restoreFromCache","getContext","scale","setTransform","error","scaleX","scaleY","save","restore","toFixed","createCanvas","styleOptions","noData","finalStyle","assign","graphWidth","graphHeight","points","dataPoint","index","normalizedDensity","midTime","density","p1","p2","slope","startY","startPoint","isExtended","pn2","pn1","endSlope","endY","endPoint","point","dataIndex","drawFillArea","drawSmoothCurve","paddingVertical","gradient","createLinearGradient","addColorStop","beginPath","moveTo","lineTo","drawMonotonicSpline","closePath","fill","imageSmoothingEnabled","imageSmoothingQuality","lineCap","lineJoin","shadowColor","shadowBlur","shadowOffsetX","shadowOffsetY","stroke","slopes","calculateMonotonicSlopes","m1","m2","steps","dataIndex1","dataIndex2","currentData","nextData","timeDuration","ceil","u","hermiteInterpolation","dx1","dy1","dx2","dy2","w1","w2","slope1","slope2","minSlope","sign","t2","t3","h00","h10","h01","h11","showError","fillRect","fillText","process","heatmapData","videoDuration","newData","newDuration","properties","dpr","canvasHeightCache","create","__getGlobal","__getRemoteFontCache","remoteFontCache","urlPath","cache","status","promise","ff","absUrl","FontFace","weight","load","loaded","fontFace","danmakuRemoteFontFamilyName","createCommentCanvas","cmt","render","cvs","HTMLCanvasElement","match","maybeRewriteStyleFont","strokeWidth","Infinity","measureText","fs","fsu","lh","lhu","root","canvasHeight","baseline","strokeText","computeFontSize","getPropertyValue","canvasEngine","init","stage","context","_fontSize","getElementsByTagName","clear","resize","framing","setup","raf","rAF","mozRequestAnimationFrame","webkitRequestAnimationFrame","cb","caf","cAF","mozCancelAnimationFrame","webkitCancelAnimationFrame","binsearch","prop","LOG_PREFIX","mid","insertion","formatMode","test","collidableRange","resetSpace","ltr","rtl","allocate","that","ct","pbr","playbackRate","willCollide","cr","crElapsed","crLeftTime","cmtTotalWidth","cmtTime","_utc","cmtElapsed","cmtArrival","crs","curr","requiredRange","channel","crObj","play","visible","paused","runningList","engine","_timestamp","dn","lastPbr","ai","ac","cmtt","pendingList","elapsed","createEngine","requestID","frame","timestamp","pause","ratechange","newRate","oldRate","seek","backfillOnSeek","windowStart","backfillDuration","wsIndex","end","pool","maxBackfill","bindEvents","seeking","unbindEvents","init$1","enableCopyMenu","copyMenu","copyMenuHandlers","listener","cssText","setupCopyContextMenu","onContext","onDocClick","clear$1","resize$1","Danmaku","hitDanmaku","preview","maxHeight","borderBottom","onClick","currentCmt","clipboard","writeText","fallbackCopy","hideMenu","onDocClickWrapped","showAt","ta","execCommand","defineProperty","_setupCopyContextMenu","newComments","prepared","slice","newSpace","visibleList","startIndex","tempCtx","cm","wasPaused","wasVisible","ri","vc","resetCopyMenu","getGlobal","isVisible","offsetParent","cs","getActiveOsdRoot","roots","visibleRoots","owner","find","attachButtonsGroup","searchIn","anchors","sel","nodes","closest","findButtonsContainer","existing","danmakuButtonsGroup","existingEl","beforeNode","node","insertBefore","instance","element","generateHeatmap","heatmapArray","CANVAS_ID","candidates","tagName","scrollWidth","findHeatmapContainer","existingCanvas","once","checkAgain","renderDanmaku","videoEl","parent","layerId","innerWrapper","opacitySetting","displayTop","displayBottom","topPct","bottomPct","danmakuInstance","resizeTimer","ro","__danmakuResizeObserver","__danmakuResizeTimerCancel","handleWindowResize","__danmakuWindowResizeHandler","Logger","prefix","maxLines","_debug","_prefix","_maxLines","_overlay","_overlayWrap","_buffer","_lastOverlayTsMs","_altFlip","_ensureOverlay","next","_hideOverlay","setPrefix","_fmt","_stringify","arg","_appendToOverlay","level","nowMs","getTime","pad2","padStart","ts","getHours","getMinutes","getSeconds","delta","_ready","pre","childNodes","firstChild","scrollTop","scrollHeight","mount","content","__collapsed","__prevHeight","__prevResize","__prevMinHeight","setCollapsed","div","readyState","NS","__webPlayerStateInstalled","state","isActive","pollTimer","observer","mediaItemId","__initialDebug","uiActive","activateUI","maybeLoadForMedia","__lastSettingsLoadedForId","isButtonsReady","isHeatmapReady","isDanmakuReady","allReady","tryInitOnce","buttons","canvases","cleanupDuplicates","btnRes","finishAndLoadData","debouncedTry","debounce","idNow","obs","childList","subtree","__uiInitObserver","__uiInitInterval","setInterval","clearInterval","__uiInitMouseMove","setupPersistentWatchers","deactivateUI","cleanupAll","isInWebPlayer","osdEl","handleStateChange","newState","runCheck","debouncedRunCheck","timer","wrapped","apply","cancel","start","proto","XMLHttpRequest","open","__jfPlaybackPatched","originalOpen","method","rest","endsWith","responseText","MediaSources","Id","prevId","__maybeLoadForMedia","loggerRef","installXHRSniffer","getState","spawnExt","getLogger"],"mappings":"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"}