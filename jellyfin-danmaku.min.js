/*!
 * jellyfin-danmaku-extension v1.0.0
 * Jellyfin Web弹幕扩展
 * 
 * 构建时间: 2025-09-09T19:57:51.626Z
 * 
 * 使用方法:
 * 1. 将此文件复制到Jellyfin Web目录
 * 2. 在index.html的</body>前添加: <script src="./jellyfin-danmaku.js"><\/script>
 * 3. 或者将内容直接注入到<script>标签中
 * 
 * @license MIT
 */
!function(){"use strict";const t="__jfDanmakuGlobal__";class e{constructor(t={}){this._schema=Object.freeze({enable_danmaku:{def:!0,type:"boolean"},chConvert:{def:"0",type:"string"},withRelated:{def:"true",type:"string"},enable_heatmap:{def:"combined",type:"string"},heatmap_interval:{def:5,type:"number"},font_size:{def:25,type:"number"},font_family:{def:"sans-serif",type:"string"},opacity:{def:70,type:"number"},speed:{def:144,type:"number"},display_top_pct:{def:0,type:"number"},display_bottom_pct:{def:100,type:"number"},enable_combine:{def:!0,type:"boolean"},threshold_seconds:{def:15,type:"number"},max_distance:{def:3,type:"number"},max_cosine:{def:40,type:"number"},use_pinyin:{def:!0,type:"boolean"},cross_mode:{def:!0,type:"boolean"},trim_ending:{def:!0,type:"boolean"},trim_space:{def:!0,type:"boolean"},trim_width:{def:!0,type:"boolean"},heatmap_style:{def:'{"lineWidth":1,"lineColor":"#3498db","gradientColorStart":"rgba(52, 152, 219, 0.08)","gradientColorEnd":"rgba(52, 152, 219, 0.25)"}',type:"string"},mark_style:{def:"dynamic",type:"string"},mark_threshold:{def:1,type:"number"},mode_elevation:{def:!0,type:"boolean"},enlarge:{def:!1,type:"boolean"},scroll_threshold:{def:0,type:"number"},shrink_threshold:{def:0,type:"number"},drop_threshold:{def:0,type:"number"},max_chunk_size:{def:1e3,type:"number"},force_list:{def:"[]",type:"string"},white_list:{def:"[]",type:"string"},black_list:{def:"[]",type:"string"},black_source_list:{def:"[]",type:"string"}}),this._values={};for(const e of Object.keys(this._schema)){const n=this._schema[e],a=Object.prototype.hasOwnProperty.call(t,e)?t[e]:n.def;this._values[e]=this._normalize(a,n.type,n.def)}this._unknown=Object.keys(t).filter(t=>!this._schema[t])}_normalize(t,e,n){if(null==t)return n;try{switch(e){case"number":{if("number"==typeof t&&!isNaN(t))return t;const e=Number(t);return isNaN(e)?n:e}case"boolean":return"boolean"==typeof t?t:"true"===t||"1"===t||"false"!==t&&"0"!==t&&!!t;case"string":return String(t);default:return t}}catch(t){return n}}keys(){return Object.keys(this._schema)}toJSON(){const t={};for(const e of this.keys())t[e]=this._values[e];return t}get(t){return this._values[t]}set(t,e){const n=this._schema[t];return!!n&&(this._values[t]=this._normalize(e,n.type,n.def),!0)}patch(t={}){for(const[e,n]of Object.entries(t))this.set(e,n);return this}asBool(t){const e=this.get(t);return"boolean"==typeof e?e:"true"===e||"1"===e||"false"!==e&&"0"!==e&&!!e}mountGlobal(){if("undefined"==typeof window)return this;return(window[t]=window[t]||{}).danmakuSettings=this,this}resetToDefaults(){try{for(const t of Object.keys(this._schema)){const{def:e,type:n}=this._schema[t];this._values[t]=this._normalize(e,n,e)}}catch(t){}return this}static getDefaultObject(){try{const t=new e({}),n={};for(const e of Object.keys(t._schema))n[e]=t._schema[e].def;return n}catch(t){return{}}}}function n(n){try{if("undefined"!=typeof window){const a=window[t]=window[t]||{};if(a.danmakuSettings instanceof e)return a.danmakuSettings.patch(n||{}),a.danmakuSettings}}catch(t){}return new e(n).mountGlobal()}const a="__jfDanmakuGlobal__";async function i(t,e,i){const s=window[a]=window[a]||{},o=window?.__jfDanmakuGlobal__?.danmakuSettings;if(!o||"function"!=typeof o.toJSON)return t?.warn?.("无法保存设置：全局设置对象缺失"),null;try{const a=o.toJSON(),r=new URLSearchParams;for(const[t,e]of Object.entries(a))r.append(t,String(e));const l=[];e&&l.push(`item_id=${encodeURIComponent(e)}`);const d=l.length?`?${l.join("&")}`:"",c=ApiClient.getUrl(`danmaku/comment${d}`),h=await ApiClient.ajax({type:"POST",url:c,data:r.toString(),contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"json"});if(t?.info?.("已提交弹幕设置并获取响应",{"服务器返回弹幕数":h.comments?.length??void 0}),!h||"object"!=typeof h)return h;if(h.settings&&"object"==typeof h.settings)try{n(h.settings),t?.info?.("弹幕设置对象已更新")}catch(e){t?.warn?.("弹幕设置对象更新失败",e)}if(s.danmakuData=h,t?.info?.("全局 danmakuData 已刷新",{"数量":h.comments?.length??void 0}),e||i)try{if(s.danmakuRenderer&&"function"==typeof s.danmakuRenderer.replaceComments)try{s.danmakuRenderer.replaceComments(h.comments,{preserveState:!0}),t?.info?.("替换弹幕渲染器数据成功")}catch(e){t?.warn?.("替换弹幕渲染器数据失败",e)}if(h.heatmap_data&&"object"==typeof h.heatmap_data){const e=Object.values(h.heatmap_data);if(s.heatmapRenderer&&"function"==typeof s.heatmapRenderer.recalculate)try{const n=document.querySelector("video"),a=n?.duration||0;s.heatmapRenderer.recalculate(e,a),t?.info?.("热力图数据已更新并重新计算")}catch(e){t?.warn?.("热力图更新失败",e)}}}catch(e){t?.warn?.("刷新全局 danmakuData 失败",e)}else t?.info?.("设置已保存：未提供 item_id / danmaku_id，服务器正常不返回弹幕数据");return h}catch(e){throw t?.warn?.("提交弹幕设置请求失败",e),e}}async function s(t,e,i){const s=window[a]=window[a]||{};try{const a=[];e&&a.push(`item_id=${encodeURIComponent(e)}`);const i=a.length?`?${a.join("&")}`:"",o=ApiClient.getUrl(`danmaku/comment${i}`),r=await ApiClient.ajax({type:"GET",url:o,dataType:"json"});if(!r||"object"!=typeof r)return r;if(r.settings&&"object"==typeof r.settings)try{n(r.settings),t?.info?.("弹幕设置对象已加载")}catch(e){t?.warn?.("弹幕设置对象加载失败",e)}s.danmakuData=r,t?.info?.("已获取弹幕数据",{"数量":r.comments?.length});try{if(s.danmakuRenderer&&"function"==typeof s.danmakuRenderer.replaceComments&&Array.isArray(r.comments))try{s.danmakuRenderer.replaceComments(r.comments,{preserveState:!0}),t?.info?.("替换弹幕渲染器数据成功")}catch(e){t?.warn?.("替换弹幕渲染器数据失败",e)}if(r.heatmap_data&&"object"==typeof r.heatmap_data){const e=Object.values(r.heatmap_data);if(s.heatmapRenderer&&"function"==typeof s.heatmapRenderer.recalculate)try{const n=document.querySelector("video"),a=n?.duration||0;s.heatmapRenderer.recalculate(e,a),t?.info?.("热力图数据已更新并重新计算")}catch(e){t?.warn?.("热力图更新失败",e)}}}catch(t){}return r}catch(e){throw t?.warn?.("获取弹幕设置/数据失败",e),e}}let o=null,r=null,l=null,d=null,c=null;function h(){if(o){try{clearTimeout(o)}catch(t){}o=null}}function u(){h(),r=null,l=null,d=null}function p(t=null){try{const e=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};if(!!!e.danmakuAutoSave){if(r){h();try{l?.(void 0)}catch(t){}}return void u()}t&&(c=t);const n=300;return h(),r||(r=new Promise((t,e)=>{l=t,d=e})),o=setTimeout(()=>{o=null;const n=c||t,a=e.getMediaId?.();try{const t=i(n,a);t&&"function"==typeof t.then?t.then(t=>{l?.(t),u()}).catch(t=>{n?.warn?.("保存设置失败",t),d?.(t),u()}):(l?.(t),u())}catch(t){n?.warn?.("保存设置失败",t),d?.(t),u()}},n),r}catch(e){t?.warn?.("保存设置失败",e)}}async function m(t=null){try{const e=(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).danmakuSettings,n=e?.get?.("font_family");if(!n||"string"!=typeof n||0!==n.indexOf("/danmaku/font/"))return!1;let a=n.replace(/^\/+/,"");try{"undefined"!=typeof ApiClient&&ApiClient.getUrl&&(a=ApiClient.getUrl(a))}catch(t){}if("undefined"==typeof caches||!caches?.open)return!1;const i=await caches.open("jfdanmaku-fonts-v1"),s=new Request(a,{credentials:"same-origin",mode:"cors"});if(await i.match(s))return!0;const o=await fetch(s);if(!o||!o.ok)return t?.warn?.("字体下载失败",a,o?.status),!1;const r=o.clone();return await i.put(s,r),!0}catch(e){return t?.warn?.("缓存服务器字体失败",e),!1}}try{(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).ensureCurrentServerFontCached=m}catch(t){}var y=Object.freeze({__proto__:null,ensureCurrentServerFontCached:m,saveIfAutoOn:p});class g{constructor(t={}){this.logger=t.logger||null}getKey(){return"basic"}getLabel(){return"基础设置"}_createFontSizeRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings,e=t?.get?.("font_size")??25,n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","font_size"),n.setAttribute("data-type","number");const a=document.createElement("div");a.className="danmaku-setting-row__label";const i=document.createElement("span");i.className="danmaku-setting-row__labelText",i.textContent="字体大小 (px)",a.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px";const o=document.createElement("input");o.type="range",o.min="8",o.max="80",o.step="1",o.value=String(e),o.style.flex="1 1 auto";const r=document.createElement("input");r.type="number",r.min="8",r.max="80",r.step="1",r.value=String(e),r.className="danmaku-setting-input",r.style.width="70px";const l=(t,e)=>{let n=parseInt(t,10);if(!isNaN(n)){n<8?n=8:n>80&&(n=80),o.value=String(n),r.value=String(n);try{const t=window.__jfDanmakuGlobal__.danmakuSettings;t?.set?.("font_size",n),p(this.logger)}catch(t){}this.logger?.info?.("[BasicSettings] font_size ->",n,"(from",e,")")}};o.addEventListener("input",()=>l(o.value,"range")),r.addEventListener("input",()=>l(r.value,"number")),r.addEventListener("change",()=>l(r.value,"number-change")),s.appendChild(o),s.appendChild(r),n.appendChild(s);const d=document.createElement("div");return d.className="danmaku-setting-row__desc",n.appendChild(d),n}_createOpacityRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings,e=t?.get?.("opacity")??70,n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","opacity"),n.setAttribute("data-type","number");const a=document.createElement("div");a.className="danmaku-setting-row__label";const i=document.createElement("span");i.className="danmaku-setting-row__labelText",i.textContent="弹幕透明度 (%)",a.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px";const o=document.createElement("input");o.type="range",o.min="0",o.max="100",o.step="1",o.value=String(e),o.style.flex="1 1 auto";const r=document.createElement("input");r.type="number",r.min="0",r.max="100",r.step="1",r.value=String(e),r.className="danmaku-setting-input",r.style.width="70px";const l=(t,e)=>{let n=parseInt(t,10);if(!isNaN(n)){n<0?n=0:n>100&&(n=100),o.value=String(n),r.value=String(n);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("opacity",n);const e=document.querySelector("#danmaku-layer");e&&(e.style.opacity=String(Math.min(1,Math.max(0,n/100)))),p(this.logger)}catch(t){}this.logger?.info?.("[BasicSettings] opacity ->",n,"(from",e,")")}};o.addEventListener("input",()=>l(o.value,"range")),r.addEventListener("input",()=>l(r.value,"number")),r.addEventListener("change",()=>l(r.value,"number-change")),s.appendChild(o),s.appendChild(r),n.appendChild(s);const d=document.createElement("div");return d.className="danmaku-setting-row__desc",n.appendChild(d),n}_createSpeedRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings,e=t?.get?.("speed")??144,n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","speed"),n.setAttribute("data-type","number");const a=document.createElement("div");a.className="danmaku-setting-row__label";const i=document.createElement("span");i.className="danmaku-setting-row__labelText",i.textContent="弹幕速度",a.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.gap="8px";const o=document.createElement("input");o.type="range",o.min="24",o.max="600",o.step="1",o.value=String(e),o.style.flex="1 1 auto";const r=document.createElement("input");r.type="number",r.min="24",r.max="600",r.step="1",r.value=String(e),r.className="danmaku-setting-input",r.style.width="70px";const l=(t,e)=>{let n=parseInt(t,10);if(!isNaN(n)){n<24?n=24:n>600&&(n=600),o.value=String(n),r.value=String(n);try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t.danmakuSettings;e?.set?.("speed",n);try{t.danmakuRenderer.speed=n}catch(t){}p(this.logger)}catch(t){}this.logger?.info?.("[BasicSettings] speed ->",n,"(from",e,")")}};o.addEventListener("input",()=>l(o.value,"range")),r.addEventListener("input",()=>l(r.value,"number")),r.addEventListener("change",()=>l(r.value,"number-change")),s.appendChild(o),s.appendChild(r),n.appendChild(s);const d=document.createElement("div");return d.className="danmaku-setting-row__desc",n.appendChild(d),n}_createFontFamilyRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("font_family")||"sans-serif";const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","font_family"),n.setAttribute("data-type","string");try{if(!document.getElementById("danmaku-fontfamily-style")){const t=document.createElement("style");t.id="danmaku-fontfamily-style",t.textContent='\n/* Font Family combo input + list */\n.danmaku-setting-row[data-key="font_family"] .ff-combo { position: relative; width: 100%; }\n.danmaku-setting-row[data-key="font_family"] .ff-input {\n  width: 100%; background-color: rgba(30,30,30,.92); color: #fff;\n  border: 1px solid rgba(255,255,255,.28); border-radius: 4px; outline: none;\n  padding: 6px 8px; font-size: 12px;\n}\n.danmaku-setting-row[data-key="font_family"] .ff-input:focus { box-shadow: 0 0 0 2px rgba(255,255,255,.15); }\n.danmaku-setting-row[data-key="font_family"] .ff-list {\n  position: absolute; left: 0; right: 0; top: calc(100% + 6px);\n  max-height: 220px; overflow: auto; background: #1e1e1e; color: #fff;\n  border: 1px solid rgba(255,255,255,.28); border-radius: 6px; padding: 4px 0; z-index: 9999;\n  display: none;\n}\n.danmaku-setting-row[data-key="font_family"] .ff-item {\n  padding: 6px 10px; font-size: 12px; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;\n}\n.danmaku-setting-row[data-key="font_family"] .ff-item:hover,\n.danmaku-setting-row[data-key="font_family"] .ff-item.active { background: rgba(255,255,255,.12); }\n',document.head.appendChild(t)}}catch(t){}const a=document.createElement("div");a.className="danmaku-setting-row__label";const i=document.createElement("span");i.className="danmaku-setting-row__labelText",i.textContent="字体",a.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.className="ff-combo";const o=document.createElement("input");o.className="ff-input danmaku-setting-input",o.type="text";const r="输入以筛选字体...";o.placeholder=r;const l=document.createElement("div");l.className="ff-list",s.appendChild(o),s.appendChild(l);let d=[],c=[],h=-1;const u=t=>{if("string"==typeof t&&0===t.indexOf("/danmaku/font/")){const e=(t.split("/").pop()||t).split("?")[0];let n=e;try{n=decodeURIComponent(e)}catch(t){}return`服务器字体: ${n}`}return t},y=()=>{l.style.display="block"},g=()=>{l.style.display="none",h=-1},f=()=>{if(l.innerHTML="",c.forEach((t,e)=>{const n=document.createElement("div");n.className="ff-item"+(e===h?" active":""),n.textContent=u(t),n.dataset.val=t,n.addEventListener("mousedown",e=>{e.preventDefault(),b(t)}),l.appendChild(n)}),c.length&&document.activeElement===o?y():g(),h>=0&&l.children[h])try{l.children[h].scrollIntoView({block:"nearest"})}catch(t){}},_=t=>{const n=t=>{let e=(t??"").toString();try{e=e.normalize("NFKC")}catch(t){}e=e.toLowerCase(),e=e.replace(/\s+/g,"");try{e=e.normalize("NFD").replace(/[\u0300-\u036f]/g,"")}catch(t){}return e},a=n(t||"");c=d.filter(t=>{const e=[],i=(t||"").toString();e.push(i);const s=u(t);if(s&&e.push(s),"string"==typeof i&&0===i.indexOf("/danmaku/font/")){const t=(i.split("/").pop()||i).split("?")[0];let n=t;try{n=decodeURIComponent(t)}catch(t){}e.push(n);const a=n.replace(/\.[a-z0-9]+$/i,"");e.push(a)}return e.some(t=>n(t).includes(a))}),h=c.length?Math.max(0,c.indexOf(e)):-1,f()},b=async t=>{if(t){v(t);try{"string"==typeof t&&0===t.indexOf("/danmaku/font/")&&await m(this.logger)}catch(t){}e=t,o.value="",o.placeholder=u(t),g();try{o.blur()}catch(t){}}},x=t=>{const n=new Set;t.forEach(t=>{t&&n.add(t)}),["sans-serif","serif","monospace","system-ui"].forEach(t=>n.add(t)),d=Array.from(n).sort((t,e)=>t.localeCompare(e,"zh-Hans-CN")),e&&!d.includes(e)&&d.push(e),o.value="",o.placeholder=u(e),_("")};Promise.resolve().then(async()=>{try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};if(Array.isArray(t.availableFontFamilies)&&t.availableFontFamilies.length){x(t.availableFontFamilies);try{await m(this.logger)}catch(t){}return}let e=await(async()=>{const t=new Set;try{if(navigator.fonts?.query)for await(const e of navigator.fonts.query())e.family&&t.add(e.family)}catch(t){}return Array.from(t)})();try{const t=await(async()=>{try{if("undefined"==typeof ApiClient||!ApiClient.getUrl)return[];const t=ApiClient.getUrl("danmaku/font/get_all"),e=await ApiClient.ajax({type:"GET",url:t,dataType:"json"});return Array.isArray(e)?e.map(t=>t&&"string"==typeof t.url?t.url:null).filter(Boolean):[]}catch(t){return[]}})();if(t&&t.length){const n=new Set([...e||[],...t]);e=Array.from(n)}}catch(t){}if(!e||e.length<5){const t=(()=>{const t=["monospace","serif","sans-serif"],e=document.createElement("span");e.style.position="absolute",e.style.left="-9999px",e.style.fontSize="72px",e.textContent="mmmmmmmmmwwwwwwwiiiilllOO0测试字样ABC123",document.body.appendChild(e);const n={};t.forEach(t=>{e.style.fontFamily=t,n[t]={w:e.offsetWidth,h:e.offsetHeight}});const a=[];return["Arial","Helvetica","Segoe UI","Roboto","PingFang SC","Microsoft YaHei","Noto Sans CJK SC","SimHei","SimSun","KaiTi","FangSong","Courier New","Consolas","Menlo","Monaco","Ubuntu","Ubuntu Mono","Tahoma","Verdana","Georgia","Times New Roman"].forEach(i=>{let s=!1;for(const a of t){e.style.fontFamily=`'${i}',${a}`;const t=e.offsetWidth,o=e.offsetHeight;if(t!==n[a].w||o!==n[a].h){s=!0;break}}s&&a.push(i)}),document.body.removeChild(e),a})(),n=new Set([...e||[],...t]);e=Array.from(n)}t.availableFontFamilies=e,x(e);try{await m(this.logger)}catch(t){}}catch(t){x([e||"sans-serif"])}});const v=t=>{try{const e=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},n=e.danmakuSettings;n?.set?.("font_family",t);const a=n=>{const a=n?`'${n}', sans-serif`:t,i=document.querySelector("#danmaku-layer");if(i&&(i.style.fontFamily=a),e.danmakuRenderer?.container)try{e.danmakuRenderer.container.style.fontFamily=a}catch(t){}};if("string"==typeof t&&0===t.indexOf("/danmaku/font/")){const n=e.ensureRemoteFontLoaded||e.danmakuRenderer&&e.danmakuRenderer.ensureRemoteFontLoaded;"function"==typeof n?n(t).then(t=>{a(t||null)}).catch(()=>a(null)):a(null)}else a(null);p(this.logger)}catch(t){}this.logger?.info?.("[BasicSettings] font_family ->",t)};o.addEventListener("input",()=>_(o.value)),o.addEventListener("focus",()=>{o.value||(o.placeholder=r),o.value="",_(""),y()}),o.addEventListener("blur",()=>{o.placeholder=u(e)}),o.addEventListener("keydown",t=>{"block"===l.style.display&&("ArrowDown"===t.key?(h=Math.min(c.length-1,h+1),f(),t.preventDefault()):"ArrowUp"===t.key?(h=Math.max(0,h-1),f(),t.preventDefault()):"Enter"===t.key?h>=0&&c[h]&&(b(c[h]),t.preventDefault()):"Escape"===t.key&&g())}),document.addEventListener("click",t=>{s.contains(t.target)||g()}),n.appendChild(s);const w=document.createElement("div");return w.className="danmaku-setting-row__desc",w.textContent='字体建议放在服务端的"/config/fonts"路径',n.appendChild(w),n}_createDisplayRangeRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings,e=t?.get?.("display_top_pct"),n=t?.get?.("display_bottom_pct");let a=isFinite(e)?Math.round(e):0,i=isFinite(n)?Math.round(n):100;a<0&&(a=0),a>99&&(a=99),i<=a&&(i=Math.min(100,a+1)),i>100&&(i=100);const s=document.createElement("div");s.className="danmaku-setting-row",s.setAttribute("data-key","display_range"),s.setAttribute("data-type","range");const o=document.createElement("div");o.className="danmaku-setting-row__label";const r=document.createElement("span");r.className="danmaku-setting-row__labelText",r.textContent="显示范围",o.appendChild(r),s.appendChild(o);const l=document.createElement("div");l.style.position="relative",l.style.height="32px",l.style.display="flex",l.style.alignItems="center",l.style.userSelect="none";const d=document.createElement("div");d.style.position="absolute",d.style.left="0",d.style.right="0",d.style.top="50%",d.style.height="4px",d.style.transform="translateY(-50%)",d.style.background="linear-gradient(90deg, rgba(255,255,255,.15), rgba(255,255,255,.15))",d.style.borderRadius="2px",l.appendChild(d);const c=document.createElement("div");function h(){c.style.left=a+"%",c.style.width=i-a+"%"}c.style.position="absolute",c.style.top="50%",c.style.height="6px",c.style.transform="translateY(-50%)",c.style.background="rgba(0,150,255,.6)",c.style.borderRadius="3px",l.appendChild(c),h();const u=t=>{t.style.position="absolute",t.style.top="50%",t.style.transform="translate(-50%, -50%)",t.style.width="14px",t.style.height="14px",t.style.borderRadius="50%",t.style.cursor="pointer",t.style.background="rgba(0,150,255,.9)",t.style.border="1px solid rgba(255,255,255,.6)",t.style.boxShadow="0 0 4px rgba(0,150,255,.7)",t.style.transition="background .15s, box-shadow .15s"},m=document.createElement("div");u(m);const y=document.createElement("div");function g(){m.style.left=a+"%",y.style.left=i+"%"}function f(e){try{const e=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},n=e.danmakuSettings||t;n?.set?.("display_top_pct",a),n?.set?.("display_bottom_pct",i);const s=document.getElementById("danmaku-layer");s&&s.parentElement&&(s.style.top=a+"%",s.style.height=i-a+"%"),e.danmakuRenderer?.resize(),p(this.logger)}catch(t){}this?.logger?.info?.("[BasicSettings] display_range ->",a,i,"from",e)}function _(){a=Math.round(a),i=Math.round(i),a<0&&(a=0),a>99&&(a=99),i<=a&&(i=Math.min(100,a+1)),i>100&&(i=100)}u(y),l.appendChild(m),l.appendChild(y),g();let b=null;const x=(t,e)=>{b=e,t.preventDefault(),document.addEventListener("pointermove",v),document.addEventListener("pointerup",w)},v=t=>{if(!b)return;const e=l.getBoundingClientRect(),n=Math.round((t.clientX-e.left)/e.width*100);"top"===b?a=Math.min(i-1,Math.max(0,n)):i=Math.max(a+1,Math.min(100,n)),_(),g(),h(),f.call(C,"drag")},w=()=>{b=null,document.removeEventListener("pointermove",v),document.removeEventListener("pointerup",w),f.call(C,"release")};m.addEventListener("pointerdown",t=>x(t,"top")),y.addEventListener("pointerdown",t=>x(t,"bottom")),l.addEventListener("pointerdown",t=>{if(t.target===m||t.target===y)return;const e=l.getBoundingClientRect(),n=Math.round((t.clientX-e.left)/e.width*100);Math.abs(n-a)<=Math.abs(n-i)?(a=Math.min(i-1,Math.max(0,n)),b="top"):(i=Math.max(a+1,Math.min(100,n)),b="bottom"),_(),g(),h(),f.call(C,"click-move"),document.addEventListener("pointermove",v),document.addEventListener("pointerup",w),t.preventDefault()}),s.appendChild(l);s.addEventListener("mouseenter",()=>{try{const t=document.getElementById("danmaku-layer");if(!t)return;void 0===t.__prevBgColor&&(t.__prevBgColor=t.style.backgroundColor),void 0===t.__prevTransition&&(t.__prevTransition=t.style.transition);const e=(t.style.transition||"").trim().length>0;t.style.transition=e?t.style.transition+", background-color .15s ease":"background-color .15s ease",t.style.backgroundColor="rgba(64, 0, 255, 0.52)"}catch(t){}}),s.addEventListener("mouseleave",()=>{try{const t=document.getElementById("danmaku-layer");if(!t)return;t.style.backgroundColor=t.__prevBgColor||"",void 0!==t.__prevTransition&&(t.style.transition=t.__prevTransition||"");try{delete t.__prevBgColor,delete t.__prevTransition}catch(t){}}catch(t){}});const k=document.createElement("div");k.className="danmaku-setting-row__desc",k.textContent="限制弹幕垂直显示区域",s.appendChild(k);const C=this;return s}_createChConvertRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings,e=t?.get?.("chConvert")??"0",n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","chConvert"),n.setAttribute("data-type","enum");const a=document.createElement("div");a.className="danmaku-setting-row__label";const i=document.createElement("span");i.className="danmaku-setting-row__labelText",i.textContent="简繁转换",a.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.style.display="flex",s.style.width="100%",s.style.gap="6px",s.style.marginTop="4px";const o=e=>{try{const n=(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).danmakuSettings||t;n?.set?.("chConvert",e),p(this.logger)}catch(t){}this.logger?.info?.("[BasicSettings] chConvert ->",e)};[{key:"0",label:"不转换"},{key:"1",label:"简体"},{key:"2",label:"繁体"}].forEach(t=>{const e=document.createElement("button");e.type="button",e.textContent=t.label,e.dataset.val=t.key,e.style.flex="1 1 0",e.style.padding="6px 4px",e.style.fontSize="12px",e.style.lineHeight="1.1",e.style.borderRadius="6px",e.style.border="1px solid rgba(255,255,255,.25)",e.style.background="rgba(255,255,255,.08)",e.style.color="#fff",e.style.cursor="pointer",e.style.transition="background .15s, border-color .15s, box-shadow .15s";const n=()=>{e.dataset.val===String(r)?(e.style.background="#3fa9ff",e.style.borderColor="#3fa9ff",e.style.boxShadow="0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)"):(e.style.background="rgba(255,255,255,.08)",e.style.borderColor="rgba(255,255,255,.25)",e.style.boxShadow="none")};e.addEventListener("mouseenter",()=>{e.dataset.val!==String(r)&&(e.style.background="rgba(255,255,255,.15)")}),e.addEventListener("mouseleave",()=>n()),e.addEventListener("click",()=>{r!==t.key&&(r=t.key,o(r),s.querySelectorAll("button").forEach(t=>{t.dataset.val===r?(t.style.background="#3fa9ff",t.style.borderColor="#3fa9ff",t.style.boxShadow="0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)"):(t.style.background="rgba(255,255,255,.08)",t.style.borderColor="rgba(255,255,255,.25)",t.style.boxShadow="none")}))}),s.appendChild(e),setTimeout(n,0)});let r=String(e);n.appendChild(s);const l=document.createElement("div");return l.className="danmaku-setting-row__desc",n.appendChild(l),n}build(){const t=document.createElement("div");t.className="danmaku-settings-tabPanel",t.dataset.key=this.getKey();const e=document.createElement("div");return e.className="danmaku-settings-list",e.appendChild(this._createFontSizeRow()),e.appendChild(this._createOpacityRow()),e.appendChild(this._createSpeedRow()),e.appendChild(this._createFontFamilyRow()),e.appendChild(this._createChConvertRow()),e.appendChild(this._createDisplayRangeRow()),t.appendChild(e),t}}class f{constructor(t={}){this.logger=t.logger||null}getKey(){return"combine"}getLabel(){return"弹幕合并"}_ensureCombineUpdate(){try{const t=p(this.logger);t&&t.then(()=>this._updateCombineStats())}catch(t){}}_updateCombineStats(){try{const t=window.__jfDanmakuGlobal__.danmakuData;if(this._combineStatsEl){let e=t?.original_total,n=t?.count;null==n&&Array.isArray(t?.comments)&&(n=t.comments.length),null==e&&"number"==typeof t?.raw_total&&(e=t.raw_total),null==e&&Array.isArray(t?.original_comments)&&(e=t.original_comments.length),null==e&&Array.isArray(t?.comments_before_merge)&&(e=t.comments_before_merge.length),null==e&&Array.isArray(t?.comments)&&(e=t.comments.length),this._combineStatsEl.textContent="number"==typeof e&&"number"==typeof n?e!==n?`${e} → ${n}`:String(n):null!=n?String(n):"--"}if(this._pakkuTimeEl){const e=t?.pakku_time,n=""===e||null==e?"--":String(e);this._pakkuTimeEl.textContent=`合并耗时: ${n}`}if(this._removed_countStatsEl){const e=t?.removed_count,n=""===e||null==e?0:Number(e),a=Number.isFinite(n)?n:0;this._removed_countStatsEl.textContent=`总击杀数: ${a}`}if(this._pinyinStatsEl){const e=t?.merge_counts?.pinyin,n=""===e||null==e?0:Number(e),a=Number.isFinite(n)?n:0;this.logger?.debug?.("[CombineSettings] 更新拼音击杀数",e,"->",a),this._pinyinStatsEl.textContent=`击杀数: ${a}`}if(this._editDistanceStatsEl){const e=t?.merge_counts?.edit_distance,n=""===e||null==e?0:Number(e),a=Number.isFinite(n)?n:0;this._editDistanceStatsEl.textContent=`击杀数: ${a}`}if(this._vectorStatsEl){const e=t?.merge_counts?.vector,n=""===e||null==e?0:Number(e),a=Number.isFinite(n)?n:0;this._vectorStatsEl.textContent=`击杀数: ${a}`}}catch(t){this._combineStatsEl&&(this._combineStatsEl.textContent="--"),this._pakkuTimeEl&&(this._pakkuTimeEl.textContent="合并耗时: --"),this._removed_countStatsEl&&(this._removed_countStatsEl.textContent="总击杀数: 0"),this._pinyinStatsEl&&(this._pinyinStatsEl.textContent="击杀数: --"),this._editDistanceStatsEl&&(this._editDistanceStatsEl.textContent="击杀数: 0"),this._vectorStatsEl&&(this._vectorStatsEl.textContent="击杀数: 0")}}_createCombineTimeRow(){const t=document.createElement("div");t.className="danmaku-setting-row",t.setAttribute("data-key","combine_time"),t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.gap="6px",t.style.textAlign="center",t.style.cursor="pointer";const e=document.createElement("span");e.style.fontSize="14px",e.style.fontWeight="500",e.style.userSelect="none",this._pakkuTimeEl=e,e.textContent="合并耗时: --";const n=document.createElement("span");return n.style.fontSize="14px",n.style.fontWeight="500",n.style.userSelect="none",this._removed_countStatsEl=n,n.textContent="总击杀数: 0",t.appendChild(e),t.appendChild(n),t.addEventListener("click",()=>this._updateCombineStats()),setTimeout(()=>this._updateCombineStats(),0),t}_createMarkStyleRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("mark_style");"string"!=typeof e&&(e="default");const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","mark_style"),n.setAttribute("data-type","select"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="合并计数标记样式",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";try{if(!document.getElementById("danmaku-markstyle-style")){const t=document.createElement("style");t.id="danmaku-markstyle-style",t.textContent='\n.danmaku-setting-row[data-key="mark_style"] select.danmaku-setting-input {\n  background-color: rgba(30,30,30,.92) !important;\n  color: #ffffff !important;\n  border: 1px solid rgba(255,255,255,.28) !important;\n  border-radius: 4px !important;\n  outline: none !important;\n}\n.danmaku-setting-row[data-key="mark_style"] select.danmaku-setting-input:focus {\n  box-shadow: 0 0 0 2px rgba(255,255,255,.15);\n}\n.danmaku-setting-row[data-key="mark_style"] select.danmaku-setting-input option {\n  background-color: #1e1e1e;\n  color: #fff;\n}\n@media (prefers-color-scheme: dark) {\n  .danmaku-setting-row[data-key="mark_style"] select.danmaku-setting-input option { background-color:#222; }\n}\n',document.head.appendChild(t)}}catch(t){}const i=document.createElement("select");i.className="danmaku-setting-input",i.style.width="140px",i.style.setProperty("background-color","rgba(30,30,30,.92)","important"),i.style.setProperty("color","#ffffff","important"),i.style.setProperty("border","1px solid rgba(255,255,255,.28)","important"),i.style.borderRadius="4px",i.style.padding="4px 6px",i.style.fontSize="12px",i.style.cursor="pointer",i.style.appearance="none",i.style.webkitAppearance="none",i.style.mozAppearance="none";const s=[{value:"off",label:"关闭"},{value:"sub_low",label:"小写下标"},{value:"sub_pre",label:"前置下标"},{value:"multiply",label:"乘号"},{value:"dynamic",label:"动态加号"}];for(const t of s){const n=document.createElement("option");n.value=t.value,n.textContent=t.label,t.value===e&&(n.selected=!0),i.appendChild(n)}const o=(t,n="ui")=>{e=String(t||"");try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("mark_style",e),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] mark_style ->",e,"from",n)};return i.addEventListener("change",()=>o(i.value,"change")),n.addEventListener("click",t=>{i.contains(t.target)||i.focus()}),n.appendChild(a),n.appendChild(i),n}_createMarkThresholdRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("mark_threshold");"number"==typeof e&&Number.isFinite(e)||(e=1),e<1?e=1:e>20&&(e=20);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","mark_threshold"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="显示标记阈值",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="1",i.max="20",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e),s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=1),a<1?a=1:a>20&&(a=20),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("mark_threshold",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] mark_threshold ->",e,"from",n)};return i.addEventListener("input",()=>{r(i.value,"input"),s.textContent=i.value}),i.addEventListener("change",()=>{r(i.value,"change"),s.textContent=i.value}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n}_createUsePinyinRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=!!t?.get?.("use_pinyin");const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","use_pinyin"),n.setAttribute("data-type","boolean"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("button");a.type="button",a.setAttribute("role","switch"),a.setAttribute("aria-checked",String(e)),a.style.position="relative",a.style.width="48px",a.style.height="22px",a.style.borderRadius="22px",a.style.border="1px solid rgba(255,255,255,.3)",a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",a.style.cursor="pointer",a.style.transition="background .2s, box-shadow .2s",a.style.outline="none",a.style.padding="0",a.style.marginTop="6px";const i=document.createElement("span");i.style.position="absolute",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.left=e?"26px":"4px",i.style.width="16px",i.style.height="16px",i.style.borderRadius="50%",i.style.background="#fff",i.style.boxShadow="0 2px 4px rgba(0,0,0,.4)",i.style.transition="left .2s",a.appendChild(i);const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.flex="0 0 auto";const o=document.createElement("span");o.textContent="识别谐音弹幕",o.style.fontSize="12px",o.style.opacity=".85",o.style.marginBottom="4px",o.style.userSelect="none",s.appendChild(o),s.appendChild(a);const r=document.createElement("span");r.style.fontSize="14px",r.style.fontWeight="500",r.style.whiteSpace="nowrap",r.style.flex="0 0 auto",r.style.maxWidth="180px",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.style.textAlign="center",this._pinyinStatsEl=r;const l=(t,n="ui")=>{e=!!t;try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("use_pinyin",e),a.setAttribute("aria-checked",String(e)),a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",i.style.left=e?"26px":"4px",this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] use_pinyin ->",e,"from",n)};return n.addEventListener("click",t=>{a.contains(t.target)||l(!e,"row")}),a.addEventListener("click",()=>l(!e,"click")),a.addEventListener("keydown",t=>{" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),l(!e,"key"))}),n.appendChild(s),n.appendChild(r),setTimeout(()=>this._updateCombineStats(),0),n}_createEnlargeRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=!!t?.get?.("enlarge");const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","enlarge"),n.setAttribute("data-type","boolean"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("button");a.type="button",a.setAttribute("role","switch"),a.setAttribute("aria-checked",String(e)),a.style.position="relative",a.style.width="48px",a.style.height="22px",a.style.borderRadius="22px",a.style.border="1px solid rgba(255,255,255,.3)",a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",a.style.cursor="pointer",a.style.transition="background .2s, box-shadow .2s",a.style.outline="none",a.style.padding="0",a.style.marginTop="6px";const i=document.createElement("span");i.style.position="absolute",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.left=e?"26px":"4px",i.style.width="16px",i.style.height="16px",i.style.borderRadius="50%",i.style.background="#fff",i.style.boxShadow="0 2px 4px rgba(0,0,0,.4)",i.style.transition="left .2s",a.appendChild(i);const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.flex="0 0 auto";const o=document.createElement("span");o.textContent="放大合并弹幕",o.style.fontSize="12px",o.style.opacity=".85",o.style.marginBottom="4px",o.style.userSelect="none",s.appendChild(o),s.appendChild(a);const r=(t,n="ui")=>{e=!!t;try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("enlarge",e),a.setAttribute("aria-checked",String(e)),a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",i.style.left=e?"26px":"4px",this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] enlarge ->",e,"from",n)};return n.addEventListener("click",t=>{a.contains(t.target)||r(!e,"row")}),a.addEventListener("click",()=>r(!e,"click")),a.addEventListener("keydown",t=>{" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),r(!e,"key"))}),n.appendChild(s),n}_createEditDistanceRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("max_distance");"number"==typeof e&&Number.isFinite(e)||(e=0),e<0?e=0:e>20&&(e=20);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","max_distance"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="编辑距离合并阈值",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="0",i.max="20",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e),s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=document.createElement("span");r.style.fontSize="14px",r.style.fontWeight="500",r.style.whiteSpace="nowrap",r.style.maxWidth="180px",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.textContent="击杀数: 0",this._editDistanceStatsEl=r;const l=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=0),a<0?a=0:a>20&&(a=20),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("max_distance",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] max_distance ->",e,"from",n)};return i.addEventListener("input",()=>{l(i.value,"input"),s.textContent=i.value}),i.addEventListener("change",()=>{l(i.value,"change"),s.textContent=i.value}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n.appendChild(r),setTimeout(()=>this._updateCombineStats(),0),n}_createVectorRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("max_cosine");"number"==typeof e&&Number.isFinite(e)||(e=0),e<0?e=0:e>100&&(e=100);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","max_cosine"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="词频向量合并阈值",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="0",i.max="100",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e)+" %",s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=document.createElement("span");r.style.fontSize="14px",r.style.fontWeight="500",r.style.whiteSpace="nowrap",r.style.maxWidth="180px",r.style.overflow="hidden",r.style.textOverflow="ellipsis",r.textContent="击杀数: 0",this._vectorStatsEl=r;const l=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=0),a<0?a=0:a>100&&(a=100),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("max_cosine",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] max_cosine ->",e,"from",n)};return i.addEventListener("input",()=>{l(i.value,"input"),s.textContent=i.value+" %"}),i.addEventListener("change",()=>{l(i.value,"change"),s.textContent=i.value+" %"}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n.appendChild(r),setTimeout(()=>this._updateCombineStats(),0),n}_createCrossModeRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=!!t?.get?.("cross_mode");const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","cross_mode"),n.setAttribute("data-type","boolean"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("button");a.type="button",a.setAttribute("role","switch"),a.setAttribute("aria-checked",String(e)),a.style.position="relative",a.style.width="48px",a.style.height="22px",a.style.borderRadius="22px",a.style.border="1px solid rgba(255,255,255,.3)",a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",a.style.cursor="pointer",a.style.transition="background .2s, box-shadow .2s",a.style.outline="none",a.style.padding="0",a.style.marginTop="6px";const i=document.createElement("span");i.style.position="absolute",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.left=e?"26px":"4px",i.style.width="16px",i.style.height="16px",i.style.borderRadius="50%",i.style.background="#fff",i.style.boxShadow="0 2px 4px rgba(0,0,0,.4)",i.style.transition="left .2s",a.appendChild(i);const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.flex="0 0 auto";const o=document.createElement("span");o.textContent="跨模式合并",o.style.fontSize="12px",o.style.opacity=".85",o.style.marginBottom="4px",o.style.userSelect="none",s.appendChild(o),s.appendChild(a);const r=(t,n="ui")=>{e=!!t;try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("cross_mode",e),a.setAttribute("aria-checked",String(e)),a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",i.style.left=e?"26px":"4px",this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] cross_mode ->",e,"from",n)};return n.addEventListener("click",t=>{a.contains(t.target)||r(!e,"row")}),a.addEventListener("click",()=>r(!e,"click")),a.addEventListener("keydown",t=>{" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),r(!e,"key"))}),n.appendChild(s),n}_createNormalizeRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings,e=!!t?.get?.("trim_ending"),n=!!t?.get?.("trim_space"),a=!!t?.get?.("trim_width");let i=e&&n&&a;const s=document.createElement("div");s.className="danmaku-setting-row",s.setAttribute("data-key","text_normalize"),s.setAttribute("data-type","boolean-group"),s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.justifyContent="center",s.style.gap="6px",s.style.textAlign="center";const o=document.createElement("button");o.type="button",o.setAttribute("role","switch"),o.setAttribute("aria-checked",String(i)),o.style.position="relative",o.style.width="48px",o.style.height="22px",o.style.borderRadius="22px",o.style.border="1px solid rgba(255,255,255,.3)",o.style.background=i?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",o.style.cursor="pointer",o.style.transition="background .2s, box-shadow .2s",o.style.outline="none",o.style.padding="0",o.style.marginTop="6px";const r=document.createElement("span");r.style.position="absolute",r.style.top="50%",r.style.transform="translateY(-50%)",r.style.left=i?"26px":"4px",r.style.width="16px",r.style.height="16px",r.style.borderRadius="50%",r.style.background="#fff",r.style.boxShadow="0 2px 4px rgba(0,0,0,.4)",r.style.transition="left .2s",o.appendChild(r);const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.alignItems="center",l.style.flex="0 0 auto";const d=document.createElement("span");d.textContent="文本规范化",d.style.fontSize="12px",d.style.opacity=".85",d.style.marginBottom="4px",d.style.userSelect="none",l.appendChild(d),l.appendChild(o);const c=(t,e="ui")=>{i=!!t;try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("trim_ending",i),t?.set?.("trim_space",i),t?.set?.("trim_width",i),o.setAttribute("aria-checked",String(i)),o.style.background=i?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",r.style.left=i?"26px":"4px",this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] text_normalize ->",i,"from",e)};return s.addEventListener("click",t=>{o.contains(t.target)||c(!i,"row")}),o.addEventListener("click",()=>c(!i,"click")),o.addEventListener("keydown",t=>{" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),c(!i,"key"))}),s.appendChild(l),s}_createThresholdSecondsRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("threshold_seconds");"number"==typeof e&&Number.isFinite(e)||(e=1),e<1?e=1:e>30&&(e=30);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","threshold_seconds"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="合并时间窗口",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="1",i.max="30",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e)+" 秒",s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=1),a<1?a=1:a>30&&(a=30),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("threshold_seconds",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] threshold_seconds ->",e,"from",n)};return i.addEventListener("input",()=>{r(i.value,"input"),s.textContent=i.value+" 秒"}),i.addEventListener("change",()=>{r(i.value,"change"),s.textContent=i.value+" 秒"}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n}_createMaxChunkSizeRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("max_chunk_size");"number"==typeof e&&Number.isFinite(e)||(e=10),e<10?e=10:e>1e3&&(e=1e3);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","max_chunk_size"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="处理块最大数量",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="10",i.max="1000",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e)+" 条",s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=10),a<10?a=10:a>1e3&&(a=1e3),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("max_chunk_size",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] max_chunk_size ->",e,"from",n)};return i.addEventListener("input",()=>{r(i.value,"input"),s.textContent=i.value+" 条"}),i.addEventListener("change",()=>{r(i.value,"change"),s.textContent=i.value+" 条"}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n}_createEnableCombineRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=!!t?.get?.("enable_combine");const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","enable_combine"),n.setAttribute("data-type","boolean"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("button");a.type="button",a.setAttribute("role","switch"),a.setAttribute("aria-checked",String(e)),a.style.position="relative",a.style.width="48px",a.style.height="22px",a.style.borderRadius="22px",a.style.border="1px solid rgba(255,255,255,.3)",a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",a.style.cursor="pointer",a.style.transition="background .2s, box-shadow .2s",a.style.outline="none",a.style.padding="0",a.style.marginTop="6px";const i=document.createElement("span");i.style.position="absolute",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.left=e?"26px":"4px",i.style.width="16px",i.style.height="16px",i.style.borderRadius="50%",i.style.background="#fff",i.style.boxShadow="0 2px 4px rgba(0,0,0,.4)",i.style.transition="left .2s",a.appendChild(i);const s=document.createElement("span");s.style.fontSize="16px",s.style.fontWeight="600",s.style.letterSpacing=".5px",s.style.whiteSpace="nowrap",s.style.flex="0 0 auto",s.style.maxWidth="180px",s.style.overflow="hidden",s.style.textOverflow="ellipsis",s.style.textAlign="center",this._combineStatsEl=s;const o=(t,n="ui")=>{e=!!t;try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("enable_combine",e),a.setAttribute("aria-checked",String(e)),a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",i.style.left=e?"26px":"4px",this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] enable_combine ->",e,"from",n)};n.addEventListener("click",t=>{a.contains(t.target)||o(!e,"row")}),a.addEventListener("click",()=>o(!e,"click")),a.addEventListener("keydown",t=>{" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),o(!e,"key"))});const r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.alignItems="center",r.style.flex="0 0 auto";const l=document.createElement("span");return l.textContent="合并总开关",l.style.fontSize="12px",l.style.opacity=".85",l.style.marginBottom="4px",l.style.userSelect="none",r.appendChild(l),r.appendChild(a),n.appendChild(r),n.appendChild(s),setTimeout(()=>this._updateCombineStats(),0),n}_createModeElevationRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=!!t?.get?.("mode_elevation");const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","mode_elevation"),n.setAttribute("data-type","boolean"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("button");a.type="button",a.setAttribute("role","switch"),a.setAttribute("aria-checked",String(e)),a.style.position="relative",a.style.width="48px",a.style.height="22px",a.style.borderRadius="22px",a.style.border="1px solid rgba(255,255,255,.3)",a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",a.style.cursor="pointer",a.style.transition="background .2s, box-shadow .2s",a.style.outline="none",a.style.padding="0",a.style.marginTop="6px";const i=document.createElement("span");i.style.position="absolute",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.left=e?"26px":"4px",i.style.width="16px",i.style.height="16px",i.style.borderRadius="50%",i.style.background="#fff",i.style.boxShadow="0 2px 4px rgba(0,0,0,.4)",i.style.transition="left .2s",a.appendChild(i);const s=document.createElement("div");s.style.display="flex",s.style.flexDirection="column",s.style.alignItems="center",s.style.flex="0 0 auto";const o=document.createElement("span");o.textContent="合并后尽量显示为静态",o.style.fontSize="12px",o.style.opacity=".85",o.style.marginBottom="4px",o.style.userSelect="none",s.appendChild(o),s.appendChild(a);const r=(t,n="ui")=>{e=!!t;try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("mode_elevation",e),a.setAttribute("aria-checked",String(e)),a.style.background=e?"linear-gradient(90deg,#3fa9ff,#0c82d8)":"rgba(255,255,255,.15)",i.style.left=e?"26px":"4px",this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] mode_elevation ->",e,"from",n)};return n.addEventListener("click",t=>{a.contains(t.target)||r(!e,"row")}),a.addEventListener("click",()=>r(!e,"click")),a.addEventListener("keydown",t=>{" "!==t.key&&"Enter"!==t.key||(t.preventDefault(),r(!e,"key"))}),n.appendChild(s),n}_createScrollThresholdRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("scroll_threshold");"number"==typeof e&&Number.isFinite(e)||(e=0),e<0?e=0:e>1920&&(e=1920);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","scroll_threshold"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="过长静态弹幕转为滚动阈值",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="0",i.max="1920",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e)+" px",s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=0),a<0?a=0:a>1920&&(a=1920),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("scroll_threshold",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] scroll_threshold ->",e,"from",n)};return i.addEventListener("input",()=>{r(i.value,"input"),s.textContent=i.value+" px"}),i.addEventListener("change",()=>{r(i.value,"change"),s.textContent=i.value+" px"}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n}_createShrinkThresholdRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("shrink_threshold");"number"==typeof e&&Number.isFinite(e)||(e=0),e<0?e=0:e>500&&(e=500);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","shrink_threshold"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="弹幕缩小阈值",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="0",i.max="500",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e)+" 条",s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=0),a<0?a=0:a>500&&(a=500),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("shrink_threshold",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] shrink_threshold ->",e,"from",n)};return i.addEventListener("input",()=>{r(i.value,"input"),s.textContent=i.value+" 条"}),i.addEventListener("change",()=>{r(i.value,"change"),s.textContent=i.value+" 条"}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n}_createDropThresholdRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings;let e=t?.get?.("drop_threshold");"number"==typeof e&&Number.isFinite(e)||(e=0),e<0?e=0:e>500&&(e=500);const n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","drop_threshold"),n.setAttribute("data-type","range"),n.style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.gap="6px",n.style.textAlign="center";const a=document.createElement("span");a.textContent="丢弃弹幕阈值",a.style.fontSize="12px",a.style.opacity=".85",a.style.userSelect="none";const i=document.createElement("input");i.type="range",i.min="0",i.max="500",i.step="1",i.value=String(e),i.style.width="140px",i.style.cursor="pointer",i.style.accentColor="#3fa9ff";const s=document.createElement("span");s.textContent=String(e)+" 条",s.style.minWidth="0",s.style.textAlign="center",s.style.fontSize="12px",s.style.opacity=".85",s.style.whiteSpace="nowrap",s.style.overflow="hidden",s.style.textOverflow="clip",s.style.flex="0 0 auto",s.style.width="140px";const o=document.createElement("div");o.style.display="flex",o.style.flexDirection="column",o.style.alignItems="center",o.style.gap="4px",o.style.width="100%",o.style.maxWidth="190px",o.appendChild(s),o.appendChild(i);const r=(t,n="ui")=>{let a=parseInt(t,10);Number.isFinite(a)||(a=0),a<0?a=0:a>500&&(a=500),e=a,i.value=String(a);try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings;t?.set?.("drop_threshold",a),this._ensureCombineUpdate()}catch(t){}this.logger?.info?.("[CombineSettings] drop_threshold ->",e,"from",n)};return i.addEventListener("input",()=>{r(i.value,"input"),s.textContent=i.value+" 条"}),i.addEventListener("change",()=>{r(i.value,"change"),s.textContent=i.value+" 条"}),n.addEventListener("click",()=>i.focus()),n.appendChild(a),n.appendChild(o),n}build(){const t=document.createElement("div");t.className="danmaku-settings-tabPanel",t.dataset.key=this.getKey();const e=document.createElement("div");e.className="danmaku-settings-list",e.style.display="grid",e.style.gridTemplateColumns="repeat(2, minmax(0, 1fr))",e.style.columnGap="16px",e.style.rowGap="14px",e.style.alignItems="stretch",e.style.width="100%";const n=this._createEnableCombineRow(),a=this._createCombineTimeRow();try{const t=t=>{t.style.position="sticky",t.style.top="0px",t.style.zIndex="10",t.style.background="rgba(30,30,30,0.92)",t.style.borderBottom="1px solid rgba(255,255,255,.12)",t.style.boxShadow="0 2px 6px rgba(0,0,0,.25)"};t(n),t(a)}catch(t){}e.appendChild(n),e.appendChild(a),e.appendChild(this._createMarkStyleRow()),e.appendChild(this._createMarkThresholdRow()),e.appendChild(this._createThresholdSecondsRow()),e.appendChild(this._createEnlargeRow()),e.appendChild(this._createEditDistanceRow()),e.appendChild(this._createVectorRow()),e.appendChild(this._createUsePinyinRow()),e.appendChild(this._createMaxChunkSizeRow()),e.appendChild(this._createCrossModeRow()),e.appendChild(this._createNormalizeRow()),e.appendChild(this._createModeElevationRow()),e.appendChild(this._createScrollThresholdRow()),e.appendChild(this._createShrinkThresholdRow()),e.appendChild(this._createDropThresholdRow());const i=document.createElement("div");return i.style.padding="6px 2px",i.style.textAlign="center",i.style.opacity=".55",i.style.fontSize="12px",i.style.gridColumn="1 / span 2",e.appendChild(i),t.appendChild(e),t}}class _{constructor(t={}){this.logger=t.logger||null,this._sectionUpdaters=[]}getKey(){return"filter"}getLabel(){return"过滤规则"}_commit(t,e,n="manual"){try{const a=window.__jfDanmakuGlobal__.danmakuSettings;let i=e;if(Array.isArray(e))try{i=JSON.stringify(e)}catch(t){i="[]"}a?.set?.(t,i);const s=p(this.logger);s&&s.then(()=>{try{this._sectionUpdaters.forEach(t=>{try{t()}catch(t){}})}catch(t){}}),this.logger?.info?.("[FilterSettings]",t,"updated via",n,e)}catch(e){this.logger?.warn?.("[FilterSettings] commit failed",t,e)}}_createSection(t){const{key:e,label:n,type:a}=t,i=document.createElement("div");i.className="danmaku-setting-row",i.setAttribute("data-key",e),i.setAttribute("data-type","list");const s=document.createElement("div");s.className="danmaku-setting-row__label",s.style.cursor="pointer";const o=document.createElement("span");o.className="danmaku-setting-row__labelText",o.textContent=n,s.appendChild(o);const r=document.createElement("span");r.style.fontSize="11px",r.style.opacity=".75",r.textContent="0",s.appendChild(r);const l=document.createElement("span");l.textContent="▸",l.style.marginLeft="6px",l.style.transition="transform .18s",s.appendChild(l),i.appendChild(s);const d=document.createElement("div");d.style.marginTop="6px",d.style.display="none",d.style.padding="4px 2px 2px",d.style.borderTop="1px solid rgba(255,255,255,.12)",d.style.display="none";const c=document.createElement("div");c.style.display="flex",c.style.flexDirection="column",c.style.gap="4px",d.appendChild(c);const h=document.createElement("div");h.className="danmaku-setting-row__desc",h.style.marginTop="4px",h.textContent="repl"===a?"替换名单: 正则/纯文本 pattern 匹配后替换为 replace":"支持纯文本或正则 (切换开关)。",d.appendChild(h),i.appendChild(d);let u=[];try{const t=window?.__jfDanmakuGlobal__?.danmakuSettings||null,n=t?.get?.(e);if(Array.isArray(n))u=n;else if("string"==typeof n){const t=n.trim();if(t)try{const e=JSON.parse(t);Array.isArray(e)&&(u=e)}catch(t){}}Array.isArray(u)||(u=[])}catch(t){u=[]}let p=!1;s.addEventListener("click",()=>{p=!p,d.style.display=p?"block":"none",l.style.transform=p?"rotate(90deg)":"rotate(0deg)"});const m=()=>{try{const t=window.__jfDanmakuGlobal__||{},n=t?.danmakuData?.rule_counts,a={white_list:"whitelist",black_list:"blacklist",force_list:"forcelist"}[e];let i=0;if(n&&a&&null!=n[a]){const t=Number(n[a]);if(Number.isFinite(t))i=t;else if("string"==typeof n[a]&&""!==n[a].trim()){const t=Number(n[a].trim());Number.isFinite(t)&&(i=t)}}r.textContent=`规则数:${u.length} 命中次数:${i}`}catch(t){r.textContent=`规则数:${u.length} 命中次数:0`}},y=()=>{c.innerHTML="",r.textContent=`规则数:${u.length} 命中次数:--`;const t=(t="bottom")=>{const n=document.createElement("button");n.type="button",n.textContent="+ 添加",n.style.width="100%",n.style.padding="6px 8px",n.style.fontSize="12px",n.style.background="rgba(255,255,255,.08)",n.style.color="#fff",n.style.border="1px dashed rgba(255,255,255,.3)",n.style.borderRadius="6px",n.style.cursor="pointer",n.addEventListener("mouseenter",()=>n.style.background="rgba(255,255,255,.15)"),n.addEventListener("mouseleave",()=>n.style.background="rgba(255,255,255,.08)"),n.addEventListener("click",()=>{"repl"===a?u.push({pattern:"",replace:""}):u.push({isRegex:!1,pattern:""}),this._commit(e,u,"add"),y()}),c.appendChild(n)};0!==u.length?(u.forEach((t,n)=>{const i=document.createElement("div");if(i.style.display="flex",i.style.alignItems="center",i.style.gap="6px",i.style.padding="6px 6px",i.style.background="rgba(255,255,255,.05)",i.style.border="1px solid rgba(255,255,255,.15)",i.style.borderRadius="6px",i.style.position="relative","repl"!==a){const n=document.createElement("button");n.type="button",n.textContent=t.isRegex?"正则":"文本",n.style.minWidth="44px",n.style.fontSize="11px",n.style.padding="4px 6px",n.style.border="1px solid rgba(255,255,255,.25)",n.style.borderRadius="4px",n.style.background=t.isRegex?"#3fa9ff":"rgba(255,255,255,.12)",n.style.cursor="pointer",n.addEventListener("click",()=>{t.isRegex=!t.isRegex,n.textContent=t.isRegex?"正则":"文本",n.style.background=t.isRegex?"#3fa9ff":"rgba(255,255,255,.12)",this._commit(e,u,"toggle")}),i.appendChild(n)}const s=document.createElement("input");if(s.type="text",s.placeholder="pattern",s.value=t.pattern||"",s.className="danmaku-setting-input",s.style.flex="1 1 auto",s.style.minWidth="120px",s.addEventListener("input",()=>{t.pattern=s.value}),s.addEventListener("change",()=>{this._commit(e,u,"pattern-change")}),i.appendChild(s),"repl"===a){const n=document.createElement("input");n.type="text",n.placeholder="replace",n.value=t.replace||"",n.className="danmaku-setting-input",n.style.flex="1 1 auto",n.style.minWidth="120px",n.addEventListener("input",()=>{t.replace=n.value}),n.addEventListener("change",()=>{this._commit(e,u,"replace-change")}),i.appendChild(n)}const o=document.createElement("button");o.type="button",o.textContent="✕",o.title="删除",o.style.padding="4px 6px",o.style.fontSize="12px",o.style.background="rgba(255,80,80,.25)",o.style.border="1px solid rgba(255,80,80,.4)",o.style.borderRadius="4px",o.style.cursor="pointer",o.addEventListener("mouseenter",()=>o.style.background="rgba(255,80,80,.4)"),o.addEventListener("mouseleave",()=>o.style.background="rgba(255,80,80,.25)"),o.addEventListener("click",()=>{u.splice(n,1),this._commit(e,u,"delete"),y()}),i.appendChild(o),c.appendChild(i)}),t("bottom"),m()):t("top")};return y(),this._sectionUpdaters.push(m),setTimeout(m,0),i}build(){const t=document.createElement("div");t.className="danmaku-settings-tabPanel",t.dataset.key=this.getKey();const e=document.createElement("div");e.className="danmaku-settings-list",e.appendChild(this._createSection({key:"white_list",label:"白名单",type:"wl"})),e.appendChild(this._createSection({key:"black_list",label:"黑名单",type:"bl"})),e.appendChild(this._createSection({key:"force_list",label:"替换名单",type:"repl"}));const n=document.createElement("div");return n.className="danmaku-setting-row__desc",n.style.marginTop="8px",n.style.opacity=".85",n.innerHTML="白名单: 命中时无视合并规则<br>黑名单: 命中时直接删除<br>替换名单: 命中时替换文本后继续处理<br>需要开启弹幕合并总开关才能生效",e.appendChild(n),t.appendChild(e),t}}class b{constructor(t={}){this.logger=t.logger||null,this._balls=[],this._raf=null,this._lastT=0,this._boxEl=null,this._panel=null,this._resizeOb=null,this._activeMo=null,this._trashZoneEl=null}getKey(){return"commentpool"}getLabel(){return"弹幕池"}_readStats(){try{const t=window.__jfDanmakuGlobal__||{},e=t?.danmakuData?.source_stats;if(!e||"object"!=typeof e)return null;const n=Object.entries(e).map(([t,e])=>({name:t,count:Number(e)||0})).filter(t=>t.count>0);return n.length?n:null}catch(t){return null}}_readInitialBlacklist(){try{const t=window.__jfDanmakuGlobal__||{},e=t?.danmakuData?.settings?.black_source_list;let n=[];if(Array.isArray(e))n=e;else if("string"==typeof e){const t=e.trim();if(t)try{const e=JSON.parse(t);n=Array.isArray(e)?e:t.split(",")}catch(e){n=t.split(",")}}const a=n.map(t=>String(t).trim()).filter(Boolean),i=new Set(a.map(t=>t.toLowerCase()));return{list:a,set:i}}catch(t){return{list:[],set:new Set}}}_createBox(){const t=document.createElement("div");return t.style.position="relative",t.style.width="100%",t.style.height="260px",t.style.background="rgba(255,255,255,.05)",t.style.border="1px solid rgba(255,255,255,.15)",t.style.borderRadius="10px",t.style.overflow="hidden",t.style.touchAction="pan-y",t.style.userSelect="none",t}_makeBallEl(t,e){const n=String(t??"").split("\n"),a=(n[0]||"").trim(),i=(n[1]||"").trim(),s=a?a[0]:"·",o=document.createElement("div");o.style.position="absolute",o.style.left="0px",o.style.top="0px",o.style.width="40px",o.style.height="40px",o.style.borderRadius="50%",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.color="#fff",o.style.textAlign="center",o.style.padding="4px",o.style.boxSizing="border-box",o.style.cursor="grab",o.style.touchAction="none",o.style.willChange="transform",o.style.background=`radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.05) 35%), ${e}`,o.style.boxShadow="0 4px 10px rgba(0,0,0,.35)",o.title=a?`${a} (${i||"0"})`:i||"";const r=document.createElement("div");r.className="jf-ball-bg",r.style.position="absolute",r.style.inset="0",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.pointerEvents="none",r.style.userSelect="none",r.style.fontWeight="800",r.style.lineHeight="1",r.style.letterSpacing="0",r.style.color="rgba(255,255,255,.12)",r.style.textShadow="0 1px 2px rgba(0,0,0,.2)",r.style.zIndex="0",r.textContent=s;const l=document.createElement("div");return l.className="jf-ball-count",l.style.position="relative",l.style.zIndex="1",l.style.fontSize="12px",l.style.fontWeight="600",l.style.textShadow="0 1px 2px rgba(0,0,0,.35)",l.textContent=i||"",o.appendChild(r),o.appendChild(l),o._bgWatermark=r,o}_colorForIndex(t){const e=["linear-gradient(135deg,#3fa9ff,#0c82d8)","linear-gradient(135deg,#ff7a59,#ff3d6e)","linear-gradient(135deg,#6bd06b,#2fbf71)","linear-gradient(135deg,#a78bfa,#6d28d9)","linear-gradient(135deg,#fbbf24,#f59e0b)","linear-gradient(135deg,#34d399,#10b981)","linear-gradient(135deg,#f472b6,#ec4899)"];return e[t%e.length]}_initBalls(t){const e=this._boxEl.getBoundingClientRect(),n=Math.max(50,e.width),a=Math.max(50,e.height),i=Math.max(...t.map(t=>t.count));this._balls=t.map((t,e)=>{const s=14+(i>0?t.count/i*30:0),o=this._makeBallEl(`${t.name}\n${t.count}`,this._colorForIndex(e));o.style.width=`${Math.round(2*s)}px`,o.style.height=`${Math.round(2*s)}px`;const r=Math.max(12,Math.round(1.1*s));o._bgWatermark&&(o._bgWatermark.style.fontSize=`${r}px`),this._boxEl.appendChild(o);let l=s+Math.random()*(n-2*s),d=s+Math.random()*(a-2*s),c=0;const h={x:l,y:d,r:s};for(;c++<50&&this._balls?.length;){let t=!1;for(const e of this._balls){const n=h.x-e.x,a=h.y-e.y;if(Math.hypot(n,a)<h.r+e.r+2){t=!0;break}}if(!t)break;h.x=s+Math.random()*(n-2*s),h.y=s+Math.random()*(a-2*s)}l=h.x,d=h.y;const u=s*s,p=Math.random()*Math.PI*2,m=40+80*Math.random(),y={el:o,name:t.name,count:t.count,x:l,y:d,vx:0,vy:0,r:s,mass:u,dragging:!1,_px:0,_py:0,_pt:0,_driftFx:0,_driftFy:0,_driftTargetFx:Math.cos(p)*m,_driftTargetFy:Math.sin(p)*m,_driftNext:performance.now()+(150+200*Math.random())};return this._attachDrag(y),y})}_attachDrag(t){const e=e=>{if("number"!=typeof e.button||0===e.button){try{t.el.setPointerCapture?.(e.pointerId)}catch(t){}if(t.dragging=!0,t.el.style.cursor="grabbing",t.vx=0,t.vy=0,t.inTrash){const n=t.r;t._ghostEl||this._createGhostEl(t),t.el.style.visibility="hidden",t._ghostEl.style.left=`${Math.round(e.clientX-n)}px`,t._ghostEl.style.top=`${Math.round(e.clientY-n)}px`;const a=performance.now();t._pt=a,t._px=e.clientX,t._py=e.clientY}else{const n=this._toLocal(e.clientX,e.clientY);t._offsetX=n.x-t.x,t._offsetY=n.y-t.y,t._px=n.x,t._py=n.y,t._pt=performance.now()}e.preventDefault?.(),e.stopPropagation?.()}else try{e.preventDefault?.(),e.stopPropagation?.(),e.stopImmediatePropagation?.()}catch(t){}},n=e=>{if(t.dragging){try{e.preventDefault?.()}catch(t){}if(t.inTrash){t._ghostEl||this._createGhostEl(t);const n=t.r,a=Math.round(e.clientX-n),i=Math.round(e.clientY-n);t._ghostEl.style.left=`${a}px`,t._ghostEl.style.top=`${i}px`}else{if(this._isPointInBox(e.clientX,e.clientY)){t._ghostEl&&this._removeGhostEl(t),"hidden"===t.el.style.visibility&&(t.el.style.visibility="visible");const n=this._toLocal(e.clientX,e.clientY),a=n.x-t._offsetX,i=n.y-t._offsetY,s=this._boxEl.getBoundingClientRect(),o=s.width,r=s.height,l=t.r;t.x=Math.max(l,Math.min(o-l,a)),t.y=Math.max(l,Math.min(r-l,i));const d=performance.now(),c=Math.max(1,d-(t._pt||d));t.vx=(n.x-(t._px||n.x))/c*16,t.vy=(n.y-(t._py||n.y))/c*16,t._px=n.x,t._py=n.y,t._pt=d}else{t._ghostEl||this._createGhostEl(t),"hidden"!==t.el.style.visibility&&(t.el.style.visibility="hidden");const n=t.r,a=Math.round(e.clientX-n),i=Math.round(e.clientY-n);t._ghostEl.style.left=`${a}px`,t._ghostEl.style.top=`${i}px`}}if(this._trashZoneEl)try{const n=this._trashZoneEl.getBoundingClientRect(),a=e.clientX>=n.left&&e.clientX<=n.right&&e.clientY>=n.top&&e.clientY<=n.bottom;t._overTrash=!!a,this._trashZoneEl.style.outlineColor=a?"rgba(255,80,80,.95)":"rgba(255,255,255,.25)",this._trashZoneEl.style.background=a?"linear-gradient(135deg, rgba(255,64,64,.25), rgba(255,0,0,.12))":"rgba(255,255,255,.04)"}catch(t){}}},a=async e=>{const n=t.dragging;t.dragging=!1,t.el.style.cursor="grab";try{t.el.releasePointerCapture?.(e.pointerId)}catch(t){}if(!n)return;const a=this._isPointInTrash(e.clientX,e.clientY),i="touch"===e.pointerType?Math.max(24,Math.min(48,Math.round(t.r))):0,s=this._isPointInBox(e.clientX,e.clientY),o=i>0&&this._isPointNearBox(e.clientX,e.clientY,i);return null!=t._prevPosStyle&&(t.el.style.position=t._prevPosStyle,t.el.style.left=t._prevLeft||"",t.el.style.top=t._prevTop||"",t.el.style.transform=t._prevTransform||"",t._prevPosStyle=null,t._prevLeft=null,t._prevTop=null,t._prevTransform=null),!t.inTrash&&a?(t._ghostEl&&this._removeGhostEl(t),"hidden"===t.el.style.visibility&&(t.el.style.visibility="visible"),void await this._moveBallToTrash(t)):t.inTrash&&(s||o)?(t._ghostEl&&this._removeGhostEl(t),"hidden"===t.el.style.visibility&&(t.el.style.visibility="visible"),void await this._moveBallBackToBox(t,e.clientX,e.clientY)):t.inTrash&&!s||!t.inTrash&&s?(t._ghostEl&&this._removeGhostEl(t),void("hidden"===t.el.style.visibility&&(t.el.style.visibility="visible"))):t.inTrash||a||s?void 0:(t._ghostEl&&this._removeGhostEl(t),void("hidden"===t.el.style.visibility&&(t.el.style.visibility="visible")))},i=t=>{try{a(t)}catch(t){}},s=e=>{try{if("mouse"!==(e.pointerType||"mouse"))return;if(t.dragging||t.inTrash)return;t.hoverPause=!0,t._preHoverVx=t.vx,t._preHoverVy=t.vy,t.vx=0,t.vy=0}catch(t){}},o=e=>{try{if("mouse"!==(e.pointerType||"mouse"))return;t.hoverPause=!1}catch(t){}},r=e=>{try{e.preventDefault?.(),e.stopPropagation?.()}catch(t){}this._showBallMenu(t,e.clientX,e.clientY)};t.el.addEventListener("pointerdown",e),window.addEventListener("pointermove",n,{passive:!1}),window.addEventListener("pointerup",a,{passive:!0}),window.addEventListener("pointercancel",i,{passive:!0}),t.el.addEventListener("pointerenter",s),t.el.addEventListener("pointerleave",o),t.el.addEventListener("contextmenu",r,{capture:!0}),t._onDown=e,t._onMove=n,t._onUp=a,t._onCancel=i,t._onEnter=s,t._onLeave=o,t._onCtx=r}_showBallMenu(t,e,n){try{this._closeMenu()}catch(t){}const a=document.createElement("div");a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.background="rgba(20,20,20,.96)",a.style.backdropFilter="blur(4px)",a.style.border="1px solid rgba(255,255,255,.15)",a.style.borderRadius="8px",a.style.boxShadow="0 8px 24px rgba(0,0,0,.45)",a.style.padding="6px",a.style.minWidth="160px",a.style.color="#fff",a.style.zIndex="999999",a.style.fontSize="12px",a.style.userSelect="none";const i=(t,e,{danger:n=!1,disabled:i=!1}={})=>{const s=document.createElement("div");return s.textContent=t,s.style.padding="8px 10px",s.style.borderRadius="6px",s.style.cursor=i?"not-allowed":"pointer",s.style.opacity=i?".45":"1",s.style.color=n?"rgb(255,120,120)":"#fff",s.addEventListener("mouseenter",()=>{i||(s.style.background="rgba(255,255,255,.08)")}),s.addEventListener("mouseleave",()=>{s.style.background="transparent"}),i||"function"!=typeof e||s.addEventListener("click",async()=>{try{await e()}finally{this._closeMenu()}}),a.appendChild(s),s};t.inTrash?i("移出黑名单",async()=>{await this._moveBallBackToBox(t,e,n)}):i("加入黑名单",async()=>{await this._moveBallToTrash(t,!0)},{danger:!0}),i("查看来源信息（暂未实现）",()=>{},{disabled:!0}),i("更多操作（暂未实现）",()=>{},{disabled:!0}),i("取消",()=>{});const s=this._panel||document.body;s.appendChild(a);const o=t=>{try{t.stopPropagation(),t.stopImmediatePropagation?.()}catch(t){}},r=t=>{try{t.stopPropagation()}catch(t){}};a.addEventListener("pointerdown",o,{capture:!0}),a.addEventListener("pointerup",o,{capture:!0}),a.addEventListener("contextmenu",o,{capture:!0}),a.addEventListener("click",r,{capture:!1}),this._stopMenuCap=o,this._stopMenuBubble=r;try{const t=a.offsetWidth||160,i=a.offsetHeight||10,o=s.getBoundingClientRect();let r=e-o.left,l=n-o.top;r=Math.min(Math.max(8,r),Math.max(8,o.width-t-8)),l=Math.min(Math.max(8,l),Math.max(8,o.height-i-8)),a.style.left=`${r}px`,a.style.top=`${l}px`}catch(t){}const l=t=>{try{a.contains(t.target)||this._closeMenu()}catch(t){}},d=t=>{"Escape"===t.key&&this._closeMenu()},c=()=>{this._closeMenu()};setTimeout(()=>{document.addEventListener("pointerdown",l,{passive:!0,capture:!0}),window.addEventListener("scroll",c,{passive:!0}),window.addEventListener("resize",c,{passive:!0}),window.addEventListener("keydown",d,{passive:!0})},0),this._menuEl=a,this._menuBallRef=t,this._onMenuDocDown=l,this._onMenuScroll=c,this._onMenuKey=d}_closeMenu(){try{if(this._menuEl?.parentElement){try{this._stopMenuCap&&(this._menuEl.removeEventListener("pointerdown",this._stopMenuCap,{capture:!0}),this._menuEl.removeEventListener("pointerup",this._stopMenuCap,{capture:!0}),this._menuEl.removeEventListener("contextmenu",this._stopMenuCap,{capture:!0})),this._stopMenuBubble&&this._menuEl.removeEventListener("click",this._stopMenuBubble,{capture:!1})}catch(t){}this._menuEl.parentElement.removeChild(this._menuEl)}}catch(t){}try{this._onMenuDocDown&&document.removeEventListener("pointerdown",this._onMenuDocDown,{capture:!0})}catch(t){}try{this._onMenuScroll&&window.removeEventListener("scroll",this._onMenuScroll)}catch(t){}try{this._onMenuScroll&&window.removeEventListener("resize",this._onMenuScroll)}catch(t){}try{this._onMenuKey&&window.removeEventListener("keydown",this._onMenuKey)}catch(t){}this._menuEl=null,this._menuBallRef=null,this._stopMenuBubble=null,this._stopMenuCap=null,this._onMenuDocDown=null,this._onMenuScroll=null,this._onMenuKey=null}_isPointInTrash(t,e){try{if(!this._trashZoneEl)return!1;const n=this._trashZoneEl.getBoundingClientRect();return t>=n.left&&t<=n.right&&e>=n.top&&e<=n.bottom}catch(t){return!1}}_isPointInBox(t,e){try{if(!this._boxEl)return!1;const n=this._boxEl.getBoundingClientRect();return t>=n.left&&t<=n.right&&e>=n.top&&e<=n.bottom}catch(t){return!1}}_isPointNearBox(t,e,n=24){try{if(!this._boxEl)return!1;const a=this._boxEl.getBoundingClientRect(),i={left:a.left-n,top:a.top-n,right:a.right+n,bottom:a.bottom+n};return t>=i.left&&t<=i.right&&e>=i.top&&e<=i.bottom}catch(t){return!1}}_createGhostEl(t){try{const e=document.createElement("div"),n=Math.round(2*t.r);e.style.position="fixed",e.style.left="0px",e.style.top="0px",e.style.width=`${n}px`,e.style.height=`${n}px`,e.style.borderRadius="50%",e.style.pointerEvents="none",e.style.backdropFilter="none",e.style.filter="none",e.style.opacity="0.7",e.style.boxShadow="0 6px 16px rgba(0,0,0,.35)",e.style.background=t.el.style.background||"rgba(255,255,255,.2)",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.color="#fff",e.style.fontSize="11px",e.style.userSelect="none",e.style.zIndex="999999",e.textContent=t.name||"",document.body.appendChild(e),t._ghostEl=e}catch(t){}}_removeGhostEl(t){try{t?._ghostEl?.parentElement&&t._ghostEl.parentElement.removeChild(t._ghostEl)}catch(t){}t._ghostEl=null}async _moveBallToTrash(t,e=!0){try{this._closeMenu(),t.inTrash=!0,t.vx=0,t.vy=0,t._ghostEl&&this._removeGhostEl(t),t.el.style.visibility="visible",this._trashZoneEl&&t.el?.parentElement!==this._trashZoneEl&&this._trashZoneEl.appendChild(t.el),t.el.style.position="relative",t.el.style.transform="none",t.el.style.left="auto",t.el.style.top="auto",t.el.style.margin="4px",t.el.style.zIndex="1",e&&await this._blacklistUpdate(t.name,!0)}catch(t){this.logger?.warn?.("[CommentPool] 移入垃圾桶失败",t)}finally{this._trashZoneEl&&(this._trashZoneEl.style.outlineColor="rgba(255,255,255,.25)",this._trashZoneEl.style.background="rgba(255,255,255,.04)")}}async _moveBallBackToBox(t,e,n){try{this._closeMenu(),t.inTrash=!1,this._boxEl&&t.el?.parentElement!==this._boxEl&&this._boxEl.appendChild(t.el),t.el.style.margin="0",t.el.style.position="absolute",t.el.style.zIndex="";try{const e=t.r,n=Math.max(12,Math.round(1.1*e));t.el&&t.el._bgWatermark&&(t.el._bgWatermark.style.fontSize=`${n}px`)}catch(t){}const a=this._toLocal(e,n),i=this._boxEl.getBoundingClientRect(),s=i.width,o=i.height,r=t.r;t.x=Math.max(r,Math.min(s-r,a.x)),t.y=Math.max(r,Math.min(o-r,a.y)),await this._blacklistUpdate(t.name,!1)}catch(t){this.logger?.warn?.("[CommentPool] 恢复至主框失败",t)}finally{this._trashZoneEl&&(this._trashZoneEl.style.outlineColor="rgba(255,255,255,.25)",this._trashZoneEl.style.background="rgba(255,255,255,.04)")}}async _blacklistUpdate(t,e){try{const n=(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).danmakuSettings;if(!n?.get||!n?.set)return;const a=n.get("black_source_list")||"";let i=[];if("string"==typeof a&&a.trim())try{const t=JSON.parse(a.trim());Array.isArray(t)&&(i=t)}catch(t){i=a.split(",").map(t=>t.trim()).filter(Boolean)}const s=String(t||"").trim().toLowerCase(),o=i.map(t=>String(t).toLowerCase());e?o.includes(s)||i.push(s):i=i.filter(t=>String(t).toLowerCase()!==s),n.set("black_source_list",JSON.stringify(i));try{p(this.logger)}catch(t){this.logger?.warn?.("[CommentPool] 保存 black_source_list 失败",t)}this.logger?.info?.(`[CommentPool] ${e?"已加入":"已移除"}黑名单来源`,s)}catch(t){this.logger?.warn?.("[CommentPool] 更新黑名单失败",t)}}_toLocal(t,e){const n=this._boxEl.getBoundingClientRect();return{x:t-n.left,y:e-n.top}}_step=t=>{if(!this._boxEl?.isConnected)return void(this._raf=null);if(this._panel&&"true"!==this._panel.getAttribute("data-active"))return void(this._raf=null);const e=Math.min(32,t-(this._lastT||t))||16;this._lastT=t;const n=this._boxEl.getBoundingClientRect(),a=n.width,i=n.height,s=8e-4,o=.9;let r=0,l=0,d=0,c=0;for(const t of this._balls){if(t.inTrash)continue;const e=t.mass||t.r*t.r||1;r+=e,l+=(t.x||0)*e,d+=(t.y||0)*e,c++}if(r>0){const t=.5*r,e=r+t;l=(l+a/2*t)/e,d=(d+i/2*t)/e}else l=a/2,d=i/2;for(const n of this._balls){if(!n.dragging&&!n.inTrash&&!n.hoverPause){const a=n.mass||n.r*n.r||1,i=n.r,o=-(.06*i*n.vx+s*i*i*n.vx*Math.abs(n.vx))/a,r=-(.06*i*n.vy+s*i*i*n.vy*Math.abs(n.vy))/a;n.vx+=o*e,n.vy+=r*e;const h=1e3,u=1500,p=3500;if("number"!=typeof n._driftNext&&(n._driftNext=t+(1500+2e3*Math.random())),t>=n._driftNext){const e=Math.random()*Math.PI*2,a=.4,i=1.2,s=a+Math.random()*(i-a);n._driftTargetFx=Math.cos(e)*s,n._driftTargetFy=Math.sin(e)*s,n._driftNext=t+(u+Math.random()*(p-u))}const m=Math.min(1,e/h);if(n._driftFx=(n._driftFx||0)+((n._driftTargetFx||0)-(n._driftFx||0))*m,n._driftFy=(n._driftFy||0)+((n._driftTargetFy||0)-(n._driftFy||0))*m,n.vx+=(n._driftFx||0)/a*e,n.vy+=(n._driftFy||0)/a*e,c>=1){const t=l-n.x,i=d-n.y,s=70*-Math.PI/180,o=Math.cos(s),r=Math.sin(s),c=t*o-i*r,h=t*r+i*o;n.vx+=.045*c/a*e,n.vy+=.045*h/a*e}Math.abs(n.vx)<.001&&(n.vx=0),Math.abs(n.vy)<.001&&(n.vy=0),n.x+=n.vx*e/16,n.y+=n.vy*e/16}n.inTrash||(n.x<n.r&&(n.x=n.r,n.vx=Math.abs(n.vx)*o),n.x>a-n.r&&(n.x=a-n.r,n.vx=-Math.abs(n.vx)*o),n.y<n.r&&(n.y=n.r,n.vy=Math.abs(n.vy)*o),n.y>i-n.r&&(n.y=i-n.r,n.vy=-Math.abs(n.vy)*o,n.vx*=.285))}for(let t=0;t<this._balls.length;t++)for(let e=t+1;e<this._balls.length;e++){const n=this._balls[t],a=this._balls[e];if(n.inTrash||a.inTrash)continue;const i=a.x-n.x,s=a.y-n.y,o=Math.hypot(i,s)||1e-4,r=n.r+a.r;if(o<r){const t=i/o,e=s/o,l=r-o,d=n.dragging||n.hoverPause?0:1/(n.mass||n.r*n.r||1),c=a.dragging||a.hoverPause?0:1/(a.mass||a.r*a.r||1),h=d+c;if(h>0){const i=l/h;n.x-=t*(i*d),n.y-=e*(i*d),a.x+=t*(i*c),a.y+=e*(i*c)}const u=(a.vx-n.vx)*t+(a.vy-n.vy)*e;if(u<0&&h>0){const i=-1.9*u/h,s=i*t,o=i*e;d>0&&(n.vx-=s*d,n.vy-=o*d),c>0&&(a.vx+=s*c,a.vy+=o*c)}}}for(const t of this._balls){if(t.inTrash)continue;const e=t.x-t.r,n=t.y-t.r;t.el.style.transform=`translate(${Math.round(e)}px, ${Math.round(n)}px)`}this._raf=requestAnimationFrame(this._step)};build(){const t=document.createElement("div");t.className="danmaku-settings-tabPanel",t.dataset.key=this.getKey(),this._panel=t;const e=document.createElement("div");e.className="danmaku-settings-list";const n=document.createElement("div");n.className="danmaku-setting-row";const a=document.createElement("div");a.className="danmaku-setting-row__label";const i=document.createElement("span");i.className="danmaku-setting-row__labelText",i.textContent="弹幕来源",a.appendChild(i),n.appendChild(a);const s=this._createBox();this._boxEl=s,n.appendChild(s),this._trashZoneEl=((t,e="left")=>{const n=document.createElement("div");n.style.flex="1",n.style.minHeight="48px",n.style.border="1px dashed rgba(255,255,255,.25)",n.style.borderRadius="8px",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="left"===e?"flex-start":"flex-end",n.style.padding="8px 10px",n.style.background="rgba(255,255,255,.04)",n.style.outline="2px solid transparent",n.style.outlineColor="rgba(255,255,255,.25)",n.style.flexWrap="wrap",n.style.gap="6px",n.style.position="relative";const a=document.createElement("div");return a.style.position="absolute",a.style.left="0",a.style.top="0",a.style.right="0",a.style.bottom="0",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.pointerEvents="none",a.style.userSelect="none",a.style.fontSize="30px",a.style.fontWeight="700",a.style.letterSpacing="0.3em",a.style.color="rgba(255,255,255,.12)",a.style.textShadow="0 1px 2px rgba(0,0,0,.2)",a.style.zIndex="0",a.textContent=t,n.appendChild(a),n})("黑名单","left"),this._trashZoneEl.style.touchAction="pan-y",this._trashZoneEl.style.margin="8px 0 0 0",n.appendChild(this._trashZoneEl);const o=document.createElement("div");o.className="danmaku-setting-row__desc",o.textContent="";const r=document.createElement("div");r.style.fontWeight="600",r.style.margin="2px 0 6px";const l=document.createElement("div");l.style.display="flex",l.style.flexWrap="wrap",l.style.gap="8px 14px",l.style.alignItems="center",l.style.opacity="0.95",o.appendChild(r),o.appendChild(l);const d=()=>{try{if(!l)return;l.innerHTML="";const t=Array.isArray(this._balls)?this._balls:[];for(const e of t){const t=document.createElement("div");t.style.display="inline-flex",t.style.alignItems="center",t.style.lineHeight="1.3";const n=document.createElement("span");n.style.width="12px",n.style.height="12px",n.style.borderRadius="50%",n.style.display="inline-block",n.style.marginRight="6px",n.style.boxShadow="0 0 0 1px rgba(255,255,255,.25) inset, 0 0 4px rgba(0,0,0,.35)";try{n.style.background=e?.el?.style?.background||"#999"}catch(t){n.style.background="#999"}const a=document.createElement("span");a.style.fontSize="12px",a.style.opacity="0.95",a.textContent=(e?.name??"").toString(),t.appendChild(n),t.appendChild(a),l.appendChild(t)}}catch(t){}};n.appendChild(o),e.appendChild(n),t.appendChild(e);const c=this._readStats();if(!c){const n=document.createElement("div");return n.className="danmaku-setting-row__desc",n.style.opacity=".8",n.textContent="暂无来源统计数据。",e.appendChild(n),t}this._initBalls(c);try{d()}catch(t){}try{const t=this._readInitialBlacklist();if(t&&t.set&&t.set.size){for(const e of this._balls){const n=String(e.name||"").trim().toLowerCase();t.set.has(n)&&this._moveBallToTrash(e,!1).catch(()=>{})}const e=new Set(this._balls.map(t=>String(t.name||"").trim().toLowerCase()));let n=0;for(const a of t.list){const t=String(a||"").trim().toLowerCase();if(!t||e.has(t))continue;const i=14,s=this._colorForIndex(this._balls.length+n++),o=this._makeBallEl(`${a}\n0`,s);o.style.width=2*i+"px",o.style.height=2*i+"px";const r=Math.max(12,Math.round(1.1*i));o._bgWatermark&&(o._bgWatermark.style.fontSize=`${r}px`),this._trashZoneEl&&this._trashZoneEl.appendChild(o),o.style.position="relative",o.style.transform="none",o.style.left="auto",o.style.top="auto",o.style.margin="4px",o.style.zIndex="1";const l=Math.random()*Math.PI*2,d=.4,c=1.2,h=d+Math.random()*(c-d),u={el:o,name:a,count:0,x:i,y:i,vx:0,vy:0,r:i,mass:i*i,dragging:!1,_px:0,_py:0,_pt:0,inTrash:!0,_driftFx:0,_driftFy:0,_driftTargetFx:Math.cos(l)*h,_driftTargetFy:Math.sin(l)*h,_driftNext:performance.now()+(1500+2e3*Math.random())};this._attachDrag(u),this._balls.push(u)}try{d()}catch(t){}}}catch(t){}try{this._activeMo=new MutationObserver(()=>{if(!this._panel?.isConnected)return;"true"===this._panel.getAttribute("data-active")&&!this._raf&&(this._lastT=0,this._raf=requestAnimationFrame(this._step))}),this._activeMo.observe(t,{attributes:!0,attributeFilter:["data-active"]})}catch(t){}try{this._resizeOb=new ResizeObserver(()=>{if(!this._boxEl)return;const{width:t,height:e}=this._boxEl.getBoundingClientRect();for(const n of this._balls)n.x=Math.max(n.r,Math.min(t-n.r,n.x)),n.y=Math.max(n.r,Math.min(e-n.r,n.y))}),this._resizeOb.observe(this._boxEl)}catch(t){}return"true"===t.getAttribute("data-active")&&(this._raf=requestAnimationFrame(this._step)),t}destroy(){try{this._raf&&cancelAnimationFrame(this._raf)}catch(t){}this._raf=null,this._lastT=0;try{this._activeMo?.disconnect()}catch(t){}this._activeMo=null;try{this._resizeOb?.disconnect()}catch(t){}this._resizeOb=null;for(const t of this._balls){if(t?._onDown)try{t.el.removeEventListener("pointerdown",t._onDown)}catch(t){}if(t?._onMove)try{window.removeEventListener("pointermove",t._onMove)}catch(t){}if(t?._onUp)try{window.removeEventListener("pointerup",t._onUp)}catch(t){}if(t?._onCancel)try{window.removeEventListener("pointercancel",t._onCancel)}catch(t){}if(t?._onEnter)try{t.el.removeEventListener("pointerenter",t._onEnter)}catch(t){}if(t?._onLeave)try{t.el.removeEventListener("pointerleave",t._onLeave)}catch(t){}if(t?._onCtx)try{t.el.removeEventListener("contextmenu",t._onCtx)}catch(t){}if(t?._ghostEl)try{this._removeGhostEl(t)}catch(t){}t._onMove=null,t._onUp=null,t._onCancel=null}try{this._closeMenu()}catch(t){}this._trashZoneEl=null}}class x{constructor(t={}){this.logger=t.logger||null}getKey(){return"heatmap"}getLabel(){return"密度图"}_getStyle(){try{const t=(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).danmakuSettings,e=t?.get?.("heatmap_style"),n={lineWidth:1,lineColor:"#3498db",gradientColorStart:"rgba(52, 152, 219, 0.08)",gradientColorEnd:"rgba(52, 152, 219, 0.25)"};if(!e||"string"!=typeof e)return n;try{const t=JSON.parse(e);return{...n,...t||{}}}catch(t){return n}}catch(t){return{lineWidth:1,lineColor:"#3498db",gradientColorStart:"rgba(52, 152, 219, 0.08)",gradientColorEnd:"rgba(52, 152, 219, 0.25)"}}}_setStyle(t={}){try{const e=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},n=e.danmakuSettings,a={...this._getStyle(),...t||{}};n?.set?.("heatmap_style",JSON.stringify(a));try{e.heatmapRenderer?.updateStyles?.({lineWidth:a.lineWidth,lineColor:a.lineColor,gradientColorStart:a.gradientColorStart,gradientColorEnd:a.gradientColorEnd})}catch(t){}try{Promise.resolve().then(function(){return y}).then(t=>t.saveIfAutoOn?.(this.logger))}catch(t){}}catch(t){}}_createLineWidthRow(){const t=this._getStyle(),e=document.createElement("div");e.className="danmaku-setting-row",e.setAttribute("data-key","heatmap_lineWidth"),e.setAttribute("data-type","number");const n=document.createElement("div");n.className="danmaku-setting-row__label";const a=document.createElement("span");a.className="danmaku-setting-row__labelText",a.textContent="线条粗细",n.appendChild(a),e.appendChild(n);const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="8px";const s=document.createElement("input");s.type="range",s.min="0.1",s.max="4.0",s.step="0.1",s.value=String(Number(t.lineWidth??1)),s.style.flex="1 1 auto",s.style.height="24px";const o=document.createElement("div");o.textContent=`${String(Number(t.lineWidth??1))} px`,o.style.minWidth="48px",o.style.textAlign="center",o.style.opacity=".9";const r=(t,e)=>{let n=parseFloat(t);if(isFinite(n)){n<.1?n=.1:n>4&&(n=4),s.value=String(n);try{o.textContent=`${n} px`}catch(t){}this._setStyle({lineWidth:n}),this.logger?.info?.("[HeatmapSettings] lineWidth ->",n,"(from",e,")")}};s.addEventListener("input",()=>r(s.value,"range")),i.appendChild(s),i.appendChild(o),e.appendChild(i);const l=document.createElement("div");return l.className="danmaku-setting-row__desc",e.appendChild(l),e}_createLineColorRow(){const t=this._getStyle(),e=document.createElement("div");e.className="danmaku-setting-row",e.setAttribute("data-key","heatmap_lineColor"),e.setAttribute("data-type","color");const n=document.createElement("div");n.className="danmaku-setting-row__label";const a=document.createElement("span");a.className="danmaku-setting-row__labelText",a.textContent="线条颜色",n.appendChild(a),e.appendChild(n);const i=document.createElement("div");i.style.display="flex",i.style.alignItems="center",i.style.gap="8px";const s=document.createElement("input");s.type="color";const o=t=>{if("string"!=typeof t||!t)return"#3498db";const e=t.match(/^#([0-9a-f]{6})$/i);if(e)return"#"+e[1].toLowerCase();const n=t.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);if(n){const t=Math.max(0,Math.min(255,parseInt(n[1],10))),e=Math.max(0,Math.min(255,parseInt(n[2],10))),a=Math.max(0,Math.min(255,parseInt(n[3],10))),i=t=>t.toString(16).padStart(2,"0");return"#"+i(t)+i(e)+i(a)}return"#3498db"};s.value=o(t.lineColor),s.className="danmaku-setting-input",s.style.width="44px",s.style.padding="0",s.style.height="24px";const r=document.createElement("input");r.type="text",r.value=t.lineColor||"#3498db",r.className="danmaku-setting-input",r.style.flex="1 1 auto";const l=(t,e)=>{if(t&&"string"==typeof t){this._setStyle({lineColor:t});try{s.value=o(t)}catch(t){}try{r.value=t}catch(t){}this.logger?.info?.("[HeatmapSettings] lineColor ->",t,"(from",e,")")}};s.addEventListener("input",()=>l(s.value,"color")),r.addEventListener("change",()=>l(r.value.trim(),"text")),i.appendChild(s),i.appendChild(r),e.appendChild(i);const d=document.createElement("div");return d.className="danmaku-setting-row__desc",e.appendChild(d),e}_createGradientColorsRow(){const t=this._getStyle(),e=document.createElement("div");e.className="danmaku-setting-row",e.setAttribute("data-key","heatmap_gradientColors"),e.setAttribute("data-type","color");const n=document.createElement("div");n.className="danmaku-setting-row__label";const a=document.createElement("span");a.className="danmaku-setting-row__labelText",a.textContent="渐变颜色（起/止）",n.appendChild(a),e.appendChild(n);const i=document.createElement("div");i.style.display="grid",i.style.gridTemplateColumns="auto 1fr auto 1fr",i.style.gap="8px",i.style.alignItems="center";const s=(t,e="#3498db")=>{if("string"!=typeof t||!t)return e;const n=t.match(/^#([0-9a-f]{6})$/i);if(n)return"#"+n[1].toLowerCase();const a=t.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);if(a){const t=Math.max(0,Math.min(255,parseInt(a[1],10))),e=Math.max(0,Math.min(255,parseInt(a[2],10))),n=Math.max(0,Math.min(255,parseInt(a[3],10))),i=t=>t.toString(16).padStart(2,"0");return"#"+i(t)+i(e)+i(n)}return e},o=(t,e)=>{const n="string"==typeof t&&t.match(/rgba\s*\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*([0-9]*\.?[0-9]+)\s*\)/i);if(n){const t=parseFloat(n[1]);return isFinite(t)?Math.max(0,Math.min(1,t)):e}return e},r=(t,e=1)=>{const n=(t||"").replace("#","");if(!/^[0-9a-f]{6}$/i.test(n))return t;return`rgba(${parseInt(n.slice(0,2),16)}, ${parseInt(n.slice(2,4),16)}, ${parseInt(n.slice(4,6),16)}, ${e})`},l=o(t.gradientColorStart,.08),d=o(t.gradientColorEnd,.25),c=document.createElement("input");c.type="color",c.className="danmaku-setting-input",c.style.width="44px",c.style.height="24px",c.style.padding="0",c.value=s(t.gradientColorStart,"#3498db");const h=document.createElement("input");h.type="text",h.className="danmaku-setting-input",h.style.width="100%",h.value=t.gradientColorStart||"rgba(52, 152, 219, 0.08)";const u=document.createElement("input");u.type="color",u.className="danmaku-setting-input",u.style.width="44px",u.style.height="24px",u.style.padding="0",u.value=s(t.gradientColorEnd,"#3498db");const p=document.createElement("input");p.type="text",p.className="danmaku-setting-input",p.style.width="100%",p.value=t.gradientColorEnd||"rgba(52, 152, 219, 0.25)";const m=(t,e)=>{let n=t||"";"color"===e&&(n=r(c.value,l),h.value=n),this._setStyle({gradientColorStart:n}),this.logger?.info?.("[HeatmapSettings] gradientColorStart ->",n,"(from",e,")")},y=(t,e)=>{let n=t||"";"color"===e&&(n=r(u.value,d),p.value=n),this._setStyle({gradientColorEnd:n}),this.logger?.info?.("[HeatmapSettings] gradientColorEnd ->",n,"(from",e,")")};c.addEventListener("input",()=>m(c.value,"color")),h.addEventListener("change",()=>m(h.value.trim(),"text")),u.addEventListener("input",()=>y(u.value,"color")),p.addEventListener("change",()=>y(p.value.trim(),"text")),i.appendChild(c),i.appendChild(h),i.appendChild(u),i.appendChild(p),e.appendChild(i);const g=document.createElement("div");return g.className="danmaku-setting-row__desc",e.appendChild(g),e}_createColorsRow(){const t=this._getStyle(),e=document.createElement("div");e.className="danmaku-setting-row",e.setAttribute("data-key","heatmap_colors"),e.setAttribute("data-type","color");const n=document.createElement("div");n.className="danmaku-setting-row__label";const a=document.createElement("span");a.className="danmaku-setting-row__labelText",a.textContent="颜色设置",n.appendChild(a),e.appendChild(n);const i=document.createElement("div");i.style.display="grid",i.style.gridTemplateColumns="1fr 1fr",i.style.gap="12px",i.style.alignItems="center";const s=(t,e="#3498db")=>{if("string"!=typeof t||!t)return e;const n=t.match(/^#([0-9a-f]{6})$/i);if(n)return"#"+n[1].toLowerCase();const a=t.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);if(a){const t=Math.max(0,Math.min(255,parseInt(a[1],10))),e=Math.max(0,Math.min(255,parseInt(a[2],10))),n=Math.max(0,Math.min(255,parseInt(a[3],10))),i=t=>t.toString(16).padStart(2,"0");return"#"+i(t)+i(e)+i(n)}return e},o=(t,e)=>{const n="string"==typeof t&&t.match(/rgba\s*\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*,\s*([0-9]*\.?[0-9]+)\s*\)/i);if(n){const t=parseFloat(n[1]);return isFinite(t)?Math.max(0,Math.min(1,t)):e}return e},r=(t,e=1)=>{const n=(t||"").replace("#","");if(!/^[0-9a-f]{6}$/i.test(n))return t;return`rgba(${parseInt(n.slice(0,2),16)}, ${parseInt(n.slice(2,4),16)}, ${parseInt(n.slice(4,6),16)}, ${e})`},l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.gap="6px",l.style.position="relative";const d=document.createElement("div");d.style.fontSize="11px",d.style.opacity=".85",d.textContent="线条颜色";const c=document.createElement("div");c.style.width="100%",c.style.maxWidth="280px",c.style.aspectRatio="2 / 1",c.style.borderRadius="6px",c.style.border="1px solid rgba(255,255,255,.25)",c.style.cursor="pointer",c.style.boxShadow="inset 0 0 0 1px rgba(0,0,0,.2)",c.style.position="relative";const h=()=>{const t=this._getStyle().lineColor||"#3498db";c.style.background=t};h();const u=document.createElement("input");u.type="color",u.style.position="absolute",u.style.inset="0",u.style.width="100%",u.style.height="100%",u.style.opacity="0",u.style.cursor="pointer",u.style.border="none",u.style.padding="0",u.style.margin="0",u.style.zIndex="1",u.value=s(t.lineColor,"#3498db"),u.addEventListener("input",()=>{const t=u.value,e=o(this._getStyle().lineColor,1),n=r(t,e);this._setStyle({lineColor:n}),h(),this.logger?.info?.("[HeatmapSettings] lineColor ->",n,"(from overlay picker, keep alpha)")}),l.appendChild(d),l.appendChild(c),c.appendChild(u);const p=document.createElement("div");p.style.position="absolute",p.style.right="4px",p.style.top="0",p.style.width="24px",p.style.height="100%",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.style.zIndex="3";const m=document.createElement("input");m.type="range",m.min="0",m.max="1",m.step="0.01",m.value=String(o(t.lineColor,1)),m.style.appearance="slider-vertical",m.style.WebkitAppearance="slider-vertical",m.style.MozAppearance="slider-vertical",m.style.writingMode="bt-lr",m.style.height="100%",m.style.width="16px",m.style.cursor="pointer",m.addEventListener("input",()=>{const e=Math.max(0,Math.min(1,parseFloat(m.value))),n=this._getStyle(),a=s(n.lineColor,s(t.lineColor,"#3498db")),i=r(a,e);this._setStyle({lineColor:i}),h(),this.logger?.info?.("[HeatmapSettings] lineAlpha ->",e)}),p.appendChild(m),c.appendChild(p),o(t.gradientColorStart,.08),o(t.gradientColorEnd,.25);const y=document.createElement("div");y.style.display="flex",y.style.flexDirection="column",y.style.gap="6px",y.style.position="relative";const g=document.createElement("div");g.style.fontSize="11px",g.style.opacity=".85",g.textContent="渐变填充颜色";const f=document.createElement("div");f.style.width="100%",f.style.maxWidth="280px",f.style.aspectRatio="2 / 1",f.style.borderRadius="6px",f.style.border="1px solid rgba(255,255,255,.25)",f.style.cursor="pointer",f.style.boxShadow="inset 0 0 0 1px rgba(0,0,0,.2)";const _=()=>{const t=this._getStyle(),e=t.gradientColorStart||"rgba(52, 152, 219, 0.08)",n=t.gradientColorEnd||"rgba(52, 152, 219, 0.25)";f.style.background=`linear-gradient(to bottom, ${n} 0%, ${e} 100%)`};_();const b=(t,e="#3498db")=>{if("string"!=typeof t||!t)return e;const n=t.match(/^#([0-9a-f]{6})$/i);if(n)return"#"+n[1].toLowerCase();const a=t.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)/i);if(a){const t=Math.max(0,Math.min(255,parseInt(a[1],10))),e=Math.max(0,Math.min(255,parseInt(a[2],10))),n=Math.max(0,Math.min(255,parseInt(a[3],10))),i=t=>t.toString(16).padStart(2,"0");return"#"+i(t)+i(e)+i(n)}return e};f.style.position="relative";const x=document.createElement("div");x.style.position="absolute",x.style.left="8px",x.style.right="8px",x.style.top="50%",x.style.transform="translateY(-0.5px)",x.style.borderTop="1px dashed rgba(255,255,255,.5)",x.style.pointerEvents="none";const v=document.createElement("input");v.type="color",v.style.position="absolute",v.style.left="0",v.style.right="0",v.style.top="0",v.style.width="100%",v.style.height="50%",v.style.opacity="0",v.style.cursor="pointer",v.style.border="none",v.style.padding="0",v.style.margin="0",v.style.zIndex="1",v.value=b(t.gradientColorEnd,"#3498db"),v.addEventListener("input",()=>{const t=v.value,e=o(this._getStyle().gradientColorEnd,.25),n=r(t,e);this._setStyle({gradientColorEnd:n}),_(),this.logger?.info?.("[HeatmapSettings] gradientColorEnd ->",n,"(from overlay picker)")});const w=document.createElement("input");w.type="color",w.style.position="absolute",w.style.left="0",w.style.right="0",w.style.bottom="0",w.style.width="100%",w.style.height="50%",w.style.opacity="0",w.style.cursor="pointer",w.style.border="none",w.style.padding="0",w.style.margin="0",w.style.zIndex="1",w.value=b(t.gradientColorStart,"#3498db"),w.addEventListener("input",()=>{const t=w.value,e=o(this._getStyle().gradientColorStart,.08),n=r(t,e);this._setStyle({gradientColorStart:n}),_(),this.logger?.info?.("[HeatmapSettings] gradientColorStart ->",n,"(from overlay picker)")}),y.appendChild(g),y.appendChild(f),f.appendChild(x),f.appendChild(v),f.appendChild(w);const k=document.createElement("div");k.style.position="absolute",k.style.right="4px",k.style.top="0",k.style.width="24px",k.style.height="50%",k.style.display="flex",k.style.alignItems="center",k.style.justifyContent="center",k.style.zIndex="3";const C=document.createElement("input");C.type="range",C.min="0",C.max="1",C.step="0.01",C.value=String(o(t.gradientColorEnd,.25)),C.style.appearance="slider-vertical",C.style.WebkitAppearance="slider-vertical",C.style.MozAppearance="slider-vertical",C.style.writingMode="bt-lr",C.style.height="100%",C.style.width="16px",C.style.cursor="pointer",C.addEventListener("input",()=>{const t=Math.max(0,Math.min(1,parseFloat(C.value))),e=this._getStyle(),n=b(e.gradientColorEnd,"#3498db"),a=r(n,t);this._setStyle({gradientColorEnd:a}),_(),this.logger?.info?.("[HeatmapSettings] gradientEndAlpha ->",t)}),k.appendChild(C),f.appendChild(k);const E=document.createElement("div");E.style.position="absolute",E.style.right="4px",E.style.bottom="0",E.style.width="24px",E.style.height="50%",E.style.display="flex",E.style.alignItems="center",E.style.justifyContent="center",E.style.zIndex="3";const S=document.createElement("input");S.type="range",S.min="0",S.max="1",S.step="0.01",S.value=String(o(t.gradientColorStart,.08)),S.style.appearance="slider-vertical",S.style.WebkitAppearance="slider-vertical",S.style.MozAppearance="slider-vertical",S.style.writingMode="bt-lr",S.style.height="100%",S.style.width="16px",S.style.cursor="pointer",S.addEventListener("input",()=>{const t=Math.max(0,Math.min(1,parseFloat(S.value))),e=this._getStyle(),n=b(e.gradientColorStart,"#3498db"),a=r(n,t);this._setStyle({gradientColorStart:a}),_(),this.logger?.info?.("[HeatmapSettings] gradientStartAlpha ->",t)}),E.appendChild(S),f.appendChild(E),i.appendChild(l),i.appendChild(y),e.appendChild(i);const L=document.createElement("div");return L.className="danmaku-setting-row__desc",e.appendChild(L),e}_createHeatmapModeRow(){const t=window?.__jfDanmakuGlobal__?.danmakuSettings,e=t?.get?.("enable_heatmap")??"combined",n=document.createElement("div");n.className="danmaku-setting-row",n.setAttribute("data-key","enable_heatmap"),n.setAttribute("data-type","enum");const a=document.createElement("div");a.className="danmaku-setting-row__label";const i=document.createElement("span");i.className="danmaku-setting-row__labelText",i.textContent="弹幕密度图",a.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.style.display="flex",s.style.width="100%",s.style.gap="6px",s.style.marginTop="4px";const o=e=>{try{const n=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},a=n.danmakuSettings||t;a?.set?.("enable_heatmap",e);try{if("off"===e)if(n.heatmapRenderer&&"function"==typeof n.heatmapRenderer.hide)n.heatmapRenderer.hide();else{const t=document.getElementById("danmaku-heatmap-canvas");t&&(t.style.display="none")}else{let t=!1;n.heatmapRenderer&&"function"==typeof n.heatmapRenderer.show&&(n.heatmapRenderer.show(),t=!0);const e=document.getElementById("danmaku-heatmap-canvas");if(!t&&e&&(e.style.display="block",t=!0),!t)try{n.getExt?.()?._generateHeatmap?.()}catch(t){}}}catch(t){}p(this.logger)}catch(t){}this.logger?.info?.("[HeatmapSettings] enable_heatmap ->",e)};[{key:"off",label:"关闭"},{key:"combined",label:"合并后"},{key:"original",label:"原始数据"}].forEach(t=>{const e=document.createElement("button");e.type="button",e.textContent=t.label,e.dataset.val=t.key,e.style.flex="1 1 0",e.style.padding="6px 4px",e.style.fontSize="12px",e.style.lineHeight="1.1",e.style.borderRadius="6px",e.style.border="1px solid rgba(255,255,255,.25)",e.style.background="rgba(255,255,255,.08)",e.style.color="#fff",e.style.cursor="pointer",e.style.transition="background .15s, border-color .15s, box-shadow .15s";const n=()=>{e.dataset.val===String(r)?(e.style.background="#3fa9ff",e.style.borderColor="#3fa9ff",e.style.boxShadow="0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)"):(e.style.background="rgba(255,255,255,.08)",e.style.borderColor="rgba(255,255,255,.25)",e.style.boxShadow="none")};e.addEventListener("mouseenter",()=>{e.dataset.val!==String(r)&&(e.style.background="rgba(255,255,255,.15)")}),e.addEventListener("mouseleave",()=>n()),e.addEventListener("click",()=>{r!==t.key&&(r=t.key,o(r),s.querySelectorAll("button").forEach(t=>{t.dataset.val===r?(t.style.background="#3fa9ff",t.style.borderColor="#3fa9ff",t.style.boxShadow="0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6)"):(t.style.background="rgba(255,255,255,.08)",t.style.borderColor="rgba(255,255,255,.25)",t.style.boxShadow="none")}))}),s.appendChild(e),setTimeout(n,0)});let r=String(e);n.appendChild(s);const l=document.createElement("div");return l.className="danmaku-setting-row__desc",n.appendChild(l),n}_createIntervalRow(){const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t.danmakuSettings;let n=e?.get?.("heatmap_interval"),a="number"==typeof n&&isFinite(n)?Math.max(1,Math.min(20,Math.round(n))):5;const i=document.createElement("div");i.className="danmaku-setting-row",i.setAttribute("data-key","heatmap_interval"),i.setAttribute("data-type","number");const s=document.createElement("div");s.className="danmaku-setting-row__label";const o=document.createElement("span");o.className="danmaku-setting-row__labelText",o.textContent="取样间隔",s.appendChild(o),i.appendChild(s);const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px";const l=document.createElement("input");l.type="range",l.min="1",l.max="20",l.step="1",l.value=String(a),l.style.flex="1 1 auto",l.style.height="24px";const d=document.createElement("div");d.textContent=`${String(a)} 秒`,d.style.minWidth="48px",d.style.textAlign="center",d.style.opacity=".9";const c=n=>{let i=parseInt(n,10);if(isFinite(i)){i<1?i=1:i>20&&(i=20),a=i,l.value=String(i),d.textContent=`${String(i)} 秒`;try{e?.set?.("heatmap_interval",i)}catch(t){}try{p(this.logger)}catch(t){}try{t.getExt?.()?._generateHeatmap?.()}catch(t){}this.logger?.info?.("[HeatmapSettings] heatmap_interval ->",i)}};l.addEventListener("input",()=>c(l.value)),r.appendChild(l),r.appendChild(d),i.appendChild(r);const h=document.createElement("div");return h.className="danmaku-setting-row__desc",i.appendChild(h),i}build(){const t=document.createElement("div");t.className="danmaku-settings-tabPanel",t.dataset.key=this.getKey();const e=document.createElement("div");return e.className="danmaku-settings-list",e.appendChild(this._createHeatmapModeRow()),e.appendChild(this._createIntervalRow()),e.appendChild(this._createLineWidthRow()),e.appendChild(this._createColorsRow()),t.appendChild(e),t}}class v{constructor(t={}){this.logger=t.logger||null,this._panel=null,this._modalHost=null,this._headerBox=null,this._imgEl=null,this._titleValEl=null,this._episodeTitleEl=null,this._idValEl=null,this._epIdValEl=null,this._offsetInput=null,this._matchData=null,this._unbinds=[],this._searchInput=null,this._searchBtn=null,this._searchPlaceholder=null,this._resultsWrap=null,this._listWrap=null,this._detailWrap=null,this._selectedItem=null,this._detailUnbinds=[],this._isAnimating=!1}getKey(){return"search"}getLabel(){return"搜索弹幕"}build(){const t=document.createElement("div");t.className="danmaku-settings-tabPanel",t.dataset.key=this.getKey(),this._panel=t;const e=document.createElement("div");e.style.position="relative",e.style.zIndex="0",this._modalHost=e;const n=document.createElement("div");n.style.display="flex",n.style.alignItems="stretch",n.style.gap="10px",n.style.border="1px solid rgba(255,255,255,.12)",n.style.borderRadius="8px",n.style.background="rgba(255,255,255,.05)",n.style.padding="10px",n.style.minHeight="110px",n.style.boxSizing="border-box",n.style.overflow="hidden",this._headerBox=n;const a=document.createElement("div");a.style.flex="0 0 25%",a.style.maxWidth="25%",a.style.borderRadius="6px",a.style.overflow="hidden",a.style.background="rgba(0,0,0,.2)",a.style.alignSelf="center";const i=document.createElement("img");i.alt="海报",i.style.display="block",i.style.width="100%",i.style.height="auto";try{i.style.objectFit="contain"}catch(t){}i.style.background="rgba(0,0,0,.3)",i.referrerPolicy="no-referrer",this._imgEl=i,a.appendChild(i),n.appendChild(a);const s=document.createElement("div");s.style.flex="1 1 auto",s.style.display="flex",s.style.flexDirection="column",s.style.gap="8px";const o=(t,e)=>{const n=document.createElement("div");n.style.display="flex",n.style.gap="8px",n.style.alignItems="center";const a=document.createElement("span");a.textContent=t,a.style.opacity=".8",a.style.minWidth="64px",a.style.fontSize="12px";const i=e||document.createElement("span");return i.style.fontSize="13px",i.style.wordBreak="break-all",n.appendChild(a),n.appendChild(i),{line:n,val:i}},r=document.createElement("span");r.textContent="加载中…";const l=o("标题:",r);this._titleValEl=r;const d=document.createElement("span");try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};d.textContent=t?.danmakuData?.episodeTitle||"--"}catch(t){d.textContent="--"}const c=o("本集标题:",d);this._episodeTitleEl=d;const h=document.createElement("span");h.textContent="--";const u=o("anime_id:",h);this._idValEl=h;const m=document.createElement("input");m.type="text",m.value="0",m.className="danmaku-setting-input",m.style.width="3ch",m.style.padding="4px 6px",m.style.fontSize="12px",m.step="1",m.min="-9999",m.max="9999",this._offsetInput=m;const y=document.createElement("button");y.type="button",y.textContent="更新",y.style.border="1px solid rgba(255,255,255,.28)",y.style.background="rgba(255,255,255,.10)",y.style.color="#fff",y.style.borderRadius="6px",y.style.fontSize="12px",y.style.padding="6px 10px",y.style.cursor="pointer",y.style.whiteSpace="nowrap";const g=document.createElement("div");g.style.display="flex",g.style.alignItems="center",g.style.gap="8px",g.appendChild(m),g.appendChild(y);const f=o("集数偏移:",g),_=document.createElement("span");try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t?.danmakuData?.episodeId;_.textContent=null==e||""===e?"--":String(e)}catch(t){_.textContent="--"}const b=o("ep_id:",_);this._epIdValEl=_;const x=()=>{let t=parseInt(m.value,10);Number.isFinite(t)||(t=0),t<-9999?t=-9999:t>9999&&(t=9999),m.value=String(t),this._matchData&&(this._matchData.offset=t);try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};t.danmakuMatchData={...t.danmakuMatchData||{},...this._matchData}}catch(t){}this.logger?.info?.("[Search] offset ->",t)};m.addEventListener("change",x),m.addEventListener("input",()=>{let t=parseInt(m.value,10);Number.isFinite(t)&&this._matchData&&(this._matchData.offset=t)}),this._unbinds.push(()=>{try{m.removeEventListener("change",x)}catch(t){}});const v=async()=>{try{if("undefined"==typeof ApiClient||!ApiClient.getUrl)return void this.logger?.warn?.("[Search] 无法更新：缺少 ApiClient");const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t.getMediaId?.();if(!e)return void this.logger?.warn?.("[Search] 无法更新：缺少 item_id");let n=parseInt(m.value,10);Number.isFinite(n)||(n=0);const a=ApiClient.getUrl("danmaku/match_data");y.disabled=!0,y.textContent="更新中…";const i=new URLSearchParams;i.append("item_id",String(e)),i.append("offset",String(n)),await ApiClient.ajax({type:"POST",url:a,data:i.toString(),contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"json"});const s=p(this.logger);try{s&&"function"==typeof s.then&&s.then(t=>{if(t)try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t?.danmakuData?.episodeTitle||"--";this._episodeTitleEl&&(this._episodeTitleEl.textContent=e);const n=t?.danmakuData?.episodeId;this._epIdValEl&&(this._epIdValEl.textContent=null==n||""===n?"--":String(n))}catch(t){}}).catch(()=>{})}catch(t){}this.logger?.info?.("[Search] 已提交匹配偏移更新",{item_id:e,offset:n})}catch(t){this.logger?.warn?.("[Search] 提交偏移更新失败",t)}finally{try{y.disabled=!1,y.textContent="更新"}catch(t){}}};y.addEventListener("click",v),this._unbinds.push(()=>{try{y.removeEventListener("click",v)}catch(t){}}),s.appendChild(l.line),s.appendChild(u.line),s.appendChild(f.line),s.appendChild(c.line),s.appendChild(b.line),n.appendChild(s);const w=document.createElement("div");w.className="danmaku-settings-list",w.appendChild(n);const k=document.createElement("div");k.textContent="删除已匹配结果",k.style.marginTop="10px",k.style.height="36px",k.style.lineHeight="36px",k.style.textAlign="center",k.style.color="#fff",k.style.fontSize="13px",k.style.fontWeight="600",k.style.background="rgba(220, 53, 69, 0.95)",k.style.border="1px solid rgba(255,255,255,.18)",k.style.borderRadius="8px",k.style.cursor="pointer",k.style.userSelect="none",k.style.transition="filter .12s ease, opacity .12s ease",k.addEventListener("mouseenter",()=>{try{k.style.filter="brightness(1.05)"}catch(t){}}),k.addEventListener("mouseleave",()=>{try{k.style.filter="none"}catch(t){}});const C=async()=>{try{if(!await this._showConfirm({title:"确认删除",message:"确认删除已匹配结果？此操作将清空信息栏数据。",confirmText:"删除",cancelText:"取消"}))return;if("undefined"==typeof ApiClient||!ApiClient.getUrl)return void this.logger?.warn?.("[Search] 无法删除：缺少 ApiClient");const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t.getMediaId?.();if(!e)return void this.logger?.warn?.("[Search] 无法删除：缺少 item_id");k.textContent;k.textContent="处理中…",k.style.opacity="0.85",k.style.pointerEvents="none";const n=ApiClient.getUrl(`danmaku/del_match?item_id=${encodeURIComponent(String(e))}`);await ApiClient.ajax({type:"GET",url:n}),this._clearHeaderInfo(),this.logger?.info?.("[Search] 已删除匹配结果",{item_id:e})}catch(t){this.logger?.warn?.("[Search] 删除匹配结果失败",t)}finally{try{k.textContent="删除已匹配结果",k.style.opacity="",k.style.pointerEvents=""}catch(t){}}};k.addEventListener("click",C),this._unbinds.push(()=>{try{k.removeEventListener("click",C)}catch(t){}}),w.appendChild(k);const E=document.createElement("div");E.style.position="relative",E.style.marginTop="10px",E.style.height="36px",E.style.display="block";const S=document.createElement("input");S.type="text",S.autocomplete="off",S.spellcheck=!1,S.className="danmaku-setting-input",S.style.boxSizing="border-box",S.style.width="100%",S.style.height="36px",S.style.padding="0 40px 0 12px",S.style.fontSize="13px",S.style.border="1px solid rgba(255,255,255,.18)",S.style.background="rgba(255,255,255,.06)",S.style.color="#fff",S.style.borderRadius="8px",S.style.outline="none",this._searchInput=S;const L=document.createElement("span");L.textContent="搜索",L.style.position="absolute",L.style.left="0",L.style.right="40px",L.style.top="0",L.style.bottom="0",L.style.display="flex",L.style.alignItems="center",L.style.justifyContent="center",L.style.color="rgba(255,255,255,.5)",L.style.pointerEvents="none",L.style.fontSize="13px",this._searchPlaceholder=L;const D=document.createElement("button");D.type="button",D.title="搜索",D.style.position="absolute",D.style.top="0",D.style.right="0",D.style.height="100%",D.style.width="36px",D.style.border="1px solid rgba(255,255,255,.18)",D.style.borderLeft="none",D.style.background="rgba(255,255,255,.10)",D.style.color="#fff",D.style.cursor="pointer",D.style.borderTopRightRadius="8px",D.style.borderBottomRightRadius="8px",D.style.display="flex",D.style.alignItems="center",D.style.justifyContent="center";const M="http://www.w3.org/2000/svg",A=document.createElementNS(M,"svg");A.setAttribute("viewBox","0 0 24 24"),A.setAttribute("width","18"),A.setAttribute("height","18"),A.style.pointerEvents="none";const I=document.createElementNS(M,"circle");I.setAttribute("cx","11"),I.setAttribute("cy","11"),I.setAttribute("r","7"),I.setAttribute("fill","none"),I.setAttribute("stroke","currentColor"),I.setAttribute("stroke-width","2");const T=document.createElementNS(M,"line");T.setAttribute("x1","16.5"),T.setAttribute("y1","16.5"),T.setAttribute("x2","21"),T.setAttribute("y2","21"),T.setAttribute("stroke","currentColor"),T.setAttribute("stroke-width","2"),T.setAttribute("stroke-linecap","round"),A.appendChild(I),A.appendChild(T),D.appendChild(A),this._searchBtn=D;const R=()=>{const t=document.activeElement===S,e=!!S.value&&S.value.trim().length>0;L.style.display=t||e?"none":"flex"},z=()=>R(),N=()=>R(),j=()=>R(),W=()=>{try{S.focus()}catch(t){}};S.addEventListener("focus",z),S.addEventListener("blur",N),S.addEventListener("input",j),D.addEventListener("click",W),this._unbinds.push(()=>{try{S.removeEventListener("focus",z)}catch(t){}}),this._unbinds.push(()=>{try{S.removeEventListener("blur",N)}catch(t){}}),this._unbinds.push(()=>{try{S.removeEventListener("input",j)}catch(t){}}),this._unbinds.push(()=>{try{D.removeEventListener("click",W)}catch(t){}}),E.appendChild(S),E.appendChild(L),E.appendChild(D),w.appendChild(E);const P=document.createElement("div");return P.style.marginTop="12px",P.style.display="grid",P.style.gridTemplateColumns="1fr 1fr",P.style.gap="12px",this._resultsWrap=P,w.appendChild(P),t.appendChild(this._modalHost),t.appendChild(w),this._listWrap=w,this._bindSearchActions(),Promise.resolve().then(()=>{this._fetchMatchData(),this._applyEpIdFromGlobal()}),t}_ensureModalLayer(){if(!this._panel)return null;let t=this._panel.querySelector?.(".danmaku-modal-overlay");return t||(t=document.createElement("div"),t.className="danmaku-modal-overlay",t.style.position="fixed",t.style.inset="0",t.style.display="none",t.style.alignItems="center",t.style.justifyContent="center",t.style.background="rgba(0,0,0,.45)",t.style.zIndex="9999",t.style.backdropFilter="blur(2px)",this._panel.appendChild(t)),t}_showConfirm({title:t="确认",message:e="确定执行该操作吗？",confirmText:n="确定",cancelText:a="取消"}={}){return new Promise(i=>{try{const s=this._ensureModalLayer();if(!s)return void i(window.confirm?.(e));s.innerHTML="";const o=document.createElement("div");o.style.maxWidth="420px",o.style.width="min(90vw, 420px)",o.style.background="rgba(30,30,30,.98)",o.style.border="1px solid rgba(255,255,255,.16)",o.style.borderRadius="10px",o.style.boxShadow="0 10px 30px rgba(0,0,0,.4)",o.style.padding="14px 16px 12px",o.style.color="#fff",o.style.transform="scale(.96)",o.style.opacity="0",o.style.transition="transform .15s ease, opacity .15s ease";const r=document.createElement("div");r.textContent=t,r.style.fontSize="15px",r.style.fontWeight="700",r.style.marginBottom="8px";const l=document.createElement("div");l.textContent=e,l.style.fontSize="13px",l.style.opacity=".92",l.style.lineHeight="1.6",l.style.marginBottom="12px";const d=document.createElement("div");d.style.display="flex",d.style.justifyContent="flex-end",d.style.gap="8px";const c=document.createElement("button");c.type="button",c.textContent=a,c.style.padding="6px 12px",c.style.fontSize="12px",c.style.borderRadius="6px",c.style.border="1px solid rgba(255,255,255,.20)",c.style.background="rgba(255,255,255,.08)",c.style.color="#fff";const h=document.createElement("button");h.type="button",h.textContent=n,h.style.padding="6px 12px",h.style.fontSize="12px",h.style.borderRadius="6px",h.style.border="1px solid rgba(76,175,80,.7)",h.style.background="rgba(76,175,80,.25)",h.style.color="#c8f0c8",d.appendChild(c),d.appendChild(h),o.appendChild(r),o.appendChild(l),o.appendChild(d),s.appendChild(o);let u=null;try{u=document.body&&document.body.style?document.body.style.overflow:null}catch(t){}const p=t=>{try{o.style.transform="scale(.96)",o.style.opacity="0",setTimeout(()=>{s.style.display="none",s.innerHTML="";try{document.body&&document.body.style&&(document.body.style.overflow=u||"")}catch(t){}try{document.removeEventListener("keydown",m)}catch(t){}i(t)},140)}catch(e){s.style.display="none",i(t)}},m=t=>{"Escape"===t.key&&(t.preventDefault?.(),p(!1)),"Enter"===t.key&&(t.preventDefault?.(),p(!0))};c.addEventListener("click",()=>p(!1)),h.addEventListener("click",()=>p(!0)),s.addEventListener("click",t=>{t.target===s&&p(!1)}),document.addEventListener("keydown",m),s.style.display="flex";try{document.body&&document.body.style&&(document.body.style.overflow="hidden")}catch(t){}requestAnimationFrame(()=>{o.style.transform="scale(1)",o.style.opacity="1"})}catch(t){i(!1)}})}_bindSearchActions(){if(!this._searchInput||!this._searchBtn)return;const t=()=>this._doSearch(),e=e=>{"Enter"===e.key&&(e.preventDefault?.(),t())};this._searchInput.addEventListener("keydown",e),this._searchBtn.addEventListener("click",t),this._unbinds.push(()=>{try{this._searchInput.removeEventListener("keydown",e)}catch(t){}}),this._unbinds.push(()=>{try{this._searchBtn.removeEventListener("click",t)}catch(t){}})}_applyEpIdFromGlobal(){try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t?.danmakuData?.episodeId;this._epIdValEl&&(this._epIdValEl.textContent=null==e||""===e?"--":String(e))}catch(t){try{this._epIdValEl&&(this._epIdValEl.textContent="--")}catch(t){}}}async _doSearch(){try{const t=(this._searchInput?.value||"").trim();if(!t)return void this._renderSearchResults([]);if("undefined"==typeof ApiClient||!ApiClient.getUrl)return void this.logger?.warn?.("[Search] 缺少 ApiClient，无法搜索");this._renderSearchLoading();const e=ApiClient.getUrl(`danmaku/search?keyword=${encodeURIComponent(t)}`),n=await ApiClient.ajax({type:"GET",url:e,dataType:"json"}),a=Array.isArray(n?.animes)?n.animes:[];this.logger?.info?.("[Search] 搜索结果",{"关键字":t,"数量":a.length}),this._renderSearchResults(a)}catch(t){this.logger?.warn?.("[Search] 搜索失败",t),this._renderSearchError()}}_renderSearchLoading(){if(!this._resultsWrap)return;this._resultsWrap.innerHTML="";const t=document.createElement("div");t.textContent="正在搜索…",t.style.opacity=".8",t.style.fontSize="13px",t.style.gridColumn="1 / -1",this._resultsWrap.appendChild(t)}_renderSearchError(){if(!this._resultsWrap)return;this._resultsWrap.innerHTML="";const t=document.createElement("div");t.textContent="搜索失败",t.style.color="#e66",t.style.fontSize="13px",t.style.gridColumn="1 / -1",this._resultsWrap.appendChild(t)}_renderSearchResults(t){if(this._resultsWrap){if(this._resultsWrap.innerHTML="",!t||0===t.length){const t=document.createElement("div");return t.textContent="无结果",t.style.opacity=".7",t.style.fontSize="13px",t.style.gridColumn="1 / -1",void this._resultsWrap.appendChild(t)}for(const e of t){const t=this._createResultCard(e);t.style.cursor="pointer",t.style.userSelect="none",t.addEventListener("click",()=>{try{this._enterDetail(e)}catch(t){}}),this._resultsWrap.appendChild(t)}}}_createResultCard(t){const e=document.createElement("div");e.style.border="1px solid rgba(255,255,255,.12)",e.style.borderRadius="8px",e.style.background="rgba(255,255,255,.04)",e.style.overflow="hidden",e.style.position="relative";try{e.style.aspectRatio="2 / 3"}catch(t){}const n=document.createElement("div");n.style.position="absolute",n.style.left="0",n.style.right="0",n.style.top="0",n.style.bottom="0",n.style.background="transparent",n.style.overflow="hidden",n.style.zIndex="1";const a=document.createElement("img");a.alt=t?.animeTitle||"",a.referrerPolicy="no-referrer",a.style.width="100%",a.style.height="100%",a.style.objectFit="contain",a.style.objectPosition="center center",a.style.transition="transform .15s ease",a.style.transformOrigin="center center";const i=t?.imageUrl||"";i?a.src=i:a.removeAttribute("src"),a.onerror=()=>{try{a.style.display="none",n.style.background="transparent"}catch(t){}},a.onload=()=>{try{if(!a.src)return;a.style.display="",n.style.background="transparent"}catch(t){}},n.appendChild(a),e.appendChild(n);const s=document.createElement("div");s.style.position="absolute",s.style.left="0",s.style.right="0",s.style.bottom="0",s.style.background="rgba(0,0,0,.5)",s.style.color="#fff",s.style.padding="6px 8px",s.style.display="flex",s.style.flexDirection="column",s.style.gap="2px",s.style.zIndex="2",s.style.transformOrigin="bottom left",s.style.transition="transform .15s ease";const o=document.createElement("div");o.textContent=t?.animeTitle||"--",o.style.fontSize="12px",o.style.fontWeight="600",o.style.lineHeight="1.3",o.style.whiteSpace="nowrap",o.style.overflow="hidden",o.style.textOverflow="ellipsis";const r=document.createElement("div");return r.textContent=t?.typeDescription||t?.type||"",r.style.opacity=".9",r.style.fontSize="11px",r.style.whiteSpace="nowrap",r.style.overflow="hidden",r.style.textOverflow="ellipsis",s.appendChild(o),s.appendChild(r),e.appendChild(s),e.addEventListener("mouseenter",()=>{try{s.style.transform="scale(1.05)"}catch(t){}try{a.style.transform="scale(0.97)"}catch(t){}}),e.addEventListener("mouseleave",()=>{try{s.style.transform="scale(1)"}catch(t){}try{a.style.transform="scale(1)"}catch(t){}}),e}_enterDetail(t){try{if(this._isAnimating)return;if(this._isAnimating=!0,this._selectedItem=t||null,this._listWrap&&(this._listWrap.style.display=""),this._detailWrap&&this._detailWrap.parentNode)try{this._detailWrap.parentNode.removeChild(this._detailWrap)}catch(t){}this._detailWrap=document.createElement("div"),this._detailWrap.style.position="relative",this._detailWrap.style.display="block",this._detailWrap.style.minHeight="200px",this._detailWrap.style.border="1px solid rgba(255,255,255,.12)",this._detailWrap.style.borderRadius="8px",this._detailWrap.style.padding="10px",this._detailWrap.style.background="rgba(255,255,255,.04)";const e=document.createElement("button");e.type="button",e.textContent="← 返回",e.style.border="1px solid rgba(255,255,255,.28)",e.style.background="rgba(255,255,255,.10)",e.style.color="#fff",e.style.borderRadius="6px",e.style.fontSize="12px",e.style.padding="6px 10px",e.style.cursor="pointer",e.style.marginBottom="10px";const n=()=>{this._exitDetail()};e.addEventListener("click",n),this._detailUnbinds.push(()=>{try{e.removeEventListener("click",n)}catch(t){}}),this._detailWrap.appendChild(e);const a=document.createElement("div");a.style.display="flex",a.style.gap="12px",a.style.alignItems="stretch";const i=document.createElement("div");i.style.flex="0 0 33%",i.style.maxWidth="240px",i.style.borderRadius="8px",i.style.overflow="hidden",i.style.background="transparent",i.style.position="relative";try{i.style.aspectRatio="2 / 3"}catch(t){}const s=document.createElement("img");s.alt=t?.animeTitle||"",s.referrerPolicy="no-referrer",s.style.width="100%",s.style.height="100%",s.style.objectFit="contain",s.style.background="transparent";const o=t?.imageUrl||"";o&&(s.src=o),i.appendChild(s);const r=document.createElement("div");r.style.flex="1 1 auto",r.style.display="flex",r.style.flexDirection="column",r.style.gap="8px";const l=document.createElement("div");l.textContent=t?.animeTitle||"--",l.style.fontSize="16px",l.style.fontWeight="700",l.style.lineHeight="1.3";const d=document.createElement("div");d.textContent=t?.typeDescription||t?.type||"",d.style.opacity=".9",d.style.fontSize="12px";const c=document.createElement("div");c.textContent="",c.style.opacity=".85",c.style.fontSize="12px",c.style.lineHeight="1.45",c.style.overflow="hidden",c.style.display="-webkit-box",c.style.webkitLineClamp="6",c.style.webkitBoxOrient="vertical",r.appendChild(l),r.appendChild(d),r.appendChild(c),a.appendChild(i),a.appendChild(r),this._detailWrap.appendChild(a);const h=document.createElement("div");h.style.marginTop="10px",h.style.border="1px solid rgba(255,255,255,.12)",h.style.borderRadius="8px",h.style.padding="8px 10px",h.style.display="flex",h.style.alignItems="center",h.style.gap="10px",h.style.background="rgba(255,255,255,.03)",h.style.minHeight="52px";const u=document.createElement("span"),m=t?.animeId??t?.id??"--";u.textContent=`将 ${m} 作为本季id,集数偏移:`,u.style.fontSize="12px",u.style.opacity=".95";const y=document.createElement("div");y.style.flex="0 0 auto",y.style.display="flex",y.style.alignItems="center",y.style.justifyContent="center",y.style.padding="0 8px";const g=document.createElement("div"),f=(m??"").toString();g.textContent=f.toUpperCase(),g.style.fontSize="18px",g.style.fontWeight="700",g.style.letterSpacing=".5px",g.style.opacity=".95",y.appendChild(g);const _=document.createElement("input");_.type="text",_.value="0",_.className="danmaku-setting-input",_.style.width="3ch",_.style.padding="4px 6px",_.style.fontSize="12px",_.step="1",_.min="-9999",_.max="9999";const b=document.createElement("button");b.type="button",b.textContent="确认";const x=document.createElement("div");x.style.flex="1 1 auto",x.style.display="flex",x.style.alignItems="center",x.style.gap="10px",x.appendChild(u),x.appendChild(_),h.appendChild(y),h.appendChild(x),h.style.cursor="pointer",h.addEventListener("mouseenter",()=>{try{h.style.filter="brightness(1.02)"}catch(t){}}),h.addEventListener("mouseleave",()=>{try{h.style.filter=""}catch(t){}}),this._detailWrap.appendChild(h);const v=async()=>{try{if("undefined"==typeof ApiClient||!ApiClient.getUrl)return void this.logger?.warn?.("[Search] 无法设置本季id：缺少 ApiClient");const e=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},n=e.getMediaId?.(),a=t?.animeId??t?.id,i=t?.animeTitle||"",s=t?.imageUrl||"";if(!n||!a)return void this.logger?.warn?.("[Search] 无法设置本季id：缺少 itemId/animeId");let o=parseInt(_.value,10);Number.isFinite(o)||(o=0),o<-9999?o=-9999:o>9999&&(o=9999),_.value=String(o);const r=ApiClient.getUrl("danmaku/match_data");b.disabled=!0;b.textContent;b.textContent="提交中…";const l=new URLSearchParams;l.append("itemId",String(n)),l.append("animeId",String(a)),l.append("offset",String(o)),l.append("animeTitle",String(i)),l.append("imageUrl",String(s)),await ApiClient.ajax({type:"POST",url:r,data:l.toString(),contentType:"application/x-www-form-urlencoded; charset=UTF-8",dataType:"json"});try{this._idValEl&&(this._idValEl.textContent=String(a)),this._titleValEl&&(this._titleValEl.textContent=i||this._titleValEl.textContent),this._imgEl&&s&&(this._imgEl.src=s),this._offsetInput&&(this._offsetInput.value=String(o));const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};t.danmakuMatchData={...t.danmakuMatchData||{},animeId:a,animeTitle:i,imageUrl:s,offset:o,exists:!0}}catch(t){}try{const t=p(this.logger);t&&"function"==typeof t.then&&t.then(t=>{if(t)try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t?.danmakuData?.episodeTitle||"--";this._episodeTitleEl&&(this._episodeTitleEl.textContent=e);const n=t?.danmakuData?.episodeId;this._epIdValEl&&(this._epIdValEl.textContent=null==n||""===n?"--":String(n))}catch(t){}}).catch(()=>{})}catch(t){}this.logger?.info?.("[Search] 已设置本季id",{itemId:n,animeId:a,offset:o})}catch(t){this.logger?.warn?.("[Search] 设置本季id失败",t)}finally{try{b.disabled=!1,b.textContent="确认"}catch(t){}}},w=async t=>{try{if(t&&(t.target===_||_.contains?.(t.target)))return;if(!await this._showConfirm({title:"设置全季",message:"确认将该 id 设为全季id，并应用当前 offset 吗？",confirmText:"确定",cancelText:"取消"}))return}catch(t){}v()};h.addEventListener("click",w),this._detailUnbinds.push(()=>{try{h.removeEventListener("click",w)}catch(t){}});const k=document.createElement("div");k.style.marginTop="12px",k.style.display="flex",k.style.flexDirection="column",k.style.gap="8px";const C=document.createElement("div");C.textContent="加载中…",C.style.opacity=".8",C.style.fontSize="13px",k.appendChild(C),this._detailWrap.appendChild(k),this._panel&&this._panel.appendChild(this._detailWrap);const E=this._listWrap,S=this._detailWrap,L=220,D="ease";E&&(E.style.transition="transform "+L+"ms "+D+", opacity "+L+"ms "+D,E.style.transform="translateX(0)",E.style.opacity="1"),S&&(S.style.transition="transform "+L+"ms "+D+", opacity "+L+"ms "+D,S.style.transform="translateX(-24px)",S.style.opacity="0"),S&&S.offsetWidth,E&&(E.style.transform="translateX(24px)",E.style.opacity="0"),S&&(S.style.transform="translateX(0)",S.style.opacity="1");const M=()=>{try{E&&(E.style.display="none",E.style.transition="",E.style.transform="",E.style.opacity=""),S&&(S.style.transition="",S.style.transform="",S.style.opacity="")}catch(t){}this._isAnimating=!1},A=t=>{M();try{S.removeEventListener("transitionend",A)}catch(t){}};try{S.addEventListener("transitionend",A)}catch(t){}setTimeout(M,L+80),this._loadBangumiDetail(t,{summaryEl:c,episodesWrap:k})}catch(t){this.logger?.warn?.("[Search] 进入二级页面失败",t),this._isAnimating=!1}}_exitDetail(){try{if(this._isAnimating)return;this._isAnimating=!0;const t=this._listWrap,e=this._detailWrap;if(!e)return t&&(t.style.display=""),void(this._isAnimating=!1);const n=220,a="ease";t&&(t.style.display="",t.style.transition="transform "+n+"ms "+a+", opacity "+n+"ms "+a,t.style.transform="translateX(24px)",t.style.opacity="0"),e&&(e.style.transition="transform "+n+"ms "+a+", opacity "+n+"ms "+a,e.style.transform="translateX(0)",e.style.opacity="1"),e&&e.offsetWidth,t&&(t.style.transform="translateX(0)",t.style.opacity="1"),e&&(e.style.transform="translateX(-24px)",e.style.opacity="0");const i=()=>{try{e&&e.parentNode&&e.parentNode.removeChild(e)}catch(t){}this._detailWrap=null,this._selectedItem=null;try{this._detailUnbinds.forEach(t=>{try{t()}catch(t){}})}catch(t){}this._detailUnbinds=[],t&&(t.style.transition="",t.style.transform="",t.style.opacity="",t.style.display=""),this._isAnimating=!1},s=()=>{i();try{e.removeEventListener("transitionend",s)}catch(t){}};try{e.addEventListener("transitionend",s)}catch(t){}setTimeout(i,n+80)}catch(t){this.logger?.warn?.("[Search] 退出二级页面失败",t),this._isAnimating=!1}}async _loadBangumiDetail(t,{summaryEl:e,episodesWrap:n}){try{const a=t?.animeId??t?.id??null;if(!a){if(e&&(e.textContent=""),n){n.innerHTML="";const t=document.createElement("div");t.textContent="缺少 animeId",t.style.color="#e66",t.style.fontSize="13px",n.appendChild(t)}return}if("undefined"==typeof ApiClient||!ApiClient.getUrl){if(n){n.innerHTML="";const t=document.createElement("div");t.textContent="缺少 ApiClient",t.style.color="#e66",t.style.fontSize="13px",n.appendChild(t)}return}const i=ApiClient.getUrl(`danmaku/search?bangumi_id=${encodeURIComponent(a)}`),s=await ApiClient.ajax({type:"GET",url:i,dataType:"json"}),o=s?.bangumi||{};if(e){const t=(o.summary||"").trim();e.textContent=t||""}if(n){n.innerHTML="";const t=Array.isArray(o.episodes)?o.episodes:[];if(0===t.length){const t=document.createElement("div");t.textContent="无分集",t.style.opacity=".8",t.style.fontSize="13px",n.appendChild(t)}else for(const e of t){const t=document.createElement("div");t.style.border="1px solid rgba(255,255,255,.12)",t.style.borderRadius="8px",t.style.padding="8px 10px",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.gap="10px",t.style.background="rgba(255,255,255,.03)";const a=document.createElement("div");a.style.flex="0 0 auto",a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.padding="0 8px";const i=document.createElement("div"),s=(e?.episodeNumber??"").toString();i.textContent=s.toUpperCase(),i.style.fontSize="18px",i.style.fontWeight="700",i.style.letterSpacing=".5px",i.style.opacity=".95",a.appendChild(i);const o=document.createElement("div");o.style.flex="1 1 auto",o.style.display="flex",o.style.flexDirection="column",o.style.justifyContent="center",o.style.minHeight="52px";const r=document.createElement("div");r.textContent="ep_id: "+String(e?.episodeId??"--"),r.style.fontSize="12px",r.style.opacity=".9";const l=document.createElement("div");l.textContent=e?.episodeTitle||"",l.style.fontSize="13px",l.style.fontWeight="600",l.style.lineHeight="1.35",l.style.whiteSpace="nowrap",l.style.overflow="hidden",l.style.textOverflow="ellipsis",o.appendChild(r),o.appendChild(l);document.createElement("div").style.flex="0 0 auto";const d=document.createElement("button");d.type="button",d.textContent="设置单集ID";const c=async()=>{try{if("undefined"==typeof ApiClient||!ApiClient.getUrl)return void this.logger?.warn?.("[Search] 无法设置单集ID：缺少 ApiClient");const n=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},a=n.getMediaId?.(),i=e?.episodeId;if(!a||null==i)return void this.logger?.warn?.("[Search] 无法设置单集ID：缺少 item_id/episodeId");const s=ApiClient.getUrl(`danmaku/set_id?item_id=${encodeURIComponent(String(a))}&danmaku_id=${encodeURIComponent(String(i))}`);t.style.opacity,t.style.pointerEvents;t.style.opacity="0.85",t.style.pointerEvents="none",d.disabled=!0;const o=d.textContent;d.textContent="设置中…",await ApiClient.ajax({type:"GET",url:s});try{this._epIdValEl&&(this._epIdValEl.textContent=String(i)),n.danmakuEpId=i}catch(t){}this.logger?.info?.("[Search] 已设置单集ID",{item_id:a,danmaku_id:i}),d.textContent=o;try{const t=p(this.logger);t&&"function"==typeof t.then&&t.then(t=>{if(t)try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t?.danmakuData?.episodeTitle||"--";this._episodeTitleEl&&(this._episodeTitleEl.textContent=e)}catch(t){}}).catch(()=>{})}catch(t){}}catch(t){this.logger?.warn?.("[Search] 设置单集ID失败",t)}finally{try{d.disabled=!1,t.style.opacity=prevOpacity,t.style.pointerEvents=prevPointer}catch(t){}}};t.style.cursor="pointer",t.addEventListener("mouseenter",()=>{try{t.style.filter="brightness(1.02)"}catch(t){}}),t.addEventListener("mouseleave",()=>{try{t.style.filter=""}catch(t){}});const h=async()=>{try{if(!await this._showConfirm({title:"设置单集ID",message:"确认将该分集设置为当前单集ID吗？(仅本集生效,优先级大于全季ID)",confirmText:"确定",cancelText:"取消"}))return}catch(t){}c()};t.addEventListener("click",h),this._detailUnbinds.push(()=>{try{t.removeEventListener("click",h)}catch(t){}}),t.appendChild(a),t.appendChild(o),n.appendChild(t)}}}catch(t){this.logger?.warn?.("[Search] 加载 bangumi 详情失败",t);try{if(n){n.innerHTML="";const t=document.createElement("div");t.textContent="加载失败",t.style.color="#e66",t.style.fontSize="13px",n.appendChild(t)}}catch(t){}}}async _fetchMatchData(){try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t.getMediaId?.();if(!e)return void this._applyMatchData(null,{reason:"no-media-id"});if("undefined"==typeof ApiClient||!ApiClient.getUrl)return void this._applyMatchData(null,{reason:"no-apiclient"});const n=ApiClient.getUrl(`danmaku/match_data?item_id=${encodeURIComponent(e)}`),a=await ApiClient.ajax({type:"GET",url:n,dataType:"json"});this.logger?.info?.("[Search] 获取匹配信息",a),this._applyMatchData(a)}catch(t){this.logger?.warn?.("[Search] 获取匹配信息失败",t),this._applyMatchData(null,{reason:"error"})}}_applyMatchData(t,e={}){this._matchData=t&&"object"==typeof t?t:null;const n=!!this._matchData?.exists;try{this._titleValEl.textContent=n?this._matchData.animeTitle??"--":e.reason?"未获取到匹配数据":"--"}catch(t){}try{const t=this._matchData?.animeId;this._idValEl.textContent=n&&null!=t?String(t):"--"}catch(t){}try{const t=Number(this._matchData?.offset??0);Number.isFinite(t)?this._offsetInput.value=String(t):this._offsetInput.value="0"}catch(t){try{this._offsetInput.value="0"}catch(t){}}try{const t=n&&this._matchData.imageUrl||"";t?this._imgEl.src=t:this._imgEl.removeAttribute("src"),this._imgEl.onerror=()=>{try{this._imgEl.removeAttribute("src")}catch(t){}}}catch(t){}try{(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).danmakuMatchData=this._matchData||null}catch(t){}}_clearHeaderInfo(){try{if(this._matchData=null,this._titleValEl&&(this._titleValEl.textContent="--"),this._episodeTitleEl&&(this._episodeTitleEl.textContent="--"),this._idValEl&&(this._idValEl.textContent="--"),this._offsetInput&&(this._offsetInput.value="0"),this._epIdValEl&&(this._epIdValEl.textContent="--"),this._imgEl)try{this._imgEl.removeAttribute("src")}catch(t){}try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};t.danmakuMatchData=null,t.danmakuEpId=null}catch(t){}}catch(t){}}async _fetchEpId(){this._applyEpIdFromGlobal()}destroy(){try{this._exitDetail()}catch(t){}try{this._unbinds.forEach(t=>{try{t()}catch(t){}})}catch(t){}this._unbinds=[];try{this._detailUnbinds.forEach(t=>{try{t()}catch(t){}})}catch(t){}this._detailUnbinds=[],this._panel=null,this._headerBox=null,this._imgEl=null,this._titleValEl=null,this._episodeTitleEl=null,this._idValEl=null,this._epIdValEl=null,this._offsetInput=null,this._matchData=null,this._searchInput=null,this._searchBtn=null,this._searchPlaceholder=null,this._resultsWrap=null,this._listWrap=null,this._detailWrap=null,this._selectedItem=null}}class w{constructor({logger:t}={}){this.logger=t||null,this.el=null,this._styleInjected=!1,this._id="danmakuSettingsPanel",this._followRaf=null,this._followAnchor=null,this._lastPosKey="",this._wheelListener=null,this._keyboardListener=null,this._currentTab=null,this._pinned=!1,this._vvListener=null}getElement(){if(this.el)return this.el;this._injectStyles();const t=document.createElement("div");return t.id=this._id,t.className="danmaku-settings-panel",t.setAttribute("role","dialog"),t.setAttribute("aria-hidden","true"),t.setAttribute("data-open","false"),t.appendChild(this._buildContent()),this._installWheelInterceptor(t),this._installKeyboardInterceptor(t),this.el=t,t}show(t){try{const e=this.getElement();e.parentElement||(document.body||document.documentElement).appendChild(e),this._updatePanelVhVar(),this._position(t),e.removeAttribute("data-closing"),e.setAttribute("data-open","true"),e.setAttribute("aria-hidden","false"),this._beginFollow(t)}catch(t){this.logger?.warn?.("显示设置面板失败",t)}}hide(){try{const t=this.el;if(!t)return;if("true"!==t.getAttribute("data-open"))return;t.setAttribute("data-closing","true"),t.setAttribute("data-open","false"),this._stopFollow();const e=()=>{try{t.setAttribute("aria-hidden","true"),t.removeAttribute("data-closing")}catch(t){}try{t.removeEventListener("transitionend",e)}catch(t){}};try{t.addEventListener("transitionend",e)}catch(t){}setTimeout(e,300)}catch(t){}}toggle(t){this.el&&"true"===this.el.getAttribute("data-open")?this.hide():this.show(t)}_position(t){if(this.el&&t&&"function"==typeof t.getBoundingClientRect)try{const e=t.getBoundingClientRect(),n=this.el.offsetHeight||0;this.el.style.position="absolute",this.el.style.zIndex=9999,this.el.style.left=`${Math.round(e.left+e.width/2)}px`,this.el.style.top=`${Math.round(e.top-n)}px`,this._lastPosKey=`${e.left},${e.top},${n}`,this._ensureInViewport()}catch(t){}}_beginFollow(t){if(this._followAnchor=t||this._followAnchor,!this._followAnchor)return;if(this._followRaf)return;this._anchorInvisible=!1,this._reacquireTick=0,this._updatePanelVhVar();const e=t=>{if(!t)return!1;if(!t.isConnected)return!1;const e=t.getBoundingClientRect();if(0===e.width&&0===e.height)return!1;const n=window.getComputedStyle?window.getComputedStyle(t):null;return!n||"none"!==n.display&&"hidden"!==n.visibility&&0!==parseFloat(n.opacity||"1")},n=()=>{try{const t=document.querySelector(".danmaku-settings-btn, .btnDanmakuSettings");t&&(this._followAnchor=t,this._position(t),this._anchorInvisible=!e(t))}catch(t){}},a=()=>{this._followRaf=null;try{if(!this.el||"true"!==this.el.getAttribute("data-open"))return void this._stopFollow();if(this._followAnchor&&this._followAnchor.isConnected){if(e(this._followAnchor)){const t=this._followAnchor.getBoundingClientRect(),e=this.el.offsetHeight||0,n=`${t.left},${t.top},${e}`;n!==this._lastPosKey&&(this.el.style.left=`${Math.round(t.left+t.width/2)}px`,this.el.style.top=`${Math.round(t.top-e)}px`,this._lastPosKey=n,this._ensureInViewport()),this._anchorInvisible=!1}else this._anchorInvisible=!0}else this._reacquireTick++%30==0&&n()}catch(t){}this._followRaf=requestAnimationFrame(a)};if(this._followRaf=requestAnimationFrame(a),!this._resizeListener){this._resizeListener=()=>{try{this._updatePanelVhVar(),this._position(this._followAnchor),this._ensureInViewport()}catch(t){}};try{window.addEventListener("resize",this._resizeListener,{passive:!0})}catch(t){}}if(!this._vvListener&&window.visualViewport){this._vvListener=()=>{try{this._updatePanelVhVar(),this._ensureInViewport()}catch(t){}};try{window.visualViewport.addEventListener("resize",this._vvListener,{passive:!0})}catch(t){}try{window.visualViewport.addEventListener("scroll",this._vvListener,{passive:!0})}catch(t){}}}_stopFollow(){if(this._followRaf){try{cancelAnimationFrame(this._followRaf)}catch(t){}this._followRaf=null}if(this._resizeListener){try{window.removeEventListener("resize",this._resizeListener)}catch(t){}this._resizeListener=null}if(this._vvListener&&window.visualViewport){try{window.visualViewport.removeEventListener("resize",this._vvListener)}catch(t){}try{window.visualViewport.removeEventListener("scroll",this._vvListener)}catch(t){}this._vvListener=null}}_injectStyles(){if(this._styleInjected)return;if("undefined"==typeof document)return;const t="danmakuSettingsPanelStyles";if(document.getElementById(t))return void(this._styleInjected=!0);const e=document.createElement("style");e.id=t,e.textContent='\n        .danmaku-settings-panel { \n            display:block; box-sizing:border-box; position:absolute; \n            background:rgba(0,0,0,.78); backdrop-filter:blur(6px); -webkit-backdrop-filter:blur(6px);\n            color:#fff; font-size:12px; line-height:1.4; padding:10px 14px 12px; \n            border:1px solid rgba(255,255,255,.18); border-radius:10px; \n            /* 自适应宽度：在较窄窗口下自动收缩，保证不超出；使用 clamp 设定范围 */\n            width:clamp(320px, 70vw, 400px); max-width:90vw; min-width:0; \n            /* 高度策略：空间充足固定 600px；小屏降级为可视高度的 90% */\n            height:min(600px, calc(var(--danmaku-vh, 1vh) * 90));\n            max-height:none;\n            opacity:0; transform:translate(-50%, 8px) scale(.94); \n            transition:opacity .18s ease, transform .22s cubic-bezier(.215,.61,.355,1); \n            pointer-events:none; will-change:opacity,transform; \n            box-shadow:0 8px 28px -6px rgba(0,0,0,.55), 0 4px 10px -2px rgba(0,0,0,.5);\n            font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;\n            overflow:hidden; display:flex; flex-direction:column;\n            /* 防止滚动冒泡到页面 */\n            overscroll-behavior:contain;\n        }\n        .danmaku-settings-panel[data-open="true"] { opacity:1; transform:translate(-50%, 0) scale(1); pointer-events:auto; }\n        .danmaku-settings-panel[data-closing="true"] { pointer-events:none; }\n    .danmaku-settings-pinBtn { position:absolute; top:6px; right:34px; width:22px; height:22px; border:0; background:rgba(255,255,255,.08); color:#ddd; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; transition:background .18s ease, color .18s ease, box-shadow .18s ease; }\n    .danmaku-settings-pinBtn:hover { background:rgba(255,255,255,.18); color:#fff; }\n    .danmaku-settings-pinBtn svg { width:14px; height:14px; fill:currentColor; pointer-events:none; }\n    .danmaku-settings-panel[data-pinned="true"] .danmaku-settings-pinBtn { background:#3fa9ff; color:#fff; box-shadow:0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6); }\n    .danmaku-settings-panel[data-pinned="true"] .danmaku-settings-pinBtn:hover { background:#56b4ff; }\n    .danmaku-settings-closeBtn { position:absolute; top:6px; right:6px; width:22px; height:22px; border:0; background:rgba(255,0,0,.14); color:#ff6b6b; border-radius:6px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; transition:background .18s ease, color .18s ease, box-shadow .18s ease; }\n    .danmaku-settings-closeBtn:hover { background:rgba(255,0,0,.22); color:#fff; }\n    .danmaku-settings-closeBtn svg { width:14px; height:14px; fill:currentColor; pointer-events:none; }\n        .danmaku-settings-panel__title { font-size:14px; font-weight:600; margin:0 0 6px; letter-spacing:.5px; }\n        .danmaku-settings-tabs { display:flex; gap:6px; margin:0 0 8px; flex-wrap:wrap; }\n        .danmaku-settings-tab { border:1px solid rgba(255,255,255,.25); background:rgba(255,255,255,.06); color:#fff; padding:4px 10px; border-radius:16px; font-size:12px; cursor:pointer; line-height:1; position:relative; }\n        .danmaku-settings-tab:hover { background:rgba(255,255,255,.12); border-color:rgba(255,255,255,.35); }\n        .danmaku-settings-tab[data-active="true"] { background:#3fa9ff; border-color:#3fa9ff; box-shadow:0 0 0 1px rgba(63,169,255,.6),0 2px 6px -2px rgba(63,169,255,.6); }\n    .danmaku-settings-panel__inner { flex:1 1 auto; display:flex; flex-direction:column; overflow:hidden; }\n    .danmaku-settings-scroll { flex:1 1 auto; overflow:auto; padding-right:6px; }\n        .danmaku-settings-tabPanels { position:relative; }\n        .danmaku-settings-tabPanel { display:none; animation:fadeIn .18s ease; }\n        .danmaku-settings-tabPanel[data-active="true"] { display:block; }\n    .danmaku-settings-list { display:flex; flex-direction:column; gap:8px; }\n        .danmaku-setting-row { display:flex; flex-direction:column; gap:3px; padding:6px 8px 7px; border:1px solid rgba(255,255,255,.08); border-radius:6px; background:rgba(255,255,255,.05); position:relative; min-width:0; }\n        .danmaku-setting-row[data-type="boolean"] { cursor:pointer; }\n        .danmaku-setting-row:hover { border-color:rgba(255,255,255,.22); background:rgba(255,255,255,.09); }\n        .danmaku-setting-row__label { font-size:12px; font-weight:500; display:flex; align-items:center; justify-content:space-between; gap:8px; }\n        .danmaku-setting-row__desc { font-size:10px; opacity:.55; line-height:1.25; }\n        .danmaku-setting-input { width:100%; box-sizing:border-box; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.25); color:#fff; border-radius:4px; padding:3px 6px; font-size:12px; line-height:1.3; outline:none; }\n        .danmaku-setting-input:focus { border-color:#3fa9ff; box-shadow:0 0 0 1px rgba(63,169,255,.45); }\n        .danmaku-setting-textarea { resize:vertical; min-height:52px; }\n        .danmaku-setting-switch { width:30px; height:16px; border-radius:16px; background:rgba(255,255,255,.35); position:relative; flex-shrink:0; }\n        .danmaku-setting-switch::after { content:""; position:absolute; left:2px; top:2px; width:12px; height:12px; background:#fff; border-radius:50%; transition:transform .18s ease, background-color .18s ease; }\n        .danmaku-setting-row[data-enabled="true"] .danmaku-setting-switch { background:#3fa9ff; }\n        .danmaku-setting-row[data-enabled="true"] .danmaku-setting-switch::after { transform:translateX(14px); }\n    .danmaku-settings-footer { padding:8px 2px 0; font-size:10px; opacity:.55; text-align:right; }\n    .danmaku-settings-actions { display:flex; gap:8px; justify-content:flex-end; padding:10px 0 0; margin-top:8px; background:transparent; border-top:1px solid rgba(255,255,255,.15); }\n    .danmaku-settings-actions button { font:500 12px/1 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; padding:6px 14px 7px; border-radius:6px; border:1px solid rgba(255,255,255,.28); background:rgba(255,255,255,.10); color:#fff; cursor:pointer; letter-spacing:.5px; transition:background-color .15s ease, border-color .15s ease, transform .15s ease; }\n    .danmaku-settings-actions button:hover:not([data-busy="true"]) { background:rgba(255,255,255,.18); border-color:rgba(255,255,255,.4); }\n    .danmaku-settings-actions button:active:not([data-busy="true"]) { transform:translateY(1px); }\n    .danmaku-settings-actions button[data-type="primary"] { background:#3fa9ff; border-color:#3fa9ff; color:#fff; box-shadow:0 2px 8px -2px rgba(63,169,255,.6); }\n    .danmaku-settings-actions button[data-type="primary"]:hover:not([data-busy="true"]) { background:#56b4ff; }\n    .danmaku-settings-actions button[data-busy="true"] { opacity:.6; cursor:default; }\n        /* 滚动条微样式 */\n    .danmaku-settings-scroll::-webkit-scrollbar { width:8px; }\n    .danmaku-settings-scroll::-webkit-scrollbar-track { background:transparent; }\n    .danmaku-settings-scroll::-webkit-scrollbar-thumb { background:rgba(255,255,255,.25); border-radius:4px; }\n    .danmaku-settings-scroll::-webkit-scrollbar-thumb:hover { background:rgba(255,255,255,.38); }\n        @media (max-width:860px) { .danmaku-settings-grid { grid-template-columns:repeat(3,1fr);} }\n        @media (max-width:680px) { .danmaku-settings-grid { grid-template-columns:repeat(2,1fr);} }\n        @media (max-width:520px) { .danmaku-settings-grid { grid-template-columns:repeat(1,1fr);} }\n        @media (prefers-reduced-motion: reduce) { .danmaku-settings-panel { transition:none!important; } .danmaku-setting-switch::after { transition:none!important; } }\n        @keyframes fadeIn { from { opacity:0; transform:translateY(4px);} to { opacity:1; transform:translateY(0);} }\n    /* 确认框样式 */\n    .danmaku-confirm-mask { position:absolute; inset:0; background:rgba(0,0,0,.35); backdrop-filter:blur(2px); -webkit-backdrop-filter:blur(2px); z-index:10000; }\n    .danmaku-confirm { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); min-width:280px; max-width:90%; background:rgba(0,0,0,.86); color:#fff; border:1px solid rgba(255,255,255,.18); border-radius:10px; box-shadow:0 8px 28px -6px rgba(0,0,0,.55), 0 4px 10px -2px rgba(0,0,0,.5); padding:12px 14px; z-index:10001; }\n    .danmaku-confirm__title { font-size:14px; font-weight:600; margin:0 0 6px; letter-spacing:.5px; }\n    .danmaku-confirm__msg { font-size:12px; opacity:.9; line-height:1.4; }\n    .danmaku-confirm__actions { display:flex; gap:8px; justify-content:flex-end; padding-top:10px; margin-top:10px; border-top:1px solid rgba(255,255,255,.15); }\n    .danmaku-confirm__actions button { font:500 12px/1 system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif; padding:6px 14px 7px; border-radius:6px; border:1px solid rgba(255,255,255,.28); background:rgba(255,255,255,.10); color:#fff; cursor:pointer; letter-spacing:.5px; transition:background-color .15s ease, border-color .15s ease, transform .15s ease; }\n    .danmaku-confirm__actions button:hover { background:rgba(255,255,255,.18); border-color:rgba(255,255,255,.4); }\n    .danmaku-confirm__actions button:active { transform:translateY(1px); }\n    .danmaku-confirm__actions button[data-type="primary"] { background:#ff6363; border-color:#ff6363; color:#fff; box-shadow:0 2px 8px -2px rgba(255,99,99,.6); }\n    .danmaku-confirm__actions button[data-type="primary"]:hover { background:#ff7a7a; }\n        ';try{(document.head||document.documentElement).appendChild(e),this._styleInjected=!0}catch(t){}}_buildContent(){const t=document.createElement("div");t.className="danmaku-settings-panel__inner";const e=document.createElement("h3");e.className="danmaku-settings-panel__title",e.textContent="弹幕设置";const n=document.createElement("button");n.type="button",n.className="danmaku-settings-pinBtn",n.setAttribute("aria-label","固定/取消固定 面板"),n.innerHTML='<svg viewBox="0 0 24 24"><path d="M14.53 2.53 12 0 9.47 2.53a5.5 5.5 0 0 0-1.61 3.9v4.17l-3.2 3.2a1 1 0 0 0 .7 1.7H11v6.5a1 1 0 0 0 2 0V15.5h5.64a1 1 0 0 0 .7-1.7l-3.2-3.2V6.43a5.5 5.5 0 0 0-1.61-3.9Z"/></svg>',n.addEventListener("click",()=>{try{this.togglePin()}catch(t){}}),t.appendChild(e),t.appendChild(n);const a=document.createElement("button");a.type="button",a.className="danmaku-settings-closeBtn",a.setAttribute("aria-label","关闭设置面板"),a.innerHTML='<svg viewBox="0 0 24 24" focusable="false" aria-hidden="true"><path d="M18.3 5.71a1 1 0 0 0-1.41 0L12 10.59 7.11 5.7A1 1 0 0 0 5.7 7.11L10.59 12l-4.9 4.89a1 1 0 1 0 1.41 1.41L12 13.41l4.89 4.9a1 1 0 0 0 1.41-1.41L13.41 12l4.9-4.89a1 1 0 0 0-.01-1.4Z"/></svg>',a.addEventListener("click",t=>{try{t.stopPropagation(),t.stopImmediatePropagation?.(),t.preventDefault?.()}catch(t){}try{this.hide()}catch(t){}}),t.appendChild(a);const i=document.createElement("div");i.className="danmaku-settings-tabs",t.appendChild(i);const s=document.createElement("div");s.className="danmaku-settings-scroll",t.appendChild(s),this._pages=[new g({logger:this.logger}),new f({logger:this.logger}),new _({logger:this.logger}),new x({logger:this.logger}),new v({logger:this.logger}),new b({logger:this.logger})];const o=document.createElement("div");o.className="danmaku-settings-tabPanels",s.appendChild(o);const r=t=>{this._currentTab!==t&&(this._currentTab=t,i.querySelectorAll(".danmaku-settings-tab").forEach(e=>e.setAttribute("data-active",e.dataset.key===t?"true":"false")),o.querySelectorAll(".danmaku-settings-tabPanel").forEach(e=>e.setAttribute("data-active",e.dataset.key===t?"true":"false")))};this._pages.forEach(t=>{const e=t.getKey(),n=document.createElement("button");n.type="button",n.className="danmaku-settings-tab",n.dataset.key=e,n.textContent=t.getLabel(),n.setAttribute("data-active","false"),n.addEventListener("click",()=>r(e)),i.appendChild(n);const a=t.build();o.appendChild(a)}),this._pages.length&&r(this._pages[0].getKey());const l=document.createElement("div");return l.className="danmaku-settings-footer",s.appendChild(l),t.appendChild(this._buildActionBar()),t}_renderRow(t,e){return document.createElement("div")}_buildActionBar(){const t=document.createElement("div");t.className="danmaku-settings-actions",t.style.justifyContent="space-between";const e=document.createElement("label");e.style.display="flex",e.style.alignItems="center",e.style.gap="4px",e.style.fontSize="11px",e.style.opacity=".85",e.style.cursor="pointer";const n=document.createElement("input");n.type="checkbox",n.style.margin=0;let a=null;try{a=localStorage.getItem("danmaku_debug_enabled")}catch(t){}let s=null!=a?"1"===a:!!this.logger?.getDebug?.();n.checked=s;try{this.logger&&this.logger.getDebug&&this.logger.getDebug()!==s&&this.logger.setDebug(s)}catch(t){}const o=document.createElement("span");o.textContent="调试模式",e.appendChild(n),e.appendChild(o),n.addEventListener("change",()=>{try{this.logger?.setDebug?.(n.checked);try{localStorage.setItem("danmaku_debug_enabled",n.checked?"1":"0")}catch(t){}}catch(t){}}),t.appendChild(e);const r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px";const l=document.createElement("button");l.type="button",l.textContent="重置",l.addEventListener("click",async()=>{try{if(!await this._showConfirm({title:"恢复默认设置",message:"确定将所有设置恢复为默认值吗？此操作会覆盖当前自定义设置。",confirmText:"重置",cancelText:"取消"}))return;const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{},e=t.danmakuSettings;if(!e||"function"!=typeof e.resetToDefaults)return void this.logger?.warn?.("重置失败：设置对象缺失或不支持重置");e.resetToDefaults(),this.logger?.info?.("已重置为默认设置（本地）");try{const e=t.getMediaId?.();e?await i(this.logger,e):await i(this.logger),this.logger?.info?.("默认设置已提交保存")}catch(t){this.logger?.warn?.("默认设置保存失败",t)}try{this._refreshPagesUI()}catch(t){}}catch(t){this.logger?.warn?.("执行重置时出错",t)}});const d=document.createElement("button");d.type="button",d.textContent="保存",d.dataset.type="primary";const c=t=>{t?(d.setAttribute("data-busy","true"),d.textContent="保存中…"):(d.removeAttribute("data-busy"),d.textContent="保存")};d.addEventListener("click",async()=>{if("true"!==d.getAttribute("data-busy"))try{const t=window?.__jfDanmakuGlobal__?.getMediaId?.();if(!t)return void this.logger?.warn?.("保存失败：缺少 mediaId");c(!0),await i(this.logger,t),this.logger?.info?.("弹幕设置已保存")}catch(t){this.logger?.warn?.("保存弹幕设置出错",t)}finally{c(!1)}}),r.appendChild(l),r.appendChild(d);const h=document.createElement("label");h.style.display="flex",h.style.alignItems="center",h.style.gap="4px",h.style.marginLeft="8px",h.style.fontSize="11px",h.style.opacity=".85";const u=document.createElement("input");u.type="checkbox",u.style.margin=0;try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};let e=null;try{e=localStorage.getItem("danmaku_auto_save")}catch(t){}const n="true"===e||"false"!==e&&null;t.danmakuAutoSave=null==n||n,u.checked=t.danmakuAutoSave}catch(t){}const p=document.createElement("span");return p.textContent="实时",h.appendChild(u),h.appendChild(p),u.addEventListener("change",()=>{try{try{localStorage.setItem("danmaku_auto_save",u.checked?"true":"false")}catch(t){}if(u.checked){(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).danmakuAutoSave=!0,localStorage.setItem("danmaku_auto_save","true"),this.logger?.info?.("实时保存已开启")}else{(window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}).danmakuAutoSave=!1,localStorage.setItem("danmaku_auto_save","false"),this.logger?.info?.("实时保存已关闭")}}catch(t){}}),r.appendChild(h),t.appendChild(r),t}_refreshPagesUI(){try{if(!this.el)return;const t=this.el.querySelector(".danmaku-settings-tabPanels"),e=this.el.querySelector(".danmaku-settings-tabs");if(!t||!e)return;const n=this._currentTab||this._pages?.[0]?.getKey?.();if(Array.isArray(this._pages))try{this._pages.forEach(t=>t?.destroy?.())}catch(t){}t.innerHTML="",e.querySelectorAll(".danmaku-settings-tab").forEach(t=>t.remove()),this._pages=[new g({logger:this.logger}),new f({logger:this.logger}),new _({logger:this.logger}),new x({logger:this.logger}),new v({logger:this.logger}),new b({logger:this.logger})];const a=n=>{this._currentTab!==n&&(this._currentTab=n,e.querySelectorAll(".danmaku-settings-tab").forEach(t=>t.setAttribute("data-active",t.dataset.key===n?"true":"false")),t.querySelectorAll(".danmaku-settings-tabPanel").forEach(t=>t.setAttribute("data-active",t.dataset.key===n?"true":"false")))};if(this._pages.forEach(n=>{const i=n.getKey(),s=document.createElement("button");s.type="button",s.className="danmaku-settings-tab",s.dataset.key=i,s.textContent=n.getLabel(),s.setAttribute("data-active","false"),s.addEventListener("click",()=>a(i)),e.appendChild(s);const o=n.build();t.appendChild(o)}),this._pages.length){const t=this._pages.some(t=>t.getKey()===n)?n:this._pages[0].getKey();this._currentTab=null,a(t)}}catch(t){}}destroy(){try{this.el?.parentElement?.removeChild(this.el)}catch(t){}if(this.el=null,Array.isArray(this._pages))try{this._pages.forEach(t=>t?.destroy?.())}catch(t){}if(this._stopFollow(),this._wheelListener){try{window.removeEventListener("wheel",this._wheelListener,!0)}catch(t){}this._wheelListener=null}if(this._keyboardListener){try{document.removeEventListener("keydown",this._keyboardListener,!0)}catch(t){}this._keyboardListener=null}}_installWheelInterceptor(t){if(!this._wheelListener){this._wheelListener=t=>{try{if(!this.el||"true"!==this.el.getAttribute("data-open"))return;this.el.contains(t.target)&&(t.stopPropagation(),t.stopImmediatePropagation?.())}catch(t){}};try{window.addEventListener("wheel",this._wheelListener,{capture:!0,passive:!0})}catch(t){}}}_installKeyboardInterceptor(t){if(!this._keyboardListener){this._keyboardListener=t=>{try{if(!this.el||"true"!==this.el.getAttribute("data-open"))return;if(!this.el.contains(t.target))return;if("Escape"===t.key)return t.stopPropagation(),t.stopImmediatePropagation?.(),void this.hide();if(t.ctrlKey||t.metaKey||t.altKey)return;if("Enter"===t.key)return;t.stopPropagation(),t.stopImmediatePropagation?.()," "!==t.key&&"Space"!==t.code||t.preventDefault()}catch(t){}};try{document.addEventListener("keydown",this._keyboardListener,!0)}catch(t){}}}_showConfirm({title:t="确认",message:e="确定执行此操作吗？",confirmText:n="确定",cancelText:a="取消"}={}){return new Promise(i=>{try{const s=this.el||document.body,o=document.createElement("div");o.className="danmaku-confirm-mask";const r=document.createElement("div");r.className="danmaku-confirm";const l=document.createElement("div");l.className="danmaku-confirm__title",l.textContent=t,r.appendChild(l);const d=document.createElement("div");d.className="danmaku-confirm__msg",d.textContent=e,r.appendChild(d);const c=document.createElement("div");c.className="danmaku-confirm__actions";const h=document.createElement("button");h.type="button",h.textContent=a,c.appendChild(h);const u=document.createElement("button");u.type="button",u.textContent=n,u.dataset.type="primary",c.appendChild(u),r.appendChild(c);const p=t=>{try{s.removeChild(o)}catch(t){}try{s.removeChild(r)}catch(t){}i(!!t)};h.addEventListener("click",()=>p(!1)),u.addEventListener("click",()=>p(!0)),o.addEventListener("click",()=>p(!1));const m=t=>{try{"Escape"===t.key&&(t.stopPropagation(),t.preventDefault(),p(!1)),"Enter"===t.key&&(t.stopPropagation(),t.preventDefault(),p(!0))}catch(t){}};document.addEventListener("keydown",m,!0);const y=()=>{try{document.removeEventListener("keydown",m,!0)}catch(t){}},g=p,f=t=>{y(),g(t)};h.onclick=()=>f(!1),u.onclick=()=>f(!0),o.onclick=()=>f(!1),s.appendChild(o),s.appendChild(r),setTimeout(()=>{try{u.focus()}catch(t){}},0)}catch(t){i(!1)}})}_ensureInViewport(){if(this.el)try{const t=8,e=window.innerWidth||document.documentElement.clientWidth||0,n=window.visualViewport?.height||window.innerHeight||document.documentElement.clientHeight||0,a=this.el.getBoundingClientRect();if(!a||0===a.width)return;let i=a.left+a.width/2,s=!1;a.left<t&&(i+=t-a.left,s=!0),a.right>e-t&&(i-=a.right-(e-t),s=!0),s&&(this.el.style.left=`${Math.round(i)}px`);let o=null;a.top<t?o=t:a.bottom>n-t&&(o=Math.max(t,n-t-a.height)),null!==o&&(this.el.style.top=`${Math.round(o)}px`)}catch(t){}}_updatePanelVhVar(){try{const t=window.visualViewport,e=Math.max(0,t?.height||window.innerHeight||document.documentElement.clientHeight||0)/100;(this.el||document.documentElement).style.setProperty("--danmaku-vh",`${e}px`)}catch(t){}}togglePin(){this._pinned=!this._pinned;try{this.el?.setAttribute("data-pinned",this._pinned?"true":"false")}catch(t){}if(this.logger?.info?.("设置面板已"+(this._pinned?"固定 (不再自动关闭)":"取消固定 (恢复自动关闭)")),!this._pinned)try{this._ensureInViewport()}catch(t){}}isPinned(){return!!this._pinned}}class k{constructor({logger:t}={}){this.logger=t||null,this.el=null,this.toggleButton=null,this.settingsButton=null,this.settingsPanel=new w({logger:this.logger}),this._globalKeyInterceptor=null,this._enabled=!1,this._toggleRetryTimer=null,this._onToggle=this._onToggle.bind(this),this._onOpenSettings=this._onOpenSettings.bind(this),this._onSettingsHoverOpen=this._onSettingsHoverOpen.bind(this),this._onDocumentClick=this._onDocumentClick.bind(this),this._onSettingsButtonMouseLeave=this._onSettingsButtonMouseLeave.bind(this),this._onPanelMouseEnter=this._onPanelMouseEnter.bind(this),this._onPanelMouseLeave=this._onPanelMouseLeave.bind(this),this._settingsHoverTimer=null,this._settingsAutoCloseTimer=null,this._restored=!1,this._freezeClickUntil=0,this._panelHasFocus=!1,this._imeComposing=!1}getElement(){if(this.el)return this.el;this._injectStylesIfNeeded();const t=document.createElement("div");t.setAttribute("data-danmaku-buttons","true"),t.className="flex align-items-center flex-direction-row danmakuButtonsGroup",t.setAttribute("dir","ltr"),t.setAttribute("data-enabled","false");const e=this._createTextInput(),n=this._createToggleButton(),a=this._createSettingsButton();n.setAttribute("aria-label","切换弹幕"),a.setAttribute("aria-label","弹幕设置");try{n.addEventListener("click",this._onToggle,{passive:!0})}catch(t){}try{a.addEventListener("click",this._onOpenSettings,{passive:!0})}catch(t){}try{a.addEventListener("mouseenter",this._onSettingsHoverOpen,{passive:!0})}catch(t){}try{a.addEventListener("mouseleave",this._onSettingsButtonMouseLeave,{passive:!0})}catch(t){}t.appendChild(e),t.appendChild(n),t.appendChild(a),this.el=t,this.inputEl=e,this.toggleButton=n,this.settingsButton=a,this._restoreEnabledStateFromSettings();try{t.setAttribute("data-enabled",String(this._enabled)),this.toggleButton?.setAttribute("aria-pressed",this._enabled?"true":"false")}catch(t){}return this._enabled&&this._applyVisibilityWithRetry(),t}_onToggle(){this._enabled=!this._enabled,this.logger?.info?.("弹幕开关: "+(this._enabled?"开启":"关闭"));try{this.el?.setAttribute("data-enabled",String(this._enabled)),this.toggleButton?.setAttribute("aria-pressed",this._enabled?"true":"false")}catch(t){}try{const t="undefined"!=typeof window?window.__jfDanmakuGlobal__:null;t?.danmakuSettings?.set&&(t.danmakuSettings.set("enable_danmaku",!!this._enabled),i(this.logger||null).catch(t=>{this.logger?.warn?.("保存设置失败",t)}))}catch(t){}this._applyVisibilityWithRetry()}_applyVisibilityWithRetry(){const t=()=>{try{const t="undefined"!=typeof window?window.__jfDanmakuGlobal__:null,e=t?.danmakuRenderer;if(!e)return!1;if(this._enabled)try{e.show?.()}catch(t){this.logger?.warn?.("调用 renderer.show 失败",t)}else try{e.hide?.()}catch(t){this.logger?.warn?.("调用 renderer.hide 失败",t)}return!0}catch(t){return this.logger?.warn?.("切换弹幕显示状态失败",t),!0}};if(!t()&&this._enabled){if(this._toggleRetryTimer)try{clearTimeout(this._toggleRetryTimer)}catch(t){}this._toggleRetryTimer=setTimeout(()=>{this._toggleRetryTimer=null,t()},1200)}}_restoreEnabledStateFromSettings(){if(!this._restored){this._restored=!0;try{const t="undefined"!=typeof window?window.__jfDanmakuGlobal__:null,e=t?.danmakuSettings?.asBool?.("enable_danmaku");this._enabled="boolean"!=typeof e||e}catch(t){}}}_onOpenSettings(){if(this._freezeClickUntil&&Date.now()<this._freezeClickUntil)this.logger?.info?.("设置面板点击切换已被冻结 (hover 冷却中)");else{this.logger?.info?.("打开/关闭弹幕设置面板 (点击)");try{this.settingsPanel.toggle(this.settingsButton)}catch(t){}this._ensureOutsideClickBinding(),this._afterMaybeOpened()}}_onSettingsHoverOpen(){if(this._settingsHoverTimer)try{clearTimeout(this._settingsHoverTimer)}catch(t){}this._settingsHoverTimer=setTimeout(()=>{this._settingsHoverTimer=null;if(!(this.settingsPanel?.el&&"true"===this.settingsPanel.el.getAttribute("data-open"))){this.logger?.info?.("打开弹幕设置面板 (悬停)");try{this.settingsPanel.show(this.settingsButton)}catch(t){}this._ensureOutsideClickBinding(),this._afterMaybeOpened(),this._freezeClickUntil=Date.now()+1e3}},100)}_afterMaybeOpened(){this.settingsPanel?.el&&"true"===this.settingsPanel.el.getAttribute("data-open")?(this._bindPanelHoverHandlers(),this._bindPanelFocusHandlers(),this._clearSettingsAutoClose()):this._clearSettingsAutoClose()}_bindPanelHoverHandlers(){if(this.settingsPanel?.el&&!this._panelHoverBound){try{this.settingsPanel.el.addEventListener("mouseenter",this._onPanelMouseEnter,{passive:!0})}catch(t){}try{this.settingsPanel.el.addEventListener("mouseleave",this._onPanelMouseLeave,{passive:!0})}catch(t){}this._panelHoverBound=!0}}_onSettingsButtonMouseLeave(){if(this._settingsHoverTimer){try{clearTimeout(this._settingsHoverTimer)}catch(t){}this._settingsHoverTimer=null}this._scheduleSettingsAutoClose()}_onPanelMouseEnter(){this._clearSettingsAutoClose()}_onPanelMouseLeave(){this._scheduleSettingsAutoClose()}_scheduleSettingsAutoClose(){if(this.settingsPanel?.el&&"true"===this.settingsPanel.el.getAttribute("data-open")&&(!this.settingsPanel?.isPinned||!this.settingsPanel.isPinned())){try{const t=this.settingsPanel?.el?.contains?.(this.el&&this.el.ownerDocument?this.el.ownerDocument.activeElement:document.activeElement);if(t)return}catch(t){}this._imeComposing||(this._clearSettingsAutoClose(),this._settingsAutoCloseTimer=setTimeout(()=>{if(this.settingsPanel?.el&&"true"===this.settingsPanel.el.getAttribute("data-open")&&(!this.settingsPanel?.isPinned||!this.settingsPanel.isPinned())){try{const t=this.settingsPanel?.el?.contains?.(this.el&&this.el.ownerDocument?this.el.ownerDocument.activeElement:document.activeElement);if(t)return void this._scheduleSettingsAutoClose()}catch(t){}if(this._imeComposing)this._scheduleSettingsAutoClose();else{try{const t=this._isElementHovered(this.settingsButton),e=this._isElementHovered(this.settingsPanel.el);if(t||e)return void this._scheduleSettingsAutoClose()}catch(t){}try{this.settingsPanel.hide()}catch(t){}}}},100))}}_clearSettingsAutoClose(){if(this._settingsAutoCloseTimer){try{clearTimeout(this._settingsAutoCloseTimer)}catch(t){}this._settingsAutoCloseTimer=null}}_isElementHovered(t){if(!t)return!1;try{return t.parentElement&&Array.from((t.ownerDocument||document).querySelectorAll(":hover")).includes(t)}catch(t){return!1}}_ensureOutsideClickBinding(){try{this._outsideClickBound||(document.addEventListener("mousedown",this._onDocumentClick,!0),this._outsideClickBound=!0)}catch(t){}}_onDocumentClick(t){try{if(!this.settingsPanel?.el)return;if(!("true"===this.settingsPanel.el.getAttribute("data-open")))return;if(this.settingsPanel?.isPinned&&this.settingsPanel.isPinned())return;try{const t=this.settingsPanel?.el?.contains?.(this.el&&this.el.ownerDocument?this.el.ownerDocument.activeElement:document.activeElement);if(this._imeComposing||t)return}catch(t){}if(this.settingsPanel.el.contains(t.target)||this.settingsButton.contains(t.target))return;this.settingsPanel.hide(),this._clearSettingsAutoClose()}catch(t){}}_bindPanelFocusHandlers(){if(!this.settingsPanel?.el)return;if(this._panelFocusBound)return;const t=this.settingsPanel.el;this._onPanelFocusIn||(this._onPanelFocusIn=()=>{this._panelHasFocus=!0,this._clearSettingsAutoClose()}),this._onPanelFocusOut||(this._onPanelFocusOut=()=>{setTimeout(()=>{try{const t=this.el&&this.el.ownerDocument?this.el.ownerDocument.activeElement:document.activeElement;this._panelHasFocus=!!this.settingsPanel?.el?.contains?.(t),this._panelHasFocus||this._scheduleSettingsAutoClose()}catch(t){}},50)}),this._onCompositionStart||(this._onCompositionStart=()=>{this._imeComposing=!0,this._clearSettingsAutoClose()}),this._onCompositionEnd||(this._onCompositionEnd=()=>{this._imeComposing=!1,this._scheduleSettingsAutoClose()});try{t.addEventListener("focusin",this._onPanelFocusIn,!0),t.addEventListener("focusout",this._onPanelFocusOut,!0),t.addEventListener("compositionstart",this._onCompositionStart,!0),t.addEventListener("compositionend",this._onCompositionEnd,!0)}catch(t){}this._panelFocusBound=!0}_injectStylesIfNeeded(){if("undefined"==typeof document)return;const t="danmakuButtonsStyles";if(document.getElementById(t))return;const e=t=>{try{return`data:image/svg+xml;charset=UTF-8,${encodeURIComponent(t).replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29")}`}catch(t){return""}},n=e('<svg id="Layer_1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1"><path d="m2.422 7.365 13.5 13.5c-.357.042-.717.08-1.075.108-.767.849-2.159 1.977-2.767 2.023-.76.042-2.069-1.124-2.927-2.023-2.545-.201-5.219-.806-5.338-.833-.333-.076-.604-.316-.719-.638-.011-.03-1.096-3.112-1.096-7.457 0-1.809.196-3.421.422-4.68zm20.139 13.074-1.486-1.486c.308-1.072.925-3.629.925-6.908 0-4.174-1.043-7.309-1.088-7.44-.109-.322-.375-.567-.705-.65-.156-.039-3.871-.955-8.208-.955-2.505 0-4.781.303-6.309.57l-2.129-2.131c-.586-.586-1.535-.586-2.121 0-.586.585-.586 1.536 0 2.121l18.999 19.001c.586.586 1.535.586 2.121 0 .586-.585.586-1.536 0-2.121z"/></svg>'),a=e('<?xml version="1.0" encoding="UTF-8"?>\n<svg xmlns="http://www.w3.org/2000/svg" id="Layer_1" data-name="Layer 1" viewBox="0 0 24 24">\n  <path d="M21.795,2.883c-.11-.32-.375-.562-.703-.644-.172-.043-4.259-1.047-9.092-1.047C7.254,1.192,3.088,2.196,2.913,2.238c-.332,.082-.6,.327-.71,.651-.049,.145-1.203,3.605-1.203,8.151s1.154,8.006,1.203,8.151c.11,.326,.38,.572,.715,.652,.109,.026,2.649,.628,5.954,.907,1.32,1.184,2.582,1.897,2.639,1.929,.151,.085,.32,.128,.489,.128,.162,0,.324-.04,.473-.119,.054-.029,1.274-.689,2.652-1.933,3.372-.277,5.858-.888,5.966-.915,.33-.082,.596-.326,.705-.647,.049-.144,1.204-3.579,1.204-8.153,0-4.614-1.156-8.015-1.205-8.157ZM7.437,5.846h3.096c.553,0,1,.448,1,1s-.447,1-1,1h-3.096c-.553,0-1-.448-1-1s.447-1,1-1Zm9.127,10.042H7.437c-.553,0-1-.448-1-1s.447-1,1-1h9.127c.553,0,1,.448,1,1s-.447,1-1,1Zm1-4.021H6.437c-.553,0-1-.448-1-1s.447-1,1-1h11.127c.553,0,1,.448,1,1s-.447,1-1,1Z"/>\n</svg>'),i=e('<svg id="Layer_1" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" data-name="Layer 1"><path d="m21.977 2.786c-.083-.381-.381-.679-.762-.762-.19-.042-4.713-1.023-9.214-1.023s-9.025.98-9.215 1.022c-.381.083-.679.381-.762.762-.042.19-1.023 4.713-1.023 9.214s.981 9.024 1.023 9.214c.083.381.381.679.762.762.19.042 4.713 1.023 9.214 1.023s9.024-.981 9.214-1.023c.381-.083.679-.381.762-.762.042-.19 1.023-4.713 1.023-9.214s-.981-9.024-1.023-9.214zm-4.119 14.677c-.533-.077-1.165-.159-1.857-.232v.77c0 .552-.448 1-1 1s-1-.448-1-1v-.935c-.654-.039-1.327-.065-2-.065-1.724 0-3.749.161-5.857.465-.535.081-1.056-.297-1.133-.847-.079-.547.3-1.054.847-1.133 2.233-.322 4.299-.486 6.143-.486.674 0 1.345.024 2 .061v-1.061c0-.552.448-1 1-1s1 .448 1 1v1.22c.803.082 1.536.175 2.143.263.547.079.926.586.847 1.132-.079.547-.587.923-1.132.847zm0-8c-1.464-.211-3.669-.462-5.857-.462-.627 0-1.304.029-2 .07v.93c0 .552-.448 1-1 1s-1-.448-1-1v-.764c-.609.065-1.227.139-1.857.229-.535.081-1.056-.297-1.133-.847-.079-.547.3-1.054.847-1.133.736-.106 1.446-.189 2.143-.26v-1.226c0-.552.448-1 1-1s1 .448 1 1v1.066c.689-.039 1.362-.066 2-.066 2.307 0 4.614.263 6.143.483.547.079.926.586.847 1.132-.079.547-.587.923-1.132.847z"/></svg>'),s=`\n        /* 尽量贴近 Jellyfin：最小化覆盖，仅定义图标 span 的显示与 mask */\n        [data-danmaku-buttons] .danmaku-input-wrapper { display:flex; align-items:center; }\n        [data-danmaku-buttons] .danmaku-text-input {\n            width: 80px; max-width:200px; height:24px; box-sizing:border-box;\n            background: rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.25); color:#fff;\n            border-radius:4px; padding:0 6px; font-size:12px; line-height:22px; outline:none;\n            transition: width .25s ease, border-color .2s ease;\n        }\n        [data-danmaku-buttons] .danmaku-text-input:focus { border-color:#3fa9ff; }\n        [data-danmaku-buttons][data-enabled="false"] .danmaku-text-input { opacity:.7; }\n        [data-danmaku-buttons] .danmaku-input-wrapper.active .danmaku-text-input { width:160px; }\n        [data-danmaku-buttons] .danmaku-send-btn { display:none; margin-left:4px; background:rgba(63,169,255,0.15); border:1px solid rgba(63,169,255,0.6); color:#fff; border-radius:4px; padding:0 6px; height:24px; font-size:12px; cursor:pointer; }\n        [data-danmaku-buttons] .danmaku-send-btn:hover { background:rgba(63,169,255,0.25); }\n        [data-danmaku-buttons] .danmaku-input-wrapper.active .danmaku-send-btn { display:inline-flex; align-items:center; }\n        [data-danmaku-buttons] .danmaku-btn {\n            background: none;\n            border: 0;\n            color: inherit;\n            cursor: pointer;\n        }\n        [data-danmaku-buttons] .danmaku-icon {\n            display: inline-block;\n            width: 24px; height: 24px;\n            background-color: currentColor;\n            -webkit-mask-position: center; mask-position: center;\n            -webkit-mask-repeat: no-repeat; mask-repeat: no-repeat;\n            -webkit-mask-size: 24px 24px; mask-size: 24px 24px;\n        }\n        [data-danmaku-buttons] .danmaku-settings-btn .danmaku-icon {\n            -webkit-mask-image: url(${i});\n            mask-image: url(${i});\n        }\n        [data-danmaku-buttons] .danmaku-toggle-btn .danmaku-icon {\n            -webkit-mask-image: url(${n});\n            mask-image: url(${n});\n        }\n        [data-danmaku-buttons][data-enabled="true"] .danmaku-toggle-btn .danmaku-icon {\n            -webkit-mask-image: url(${a});\n            mask-image: url(${a});\n        }\n        `,o=document.createElement("style");o.id=t,o.appendChild(document.createTextNode(s));try{(document.head||document.documentElement).appendChild(o)}catch(t){}}_createToggleButton(){const t=document.createElement("button");t.type="button",t.textContent="",t.setAttribute("is","paper-icon-button-light"),t.className="paper-icon-button-light autoSize danmaku-btn danmaku-toggle-btn btnDanmakuToggle",t.setAttribute("data-danmaku-btn","toggle"),t.setAttribute("title","弹幕开关"),t.setAttribute("aria-pressed","false");const e=document.createElement("span");return e.className="xlargePaperIconButton material-icons danmaku-icon",e.setAttribute("aria-hidden","true"),t.appendChild(e),t}_createTextInput(){const t=document.createElement("div");t.className="danmaku-input-wrapper";const e=document.createElement("input");e.type="text",e.placeholder="发送弹幕",e.className="danmaku-text-input",e.setAttribute("data-danmaku-input","text"),e.id="danmakuInputField",e.name="danmakuInput",e.setAttribute("aria-label","弹幕输入");const n=document.createElement("button");n.type="button",n.textContent="发送",n.className="danmaku-send-btn",n.setAttribute("aria-label","发送弹幕");try{const a=(n=!0)=>{const a=e.value.trim();if(!a)return;let i=!1;try{const t="undefined"!=typeof window?window.__jfDanmakuGlobal__:null,e=t?.danmakuRenderer;if(e){const t=e.media&&!isNaN(e.media.currentTime)?e.media.currentTime:0;e.emit({text:a,time:t,mode:"rtl",style:{font:"25px sans-serif",fillStyle:"#FFFFFF",strokeStyle:"#000",lineWidth:2,textBaseline:"bottom"}});try{e.show&&e.show()}catch(t){}i=!0}}catch(t){this.logger?.warn?.("发送弹幕失败(emit异常)",t)}if(i?this.logger?.info?.("发送弹幕: "+a):this.logger?.info?.("发送弹幕失败: 找不到全局 danmakuRenderer"),e.value="",t.classList.add("active"),n)try{e.focus()}catch(t){}};e.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),a(!0))}),e.addEventListener("focus",()=>{t.classList.add("active"),this._globalKeyInterceptor||(this._globalKeyInterceptor=t=>{if(document.activeElement===e){if("Escape"===t.key)return;if(t.ctrlKey||t.metaKey||t.altKey)return;if("Enter"===t.key)return;t.stopPropagation(),t.stopImmediatePropagation?.()," "!==t.key&&"Space"!==t.code||t.preventDefault()}});try{document.addEventListener("keydown",this._globalKeyInterceptor,!0)}catch(t){}}),e.addEventListener("blur",n=>{setTimeout(()=>{e.value.trim()||t.classList.remove("active");try{document.removeEventListener("keydown",this._globalKeyInterceptor,!0)}catch(t){}},120)}),n.addEventListener("click",()=>{if(e.value.trim()){a(!1);try{e.blur()}catch(t){}}else t.classList.remove("active")})}catch(t){}return t.appendChild(e),t.appendChild(n),t}_createSettingsButton(){const t=document.createElement("button");t.type="button",t.textContent="",t.setAttribute("is","paper-icon-button-light"),t.className="paper-icon-button-light autoSize danmaku-btn danmaku-settings-btn btnDanmakuSettings",t.setAttribute("data-danmaku-btn","settings"),t.setAttribute("title","弹幕设置");const e=document.createElement("span");return e.className="xlargePaperIconButton material-icons danmaku-icon",e.setAttribute("aria-hidden","true"),t.appendChild(e),t}destroy(){if(this._toggleRetryTimer){try{clearTimeout(this._toggleRetryTimer)}catch(t){}this._toggleRetryTimer=null}try{this.toggleButton?.removeEventListener("click",this._onToggle)}catch(t){}try{this.settingsButton?.removeEventListener("click",this._onOpenSettings)}catch(t){}try{this.settingsButton?.removeEventListener("mouseenter",this._onSettingsHoverOpen)}catch(t){}try{this.settingsButton?.removeEventListener("mouseleave",this._onSettingsButtonMouseLeave)}catch(t){}try{this.inputEl?.querySelector?.("input")?.removeEventListener?.("keydown")}catch(t){}try{document.removeEventListener("keydown",this._globalKeyInterceptor,!0)}catch(t){}try{document.removeEventListener("mousedown",this._onDocumentClick,!0)}catch(t){}try{this.el?.parentElement?.removeChild(this.el)}catch(t){}if(this.settingsPanel?.el){try{this.settingsPanel.el.removeEventListener("mouseenter",this._onPanelMouseEnter)}catch(t){}try{this.settingsPanel.el.removeEventListener("mouseleave",this._onPanelMouseLeave)}catch(t){}try{this.settingsPanel.el.removeEventListener("focusin",this._onPanelFocusIn,!0)}catch(t){}try{this.settingsPanel.el.removeEventListener("focusout",this._onPanelFocusOut,!0)}catch(t){}try{this.settingsPanel.el.removeEventListener("compositionstart",this._onCompositionStart,!0)}catch(t){}try{this.settingsPanel.el.removeEventListener("compositionend",this._onCompositionEnd,!0)}catch(t){}}this._clearSettingsAutoClose();try{this.settingsPanel?.destroy?.()}catch(t){}this.el=null,this.inputEl=null,this.toggleButton=null,this.settingsButton=null}}class C{constructor(t={}){this.options={height:t.height||60,debug:t.debug||!1,autoResize:!1!==t.autoResize,lineWidth:t.lineWidth||1,lineColor:t.lineColor??"#3498db",gradientColorStart:t.gradientColorStart??"rgba(52, 152, 219, 0.08)",gradientColorEnd:t.gradientColorEnd??"rgba(52, 152, 219, 0.25)",canvasId:t.canvasId||"danmaku-heatmap-canvas",...t},this.canvas=null,this.ctx=null,this.logicalWidth=0,this.rawData=[],this.processedData=[],this.actualDuration=0,this.maxDensity=0,this.minDensity=0,this.resizeObserver=null,this.parentContainer=null,this.lastRenderedWidth=0,this.resizeThreshold=t.resizeThreshold||10,this.cachedCanvas=null,this.resizeDebounceTimer=null,this.resizeDebounceDelay=t.resizeDebounceDelay||300,this.pendingWidth=null,null!=t.width&&this.debugLog("提示：width 选项已弃用，将忽略并使用父容器宽度"),this.debugLog("热力图渲染器已初始化"),this.debugLog("样式配置:",{lineWidth:this.options.lineWidth,lineColor:this.options.lineColor,gradientColorStart:this.options.gradientColorStart,gradientColorEnd:this.options.gradientColorEnd,autoResize:this.options.autoResize})}debugLog(t,...e){this.options.debug&&console.log(`[弹幕热力图] ${t}`,...e)}setHeatmapData(t){if(null==t&&(t=[]),!Array.isArray(t))throw new Error("热力图数据必须是数组格式");return 0===t.length?(this.rawData=[],this.debugLog("设置热力图数据：空数组（正常化处理）"),this):(this.rawData=t.map(t=>({start_time_seconds:Number(t.start_time_seconds),end_time_seconds:Number(t.end_time_seconds),average_density:Number(t.average_density)})),this.debugLog("设置热力图数据，共",this.rawData.length,"个数据段"),this.debugLog("原始数据详情:",JSON.stringify(this.rawData,null,2)),this)}setActualDuration(t){return this.actualDuration=Number(t),this.debugLog("设置视频实际时长:",this.actualDuration,"秒"),this}preprocessData(){if(0===this.rawData.length)return this.debugLog("没有原始数据，跳过预处理"),this;let t=[...this.rawData].sort((t,e)=>t.start_time_seconds-e.start_time_seconds);this.debugLog("排序后数据:",JSON.stringify(t,null,2));const e=t[t.length-1].end_time_seconds;return this.debugLog("数据时长:",e,"秒"),this.actualDuration<=0?(this.debugLog("未设置视频时长，使用原始数据"),this.processedData=t,this.debugLog("最终处理数据:",JSON.stringify(this.processedData,null,2)),this):(t=this.adjustDataByDuration(t,e,this.actualDuration),t=this.fillGapsWithZeroSegments(t,this.actualDuration),this.processedData=t,this.debugLog("数据预处理完成，最终数据段数量:",this.processedData.length),this.debugLog("最终处理数据:",JSON.stringify(this.processedData,null,2)),this)}adjustDataByDuration(t,e,n){const a=e-n;if(this.debugLog("时间差:",a,"秒"),this.debugLog("调整前数据:",JSON.stringify(t,null,2)),a>0){this.debugLog("删除超出视频时长的数据");const e=t.length;if(t=t.filter(t=>t.start_time_seconds<n),this.debugLog(`过滤后: ${e} -> ${t.length} 个数据段`),t.length>0){const e=t[t.length-1];if(e.end_time_seconds>n){const t=e.end_time_seconds;e.end_time_seconds=n,this.debugLog(`调整最后一个数据的结束时间: ${t} -> ${n}`)}}}else if(a<-2){this.debugLog("添加填充数据到视频结尾");const a={start_time_seconds:e,end_time_seconds:e+1,average_density:0};t.push(a),this.debugLog("添加第一个填充数据:",JSON.stringify(a,null,2));const i={start_time_seconds:e+1,end_time_seconds:n,average_density:0};t.push(i),this.debugLog("添加第二个填充数据:",JSON.stringify(i,null,2)),this.debugLog("添加了2个填充数据段")}return this.debugLog("调整后数据:",JSON.stringify(t,null,2)),t}fillGapsWithZeroSegments(t,e){if(!Array.isArray(t)||0===t.length)return t||[];const n=[...t].sort((t,e)=>t.start_time_seconds-e.start_time_seconds),a=[],i=t=>"number"==typeof e&&isFinite(e)&&e>0?Math.max(0,Math.min(t,e)):Math.max(0,t),s=n[0];if(s.start_time_seconds>0){const t=i(0),e=i(s.start_time_seconds);e>t&&(a.push({start_time_seconds:t,end_time_seconds:e,average_density:0}),this.debugLog(`起始缺口填充: [${t}, ${e}) -> 0`))}a.push(s);for(let t=1;t<n.length;t++){const e=n[t-1],s=n[t],o=i(e.end_time_seconds),r=i(s.start_time_seconds);r>o&&(a.push({start_time_seconds:o,end_time_seconds:r,average_density:0}),this.debugLog(`段间缺口填充: [${o}, ${r}) -> 0`)),a.push(s)}const o=a.filter(t=>"number"==typeof t.start_time_seconds&&"number"==typeof t.end_time_seconds&&t.end_time_seconds>t.start_time_seconds).sort((t,e)=>t.start_time_seconds-e.start_time_seconds);return this.debugLog("缺口填充后数据:",JSON.stringify(o,null,2)),o}calculateDensityRange(){0!==this.processedData.length&&(this.maxDensity=Math.max(...this.processedData.map(t=>t.average_density)),this.minDensity=Math.min(...this.processedData.map(t=>t.average_density)),this.maxDensity===this.minDensity&&(this.maxDensity+=1),this.debugLog("密度范围:",this.minDensity,"到",this.maxDensity))}setupResizeObserver(){this.canvas&&("undefined"!=typeof ResizeObserver?(this.parentContainer=this.canvas.parentElement,this.parentContainer?(this.debugLog("设置ResizeObserver，监听父容器:",this.parentContainer),this.resizeObserver=new ResizeObserver(t=>{for(const e of t)this.handleResize(e)}),this.resizeObserver.observe(this.parentContainer),this.updateCanvasSize()):this.debugLog("未找到父容器，等待Canvas插入DOM后再设置ResizeObserver")):this.debugLog("浏览器不支持ResizeObserver，跳过自动调整大小功能"))}handleResize(t){const e=Math.floor(t.contentRect.width);e!==this.logicalWidth&&e>0&&(this.debugLog(`容器宽度变化检测: ${this.logicalWidth}px -> ${e}px`),this.logicalWidth=e,this.updateCanvasSize(),this.performQuickResize(),this.pendingWidth=e,this.resizeDebounceTimer&&(clearTimeout(this.resizeDebounceTimer),this.debugLog("清除之前的防抖计时器")),this.resizeDebounceTimer=setTimeout(()=>{this.processResizeChange()},this.resizeDebounceDelay),this.debugLog(`设置防抖计时器，${this.resizeDebounceDelay}ms后执行重新计算`))}performQuickResize(){if(this.cachedCanvas){this.ctx.clearRect(0,0,this.logicalWidth,this.options.height);const t=window.devicePixelRatio||1,e=this.cachedCanvas.width/t,n=this.cachedCanvas.height/t;this.ctx.drawImage(this.cachedCanvas,0,0,this.cachedCanvas.width,this.cachedCanvas.height,0,0,this.logicalWidth,this.options.height),this.debugLog(`使用缓存内容进行快速缩放: ${e}x${n} -> ${this.logicalWidth}x${this.options.height}`)}else this.processedData&&this.processedData.length>0&&(this.drawHeatmap(),this.debugLog("执行快速重绘"))}processResizeChange(){if(null===this.pendingWidth)return;const t=Math.abs(this.pendingWidth-this.lastRenderedWidth);this.debugLog(`防抖处理完成，最终宽度: ${this.pendingWidth}px`),this.debugLog(`与上次渲染宽度(${this.lastRenderedWidth}px)差值: ${t}px, 阈值: ${this.resizeThreshold}px`),t>=this.resizeThreshold?(this.debugLog("宽度变化超过阈值，执行重新渲染"),this.redraw(),this.lastRenderedWidth=this.pendingWidth,this.cacheCanvas()):(this.debugLog("宽度变化未超过阈值，使用缓存内容"),this.restoreFromCache()),this.pendingWidth=null,this.resizeDebounceTimer=null}updateCanvasSize(){if(!this.canvas)return;const t=window.devicePixelRatio||1,e=this.canvas.parentElement||this.parentContainer;let n=0;e&&(n=Math.floor(e.clientWidth||e.getBoundingClientRect().width||0)),n||(n=Math.floor(this.canvas.getBoundingClientRect().width||0)),n||(n=this.logicalWidth||3840),this.logicalWidth=n,this.debugLog("更新Canvas尺寸:",this.logicalWidth,"x",this.options.height,"设备像素比:",t),this.canvas.width=this.logicalWidth*t,this.canvas.height=this.options.height*t,this.canvas.style.width="100%",this.canvas.style.height=this.options.height+"px",this.ctx=this.canvas.getContext("2d"),this.ctx.scale(t,t),this.debugLog("Canvas分辨率已设置为:",this.canvas.width,"x",this.canvas.height),this.debugLog("Canvas显示尺寸:",this.canvas.style.width,"x",this.canvas.style.height)}redraw(){if(!this.processedData||0===this.processedData.length)return void this.debugLog("没有处理过的数据，跳过重绘");this.debugLog("重新绘制热力图");const t=window.devicePixelRatio||1;this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(t,t),this.calculateDensityRange(),this.drawHeatmap(),this.cacheCanvas()}destroy(){this.resizeDebounceTimer&&(clearTimeout(this.resizeDebounceTimer),this.resizeDebounceTimer=null,this.debugLog("防抖计时器已清理")),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null,this.debugLog("ResizeObserver已销毁")),this.cachedCanvas=null,this.pendingWidth=null}cacheCanvas(){if(this.canvas)try{this.cachedCanvas=document.createElement("canvas"),this.cachedCanvas.width=this.canvas.width,this.cachedCanvas.height=this.canvas.height;this.cachedCanvas.getContext("2d").drawImage(this.canvas,0,0),this.debugLog("Canvas内容已缓存，尺寸:",this.canvas.width,"x",this.canvas.height)}catch(t){this.debugLog("缓存Canvas失败:",t),this.cachedCanvas=null}}restoreFromCache(){if(!this.cachedCanvas||!this.canvas||!this.ctx)return this.debugLog("无法从缓存恢复：缓存不存在或Canvas未初始化"),!1;try{this.ctx.clearRect(0,0,this.logicalWidth,this.options.height);const t=this.logicalWidth/(this.cachedCanvas.width/(window.devicePixelRatio||1)),e=this.options.height/(this.cachedCanvas.height/(window.devicePixelRatio||1));return this.ctx.save(),this.ctx.scale(t,e),this.ctx.drawImage(this.cachedCanvas,0,0,this.cachedCanvas.width/(window.devicePixelRatio||1),this.cachedCanvas.height/(window.devicePixelRatio||1)),this.ctx.restore(),this.debugLog("从缓存恢复Canvas内容，缩放比例:",t.toFixed(2),"x",e.toFixed(2)),!0}catch(t){return this.debugLog("从缓存恢复失败:",t),!1}}createCanvas(t={}){const e=!this.processedData||0===this.processedData.length,n=window.devicePixelRatio||1;this.canvas=document.createElement("canvas"),this.canvas.id=this.options.canvasId,this.canvas.width=Math.max(1,(this.logicalWidth||1)*n),this.canvas.height=this.options.height*n;const a={width:"100%",height:"40px",display:"block",margin:"0",padding:"0",borderRadius:"4px",background:"transparent",pointerEvents:"none",position:"absolute",top:"-47px",left:"0",zIndex:"1",opacity:"0.8",...t};return Object.assign(this.canvas.style,a),this.canvas.style.width="100%",this.canvas.style.height=this.options.height+"px",this.ctx=this.canvas.getContext("2d"),this.ctx.scale(n,n),this.options.autoResize&&setTimeout(()=>{this.setupResizeObserver(),this.updateCanvasSize(),e||(this.calculateDensityRange(),this.drawHeatmap(),this.cacheCanvas(),this.lastRenderedWidth=this.logicalWidth)},0),e&&this.debugLog("空数据：创建空白热力图 Canvas"),this.debugLog("Canvas创建完成"),this.canvas}drawHeatmap(){if(!this.ctx||0===this.processedData.length)return;this.ctx.clearRect(0,0,this.logicalWidth,this.options.height);const t=this.logicalWidth,e=this.options.height-10,n=[];for(const a of this.processedData){const i=e=>e/this.actualDuration*t,s=t=>{const n=(t-this.minDensity)/(this.maxDensity-this.minDensity);return 5+e-n*e};if(0===a.average_density){const t=i(a.start_time_seconds),e=i(a.end_time_seconds),o=s(0);n.push({x:t,y:o,density:0,midTime:a.start_time_seconds}),n.push({x:e,y:o,density:0,midTime:a.end_time_seconds})}else{const t=(a.start_time_seconds+a.end_time_seconds)/2,e=i(t),o=s(a.average_density);n.push({x:e,y:o,density:a.average_density,midTime:t})}}if(n.sort((t,e)=>t.x-e.x),n.length>=2){const a=.5,i=Math.abs(n[0].x-0)<a,s=Math.abs(n[n.length-1].x-t)<a;if(!i){const t=n[0],a=n[1],i=(a.y-t.y)/(a.x-t.x);let s=t.y-i*t.x;s=Math.max(5,Math.min(5+e,s));const o={x:0,y:s,density:t.density,midTime:0,isExtended:!0};n.unshift(o),this.debugLog(`添加延伸起点: 时间0s -> 坐标(${o.x.toFixed(1)}, ${o.y.toFixed(1)})`)}if(!s){const a=n[n.length-2],i=n[n.length-1],s=(i.y-a.y)/(i.x-a.x);let o=i.y+s*(t-i.x);o=Math.max(5,Math.min(5+e,o));const r={x:t,y:o,density:i.density,midTime:this.actualDuration,isExtended:!0};n.push(r),this.debugLog(`添加延伸终点: 时间${this.actualDuration}s -> 坐标(${r.x.toFixed(1)}, ${r.y.toFixed(1)})`)}}this.debugLog("坐标点映射详情:"),n.forEach((t,e)=>{t.isExtended?this.debugLog(`点${e}: [延伸点] 时间${t.midTime}s -> 坐标(${t.x.toFixed(1)}, ${t.y.toFixed(1)})`):this.debugLog(`点${e}: 时间${t.midTime}s, 密度${t.density} -> 坐标(${t.x.toFixed(1)}, ${t.y.toFixed(1)})`)}),this.drawFillArea(n,5,e),this.drawSmoothCurve(n),this.debugLog("热力图绘制完成"),this.cacheCanvas()}drawFillArea(t,e,n){if(0===t.length)return;this.ctx.save();const a=this.ctx.createLinearGradient(0,e+n,0,e);a.addColorStop(0,this.options.gradientColorStart),a.addColorStop(1,this.options.gradientColorEnd),this.ctx.fillStyle=a,this.ctx.beginPath(),this.ctx.moveTo(Math.round(t[0].x),e+n),this.ctx.lineTo(Math.round(t[0].x),Math.round(t[0].y)),this.drawMonotonicSpline(t),this.ctx.lineTo(Math.round(t[t.length-1].x),e+n),this.ctx.closePath(),this.ctx.fill(),this.ctx.restore()}drawSmoothCurve(t){0!==t.length&&(this.ctx.imageSmoothingEnabled=!0,this.ctx.imageSmoothingQuality="high",this.ctx.strokeStyle=this.options.lineColor,this.ctx.lineWidth=this.options.lineWidth,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.beginPath(),this.ctx.moveTo(Math.round(t[0].x),Math.round(t[0].y)),this.drawMonotonicSpline(t),this.ctx.stroke())}drawMonotonicSpline(t){if(t.length<3){for(let e=1;e<t.length;e++)this.ctx.lineTo(Math.round(t[e].x),Math.round(t[e].y));return}const e=this.calculateMonotonicSlopes(t);for(let n=0;n<t.length-1;n++){const a=t[n],i=t[n+1],s=e[n],o=e[n+1];let r;if(a.isExtended||i.isExtended)r=10;else{const e=t[0].isExtended?n-1:n,a=t[0].isExtended?n:n+1;if(e>=0&&a<this.processedData.length){const t=this.processedData[e],n=this.processedData[a],i=Math.abs(n.start_time_seconds-t.start_time_seconds);r=Math.max(5,Math.min(20,Math.ceil(i/5)))}else r=10}for(let t=0;t<=r;t++){const e=t/r,n=this.hermiteInterpolation(a,i,s,o,e);this.ctx.lineTo(Math.round(n.x),Math.round(n.y))}}}calculateMonotonicSlopes(t){const e=new Array(t.length);for(let n=0;n<t.length;n++)if(0===n)e[n]={x:t[1].x-t[0].x,y:(t[1].y-t[0].y)/(t[1].x-t[0].x)};else if(n===t.length-1)e[n]={x:t[n].x-t[n-1].x,y:(t[n].y-t[n-1].y)/(t[n].x-t[n-1].x)};else{const a=t[n].x-t[n-1].x,i=t[n].y-t[n-1].y,s=t[n+1].x-t[n].x,o=t[n+1].y-t[n].y,r=s/(a+s),l=a/(a+s);e[n]={x:a,y:r*(i/a)+l*(o/s)};const d=i/a,c=o/s;if(d*c<=0)e[n].y=0;else{const t=Math.min(Math.abs(d),Math.abs(c)),a=Math.sign(e[n].y);e[n].y=a*Math.min(Math.abs(e[n].y),3*t)}}return e}hermiteInterpolation(t,e,n,a,i){const s=i*i,o=s*i,r=2*o-3*s+1,l=o-2*s+i,d=-2*o+3*s,c=o-s,h=e.x-t.x;return{x:t.x+i*h,y:r*t.y+l*h*n.y+d*e.y+c*h*a.y}}showError(t="热力图渲染失败"){this.ctx&&(this.ctx.clearRect(0,0,this.logicalWidth,this.options.height),this.ctx.fillStyle="rgba(220, 53, 69, 0.1)",this.ctx.fillRect(0,0,this.logicalWidth,this.options.height),this.ctx.fillStyle="#dc3545",this.ctx.font="14px Arial",this.ctx.textAlign="center",this.ctx.fillText(t,this.logicalWidth/2,this.options.height/2))}process(t,e,n={}){try{return null==t&&(t=[]),this.setHeatmapData(t).setActualDuration(e).preprocessData().createCanvas(n)}catch(t){return this.debugLog("处理失败:",t),this.showError(t.message),this.canvas}}recalculate(t,e){try{return this.canvas?("number"==typeof e&&isFinite(e)&&e>0&&this.setActualDuration(e),Array.isArray(t)&&this.setHeatmapData(t),this.rawData&&0!==this.rawData.length?(this.debugLog("开始重新计算热力图"),this.preprocessData(),this.calculateDensityRange(),this.drawHeatmap(),this.lastRenderedWidth=this.logicalWidth,this.cacheCanvas(),this.debugLog("重新计算完成"),this):(this.debugLog("没有原始数据：清空画布并保持空白"),this.ctx.clearRect(0,0,this.logicalWidth,this.options.height),this.cacheCanvas(),this)):(this.debugLog("Canvas未创建，无法重新计算"),this)}catch(t){return this.debugLog("重新计算失败:",t),this.showError("重新计算失败: "+t.message),this}}updateStyles(t={}){if(!t||"object"!=typeof t)return this;const{lineWidth:e,lineColor:n,gradientColorStart:a,gradientColorEnd:i}=t;return"number"==typeof e&&isFinite(e)&&e>0&&(this.options.lineWidth=e),"string"==typeof n&&n&&(this.options.lineColor=n),"string"==typeof a&&a&&(this.options.gradientColorStart=a),"string"==typeof i&&i&&(this.options.gradientColorEnd=i),this.debugLog("样式已更新:",{lineWidth:this.options.lineWidth,lineColor:this.options.lineColor,gradientColorStart:this.options.gradientColorStart,gradientColorEnd:this.options.gradientColorEnd}),this.canvas&&this.ctx&&this.redraw(),this}hide(){return this.canvas?(this.canvas.style.display="none",this.debugLog("热力图已隐藏"),this):(this.debugLog("Canvas未创建，无法隐藏"),this)}show(){return this.canvas?(this.canvas.style.display="block",this.debugLog("热力图已显示"),this):(this.debugLog("Canvas未创建，无法显示"),this)}}function E(t,e,n){for(var a=0,i=t.length;a<i;){var s=a+i>>1;t[s][e]<=n?a=s+1:i=s}return a}function S(t){return/^(ltr|top|bottom)$/i.test(t)?String(t||"").toLowerCase():"rtl"}function L(t,e,n,a){if("number"!=typeof t)return 1;var i=e-t;if(i<=0)return a||1.25;var s=n||.35;if(i>=s)return 1;var o=function(t){var e=1.70158;return(t-=1)*t*((e+1)*t+e)+1}(i/s);return 1+((a||1.25)-1)*(1-o)}function D(t){var e=(t?t.width:0)||0,n="number"==typeof t._occupiedWidth&&isFinite(t._occupiedWidth)?t._occupiedWidth:e;return Math.max(e,n)}function M(t){return t&&"number"==typeof t._baseWidth&&isFinite(t._baseWidth)?t._baseWidth:t&&"number"==typeof t.width&&isFinite(t.width)?t.width:0}var A=Object.create(null),I=Object.create(null);function T(t){try{if(!t||"string"!=typeof t||0!==t.indexOf("/danmaku/font/"))return Promise.resolve(null);var e=I;if(e[t]&&"loaded"===e[t].status)return Promise.resolve(e[t].family);if(e[t]&&"loading"===e[t].status&&e[t].promise)return e[t].promise;var n="JFDanmaku_"+(t.split("/").pop()||"RemoteFont").replace(/\.[a-z0-9]+$/i,""),a=(t||"").replace(/^\/+/,""),i=a;try{"undefined"!=typeof ApiClient&&ApiClient.getUrl&&(i=ApiClient.getUrl(a))}catch(t){}var s=async function(){try{var a="undefined"!=typeof caches&&caches.open,s=null,o="font/ttf";if(a)try{var r=await caches.open("jfdanmaku-fonts-v1"),l=new Request(i,{credentials:"same-origin",mode:"cors"}),d=await r.match(l);d&&(s=await d.arrayBuffer(),o=d.headers.get("content-type")||o)}catch(t){}if(!s){var c=await fetch(i,{credentials:"same-origin",mode:"cors"});if(!c||!c.ok)throw new Error("HTTP "+(c&&c.status));try{if(a){var h=await caches.open("jfdanmaku-fonts-v1");await h.put(new Request(i,{credentials:"same-origin",mode:"cors"}),c.clone())}}catch(t){}o=c.headers.get("content-type")||o,s=await c.arrayBuffer()}var u=new Blob([s],{type:o}),p=URL&&URL.createObjectURL?URL.createObjectURL(u):null,m=new FontFace(n,p?"url("+p+")":"url("+i+")",{style:"normal",display:"swap"}),y=await m.load();try{document.fonts.add(y)}catch(t){}try{p&&URL&&URL.revokeObjectURL&&URL.revokeObjectURL(p)}catch(t){}return e[t]={status:"loaded",family:n,fontFace:y},n}catch(n){return e[t]={status:"failed",error:String(n)},null}}();return e[t]={status:"loading",family:n,promise:s},s}catch(t){return Promise.resolve(null)}}function R(t){try{if(!t||!t.font||"string"!=typeof t.font)return;if(-1===t.font.indexOf("/danmaku/font/"))return;var e=t.font.match(/\/danmaku\/font\/[^"',)\s]+/);if(!e)return;var n=e[0],a=I;if(a[n]&&"loaded"===a[n].status&&a[n].family){var i=a[n].family;return void(t.font=t.font.replace(n,"'"+i+"'"))}t.font=t.font.replace(n,"sans-serif"),T(n)}catch(t){}}function z(t,e){if(A[t])return A[t];var n=12,a=t.match(/(\d+(?:\.\d+)?)(px|%|em|rem)(?:\s*\/\s*(\d+(?:\.\d+)?)(px|%|em|rem)?)?/);if(a){var i=1*a[1]||10,s=a[2],o=1*a[3]||1.2,r=a[4];"%"===s&&(i*=e.container/100),"em"===s&&(i*=e.container),"rem"===s&&(i*=e.root),"px"===r&&(n=o),"%"===r&&(n=i*o/100),"em"===r&&(n=i*o),"rem"===r&&(n=e.root*o),void 0===r&&(n=i*o)}return A[t]=n,n}function N(t){return 1*window.getComputedStyle(t,null).getPropertyValue("font-size").match(/(.+)px/)[1]}function j(){try{return window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}}catch(t){return{}}}function W(){try{var t=j();return"dynamic"===(t&&t.danmakuSettings&&t.danmakuSettings.get&&t.danmakuSettings.get("mark_style"))}catch(t){return!1}}function P(){var t=9007199254740991;return[{range:0,time:-t,width:t,height:0},{range:t,time:t,width:0,height:0}]}function F(t,e,n){var a=t.media?t.media.currentTime:Date.now()/1e3,i=t.media?t.media.playbackRate:1;if("top"===n.mode||"bottom"===n.mode){var s=function(t,e,n){var a,i=t&&t.cmt?t.cmt:t,s=i&&"number"==typeof i.time?i.time+e:e;if(!n)return s;if(Array.isArray(i&&i._markTimes)&&i._markTimes.length>0)a=i._markTimes[i._markTimes.length-1];else if(Array.isArray(i&&i.mark_count)&&i.mark_count.length>0)try{a=Math.max.apply(null,i.mark_count)}catch(t){a=void 0}return"number"==typeof a&&isFinite(a)?a+4:s}(e,t._.duration,W());return a<s}var o=D(e.cmt||e),r=D(n);if(o>(t._.width+o)*(a-e.time)*i/t._.duration)return!0;var l=t._.duration+e.time-a,d=(t._.width+r)*(a-(t.media?n.time:n._utc))*i/t._.duration,c=t._.width-d;return l>t._.duration*c/(t._.width+r)}function B(t,e){for(var n=t._.space[e.mode],a=0,i=0,s=1;s<n.length;s++){var o=n[s],r=e.height;if("top"!==e.mode&&"bottom"!==e.mode||(r+=o.height),o.range-o.height-n[a].range>=r){i=s;break}F(t,o,e)&&(a=s)}var l=n[a].range,d={range:l+e.height,time:t.media?e.time:e._utc,width:D(e),height:e.height,cmt:e};return n.splice(a+1,i-a-1,d),"bottom"===e.mode?t._.height-e.height-l%t._.height:l%(t._.height-e.height)}function O(t,e){for(var n=this._.runningList.length-1;n>=0;n--){var a=this._.runningList[n];if(t>=a.x&&t<=a.x+a.width&&e>=a.y&&e<=a.y+a.height)return a}return null}function G(){var t=this;if(!this._.copyMenuHandlers){var e=document.createElement("div");e.style.position="fixed",e.style.zIndex="2147483646",e.style.background="rgba(30,30,30,0.95)",e.style.backdropFilter="blur(4px)",e.style.border="1px solid rgba(255,255,255,0.15)",e.style.borderRadius="6px",e.style.padding="4px 0",e.style.minWidth="96px",e.style.font="12px/1.4 system-ui, sans-serif",e.style.color="#f0f0f0",e.style.boxShadow="0 4px 18px rgba(0,0,0,0.4)",e.style.userSelect="none",e.style.display="none",e.setAttribute("data-danmaku-copy-menu","");var n=document.createElement("div");n.style.padding="6px 10px 6px 10px",n.style.fontSize="12px",n.style.lineHeight="1.35",n.style.color="#e5f6ff",n.style.maxWidth="360px",n.style.maxHeight="120px",n.style.overflow="auto",n.style.wordBreak="break-all",n.style.whiteSpace="pre-wrap",n.style.borderBottom="1px solid rgba(255,255,255,0.08)",n.style.boxSizing="border-box",n.setAttribute("data-danmaku-preview",""),e.appendChild(n);var a,i,s,o=null;a="复制",i=function(){if(o){var t=o.text||"";try{if(navigator.clipboard&&navigator.clipboard.writeText){var e=navigator.clipboard.writeText(t);e&&"function"==typeof e.then&&e.then(function(){}).catch(function(e){try{console.warn("[Danmaku] copy async failed, fallback to execCommand",e)}catch(t){}h(t)})}else h(t)}catch(e){try{console.warn("[Danmaku] copy threw, fallback",e)}catch(t){}try{h(t)}catch(t){}}}},(s=document.createElement("div")).textContent=a,s.style.padding="4px 12px",s.style.cursor="pointer",s.style.whiteSpace="nowrap",s.addEventListener("mouseenter",function(){s.style.background="rgba(255,255,255,0.08)"}),s.addEventListener("mouseleave",function(){s.style.background="transparent"}),s.addEventListener("click",function(t){t.stopPropagation();try{i()}catch(t){}r()}),s.addEventListener("mousedown",function(t){t.button}),e.appendChild(s),document.body.appendChild(e),this._.copyMenu=e,document.addEventListener("contextmenu",l,!0),document.addEventListener("click",c,!1),document.addEventListener("scroll",d,!0),this._.copyMenuHandlers={onContext:l,onDocClick:c,onScroll:d}}function r(){e.style.display="none",o=null}function l(a){if(t._.stage&&t._.stage.parentElement&&!e.contains(a.target)){var i=t._.stage.getBoundingClientRect(),s=a.clientX-i.left,r=a.clientY-i.top;if(!(s<0||r<0||s>i.width||r>i.height)){var l=O.call(t,s,r);l&&("block"===e.style.display&&(e.style.display="none"),o=l,n.textContent=l.text||"",a.preventDefault(),a.stopPropagation(),e.style.display="block",function(t,n){var a=window.innerWidth,i=window.innerHeight;e.style.left=Math.min(t,a-e.offsetWidth-4)+"px",e.style.top=Math.min(n,i-e.offsetHeight-4)+"px",e.style.display="block"}(a.clientX,a.clientY))}}}function d(){r()}function c(t){e.contains(t.target)||r()}function h(t){try{var e=document.createElement("textarea");e.value=t,e.style.position="fixed",e.style.top="-9999px",document.body.appendChild(e),e.select();try{document.execCommand("copy")}catch(t){try{console.warn("[Danmaku] execCommand copy error",t)}catch(t){}}document.body.removeChild(e)}catch(t){try{console.warn("[Danmaku] fallback copy failed",t)}catch(t){}}}}function H(t,e){try{if(!t||!t.media)return;var n=t.media.currentTime,a=Math.max(0,n-(t._.backfillDuration||t._.duration)),i=E(t.comments,"time",a)-1;i<-1&&(i=-1);for(var s=e,o=[],r=i+1;r<s;r++){var l=t.comments[r];if(l.time<=n&&l.time>=a&&(o.push(l),t._.maxBackfill&&o.length>=t._.maxBackfill))break}if(!o.length)return;t._.engine.setup(t._.stage,o);for(var d=function(){try{return("undefined"!=typeof performance&&performance.now?performance.now():Date.now())/1e3}catch(t){return Date.now()/1e3}}(),c=0;c<o.length;c++){var h=o[c];h._utc=d-(n-h.time);try{h.y=B.call(t,t,h)}catch(e){try{h.y=B(t,h)}catch(t){h.y=0}}t._.runningList.push(h)}if(t._.position=e,t._.paused||t.media&&t.media.paused)try{t._.engine.framing(t._.stage);for(var u=t.media?t.media.playbackRate:1,p=0;p<t._.runningList.length;p++){var m=t._.runningList[p],y="number"==typeof m._baseWidth&&isFinite(m._baseWidth)?m._baseWidth:m.width,g=(t._.width+y)*(n-m.time)*u/t._.duration;if("ltr"===m.mode&&(m.x=g-y),"rtl"===m.mode&&(m.x=t._.width-g),"top"===m.mode||"bottom"===m.mode)if(m._markDisplay&&"number"==typeof m._textWidth&&"number"==typeof m._textLeft){var f=m._textLeft+m._textWidth/2;m.x=t._.width/2-f}else m.x=t._.width-m.width>>1;t._.engine.render(t._.stage,m)}}catch(t){try{console.warn("[Danmaku] seek backfill static render error",t)}catch(t){}}}catch(t){try{console.warn("[Danmaku] seek backfill error",t)}catch(t){}}}var $="undefined"!=typeof window&&window.devicePixelRatio||1;function U(t,e,n,a){try{if(!W()){if(e&&(e._markShown&&e._markShown>0||"function"==typeof e.render)){e._markShown=0,e.render=null;try{e.width=void 0,e.height=void 0;var i=t&&t._fontSize?t._fontSize:{root:16,container:16};e.canvas=a(e,i)}catch(E){}}return void(e&&(e._scaleStart=void 0,e._scaleCurrent=1))}var s=e&&e.mark_count;if(!Array.isArray(s)||s.length<=1){if(e._markShown&&e._markShown>0){e._markShown=0,e.render=null;try{e.width=void 0,e.height=void 0,e.canvas=a(e,t&&t._fontSize?t._fontSize:{root:16,container:16})}catch(S){}}return void(e&&(e._occupiedWidth=void 0))}if(!e._markTimes){try{e._markTimes=s.slice().sort(function(t,e){return t-e})}catch(L){e._markTimes=[]}e._markBaseText||(e._markBaseText=null==e.text?"":String(e.text)),e._markShown=0,e._markDisplay=!1}var o=e._markTimes;if(!o||0===o.length)return;function C(t,e){for(var n=0,a=t.length;n<a;){var i=n+a>>1;t[i]<=e?n=i+1:a=i}return n}var r=C(o,n),l=function(){try{var t=j(),e=t&&t.danmakuSettings&&t.danmakuSettings.get&&t.danmakuSettings.get("mark_threshold"),n=Number(e);return isFinite(n)||(n=1),n<1?n=1:n>20&&(n=20),n}catch(t){return 1}}(),d=r>l,c=!!e._markDisplay;if(r===e._markShown&&d===c)return;if("number"==typeof e._markShown&&r>e._markShown&&r>5&&(e._scaleStart=n,e._scaleDuration=.35,e._scalePeak=1.25),e._markShown=r,e._markDisplay=d,d){var h=e._markBaseText,u=e.style||{},p=u.font||"25px sans-serif",m=1*u.lineWidth;m=m>0&&m!==1/0?Math.ceil(m):1*!!u.strokeStyle;var y=t&&t._fontSize?t._fontSize:{root:16,container:16},g="#3498db";r>30?g="#e74c3c":r>10&&(g="#e67e22"),e.render=function(){var t=document.createElement("canvas"),e=t.getContext("2d"),n=Object.assign({},u);n.font=p,n.textBaseline=n.textBaseline||"bottom",R(n),e.font=n.font;var a=Math.max(1,Math.ceil(e.measureText(h).width)),i=Math.ceil(z(n.font,y)),s=Math.max(6,Math.round(.6*i)),o=s/2,l=Math.max(2,Math.round(.2*i)),d=a+2*m+l+s,c=i+2*m;for(var f in t.width=d*$,t.height=c*$,e.scale($,$),n)e[f]=n[f];var _=0;switch(n.textBaseline){case"top":case"hanging":_=m;break;case"middle":_=c>>1;break;default:_=c-m}n.strokeStyle&&e.strokeText(h,m,_),e.fillText(h,m,_);var b=m+a+l+o,x=_-o;e.beginPath(),e.fillStyle=g,e.arc(b,x,o,0,2*Math.PI),e.fill(),e.fillStyle="#fff";var v=Math.max(8,Math.floor(.6*s)),w="sans-serif";try{var k=n.font.match(/\b\d+(?:\.\d+)?px\s+(.+)$/);k&&(w=k[1])}catch(t){}return e.font=v+"px "+w,e.textAlign="center",e.textBaseline="middle",e.fillText(r,b,x),e.textAlign=void 0,e.textBaseline=void 0,t};try{e.width=void 0,e.height=void 0,e.canvas=a(e,y)}catch(D){}try{var f=document.createElement("canvas").getContext("2d"),_=Object.assign({},u);_.font=p,_.textBaseline=_.textBaseline||"bottom",R(_),f.font=_.font;var b=Math.max(1,Math.ceil(f.measureText(h).width)),x=Math.ceil(z(_.font,y)),v=Math.max(6,Math.round(.6*x)),w=Math.max(2,Math.round(.2*x)),k=2*m;e._textWidth=b,e._textLeft=m,e._baseWidth=b+k,e._occupiedWidth=b+k+w+v}catch(M){e._occupiedWidth=e.width}}else{e.render=null;try{e.width=void 0,e.height=void 0,e.canvas=a(e,t&&t._fontSize?t._fontSize:{root:16,container:16})}catch(A){}e._occupiedWidth=void 0,e._textWidth=void 0,e._textLeft=void 0,e._baseWidth=void 0}}catch(I){}}var V=["mode","time","text","render","style"];function q(t){if(!t||"[object Object]"!==Object.prototype.toString.call(t))return this;for(var e={},n=0;n<V.length;n++)void 0!==t[V[n]]&&(e[V[n]]=t[V[n]]);if(e.text=(e.text||"").toString(),e.mode=S(e.mode),e._utc=("undefined"!=typeof performance&&performance.now?performance.now():Date.now())/1e3,this.media){var a=0;void 0===e.time?(e.time=this.media.currentTime,a=this._.position):(a=E(this.comments,"time",e.time))<this._.position&&(this._.position+=1),this.comments.splice(a,0,e)}else this.comments.push(e);return this}function K(){if(!this||!this.media)return this;var t=this.media.playbackRate||1;if(this._.paused)return this._.lastPbr=t,this;var e=this._.lastPbr||1;if(t<=0||Math.abs(t-e)<1e-6)return this._.lastPbr=t,this;for(var n=function(){try{return("undefined"!=typeof performance&&performance.now?performance.now():Date.now())/1e3}catch(t){return Date.now()/1e3}}(),a=0;a<this._.runningList.length;a++){var i=this._.runningList[a];i._utc=n-(n-i._utc)*e/t}return this._.lastPbr=t,this}var X="undefined"!=typeof window&&window.devicePixelRatio||1;function Y(){try{return window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}}catch(t){return{}}}try{Y().ensureRemoteFontLoaded=T}catch(t){}function Z(t,e){if("function"==typeof t.render){var n=t.render();if(n instanceof HTMLCanvasElement)return t.width=n.width,t.height=n.height,n}var a=document.createElement("canvas"),i=a.getContext("2d"),s=t.style||{};s.font=s.font||"25px sans-serif",s.textBaseline=s.textBaseline||"bottom",R(s);var o=1*s.lineWidth;for(var r in o=o>0&&o!==1/0?Math.ceil(o):1*!!s.strokeStyle,i.font=s.font,t.width=t.width||Math.max(1,Math.ceil(i.measureText(t.text).width)+2*o),t.height=t.height||Math.ceil(z(s.font,e))+2*o,a.width=t.width*X,a.height=t.height*X,i.scale(X,X),s)i[r]=s[r];var l=0;switch(s.textBaseline){case"top":case"hanging":l=o;break;case"middle":l=t.height>>1;break;default:l=t.height-o}return s.strokeStyle&&i.strokeText(t.text,o,l),i.fillText(t.text,o,l),a}var J={name:"canvas",init:function(t){var e=document.createElement("canvas");return e.context=e.getContext("2d"),e._fontSize={root:N(document.getElementsByTagName("html")[0]),container:N(t)},e},clear:function(t,e){t.context.clearRect(0,0,t.width,t.height);for(var n=0;n<e.length;n++)e[n].canvas=null},resize:function(t,e,n){t.width=e*X,t.height=n*X,t.style.width=e+"px",t.style.height=n+"px"},framing:function(t){t.context.clearRect(0,0,t.width,t.height)},setup:function(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.canvas=Z(a,t._fontSize)}},render:function(t,e){var n=t.context,a="number"==typeof e._scaleCurrent&&isFinite(e._scaleCurrent)?e._scaleCurrent:1;if(1!==a){var i=e._markDisplay&&"number"==typeof e._textWidth&&"number"==typeof e._textLeft?e._textLeft+e._textWidth/2:e.width/2,s=e.height/2,o=(e.x+i)*X,r=(e.y+s)*X;n.save();try{n.translate(o,r),n.scale(a,a),n.drawImage(e.canvas,-i*X,-s*X)}finally{n.restore()}}else n.drawImage(e.canvas,e.x*X,e.y*X)},remove:function(t,e){e.canvas=null}},Q=function(){if("undefined"!=typeof window){var t=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame;if(t)return t.bind(window)}return function(t){return setTimeout(t,50/3)}}(),tt=function(){if("undefined"!=typeof window){var t=window.cancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame;if(t)return t.bind(window)}return clearTimeout}();function et(t,e,n){return U(t,e,n,Z)}function nt(t){return function(t){t.ltr=P(),t.rtl=P(),t.top=P(),t.bottom=P()}(t)}function at(){return"undefined"!=typeof performance&&performance.now?performance.now():Date.now()}function it(t){return B(this,t)}function st(){if(!this._.visible||!this._.paused)return this;if(this._.paused=!1,this.media)for(var t=0;t<this._.runningList.length;t++){var e=this._.runningList[t];e._utc=at()/1e3-(this.media.currentTime-e.time)}var n=this,a=function(t,e,n,a){return function(i){t(this._.stage);var s=(i||at())/1e3,o=this.media?this.media.currentTime:s,r=this.media?this.media.playbackRate:1;if(this.media){var l=this._.lastPbr||1;if(Math.abs(r-l)>1e-6){for(var d=0;d<this._.runningList.length;d++){var c=this._.runningList[d];c._utc=s-(s-c._utc)*l/r}this._.lastPbr=r}}var h=null,u=0,p=0;for(p=this._.runningList.length-1;p>=0;p--){h=this._.runningList[p],u=this.media?h.time:h._utc;var m=!1;if("top"===h.mode||"bottom"===h.mode){var y=u+this._.duration;if(W()){var g=void 0;if(Array.isArray(h._markTimes)&&h._markTimes.length>0)g=h._markTimes[h._markTimes.length-1];else if(Array.isArray(h.mark_count)&&h.mark_count.length>0)try{g=Math.max.apply(null,h.mark_count)}catch(t){g=void 0}"number"==typeof g&&isFinite(g)&&(y=g+4)}m=o>y}else m=o-u>this._.duration;m&&(a(this._.stage,h),this._.runningList.splice(p,1))}for(var f=[];this._.position<this.comments.length&&(h=this.comments[this._.position],!((u=this.media?h.time:h._utc)>=o));)if(o-u>this._.duration)++this._.position;else{this.media&&(h._utc=s-(this.media.currentTime-h.time));try{et(this._.stage,h,o)}catch(t){}f.push(h),++this._.position}for(e(this._.stage,f),p=0;p<f.length;p++)(h=f[p]).y=it.call(this,h),this._.runningList.push(h);for(p=0;p<this._.runningList.length;p++){h=this._.runningList[p];try{et(this._.stage,h,o)}catch(t){}if("number"==typeof h._scaleStart){var _=L(h._scaleStart,o,h._scaleDuration,h._scalePeak);h._scaleCurrent=_,1===_&&o-h._scaleStart>=(h._scaleDuration||.35)&&(h._scaleStart=void 0)}else h._scaleCurrent=1;var b=D(h),x=M(h),v=(this._.width+x)*(s-h._utc)*r/this._.duration;if("ltr"===h.mode&&(h.x=v-x),"rtl"===h.mode&&(h.x=this._.width-v),"top"===h.mode||"bottom"===h.mode)if(h._markDisplay&&"number"==typeof h._textWidth&&"number"==typeof h._textLeft){var w=h._textLeft+h._textWidth/2;h.x=this._.width/2-w}else h.x=this._.width-b>>1;n(this._.stage,h)}}}(this._.engine.framing.bind(this),this._.engine.setup.bind(this),this._.engine.render.bind(this),this._.engine.remove.bind(this));return this._.requestID=Q(function t(e){a.call(n,e),n._.requestID=Q(t)}),this}function ot(){return!this._.visible||this._.paused||(this._.paused=!0,tt(this._.requestID),this._.requestID=0),this}function rt(){return K.call(this)}function lt(){if(!this.media)return this;this.clear(),nt(this._.space);var t=E(this.comments,"time",this.media.currentTime);return this._.position=Math.max(0,t-1),this._.backfillOnSeek&&H(this,t),this}function dt(t){t.play=st.bind(this),t.pause=ot.bind(this),t.seeking=lt.bind(this),t.ratechange=rt.bind(this),this.media.addEventListener("play",t.play),this.media.addEventListener("pause",t.pause),this.media.addEventListener("playing",t.play),this.media.addEventListener("waiting",t.pause),this.media.addEventListener("seeking",t.seeking),this.media.addEventListener("ratechange",t.ratechange)}function ct(t){this.media.removeEventListener("play",t.play),this.media.removeEventListener("pause",t.pause),this.media.removeEventListener("playing",t.play),this.media.removeEventListener("waiting",t.pause),this.media.removeEventListener("seeking",t.seeking),this.media.removeEventListener("ratechange",t.ratechange),t.play=null,t.pause=null,t.seeking=null,t.ratechange=null}function ht(t){this._={},this.container=t.container||document.createElement("div"),this.media=t.media,this._.visible=!0,this.engine="canvas",this._.engine=J,this._.requestID=0,this._.speed=Math.max(0,t.speed)||144,this._.duration=4,this._.lastPbr=this.media&&this.media.playbackRate||1,this._.backfillOnSeek=void 0===t.backfillOnSeek||!!t.backfillOnSeek,this._.backfillDuration="number"==typeof t.backfillDuration&&t.backfillDuration>0?t.backfillDuration:void 0,this._.maxBackfill="number"==typeof t.maxBackfill&&t.maxBackfill>0?t.maxBackfill:120,this._.enableCopyMenu=void 0===t.enableCopyMenu||!!t.enableCopyMenu,this._.copyMenu=null,this._.copyMenuHandlers=null,this.comments=t.comments||[],this.comments.sort(function(t,e){return t.time-e.time});for(var e=0;e<this.comments.length;e++)this.comments[e].mode=S(this.comments[e].mode);this._.runningList=[],this._.position=0,this._.paused=!0;var n=[];try{var a=Y(),i=a?.danmakuSettings?.get?.("font_family");"string"==typeof i&&0===i.indexOf("/danmaku/font/")&&n.push(i)}catch(t){}var s=Array.from(new Set(n)),o=Promise.resolve();s.length>0&&(o=Promise.all(s.map(function(t){return T(t)})).then(function(){}).catch(function(){})),this._.fontReadyPromise=o,this.media&&(this._.listener={},dt.call(this,this._.listener)),this._.stage=this._.engine.init(this.container),this._.stage.style.cssText+="position:relative;pointer-events:none;",this.resize(),this.container.appendChild(this._.stage);try{a=Y(),i=a?.danmakuSettings?.get?.("font_family");"string"==typeof i&&0===i.indexOf("/danmaku/font/")&&T(i).then(function(t){if(t)try{(a.danmakuRenderer?.container||this.container).style.fontFamily="'"+t+"', sans-serif"}catch(t){}}.bind(this))}catch(t){}if(this._.enableCopyMenu&&G.call(this),this._.space={},nt(this._.space),!this.media||!this.media.paused){var r=this;this._.fontReadyPromise.then(function(){lt.call(r),st.call(r)})}return this}function ut(){if(!this.container)return this;if(ot.call(this),this.clear(),this.container.removeChild(this._.stage),this.media&&ct.call(this,this._.listener),this._.copyMenuHandlers){try{document.removeEventListener("contextmenu",this._.copyMenuHandlers.onContext,!0)}catch(t){}try{document.removeEventListener("click",this._.copyMenuHandlers.onDocClick,!0)}catch(t){}try{document.removeEventListener("scroll",this._.copyMenuHandlers.onScroll,!0)}catch(t){}}if(this._.copyMenu&&this._.copyMenu.parentElement)try{this._.copyMenu.parentElement.removeChild(this._.copyMenu)}catch(t){}for(var t in this)Object.prototype.hasOwnProperty.call(this,t)&&(this[t]=null);return this}function pt(t){return q.call(this,t)}function mt(){if(this._.visible)return this;this._.visible=!0;var t=this;return(this._.fontReadyPromise||Promise.resolve()).then(function(){lt.call(t),t.media&&t.media.paused||st.call(t)}),this}function yt(){return this._.visible?(ot.call(this),this.clear(),this._.visible=!1,this):this}function gt(){return this._.engine.clear(this._.stage,this._.runningList),this._.runningList=[],this}function ft(){return this._.width=this.container.offsetWidth,this._.height=this.container.offsetHeight,this._.engine.resize(this._.stage,this._.width,this._.height),this._.duration=this._.width/this._.speed,this}var _t={get:function(){return this._.speed},set:function(t){return"number"!=typeof t||isNaN(t)||!isFinite(t)||t<=0?this._.speed:(this._.speed=t,this._.width&&(this._.duration=this._.width/t),t)}};function bt(t){t&&ht.call(this,t)}bt.prototype.destroy=function(){return ut.call(this)},bt.prototype.emit=function(t){return pt.call(this,t)},bt.prototype.show=function(){return mt.call(this)},bt.prototype.hide=function(){return yt.call(this)},bt.prototype.clear=function(){return gt.call(this)},bt.prototype.resize=function(){return ft.call(this)},bt.prototype.ensureRemoteFontLoaded=function(t){return T(t)},Object.defineProperty(bt.prototype,"speed",_t),bt.prototype._setupCopyContextMenu=function(){G.call(this)},bt.prototype.replaceComments=function(t,e){if(e=e||{},!Array.isArray(t))return this;var n=t.slice();n.sort(function(t,e){return(t.time||0)-(e.time||0)});for(var a=0;a<n.length;a++){var i=n[a];i.mode=S(i.mode),i.text=null==i.text?"":String(i.text)}var s=this.media,o=s?s.currentTime:at()/1e3,r=this._.duration||4,l=o-r,d={};nt(d);var c=[],h=E(n,"time",l)-1;h<-1&&(h=-1);for(var u=h+1,p=at()/1e3,m=s&&s.playbackRate||1,y={media:s,_:{duration:r,width:this._.width,height:this._.height,space:d}},g=this._.stage?this._.stage._fontSize:{root:16,container:16};u<n.length;){var f=n[u],_=f.time||0;if(_>o)break;if(_>=l){try{f.canvas=Z(f,g)}catch(t){f.canvas=null}f._utc=p-(o-_);try{f.y=it.call(y,f)}catch(t){f.y=0}c.push(f)}u++}var b=E(n,"time",o)-1;b<0&&(b=0);var x=this._.paused,v=this._.visible;if(!x){try{tt(this._.requestID)}catch(t){}this._.requestID=0,this._.paused=!0}this.comments=n,this._.space=d,this._.runningList=c,this._.position=b;try{this._.engine.framing(this._.stage);for(var w=0;w<c.length;w++){var k=c[w],C="number"==typeof k._baseWidth&&isFinite(k._baseWidth)?k._baseWidth:k.width,L=(this._.width+C)*(p-k._utc)*m/r;if("ltr"===k.mode&&(k.x=L-C),"rtl"===k.mode&&(k.x=this._.width-L),"top"===k.mode||"bottom"===k.mode)if(k._markDisplay&&"number"==typeof k._textWidth&&"number"==typeof k._textLeft){var D=k._textLeft+k._textWidth/2;k.x=this._.width/2-D}else k.x=this._.width-k.width>>1;this._.engine.render(this._.stage,k)}}catch(t){}if(v&&(x||st.call(this)),e.resetCopyMenu&&this._.enableCopyMenu)try{this._setupCopyContextMenu()}catch(t){}return this};const xt="__jfDanmakuGlobal__";function vt(){return"undefined"==typeof window?{}:(window[xt]=window[xt]||{},window[xt])}function wt(t){if(!t)return!1;if(null!==t.offsetParent)return!0;try{const e=window.getComputedStyle(t);return e&&"none"!==e.display&&"hidden"!==e.visibility&&"0"!==e.opacity}catch(t){return!1}}function kt(){const t=document.querySelector("video.htmlvideoplayer"),e=Array.from(document.querySelectorAll("div[data-type='video-osd']")),n=e.filter(wt);if(t){const e=n.find(e=>e.contains(t));if(e)return e}return n[0]||e[0]||null}function Ct(t=null){const e=function(){const t=t=>{if(!t)return null;const e=[".btnVideoOsdSettings",".btnVideoOsd",".pause"];for(const n of e){const e=t.querySelectorAll(n);for(const t of e){if(!wt(t))continue;const e=t.closest(".buttons.focuscontainer-x");if(e&&wt(e))return e}}const n=t.querySelectorAll(".buttons.focuscontainer-x");for(const t of n)if(wt(t))return t;return n[0]||null};return t(kt())||t(document)}();if(!e)return t?.debug?.("按钮容器未就绪"),{status:"no-container"};const n=vt(),a=n.danmakuButtonsGroup,i=a?.getElement?.(),s=e.children&&e.children.length>1?e.children[1]:null;if(a&&i){try{e.querySelectorAll("[data-danmaku-buttons]")?.forEach(t=>{if(t!==i)try{t.remove()}catch(t){}})}catch(t){}if(i.parentElement!==e){try{e.insertBefore(i,s)}catch(t){try{e.appendChild(i)}catch(t){}}return t?.info?.("弹幕按钮组已移动到当前容器"),{status:"moved",instance:a,element:i}}if(1!==Array.prototype.indexOf.call(e.children,i))try{e.insertBefore(i,s)}catch(t){}return{status:"exists",instance:a,element:i}}const o=new k({logger:t}),r=o.getElement();r?.setAttribute?.("data-danmaku-buttons","true");try{e.querySelectorAll("[data-danmaku-buttons]")?.forEach(t=>{if(t!==r)try{t.remove()}catch(t){}})}catch(t){}try{e.insertBefore(r,s)}catch(t){try{e.appendChild(r)}catch(t){}}return n.danmakuButtonsGroup=o,t?.info?.("弹幕按钮组已插入"),{status:"created",instance:o,element:r}}function Et(t=null){const e=vt(),n=e?.danmakuData?.heatmap_data,a=n?Object.values(n):[],i="danmaku-heatmap-canvas",s=function(){const t=kt()||document,e=[".sliderMarkerContainer",".osdProgressInner .sliderMarkerContainer",".osdProgressInner",".positionSlider",".emby-slider",".noUi-target",'[role="slider"]','input[type="range"]'];for(const n of e){const e=Array.from(t.querySelectorAll(n));for(const t of e){let e=t;if("INPUT"!==e.tagName&&"slider"!==e.getAttribute("role")||(e=e.parentElement||e),wt(e)&&(e.offsetWidth||e.scrollWidth))return e}}return document.querySelector(".sliderMarkerContainer")||null}(),o=document.querySelector("video"),r=o?.duration||0;if(!s||!o)return t?.debug?.("热力图容器/视频未就绪"),null;const l=document.getElementById(i);if(l){if(!s.contains(l)){try{s.appendChild(l)}catch(t){}return t?.info?.("热力图已移动到当前容器"),{status:"moved",canvas:l}}return{status:"exists",canvas:l}}if(!r||!isFinite(r)||r<=0){try{const e=vt();if(e.__heatmapWaiting)return t?.debug?.("video.duration 未就绪，已在等待中"),null;t?.debug?.("video.duration 未就绪，开始等待直到可用"),e.__heatmapWaiting=!0;const n=()=>{const t=o?.duration||0;return!!t&&isFinite(t)&&t>0},a=()=>{try{clearInterval(e.__heatmapWaitTimer)}catch(t){}e.__heatmapWaitTimer=null;try{o.removeEventListener("loadedmetadata",i)}catch(t){}try{o.removeEventListener("durationchange",i)}catch(t){}e.__heatmapWaiting=!1},i=()=>{if(n()){a();try{Et(t)}catch(t){}}};try{o.addEventListener("loadedmetadata",i)}catch(t){}try{o.addEventListener("durationchange",i)}catch(t){}e.__heatmapWaitTimer=setInterval(i,300)}catch(t){}return null}const d=document.getElementById(i);if(d&&d.parentNode)return{status:"exists",canvas:d};try{if(!e.heatmapRenderer){let t={};try{const n=e.danmakuSettings?.get?.("heatmap_style");t=n&&n.trim()?JSON.parse(n):{}}catch(t){}const n=["lineWidth","lineColor","gradientColorStart","gradientColorEnd"].reduce((e,n)=>null!=t?.[n]?(e[n]=t[n],e):e,{});e.heatmapRenderer=new C({resizeThreshold:50,resizeDebounceDelay:100,debug:!1,canvasId:i,...n})}try{const t=e.danmakuSettings?.get?.("heatmap_style"),n=t&&t.trim()?JSON.parse(t):null;if(n){const t=["lineWidth","lineColor","gradientColorStart","gradientColorEnd"].reduce((t,e)=>null!=n?.[e]?(t[e]=n[e],t):t,{});e.heatmapRenderer.updateStyles(t)}}catch(t){}const n=e.heatmapRenderer.process(a,r);return n.id=i,n.setAttribute("data-danmaku-heatmap","true"),s.appendChild(n),t?.info?.("热力图创建成功"),{status:"created",canvas:n}}catch(e){return t?.warn?.("热力图绘制异常",e),null}}function St(t=null){const e=vt(),n=e?.danmakuData?.comments||[];t?.info?.("开始渲染弹幕",{"弹幕数量":n.length});const a=document.querySelector("video");if(!a||!a.parentElement)return t?.debug?.("视频元素未就绪"),null;const i=a.parentElement,s=window.getComputedStyle(i);/(relative|absolute|fixed|sticky)/.test(s.position)||(i.style.position="relative");const o="danmaku-layer",r=document.getElementById(o);if(r){if(r.parentElement!==i)try{i.appendChild(r)}catch(t){}if(e.danmakuRenderer){try{e.danmakuRenderer.resize?.()}catch(t){}return{status:"exists",comments:n.length}}}let l=r;if(!l){l=document.createElement("div"),l.setAttribute("data-danmaku-layer","true"),l.id=o;try{i.appendChild(l)}catch(t){}}const d=(()=>{try{return Number(e?.danmakuSettings?.get("display_top_pct"))}catch(t){return 0}})(),c=(()=>{try{return Number(e?.danmakuSettings?.get("display_bottom_pct"))}catch(t){return 100}})(),h=isFinite(d)?Math.min(99,Math.max(0,d)):0,u=isFinite(c)?Math.min(100,Math.max(h+1,c)):100;l.style.cssText=["position:absolute",`top:${h}%`,`height:${u-h}%`,"left:0","right:0","overflow:hidden","width:100%","pointer-events:none"].join(";");try{const t=e?.danmakuSettings?.get("opacity"),n=Math.min(1,Math.max(0,(t??70)/100));l.style.opacity=String(n)}catch(t){l.style.opacity="0.7"}if(!e.danmakuRenderer){const s=e.danmakuRenderer=new bt({container:l,media:a,comments:n,speed:(()=>{try{const t=e.danmakuSettings?.get("speed"),n=Number(t);return Number.isFinite(n)?Math.min(600,Math.max(24,n)):144}catch(t){return 144}})()});try{if(e?.danmakuSettings?.asBool?.("enable_danmaku")??!0){try{s.show?.()}catch(t){}t?.info?.("读取设置: 弹幕初始显示")}else{try{s.hide?.()}catch(t){}t?.info?.("读取设置: 弹幕初始隐藏")}}catch(t){}if("undefined"!=typeof ResizeObserver){const t=50;let n=null;const a=new ResizeObserver(()=>{e.danmakuRenderer&&(n&&clearTimeout(n),n=setTimeout(()=>{try{e.danmakuRenderer.resize()}catch(t){}},t))});try{a.observe(i)}catch(t){}e.__danmakuResizeObserver=a,e.__danmakuResizeTimerCancel=()=>{if(n){try{clearTimeout(n)}catch(t){}n=null}}}else{const t=()=>{try{e.danmakuRenderer?.resize?.()}catch(t){}};window.addEventListener("resize",t),e.__danmakuWindowResizeHandler=t}return t?.info?.("弹幕渲染器创建完成"),{status:"created",comments:n.length}}return{status:"exists",comments:n.length}}class Lt{constructor({debug:t=!1,prefix:e="Danmaku",maxLines:n=100}={}){this._debug=!!t,this._prefix=e,this._maxLines=n,this._overlay=null,this._overlayWrap=null,this._buffer=[],this._lastOverlayTsMs=0,this._altFlip=!1,this._debug&&this._ensureOverlay()}setDebug(t){const e=!!t;this._debug!==e&&(this._debug=e,this._debug?(this._ensureOverlay(),this.info("调试:开启")):(this.info("调试:关闭"),this._hideOverlay()))}getDebug(){return this._debug}setPrefix(t){this._prefix=String(t||"")}_fmt(t){try{return[`[${this._prefix}]`,...t]}catch(e){return t}}_stringify(t){const e=typeof t;if(null==t||"number"===e||"boolean"===e||"bigint"===e||"symbol"===e)return String(t);if("string"===e)return t;try{return JSON.stringify(t)}catch(e){try{return String(t)}catch(t){return"[Unserializable]"}}}_appendToOverlay(t,e){if(!this._debug)return;if(this._ensureOverlay(),!this._overlay)return;const n=new Date,a=n.getTime(),i=t=>String(t).padStart(2,"0"),s=`${i(n.getHours())}:${i(n.getMinutes())}:${i(n.getSeconds())}`,o=this._lastOverlayTsMs?a-this._lastOverlayTsMs:0;this._lastOverlayTsMs=a;const r=`${s}(${o}ms) ${t.toUpperCase()} ${e.map(t=>this._stringify(t)).join(" ")}`;if(!this._overlay._ready)return void this._buffer.push(r);const l=document.createElement("div");for(l.textContent=r,l.style.whiteSpace="pre-wrap",l.style.wordBreak="break-word","warn"===t?l.style.color="#ffda6b":"error"===t?l.style.color="#ff6b6b":(this._altFlip=!this._altFlip,l.style.color=this._altFlip?"#dbffb9ff":"#9ec7f0ff"),this._overlay.appendChild(l);this._overlay.childNodes.length>this._maxLines;)this._overlay.removeChild(this._overlay.firstChild);this._overlay.scrollTop=this._overlay.scrollHeight}_ensureOverlay(){if(this._overlay){try{(this._overlayWrap||this._overlay.parentElement)?.style&&((this._overlayWrap||this._overlay.parentElement).style.display="block")}catch(t){}return}const t=()=>{if(this._overlay)return;const t=document.createElement("div");t.setAttribute("data-danmaku-debug","overlay"),t.style.position="fixed",t.style.top="8px",t.style.right="8px",t.style.width="320px",t.style.height="180px",t.style.resize="vertical",t.style.minHeight="14px",t.style.maxHeight="90vh",t.style.padding="6px 8px",t.style.background="rgba(0,0,0,0.7)",t.style.border="1px solid rgba(255,255,255,0.2)",t.style.borderRadius="6px",t.style.color="#9ef09e",t.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Consolas, Monospace",t.style.fontSize="12px",t.style.lineHeight="1.25",t.style.zIndex="2147483647",t.style.overflow="auto",t.style.pointerEvents="auto",t.style.userSelect="text",t.style.boxShadow="0 2px 12px rgba(0,0,0,0.4)";const e=document.createElement("div");e.textContent="Danmaku Debug Logs",e.style.fontWeight="600",e.style.marginBottom="4px",e.style.color="#d1ffe2",e.style.cursor="pointer",e.title="点击收起/展开",t.appendChild(e);const n=document.createElement("div");n.style.height="calc(100% - 20px)",n.style.overflow="auto",t.appendChild(n);let a=!1,i="",s="",o="";try{e.addEventListener("click",()=>(e=>{if(a=!!e,a){i=t.style.height,s=t.style.resize,o=t.style.minHeight,n.style.display="none";try{t.style.resize="none",t.style.minHeight="14px",t.style.height="14px"}catch(t){}}else{n.style.display="block";try{t.style.resize=s||"vertical",t.style.minHeight=o||"200px",t.style.height=i||"640px"}catch(t){}}})(!a))}catch(t){}if(this._overlay=n,this._overlayWrap=t,this._overlay._ready=!0,document.body?document.body.appendChild(t):document.documentElement.appendChild(t),this._buffer.length){for(const t of this._buffer){const e=document.createElement("div");e.textContent=t,this._overlay.appendChild(e)}this._buffer.length=0,this._overlay.scrollTop=this._overlay.scrollHeight}};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>t(),{once:!0}):t()}_hideOverlay(){const t=this._overlayWrap||this._overlay?.parentElement;t&&(t.style.display="none")}clear(){this._overlay&&(this._overlay.innerHTML=""),this._buffer.length=0,this._altFlip=!1}log(...t){this._appendToOverlay("log",t)}info(...t){this._appendToOverlay("info",t)}warn(...t){this._appendToOverlay("warn",t)}error(...t){this._appendToOverlay("error",t)}}!function(){const t="__jfDanmakuGlobal__";if("undefined"!=typeof window){const e=window[t];if(e&&e.__webPlayerStateInstalled)return}const e={isActive:null,pollTimer:null,observer:null,mediaItemId:null};let a=!1;try{const t="undefined"!=typeof window&&window.localStorage?window.localStorage.getItem("danmaku_debug_enabled"):null;"1"===t?a=!0:"0"===t&&(a=!1)}catch(t){}const i=new Lt({debug:a,prefix:"JF-Danmaku"});let o=!1;function r(t){if(!t)return!1;if(null!==t.offsetParent)return!0;try{const e=window.getComputedStyle(t);return e&&"none"!==e.display&&"hidden"!==e.visibility&&"0"!==e.opacity}catch(t){return!1}}function l(){const t=document.querySelector("video.htmlvideoplayer"),e=Array.from(document.querySelectorAll("div[data-type='video-osd']")),n=e.filter(r);if(t){const e=n.find(e=>e.contains(t));if(e)return e}return n[0]||e[0]||null}function d(){if(o)return;const t="undefined"!=typeof window?window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{}:{},a=e=>{if(e)try{if(t.__loadingMediaId===e||t.__lastSettingsLoadedForId===e)return;t.__loadingMediaId=e,t.__danmakuDataReady=!1,Promise.resolve(s(i,e)).then(()=>{t.__lastSettingsLoadedForId=e,t.__danmakuDataReady=!0;try{n({})}catch(t){}try{c()}catch(t){}}).catch(n=>{i.warn&&i.warn("fetchDanmakuData 失败",n),t.__lastSettingsLoadedForId===e&&(t.__lastSettingsLoadedForId=null)}).finally(()=>{t.__loadingMediaId===e&&(t.__loadingMediaId=null)})}catch(t){}},r=()=>{const t=l();return!(!t||!t.querySelector("[data-danmaku-buttons]"))},d=()=>r()&&(()=>{const t=l();return!(!t||!t.querySelector("#danmaku-heatmap-canvas"))})()&&(()=>{const t=document.querySelector("video.htmlvideoplayer"),e=document.getElementById("danmaku-layer");return!(!t||!e||e.parentElement!==t.parentElement)})(),c=()=>{if(t.__danmakuDataReady){try{Et(i)}catch(t){}try{St(i)}catch(t){}}},h=()=>{if(!document.querySelector("video.htmlvideoplayer"))return!1;(()=>{try{const t=l();if(t){const e=Array.from(t.querySelectorAll("[data-danmaku-buttons]"));e.length>1&&(e.slice(1).forEach(t=>{try{t.remove()}catch(t){}}),i.info("清理冗余按钮组: "+(e.length-1)))}}catch(t){}try{const t=l();if(t){const e=Array.from(t.querySelectorAll("#danmaku-heatmap-canvas"));e.length>1&&(e.slice(1).forEach(t=>{try{t.remove()}catch(t){}}),i.info("清理冗余热力图: "+(e.length-1)))}}catch(t){}})();let t={status:"skipped"};return r()||(t=Ct(i)),c(),t&&"no-container"!==t.status};let u=!1;try{u=h()}catch(t){i.warn&&i.warn("初始化尝试异常",t)}const p=()=>{if(!o){o=!0,i.info("弹幕 UI 已激活");try{const n="function"==typeof t.getMediaId?t.getMediaId():e.mediaItemId;n?a(n):i.warn&&i.warn("未能获取媒体ID，等待 XHR 嗅探再加载")}catch(t){i.warn&&i.warn("激活后加载全局数据失败",t)}}},m=((t,e)=>{let n=null;return(...a)=>{n&&clearTimeout(n),n=setTimeout(()=>t(...a),e)}})(()=>{try{const t=h();!u&&t&&(u=!0,p())}catch(t){}},150);u&&p();try{const t=e.mediaItemId;t&&a(t)}catch(t){}(()=>{try{const e=new MutationObserver(()=>{try{if(d())return}catch(t){}m(),c()});e.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]}),t.__uiInitObserver=e}catch(t){i.warn&&i.warn("附加持久观察失败",t)}try{t.__uiInitInterval=setInterval(()=>{if(d()){try{clearInterval(t.__uiInitInterval)}catch(t){}t.__uiInitInterval=null}else m(),c()},1e3)}catch(t){}try{const e=()=>{m(),c();try{document.removeEventListener("mousemove",e)}catch(t){}t.__uiInitMouseMove=null};document.addEventListener("mousemove",e,{once:!0}),t.__uiInitMouseMove=e}catch(t){}})()}function c(){if(o){try{!function(t=null){const e=vt();try{e.__heatmapWaitTimer&&clearInterval(e.__heatmapWaitTimer)}catch(t){}e.__heatmapWaitTimer=null,e.__heatmapWaiting=!1;try{e.danmakuButtonsGroup?.destroy?.()}catch(t){}e.danmakuButtonsGroup=null;try{e.danmakuRenderer?.destroy?.()}catch(t){}e.danmakuRenderer=null;try{const t=document.getElementById("danmaku-layer");t?.parentElement&&t.parentElement.removeChild(t)}catch(t){}try{e.heatmapRenderer?.destroy?.()}catch(t){}e.heatmapRenderer=null;try{const t=document.getElementById("danmaku-heatmap-canvas");t?.parentElement&&t.parentElement.removeChild(t)}catch(t){}try{e.__danmakuResizeObserver?.disconnect?.()}catch(t){}e.__danmakuResizeObserver=null;try{e.__danmakuResizeTimerCancel?.()}catch(t){}e.__danmakuResizeTimerCancel=null;try{e.__danmakuWindowResizeHandler&&window.removeEventListener("resize",e.__danmakuWindowResizeHandler)}catch(t){}e.__danmakuWindowResizeHandler=null,t?.info?.("已清理弹幕相关 UI/实例")}(i)}catch(t){}o=!1,i.info("弹幕 UI 已销毁");try{const t=window.__jfDanmakuGlobal__||{};try{t.__uiInitObserver?.disconnect?.()}catch(t){}t.__uiInitObserver=null;try{t.__uiInitInterval&&clearInterval(t.__uiInitInterval)}catch(t){}t.__uiInitInterval=null;try{t.__uiInitMouseMove&&document.removeEventListener("mousemove",t.__uiInitMouseMove)}catch(t){}t.__uiInitMouseMove=null}catch(t){}}}function h(){const t=document.querySelector("video.htmlvideoplayer"),e=document.querySelector("div[data-type='video-osd']");return!(!t||!e)}function u(t){e.isActive!==t&&(e.isActive=t,t?d():c(),i.info("状态变更",{"是否激活":t}))}function p(){u(h())}const m=function(t,e){let n=null;function a(...a){n&&clearTimeout(n),n=setTimeout(()=>{n=null;try{t.apply(this,a)}catch(t){}},e)}return a.cancel=()=>{n&&(clearTimeout(n),n=null)},a}(p,120);function y(){if(function(){try{const t=XMLHttpRequest?.prototype;if(!t)return;if(t.open&&t.open.__jfPlaybackPatched)return;const a=t.open;t.open=function(t,r,...l){return this.addEventListener("load",()=>{if(String(r||"").endsWith("PlaybackInfo"))try{const t=JSON.parse(this.responseText),a=t?.MediaSources?.[0]?.Id;if(!a)return;const r=e.mediaItemId;e.mediaItemId=a,r!==a&&i.info("PlaybackInfo 媒体ID",a);try{const t=window.__jfDanmakuGlobal__=window.__jfDanmakuGlobal__||{};t.__maybeLoadForMedia||(t.__maybeLoadForMedia=(e,a)=>{if(e)try{if(t.__loadingMediaId===e||t.__lastSettingsLoadedForId===e)return;t.__loadingMediaId=e,t.__danmakuDataReady=!1,Promise.resolve(s(a||i,e)).then(()=>{t.__lastSettingsLoadedForId=e,t.__danmakuDataReady=!0;try{n({})}catch(t){}try{Et(a||i)}catch(t){}try{St(a||i)}catch(t){}}).catch(()=>{try{t.__lastSettingsLoadedForId===e&&(t.__lastSettingsLoadedForId=null)}catch(t){}}).finally(()=>{t.__loadingMediaId===e&&(t.__loadingMediaId=null)})}catch(t){}}),t.__maybeLoadForMedia(a,i)}catch(t){}o&&(c(),d())}catch(t){}},{once:!0}),a.apply(this,[t,r,...l])},t.open.__jfPlaybackPatched=!0,i.info("已安装 XMLHttpRequest 嗅探")}catch(t){i.warn&&i.warn("安装 XHR 嗅探失败",t)}}(),e.pollTimer=setInterval(p,3e3),i.info("轮询已启动"),"MutationObserver"in window){e.observer=new MutationObserver(()=>{m()});const t=document.documentElement||document.body;t&&(e.observer.observe(t,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["class","style"]}),i.info("DOM 变动监听已附加"))}p()}if("undefined"!=typeof window){const n=window[t]=window[t]||{};Object.assign(n,{start:y,isInWebPlayer:h,getState:()=>e.isActive,getExt:()=>({uiActive:o}),getMediaId:()=>e.mediaItemId,spawnExt:()=>{try{c()}catch(t){}try{d()}catch(t){}},setDebug:t=>i.setDebug(t),getDebug:()=>i.getDebug(),getLogger:()=>i,__webPlayerStateInstalled:!0})}var g;g=y,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",g,{once:!0}):g()}()}();
//# sourceMappingURL=jellyfin-danmaku.min.js.map
